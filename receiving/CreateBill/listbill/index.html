<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auxilium - Daftar Tagihan</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/feather-icons"></script> 
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#116999', 
                        'primary-hover': '#0e5a85', 
                        bglight: '#f8fafc', 
                        darktext: '#1e293b' 
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <style>
        /* =========================================
           STYLES
           ========================================= */
        :root { 
            --primary-color: #116999; 
            --primary-hover: #0e5a85;
            --red-bg: #fee2e2; 
            --red-text: #991b1b;
        }
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; margin: 0; }
        
        /* Navbar */
        .aux-navbar { background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
        .aux-logo img { height: 40px; width: auto; display: block; }
        .aux-menu { display: flex; gap: 10px; align-items: center; height: 100%; }
        .nav-item { position: relative; height: 100%; display: flex; align-items: center; }
        .aux-link { text-decoration: none; color: #666; font-weight: 600; font-size: 14px; padding: 8px 14px; border-radius: 6px; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .aux-link:hover, .nav-item:hover .aux-link { color: #1d2939; background-color: #f9fafb; }
        .aux-link.active { color: var(--primary-color); background-color: #eff8ff; font-weight: 700; }
        
        /* Dropdown */
        .dropdown-menu-aux { visibility: hidden; opacity: 0; position: absolute; top: 90%; left: 50%; transform: translateX(-50%) translateY(-10px); background: white; min-width: 220px; border: 1px solid #eaecf0; border-radius: 8px; box-shadow: 0 12px 16px -4px rgba(16, 24, 40, 0.08); padding: 6px; z-index: 10000; transition: all 0.2s ease; }
        .dropdown-menu-aux::before { content: ""; position: absolute; top: -20px; left: 0; width: 100%; height: 20px; background: transparent; }
        .nav-item:hover .dropdown-menu-aux { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        .dropdown-item-aux { display: block; padding: 10px 12px; color: #344054; text-decoration: none; font-size: 14px; border-radius: 6px; text-align: left; font-weight: 400; }
        .dropdown-item-aux:hover { background-color: #f9fafb; color: var(--primary-color); }

        /* User & Logout */
        .user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid #eee; }
        .user-details { display: flex; flex-direction: column; text-align: right; line-height: 1.3; }
        .user-name { font-weight: 700; font-size: 13px; color: #333; }
        .user-role { font-size: 11px; color: #888; }
        .user-avatar { width: 36px; height: 36px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; user-select: none; }
        .logout-btn { background: none; border: 1px solid #ddd; color: #666; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; }
        .logout-btn:hover { background-color: var(--red-bg); color: var(--red-text); border-color: var(--red-bg); }
        .modal-logout { display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        .modal-logout-content { background-color: #fff; margin: 15% auto; padding: 32px; border-radius: 16px; width: 360px; text-align: center; font-family: 'Inter', sans-serif; }
        .btn-modal { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; }
        .btn-yes { background-color: #d92d20; color: #fff; }
        .btn-cancel { background-color: #f2f4f7; color: #344054; }

        /* App Specific */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .input-bare { background: transparent; border: 1px solid transparent; width: 100%; padding: 4px 8px; border-radius: 4px; }
        .input-bare:hover:not(:disabled) { border-color: #e2e8f0; background: white; }
        .input-bare:focus { border-color: #116999; background: white; outline: none; }
        .bill-input:focus { ring: 2px; ring-color: #116999; border-color: #116999; outline: none; }
        .bill-input:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
        
        .filter-pill.active { background-color: #e0f2fe; color: #0284c7; border-color: #bae6fd; font-weight: 700; }
        .filter-pill.inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
        
        /* Badges */
        .badge-billed { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } 
        .badge-rejected { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } 
        .badge-pending { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; } 
        .badge-siap { background-color: #e0e7ff; color: #3730a3; border: 1px solid #c7d2fe; }
        .badge-proses { background-color: #fef9c3; color: #854d0e; border: 1px solid #fde047; }
        .badge-sukses { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .badge-gagal { background-color: #ffe4e6; color: #be123c; border: 1px solid #fda4af; }

        /* SweetAlert */
        div:where(.swal2-container) { z-index: 9999 !important; font-family: 'Inter', sans-serif !important; }
        .swal2-popup { border-radius: 1rem !important; padding: 2rem !important; }
        .swal2-title { font-size: 1.25rem !important; color: #1e293b !important; }
        .xero-checkbox:checked { background-color: #116999; border-color: #116999; }
    </style>
</head>
<body class="text-slate-800 font-sans antialiased" onclick="handleClickOutside(event)">

    <div class="aux-navbar">
        <div class="aux-logo">
            <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo">
        </div>
        
        <nav class="aux-menu">
            <div class="nav-item">
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/" class="aux-link">Home</a>
            </div>
    
            <div class="nav-item">
                <div class="aux-link">
                    Penjualan 
                    <i data-feather="chevron-down" style="width:14px; height:14px;"></i>
                </div>
                <div class="dropdown-menu-aux">
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Order%20Penjualan/" class="dropdown-item-aux">Order Penjualan</a>
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Review%20Penjualan/" class="dropdown-item-aux">Review Penjualan</a>
                </div>
            </div>
    
            <div class="nav-item">
                <div class="aux-link active">
                    Pembelian
                    <i data-feather="chevron-down" style="width:14px; height:14px;"></i>
                </div>
                <div class="dropdown-menu-aux">
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/PurchaseOrder/index.html" class="dropdown-item-aux">Pemesanan Pembelian</a>
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/CreateBill/index.html" class="dropdown-item-aux">Daftar Tagihan</a>
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html" class="dropdown-item-aux">Penerimaan Pemesanan</a>
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/ImportXeroPO/index.html" class="dropdown-item-aux">Import Xero PO</a>
                </div>
            </div>
            
            <div class="nav-item">
                <div class="aux-link">Produksi <i data-feather="chevron-down" style="width:14px; height:14px;"></i></div>
                <div class="dropdown-menu-aux">
                    <a href="#" class="dropdown-item-aux">Persiapan Pemesanan</a>
                    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/" class="dropdown-item-aux">Produksi Barang Jadi</a>
                    <a href="#" class="dropdown-item-aux">Retur Penjualan</a>
                </div>
            </div>
            <div class="nav-item">
                <div class="aux-link">Persediaan <i data-feather="chevron-down" style="width:14px; height:14px;"></i></div>
                <div class="dropdown-menu-aux">
                    <a href="#" class="dropdown-item-aux">Stok KPC</a>
                    <a href="#" class="dropdown-item-aux">Stok Spandek</a>
                    <a href="#" class="dropdown-item-aux">Gudang BS</a>
                </div>
            </div>
        </nav>
    
        <div class="user-panel">
            <div class="user-details">
                <span class="user-name">Admin Gudang</span>
                <span class="user-role">CV Sukses Jaya</span>
            </div>
            <div class="user-avatar">AG</div>
            <button class="logout-btn" onclick="showLogoutModal()" title="Keluar Akun">
                <i data-feather="log-out" style="width:16px; height:16px;"></i>
            </button>
        </div>
    </div>

    <div id="logoutModal" class="modal-logout">
        <div class="modal-logout-content">
          <p style="font-size:18px; font-weight:600; color:#101828; margin-bottom:10px;">Log out</p>
          <p style="color:#667085; font-size:14px; margin-bottom:24px;">Are you sure you want to log out?</p>
          <div style="display: flex; gap:12px;">
            <button class="btn-modal btn-yes" onclick="logout()">Log out</button>
            <button class="btn-modal btn-cancel" onclick="closeLogoutModal()">Cancel</button>
          </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-6 mt-10"> 
        <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900">List Overview</h1>
                <p class="text-sm text-slate-500 mt-1">Dashboard â€¢ Daftar Tagihan</p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-2 w-full md:w-auto items-end">
                
                <div class="flex gap-2 bg-white p-1 rounded-lg border border-slate-300 shadow-sm h-[40px] items-center">
                    <input type="date" id="filterStartDate" onchange="applyFilters()" class="text-xs border-0 focus:ring-0 text-slate-600 bg-transparent outline-none cursor-pointer" title="Start Date">
                    <span class="text-slate-300 flex items-center">-</span>
                    <input type="date" id="filterEndDate" onchange="applyFilters()" class="text-xs border-0 focus:ring-0 text-slate-600 bg-transparent outline-none cursor-pointer" title="End Date">
                    <div class="w-[1px] h-4 bg-slate-200 mx-1"></div>
                    <select id="sortOrder" onchange="applyFilters()" class="text-xs border-0 focus:ring-0 text-slate-700 font-medium bg-transparent outline-none cursor-pointer pr-1">
                        <option value="asc">Oldest First</option>
                        <option value="desc">Newest First</option>
                    </select>
                </div>

                <div class="flex gap-2 w-full md:w-auto items-center">
                    <div class="relative w-full md:w-80">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fa-solid fa-magnifying-glass"></i></span>
                        <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="Search PO, Vendor, or Invoice..." class="w-full pl-10 pr-4 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none shadow-sm h-[40px]">
                    </div>
                    <button onclick="fetchData()" class="h-[40px] w-[40px] bg-white border border-slate-200 rounded-xl flex items-center justify-center text-slate-600 hover:text-primary hover:bg-slate-50 hover:border-primary/30 transition shadow-sm" title="Refresh Data">
                        <i class="fa-solid fa-arrow-rotate-right text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-end gap-2 border-b border-slate-200 mb-6 pl-1 overflow-x-auto">
            <button onclick="setFilterStatus('all')" class="bg-white px-5 py-3 rounded-t-xl font-bold text-sm flex items-center gap-2 border border-slate-200 border-b-0 min-w-max text-primary relative top-[1px] z-10 shadow-sm cursor-default hover:bg-slate-50 transition">
                <div class="bg-sky-100 text-primary w-6 h-6 flex items-center justify-center rounded text-xs">
                    <i class="fas fa-receipt"></i>
                </div>
                Daftar Tagihan
                <span id="count-total" class="ml-1 bg-primary text-white text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
            </button>

            <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/CreateBill/index.html" class="bg-slate-50 px-5 py-3 rounded-t-xl font-bold text-sm flex items-center gap-2 border border-transparent border-b border-b-slate-200 min-w-max text-slate-500 hover:bg-slate-100 hover:text-slate-700 transition relative top-[1px] group">
                <div class="bg-slate-200 text-slate-600 w-6 h-6 flex items-center justify-center rounded text-xs group-hover:bg-slate-300 transition">
                    <i class="fas fa-folder-open"></i>
                </div>
                Kelola Tagihan PO
                <i class="fas fa-external-link-alt text-[10px] ml-1 text-slate-400"></i>
            </a>
        </div>

        <div class="flex flex-wrap gap-2 mb-6 items-center">
            <button onclick="setFilterStatus('all')" id="filter-all" class="filter-pill active border px-4 py-1.5 rounded-full text-xs font-medium shadow-sm transition-all">Semua</button>
            <button onclick="setFilterStatus('billed')" id="filter-billed" class="filter-pill inactive border px-4 py-1.5 rounded-full text-xs font-medium shadow-sm flex items-center gap-2 transition-all">
                <span class="w-2 h-2 rounded-full bg-green-500"></span> Billed
            </button>
            <button onclick="setFilterStatus('rejected')" id="filter-rejected" class="filter-pill inactive border px-4 py-1.5 rounded-full text-xs font-medium shadow-sm flex items-center gap-2 transition-all">
                <span class="w-2 h-2 rounded-full bg-red-500"></span> Rejected
            </button>
            
            <div class="relative relative-dropdown">
                <button onclick="toggleXeroDropdown(event)" id="filter-xero" class="filter-pill inactive border px-4 py-1.5 rounded-full text-xs font-medium shadow-sm flex items-center gap-2 transition-all">
                    <span class="w-2 h-2 rounded-full bg-indigo-500"></span> Impor Xero <i class="fas fa-chevron-down ml-1 text-[10px]"></i>
                </button>
                
                <div id="xero-dropdown-menu" class="hidden absolute top-full left-0 mt-2 w-48 bg-white border border-slate-200 rounded-xl shadow-xl z-50 p-2 transform transition-all">
                    <div class="text-[10px] uppercase font-bold text-slate-400 px-2 py-1 mb-1">Pilih Status</div>
                    
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-indigo-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="siap impor" onchange="updateXeroFilter()" checked class="xero-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs font-medium text-slate-700">Siap Impor</span>
                    </label>
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-indigo-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="proses impor" onchange="updateXeroFilter()" checked class="xero-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs font-medium text-slate-700">Proses Impor</span>
                    </label>
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-indigo-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="sukses impor" onchange="updateXeroFilter()" checked class="xero-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs font-medium text-slate-700">Sukses Impor</span>
                    </label>
                    <label class="flex items-center gap-2 px-2 py-1.5 hover:bg-indigo-50 rounded-lg cursor-pointer">
                        <input type="checkbox" value="gagal impor" onchange="updateXeroFilter()" checked class="xero-checkbox w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-xs font-medium text-slate-700">Gagal Impor</span>
                    </label>
                </div>
            </div>
        </div>

        <div id="content-area" class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden min-h-[300px]">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase text-[11px] tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Vendor</th>
                            <th class="px-6 py-4">ID PO</th>
                            <th class="px-6 py-4">Invoice No</th>
                            <th class="px-6 py-4">Invoice Date</th>
                            <th class="px-6 py-4">Due Date</th>
                            <th class="px-6 py-4 text-right">Total Est (DPP)</th>
                            <th class="px-6 py-4 text-center">Status</th>
                            <th class="px-4 py-4 text-center w-10">File</th>
                            <th class="px-6 py-4 text-center w-32">Action</th>
                        </tr>
                    </thead>
                    <tbody id="listTableBody" class="divide-y divide-slate-100 text-slate-700"></tbody>
                </table>
            </div>
            <div id="empty-state" class="hidden p-10 text-center">
                <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-search text-slate-300"></i></div>
                <p class="text-slate-400 text-sm">Tidak ada data yang cocok.</p>
            </div>
        </div>
    </div>

    <div id="billModal" class="fixed inset-0 z-[100] hidden bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-7xl h-[95vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden relative border border-slate-200">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-4">
                    <div class="bg-sky-50 p-2.5 rounded-lg text-primary border border-sky-100 shadow-sm"><i class="fas fa-file-invoice-dollar text-xl"></i></div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">Bill Entry / Detail</h2>
                        <p class="text-xs text-slate-500">PO Ref: <span id="bill-po-id" class="font-mono font-bold text-slate-700"></span></p>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full text-slate-400 hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 bg-[#f8fafc]">
                <div id="locked-banner" class="hidden mb-6 bg-red-50 border border-red-200 rounded-xl p-4 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-lock text-red-500 text-xl"></i>
                        <div>
                            <h4 class="font-bold text-red-700">Tagihan Terkunci</h4>
                            <p class="text-xs text-red-600">Tagihan ini berstatus <span id="locked-status-text" class="font-bold"></span>. Lakukan revisi untuk mengedit.</p>
                        </div>
                    </div>
                    <button onclick="enableRevision()" class="bg-white border border-red-200 text-red-600 px-4 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-red-100 transition">
                        <i class="fas fa-unlock mr-1"></i> Buka / Revisi
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-5 mb-6 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                    <div class="md:col-span-1">
                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide mb-1 block">Vendor Name</label>
                        <input type="text" id="bill-vendor" readonly class="w-full font-bold text-slate-800 bg-transparent border-b border-transparent outline-none py-1 text-base truncate cursor-default">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-1 block">Inv Number <span class="text-red-500">*</span></label>
                        <input type="text" id="bill-inv-number" class="bill-input w-full border border-slate-300 rounded-md px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-1 block">Inv Date</label>
                        <input type="date" id="bill-date" class="bill-input w-full border border-slate-300 rounded-md px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-1 block">Due Date</label>
                        <input type="date" id="bill-due-date" class="bill-input w-full border border-slate-300 rounded-md px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-1 block">Tax Mode</label>
                        <select id="tax-mode" onchange="calculateTotal()" class="bill-input w-full border border-slate-300 rounded-md px-3 py-2 text-sm bg-white">
                            <option value="exclusive">Tax Exclusive</option>
                            <option value="inclusive">Tax Inclusive</option>
                            <option value="no_tax">No Tax</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6 bg-white p-4 rounded-xl border border-slate-200 border-l-4 border-l-primary shadow-sm">
                    <label class="text-xs font-bold text-primary uppercase mb-2 block flex items-center gap-2"><i class="fas fa-paperclip"></i> Upload Invoice</label>
                    <div class="flex items-center gap-4">
                        <input type="file" id="bill-file" class="bill-input text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-sky-50 file:text-primary hover:file:bg-sky-100 cursor-pointer">
                        <div id="existing-file-link" class="hidden text-sm">
                            <a href="#" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1"><i class="fas fa-external-link-alt"></i> View Existing File</a>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden mb-6">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200 uppercase text-[11px] tracking-wider">
                            <tr>
                                <th class="p-4 w-10 text-center"><i class="fas fa-check-square"></i></th>
                                <th class="p-4 w-16 text-center">Type</th>
                                <th class="p-4 w-1/4">Item Details</th>
                                <th class="p-4 w-32 bg-yellow-50/50">Spec Note</th>
                                <th class="p-4 w-24 text-center">Qty</th>
                                <th class="p-4 w-32 text-right">Price</th>
                                <th class="p-4 w-32 text-right">Disc</th>
                                <th class="p-4 w-40 text-right">Amount</th>
                                <th class="p-4 w-10"></th>
                            </tr>
                        </thead>
                        <tbody id="bill-items-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="action-buttons-container" class="p-4 bg-slate-50 border-t border-slate-200 flex gap-3">
                        <button onclick="openProductModal()" class="action-btn text-xs font-bold text-primary hover:text-primary-hover flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-sky-50 transition">
                            <i class="fas fa-database"></i> Tambah Item Database
                        </button>
                        <button onclick="addCustomItem()" class="action-btn text-xs font-bold text-slate-600 hover:text-slate-800 flex items-center gap-2 px-3 py-2 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-slate-100 transition">
                            <i class="fas fa-plus-circle"></i> Tambah Item Manual
                        </button>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-8 items-start">
                    <div class="w-full md:w-1/2">
                        <label class="text-[11px] font-bold text-slate-500 uppercase mb-2 block tracking-wide">Internal Notes</label>
                        <textarea id="bill-note" rows="4" class="bill-input w-full border border-slate-300 rounded-xl p-3 text-sm resize-none" placeholder="Catatan internal..."></textarea>
                    </div>
                    <div class="w-full md:w-1/2 bg-white rounded-xl p-6 shadow-sm border border-slate-200">
                        <div class="flex justify-between mb-3 text-slate-500 text-sm"><span>Subtotal (DPP)</span> <span id="display-subtotal" class="font-semibold text-slate-700">Rp 0</span></div>
                        <div class="flex justify-between mb-3 text-slate-500 text-sm items-center"><span>PPN (11%)</span> <span id="display-ppn" class="font-semibold text-slate-700">Rp 0</span></div>
                        <div class="flex justify-between mb-4 items-center">
                            <span class="text-slate-500 text-sm">Adjustment</span> 
                            <input type="number" id="bill-adjustment" value="0" oninput="calculateTotal()" class="bill-input text-right w-32 border border-slate-300 rounded-md px-2 py-1 text-sm">
                        </div>
                        <div class="border-t border-dashed border-slate-300 my-4"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-slate-800">GRAND TOTAL</span> 
                            <span id="display-grand-total" class="text-2xl font-bold text-primary">Rp 0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 bg-white border-t border-slate-200 flex justify-between items-center z-10">
                <div class="flex items-center gap-2">
                    <div id="rejection-info-container" class="hidden flex flex-col max-w-md">
                        <span class="text-[10px] font-bold text-red-500 uppercase tracking-wide flex items-center gap-1">
                            <i class="fas fa-exclamation-circle"></i> Alasan Penolakan / Pembatalan:
                        </span>
                        <p id="rejection-reason-text" class="text-sm font-bold text-red-700 mt-1 italic leading-tight">...</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="btn-reject" onclick="openRejectModal()" class="px-4 py-2.5 border border-red-200 bg-red-50 text-red-600 rounded-lg font-bold hover:bg-red-100 transition mr-2">
                        <i class="fas fa-ban mr-1"></i> Tolak / Batal
                    </button>
                    
                    <button onclick="closeModal()" class="px-6 py-2.5 border border-slate-300 rounded-lg text-slate-600 font-bold hover:bg-slate-50 transition">Cancel</button>
                    
                    <button id="btn-save" onclick="submitBill()" class="px-6 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-primary-hover shadow-lg flex items-center gap-2 transition">
                        <i class="fas fa-check"></i> Approve & Save
                    </button>
                </div>
            </div>
            
            <div id="modalLoading" class="hidden absolute inset-0 bg-white/90 backdrop-blur-[1px] flex flex-col items-center justify-center z-50 rounded-2xl">
                <i class="fa-solid fa-arrow-rotate-right text-4xl text-primary mb-4 animate-spin"></i>
                <p class="font-bold text-slate-700 animate-pulse">Processing...</p>
            </div>
        </div>
    </div>

    <div id="rejectModal" class="fixed inset-0 z-[110] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden border border-slate-100 transform transition-all scale-100">
            <div class="bg-red-50 p-4 border-b border-red-100 flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i class="fas fa-exclamation-triangle"></i></div>
                <h3 class="text-lg font-bold text-red-700">Konfirmasi Penolakan</h3>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-600 mb-3">Silakan masukkan alasan penolakan tagihan ini. Catatan ini akan disimpan.</p>
                <textarea id="reject-reason" rows="4" class="w-full border border-slate-300 rounded-xl p-3 text-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none resize-none" placeholder="Tulis alasan penolakan..."></textarea>
                <p id="reject-error" class="text-xs text-red-500 mt-2 hidden font-bold"><i class="fas fa-info-circle"></i> Alasan wajib diisi!</p>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="closeRejectModal()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-bold hover:bg-white transition">Batal</button>
                <button onclick="confirmReject()" class="px-4 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 transition"><i class="fas fa-ban"></i> Tolak Tagihan</button>
            </div>
        </div>
    </div>

    <div id="productModal" class="fixed inset-0 z-[120] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl overflow-hidden flex flex-col h-[80vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                <div><h3 class="font-bold text-slate-800">Pilih Produk Database</h3><p class="text-xs text-slate-500">Filter: <span id="product-vendor-filter" class="font-bold text-primary"></span></p></div>
                <button onclick="closeProductModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-3 bg-white border-b border-slate-100">
                <input type="text" id="searchProduct" onkeyup="filterProducts()" placeholder="Cari nama produk..." class="w-full px-3 py-2 bg-white border border-slate-300 rounded-lg text-sm focus:border-primary outline-none shadow-sm">
            </div>
            <div class="flex-1 overflow-y-auto p-0" id="productListContainer"></div>
        </div>
    </div>

    <script>
        feather.replace();
        function showLogoutModal() { document.getElementById("logoutModal").style.display = "block"; }
        function closeLogoutModal() { document.getElementById("logoutModal").style.display = "none"; }
        function logout() { setTimeout(() => { localStorage.removeItem("uxilium_current_user"); window.location.href = "login.html"; }, 800); }

        const API_URL = "https://script.google.com/macros/s/AKfycbxeoVZiywpVzH5cdgIn4a4pDY8ZlvUlkCvZ1iwRFfi_KNkZZ_99a_EvdQIE4qpX_ZzFyg/exec";
        const TAX_RATE = 0.11;
        let allData = [];
        let currentItems = [];
        let dbProducts = [];
        let currentPOId = "";
        let currentFileUrl = "";
        let currentFilterStatus = 'all';
        let originalInvNumber = ""; 

        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); } });

        window.onload = fetchData;

        async function fetchData() {
            // New Loading Logic: Inject spinner into table
            const tbody = document.getElementById('listTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="py-20 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <div class="animate-spin rounded-full h-10 w-10 border-4 border-slate-200 border-t-primary mb-3"></div>
                            <p class="text-slate-500 text-sm font-medium">Memuat Data...</p>
                        </div>
                    </td>
                </tr>`;
            document.getElementById('content-area').classList.remove('hidden'); 
            document.getElementById('empty-state').classList.add('hidden');

            try {
                const response = await fetch(`${API_URL}?t=${new Date().getTime()}`);
                const data = await response.json();
                allData = data;
                applyFilters();
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="9" class="py-10 text-center text-red-500">Gagal memuat data. Periksa koneksi internet.</td></tr>`;
                showNotification("Gagal memuat data. Periksa koneksi internet.", 'error');
            }
        }

        // --- FILTERING & SORTING LOGIC UPDATE ---
        
        function toggleXeroDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('xero-dropdown-menu');
            dropdown.classList.toggle('hidden');
            setFilterStatus('xero_group', false);
        }

        function handleClickOutside(event) {
            const dropdown = document.getElementById('xero-dropdown-menu');
            const button = document.getElementById('filter-xero');
            if (!dropdown.classList.contains('hidden') && !dropdown.contains(event.target) && !button.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        }

        function updateXeroFilter() {
            currentFilterStatus = 'xero_group';
            applyFilters();
        }

        function applyFilters() {
            const searchInput = document.getElementById('searchInput');
            const searchVal = searchInput ? searchInput.value.toLowerCase().trim() : '';
            
            // New Date & Sort Controls
            const sortOrderEl = document.getElementById('sortOrder');
            const sortOrder = sortOrderEl ? sortOrderEl.value : 'asc';
            const startDateInput = document.getElementById('filterStartDate');
            const endDateInput = document.getElementById('filterEndDate');
            const startDateVal = startDateInput ? startDateInput.value : '';
            const endDateVal = endDateInput ? endDateInput.value : '';

            // Xero Checkboxes
            const checkedBoxes = document.querySelectorAll('.xero-checkbox:checked');
            const selectedXeroStatuses = Array.from(checkedBoxes).map(cb => cb.value);

            if (!allData || allData.length === 0) return;

            let filtered = allData.filter(p => {
                // 1. Text Search
                const idSafe = (p.id || '').toString().toLowerCase();
                const vendorSafe = (p.vendor || '').toString().toLowerCase();
                const invSafe = (p.invNumber || '').toString().toLowerCase();
                const matchSearch = idSafe.includes(searchVal) || vendorSafe.includes(searchVal) || invSafe.includes(searchVal);
                
                // 2. Status Filter
                let matchStatus = true;
                const statusLower = (p.status || "").toLowerCase();
                if (currentFilterStatus === 'billed') {
                    matchStatus = statusLower.includes('billed');
                } else if (currentFilterStatus === 'rejected') {
                    matchStatus = statusLower.includes('rejected') || statusLower.includes('batal');
                } else if (currentFilterStatus === 'xero_group') {
                    matchStatus = selectedXeroStatuses.some(status => statusLower.includes(status));
                }

                // 3. Date Range Filter
                let matchDate = true;
                if (startDateVal && endDateVal && p.invDate) {
                    const itemDate = new Date(p.invDate);
                    itemDate.setHours(0,0,0,0);
                    
                    const start = new Date(startDateVal);
                    start.setHours(0,0,0,0);
                    
                    const end = new Date(endDateVal);
                    end.setHours(23,59,59,999);

                    if (!isNaN(itemDate.getTime())) {
                        matchDate = itemDate >= start && itemDate <= end;
                    }
                }
                
                return matchSearch && matchStatus && matchDate;
            });

            // 4. Sorting
            filtered.sort((a, b) => {
                const dateA = a.invDate ? new Date(a.invDate) : new Date(0);
                const dateB = b.invDate ? new Date(b.invDate) : new Date(0);

                if (sortOrder === 'asc') {
                    return dateA - dateB; // Oldest first
                } else {
                    return dateB - dateA; // Newest first
                }
            });

            renderTable(filtered);
        }

        function setFilterStatus(status, closeDropdown = true) {
            currentFilterStatus = status;
            document.querySelectorAll('.filter-pill').forEach(el => {
                el.classList.remove('active'); el.classList.add('inactive');
            });
            
            const statusMap = { 'all': 'filter-all', 'billed': 'filter-billed', 'rejected': 'filter-rejected', 'xero_group': 'filter-xero' };
            if(statusMap[status]) {
                const btn = document.getElementById(statusMap[status]);
                btn.classList.add('active'); btn.classList.remove('inactive');
            }
            if(status !== 'xero_group' && closeDropdown) {
                 document.getElementById('xero-dropdown-menu').classList.add('hidden');
            }
            applyFilters();
        }

        function renderTable(data) {
            const tbody = document.getElementById('listTableBody');
            tbody.innerHTML = '';
            document.getElementById('count-total').innerText = allData.length;
            document.getElementById('content-area').classList.remove('hidden');

            if (data.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            } else {
                document.getElementById('empty-state').classList.add('hidden');
            }

            data.forEach(po => {
                const rawStatus = po.status || "Pending";
                const statusLower = rawStatus.toLowerCase();
                let badgeClass = "badge-pending";

                if (statusLower.includes('billed')) badgeClass = "badge-billed";
                else if (statusLower.includes('rejected') || statusLower.includes('batal')) badgeClass = "badge-rejected";
                else if (statusLower.includes('siap impor')) badgeClass = "badge-siap";
                else if (statusLower.includes('proses impor')) badgeClass = "badge-proses";
                else if (statusLower.includes('gagal impor')) badgeClass = "badge-gagal";
                else if (statusLower.includes('sukses impor')) badgeClass = "badge-sukses";

                const statusBadge = `<span class="${badgeClass} px-2 py-1 rounded text-xs font-bold capitalize">${rawStatus}</span>`;
                let fileBtn = po.fileUrl ? `<a href="${po.fileUrl}" target="_blank" class="text-red-500 hover:text-red-700 block text-center"><i class="fas fa-file-pdf text-xl"></i></a>` : `<span class="text-slate-300 block text-center">-</span>`;
                let displayTotal = formatRupiah(po.totalEst || 0);

                let actionButtons = '';
                const viewBtn = `<button onclick="openBillModal('${po.uniqueKey}', true)" class="w-8 h-8 rounded border border-slate-200 text-slate-400 hover:text-primary hover:bg-teal-50 transition shadow-sm flex items-center justify-center" title="Lihat Detail"><i class="fas fa-eye"></i></button>`;

                if (statusLower.includes('rejected')) {
                    actionButtons = `${viewBtn}<button onclick="openBillModal('${po.uniqueKey}')" class="w-8 h-8 rounded bg-yellow-50 border border-yellow-200 text-yellow-600 hover:bg-yellow-100 transition shadow-sm flex items-center justify-center" title="Revisi / Reverse"><i class="fas fa-rotate-left"></i></button>`;
                } else if (statusLower.includes('siap impor') || statusLower.includes('gagal impor')) {
                    actionButtons = `${viewBtn}<button onclick="syncToXero('${po.id}', '${po.invNumber}')" class="w-8 h-8 rounded bg-blue-50 border border-blue-200 text-blue-600 hover:bg-blue-100 transition shadow-sm flex items-center justify-center" title="Sinkronisasi ke Xero"><i class="fas fa-arrows-rotate"></i></button>`;
                } else if (statusLower.includes('proses impor') || statusLower.includes('sukses impor')) {
                    actionButtons = `${viewBtn}<button disabled class="w-8 h-8 rounded bg-slate-100 border border-slate-200 text-slate-400 cursor-not-allowed flex items-center justify-center" title="Terkunci"><i class="fas fa-lock"></i></button>`;
                } else {
                    let editIcon = po.invNumber ? "fa-pencil" : "fa-plus";
                    let approveBtn = po.invNumber ? `<button onclick="approveBill('${po.uniqueKey}', '${po.id}', '${po.invNumber}')" class="w-8 h-8 rounded bg-green-50 border border-green-200 text-green-600 hover:bg-green-100 transition shadow-sm flex items-center justify-center" title="Approve"><i class="fas fa-check"></i></button>` : '';
                    actionButtons = `${viewBtn}<button onclick="openBillModal('${po.uniqueKey}')" class="w-8 h-8 rounded bg-white border border-slate-200 text-primary hover:bg-teal-50 transition shadow-sm flex items-center justify-center" title="Edit/Entry"><i class="fas ${editIcon}"></i></button>${approveBtn}`;
                }

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition border-b border-slate-100";
                tr.innerHTML = `<td class="px-6 py-4 font-bold text-slate-800">${po.vendor}</td><td class="px-6 py-4 text-primary font-medium">${po.id}</td><td class="px-6 py-4">${po.invNumber || '-'}</td><td class="px-6 py-4">${formatDate(po.invDate)}</td><td class="px-6 py-4">${formatDate(po.dueDate)}</td><td class="px-6 py-4 text-right font-mono font-bold text-slate-700">${displayTotal}</td><td class="px-6 py-4 text-center">${statusBadge}</td><td class="px-4 py-4 text-center">${fileBtn}</td><td class="px-6 py-4 text-center"><div class="flex items-center justify-center gap-2">${actionButtons}</div></td>`;
                tbody.appendChild(tr);
            });
        }

        // --- Other Utility Functions ---
        async function approveBill(uniqueKey, idPO, invNumber) {
            if(!invNumber || invNumber === '-' || invNumber === 'null') {
                Swal.fire({ icon: 'warning', title: 'Data Belum Lengkap', text: 'Tagihan belum di-entry (Invoice No kosong). Silakan entry dulu.', confirmButtonColor: '#116999' });
                return;
            }
            const result = await Swal.fire({ title: 'Setujui Tagihan?', html: `<div class="text-left text-sm text-slate-600">Apakah Anda yakin ingin menyetujui tagihan <span class="font-bold text-slate-800">${invNumber}</span>?<br><br><ul class="list-disc pl-4 text-xs space-y-1"><li>Status berubah menjadi <span class="font-bold text-blue-600">Siap Impor</span></li><li>Data akan <span class="font-bold text-red-500">Terkunci</span></li></ul></div>`, icon: 'question', showCancelButton: true, confirmButtonColor: '#116999', cancelButtonColor: '#cbd5e1', confirmButtonText: '<i class="fas fa-check mr-1"></i> Ya, Setujui', cancelButtonText: 'Batal', reverseButtons: true, focusCancel: true });
            if(result.isConfirmed) {
                Swal.fire({ title: 'Memproses...', text: 'Mohon tunggu sebentar', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                const payload = { action: 'approve_bill', idPO: idPO, invNumber: invNumber };
                try {
                    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const json = await res.json();
                    if(json.status === 'success') { Swal.fire({ icon: 'success', title: 'Berhasil!', text: json.message, confirmButtonColor: '#116999', timer: 2000, showConfirmButton: false }); fetchData(); } 
                    else { Swal.fire({ icon: 'error', title: 'Gagal', text: json.message, confirmButtonColor: '#EF4444' }); }
                } catch(e) { Swal.fire({ icon: 'error', title: 'Error Koneksi', text: e.message, confirmButtonColor: '#EF4444' }); }
            }
        }

        async function syncToXero(idPO, invNumber) {
            const result = await Swal.fire({ title: 'Sinkronisasi Xero', text: `Apakah Anda yakin ingin mengimpor tagihan ${invNumber} ke Xero?`, icon: 'info', showCancelButton: true, confirmButtonColor: '#4F46E5', cancelButtonColor: '#cbd5e1', confirmButtonText: 'Ya, Impor Sekarang', cancelButtonText: 'Batal' });
            if(result.isConfirmed) {
                Swal.fire({ title: 'Menghubungkan...', didOpen: () => Swal.showLoading() });
                const payload = { action: 'sync_xero', idPO: idPO, invNumber: invNumber };
                try {
                    const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const json = await res.json();
                    if(json.status === 'success') { Swal.fire({ icon: 'success', title: 'Proses Dimulai', text: "Status berubah menjadi 'Proses Impor'.", confirmButtonColor: '#116999' }); fetchData(); } 
                    else { Swal.fire({ icon: 'error', title: 'Gagal', text: json.message }); }
                } catch(e) { Swal.fire({ icon: 'error', title: 'Error', text: e.message }); }
            }
        }

        function openBillModal(uniqueKey, viewOnly = false) {
            const po = allData.find(d => d.uniqueKey === uniqueKey);
            if (!po) return;
            currentPOId = po.id;
            originalInvNumber = po.invNumber || ""; 
            document.getElementById('bill-po-id').innerText = po.id;
            document.getElementById('bill-vendor').value = po.vendor;
            document.getElementById('bill-inv-number').value = po.invNumber || '';
            if(po.invDate) document.getElementById('bill-date').value = new Date(po.invDate).toISOString().split('T')[0];
            else document.getElementById('bill-date').valueAsDate = new Date();
            if(po.dueDate) document.getElementById('bill-due-date').value = new Date(po.dueDate).toISOString().split('T')[0];
            else document.getElementById('bill-due-date').value = '';
            document.getElementById('tax-mode').value = po.taxMode || 'exclusive';
            document.getElementById('bill-file').value = ""; 
            const fileLinkDiv = document.getElementById('existing-file-link');
            if(po.fileUrl) { fileLinkDiv.classList.remove('hidden'); fileLinkDiv.querySelector('a').href = po.fileUrl; currentFileUrl = po.fileUrl; } 
            else { fileLinkDiv.classList.add('hidden'); currentFileUrl = ""; }
            
            // LOGIC UTAMA: Saat load existing data (biasanya dari PO), set isCustom = false (Read-only)
            currentItems = po.items.map(i => ({...i, checked: true, isCustom: false}));
            
            const statusLower = (po.status || "").toLowerCase();
            const isStatusLocked = statusLower.includes('rejected') || statusLower.includes('siap impor') || statusLower.includes('proses impor') || statusLower.includes('gagal impor') || statusLower.includes('sukses impor');
            const isFormLocked = viewOnly || isStatusLocked;
            
            renderBillItems(isFormLocked); 
            
            const rejectContainer = document.getElementById('rejection-info-container');
            const rejectText = document.getElementById('rejection-reason-text');
            if(statusLower.includes('rejected')) { rejectContainer.classList.remove('hidden'); rejectText.innerText = po.notes || "Tidak ada catatan."; } 
            else { rejectContainer.classList.add('hidden'); rejectText.innerText = ""; }
            
            if (isFormLocked) {
                if(!viewOnly && isStatusLocked) { document.getElementById('locked-banner').classList.remove('hidden'); document.getElementById('locked-status-text').innerText = po.status; } 
                else { document.getElementById('locked-banner').classList.add('hidden'); }
                document.querySelectorAll('.bill-input').forEach(el => el.disabled = true);
                document.querySelectorAll('.action-btn').forEach(el => el.disabled = true);
                document.getElementById('btn-save').classList.add('hidden');
                document.getElementById('btn-reject').classList.add('hidden');
            } else {
                document.getElementById('locked-banner').classList.add('hidden');
                document.querySelectorAll('.bill-input').forEach(el => el.disabled = false);
                document.querySelectorAll('.action-btn').forEach(el => el.disabled = false);
                document.getElementById('btn-save').classList.remove('hidden');
                document.getElementById('btn-reject').classList.remove('hidden');
            }
            document.getElementById('billModal').classList.remove('hidden');
        }

        async function enableRevision() {
            const result = await Swal.fire({ title: 'Buka Revisi?', text: "Apakah Anda yakin ingin merevisi data ini? Status akan berubah setelah disimpan.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#116999', cancelButtonColor: '#cbd5e1', confirmButtonText: 'Ya, Revisi', cancelButtonText: 'Batal' });
            if(result.isConfirmed) {
                document.getElementById('locked-banner').classList.add('hidden');
                document.querySelectorAll('.bill-input').forEach(el => el.disabled = false);
                document.querySelectorAll('.action-btn').forEach(el => el.disabled = false);
                document.getElementById('btn-save').classList.remove('hidden');
                document.getElementById('btn-reject').classList.remove('hidden');
                renderBillItems(false);
            }
        }

        function renderBillItems(isFormLocked = false) {
            const tbody = document.getElementById('bill-items-body');
            tbody.innerHTML = '';
            const isGlobalLocked = document.getElementById('btn-save').classList.contains('hidden') || isFormLocked;
            
            currentItems.forEach((item, index) => {
                const lineTotal = (item.price - item.disc) * item.qty;
                const rowClass = item.checked ? "bg-white" : "bg-gray-50 opacity-60";
                const typeBadge = item.typeProduk ? `<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold border border-gray-200">${item.typeProduk}</span>` : `<span class="text-gray-300 text-xs">-</span>`;
                const disabledAttr = isGlobalLocked ? "disabled" : "";
                
                // LOGIC NAMA: Jika Custom & Form Tidak Locked = Input, Selain itu = Text Biasa
                const nameHtml = (item.isCustom && !isGlobalLocked)
                    ? `<input type="text" value="${item.namaItem}" ${disabledAttr} oninput="updateItem(${index}, 'namaItem', this.value)" class="input-bare font-bold text-slate-700 text-sm w-full mb-1 focus:bg-white focus:border-slate-300 transition" placeholder="Deskripsi Item...">`
                    : `<div class="font-bold text-slate-700 text-sm w-full mb-1 py-1">${item.namaItem}</div>`;

                tbody.innerHTML += `
                <tr class="${rowClass} border-b border-slate-50 last:border-0 transition">
                    <td class="p-4 align-top text-center"><input type="checkbox" ${item.checked ? 'checked' : ''} ${disabledAttr} onchange="toggleItem(${index}, this.checked)" class="bill-input w-4 h-4 text-primary rounded cursor-pointer accent-primary"></td>
                    <td class="p-4 align-top text-center">${typeBadge}</td>
                    <td class="p-4 align-top">
                        ${nameHtml}
                        <div class="flex items-center"><input type="text" value="${item.satuan}" ${disabledAttr} oninput="updateItem(${index}, 'satuan', this.value)" class="input-bare text-[10px] bg-slate-100 text-slate-600 font-bold w-16 text-center rounded px-1 py-0.5 focus:bg-white focus:ring-1 focus:ring-slate-300 transition" placeholder="Unit"></div>
                    </td>
                    <td class="p-4 align-top bg-yellow-50/30"><input type="text" value="${item.spec || ''}" ${disabledAttr} oninput="updateItem(${index}, 'spec', this.value)" class="input-bare text-xs text-slate-600 font-medium h-full" placeholder="-"></td>
                    <td class="p-4 align-top"><input type="number" value="${item.qty}" min="0" ${disabledAttr} oninput="updateItem(${index}, 'qty', this.value)" class="input-bare text-center text-sm font-bold text-slate-700"></td>
                    <td class="p-4 align-top"><input type="number" value="${item.price}" ${disabledAttr} oninput="updateItem(${index}, 'price', this.value)" class="input-bare text-right text-sm font-mono text-slate-600"></td>
                    <td class="p-4 align-top"><input type="number" value="${item.disc}" ${disabledAttr} oninput="updateItem(${index}, 'disc', this.value)" class="input-bare text-right text-sm font-mono text-red-500"></td>
                    <td class="p-4 align-top text-right font-bold text-slate-800 font-mono text-sm"><span id="amount-${index}">${formatRupiah(lineTotal)}</span></td>
                    <td class="p-4 align-top text-center"><button onclick="deleteItem(${index})" ${disabledAttr} class="bill-input text-slate-300 hover:text-red-500 transition px-2"><i class="fas fa-trash"></i></button></td>
                </tr>`;
            });
            calculateTotal();
        }

        function toggleItem(index, isChecked) { currentItems[index].checked = isChecked; renderBillItems(); }
        function updateItem(index, field, value) { if(['qty', 'price', 'disc'].includes(field)) { currentItems[index][field] = Number(value); const item = currentItems[index]; const newLineTotal = (item.price - item.disc) * item.qty; const amountEl = document.getElementById(`amount-${index}`); if(amountEl) amountEl.innerText = formatRupiah(newLineTotal); calculateTotal(); } else { currentItems[index][field] = value; } }
        async function deleteItem(index) { const result = await Swal.fire({ title: 'Hapus Item?', text: "Item ini akan dihapus dari daftar.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#cbd5e1', confirmButtonText: 'Ya, Hapus', cancelButtonText: 'Batal', customClass: { popup: 'text-xs' } }); if(result.isConfirmed) { currentItems.splice(index, 1); renderBillItems(); } }
        
        function addCustomItem() { 
            currentItems.push({ 
                namaItem: "Manual Item", 
                satuan: "Unit", 
                typeProduk: "Manual", // Changed from "M"
                spec: "", 
                qty: 1, 
                price: 0, 
                disc: 0, 
                checked: true, 
                isCustom: true // Nama bisa diedit
            }); 
            renderBillItems(); 
        }
        
        function calculateTotal() { let totalLine = 0; currentItems.forEach(item => { if(item.checked) { totalLine += (item.price - item.disc) * item.qty; } }); const taxMode = document.getElementById('tax-mode').value; const adj = Number(document.getElementById('bill-adjustment').value) || 0; let dpp = 0, ppn = 0; if (taxMode === 'exclusive') { dpp = totalLine; ppn = dpp * TAX_RATE; } else if (taxMode === 'inclusive') { dpp = totalLine / (1 + TAX_RATE); ppn = totalLine - dpp; } else { dpp = totalLine; } const grand = dpp + ppn + adj; document.getElementById('display-subtotal').innerText = formatRupiah(dpp); document.getElementById('display-ppn').innerText = formatRupiah(ppn); document.getElementById('display-grand-total').innerText = formatRupiah(grand); }
        async function openProductModal() { const vendorName = document.getElementById('bill-vendor').value; if(!vendorName) { showNotification("Vendor belum terisi.", 'warning'); return; } document.getElementById('productModal').classList.remove('hidden'); document.getElementById('product-vendor-filter').innerText = vendorName; document.getElementById('productListContainer').innerHTML = '<div class="text-center p-10"><i class="fas fa-spinner fa-spin text-primary text-2xl"></i><p class="mt-2 text-slate-500">Mengambil data produk...</p></div>'; try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'getProducts', vendor: vendorName }) }); const json = await res.json(); if(json.status === 'success') { dbProducts = json.products; filterProducts(); } else { document.getElementById('productListContainer').innerHTML = `<div class="p-4 text-center text-red-500">${json.message}</div>`; } } catch(e) { document.getElementById('productListContainer').innerHTML = '<div class="p-4 text-center text-red-500">Error fetching products.</div>'; } }
        function filterProducts() { const search = document.getElementById('searchProduct').value.toLowerCase(); const container = document.getElementById('productListContainer'); container.innerHTML = ''; const filtered = dbProducts.filter(p => p.namaItem.toLowerCase().includes(search)); if (filtered.length === 0) { container.innerHTML = '<div class="text-center text-slate-400 p-8">Produk tidak ditemukan.</div>'; return; } filtered.forEach(p => { const div = document.createElement('div'); div.className = "flex justify-between items-center p-4 border-b border-slate-100 hover:bg-teal-50 cursor-pointer group transition"; div.innerHTML = `<div><div class="font-bold text-slate-700 text-sm group-hover:text-primary">${p.namaItem}</div><div class="text-xs text-slate-400 mt-0.5 flex gap-2"><span class="bg-slate-100 px-1.5 rounded">${p.satuan}</span><span class="bg-gray-100 text-gray-600 px-1.5 rounded font-bold">${p.typeProduk}</span></div></div><button class="text-xs bg-white border border-slate-200 text-primary px-3 py-1.5 rounded-lg font-bold shadow-sm hover:bg-primary hover:text-white transition"><i class="fas fa-plus"></i> Add</button>`; div.onclick = () => { addDbItemToBill(p); closeProductModal(); }; container.appendChild(div); }); }
        
        function addDbItemToBill(product) { 
            currentItems.push({ 
                namaItem: product.namaItem, 
                satuan: product.satuan, 
                typeProduk: product.typeProduk, 
                spec: "", 
                qty: 1, 
                price: product.price || 0, 
                disc: 0, 
                checked: true, 
                isCustom: false // Nama Read-Only
            }); 
            renderBillItems(); 
        }
        
        function closeProductModal() { document.getElementById('productModal').classList.add('hidden'); }
        function openRejectModal() { document.getElementById('rejectModal').classList.remove('hidden'); document.getElementById('reject-reason').value = ''; document.getElementById('reject-error').classList.add('hidden'); document.getElementById('reject-reason').focus(); }
        function closeRejectModal() { document.getElementById('rejectModal').classList.add('hidden'); }
        function confirmReject() { const reason = document.getElementById('reject-reason').value; if (!reason.trim()) { document.getElementById('reject-error').classList.remove('hidden'); document.getElementById('reject-reason').classList.add('border-red-500'); return; } submitBill('Rejected', reason); closeRejectModal(); }
        async function submitBill(customStatus = null, overrideNotes = null) { const invNum = document.getElementById('bill-inv-number').value; if(!invNum) { showNotification("Invoice Number wajib diisi!", 'warning'); return; } let finalNotes = overrideNotes !== null ? overrideNotes : document.getElementById('bill-note').value; const activeItems = currentItems.filter(i => i.checked); const payload = { action: 'save_bill', data: { idPO: currentPOId, vendor: document.getElementById('bill-vendor').value, oldInvNumber: originalInvNumber, invNumber: invNum, invDate: document.getElementById('bill-date').value, dueDate: document.getElementById('bill-due-date').value, taxMode: document.getElementById('tax-mode').value, customStatus: customStatus, notes: finalNotes, items: activeItems, existingFileUrl: currentFileUrl } }; const fileInput = document.getElementById('bill-file'); if (fileInput.files.length > 0) { const file = fileInput.files[0]; const reader = new FileReader(); reader.onload = async function() { payload.data.fileData = reader.result.split(',')[1]; payload.data.fileName = file.name; payload.data.mimeType = file.type; await sendData(payload); }; reader.readAsDataURL(file); } else { await sendData(payload); } }
        async function sendData(payload) { document.getElementById('modalLoading').classList.remove('hidden'); try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }); const json = await res.json(); if(json.status === 'success') { showNotification(json.message, 'success'); closeModal(); fetchData(); } else { showNotification("Gagal: " + json.message, 'error'); } } catch(e) { showNotification("Error koneksi: " + e.message, 'error'); } finally { document.getElementById('modalLoading').classList.add('hidden'); } }
        function closeModal() { document.getElementById('billModal').classList.add('hidden'); }
        function showNotification(msg, type = 'info') { if(type === 'info') { if(msg.toLowerCase().includes('gagal') || msg.toLowerCase().includes('error')) type = 'error'; else if (msg.toLowerCase().includes('berhasil') || msg.toLowerCase().includes('sukses')) type = 'success'; else if (msg.toLowerCase().includes('wajib')) type = 'warning'; } Toast.fire({ icon: type, title: msg }); }
        function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
        function formatRupiah(n) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n); }
        function formatDate(d) { return d ? new Date(d).toLocaleDateString('id-ID') : '-'; }
    </script>
</body>
</html>
