<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Entry - AUXILIUM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f9; color: #333; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 0.8rem 1.5rem; }
        .navbar-brand span { font-size: 0.85rem; color: #6c757d; font-weight: 400; margin-left: 5px; }
        
        .main-card { 
            border: none; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
            background: #ffffff; 
            padding: 30px; 
        }
        
        .bg-readonly { background-color: #f8f9fa; color: #6c757d; cursor: not-allowed; }
        
        /* Table Styling Enhancement */
        .table thead th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }
        .table tbody td {
            vertical-align: middle; /* Agar teks di tengah vertikal */
            font-size: 0.95rem;
        }

        #loader { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #6c757d; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">AUXILIUM <span>Accounting Management Service</span></a>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px; max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold m-0 text-dark">Buat Purchase Order</h3>
            <div id="loader">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span>Menghubungkan ke Server...</span>
            </div>
        </div>

        <div class="main-card mb-5">
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label fw-semibold">Pilih Vendor</label>
                    <select class="form-select form-select-lg" id="vendorSelect" onchange="onVendorChange()">
                        <option value="" disabled selected>Menunggu data...</option>
                    </select>
                </div>
                
                <div class="col-12">
                    <label class="form-label fw-semibold">Pilih Item</label>
                    <select class="form-select" id="itemSelect" disabled onchange="onItemChange()">
                        <option value="">-- Pilih Vendor Terlebih Dahulu --</option>
                    </select>
                </div>

                <div class="col-md-5">
                    <label class="form-label text-muted">Satuan</label>
                    <input type="text" class="form-control bg-readonly" id="unitInput" readonly placeholder="-">
                </div>
                <div class="col-md-7">
                    <label class="form-label fw-semibold">Jumlah Order</label>
                    <input type="number" class="form-control" id="qtyInput" placeholder="0" min="1">
                </div>
                
                <div class="col-12">
                    <label class="form-label">Catatan Item <small class="text-muted">(Opsional)</small></label>
                    <input type="text" class="form-control" id="noteInput" placeholder="Contoh: Kirim sebelum jam 12, Warna Merah, dll">
                </div>

                <div class="col-12 text-end mt-4">
                     <button class="btn btn-primary px-4 py-2 fw-semibold" onclick="addItemToTable()">
                        <i class="bi bi-plus-lg me-1"></i> Tambahkan ke Daftar
                    </button>
                </div>
            </div>
        </div>

        <div class="mb-5">
            <h5 class="fw-bold mb-3 text-secondary">Daftar Item PO</h5>
            <div class="card border-0 shadow-sm rounded-3 overflow-hidden">
                <div class="card-body p-0">
                    <table class="table table-hover table-striped mb-0" id="poTable">
                        <thead>
                            <tr>
                                <th class="ps-4" width="5%">No</th>
                                <th width="25%">Item</th>
                                <th width="20%">Vendor</th>
                                <th width="10%">Qty</th>
                                <th width="10%">Satuan</th>
                                <th width="25%">Catatan</th>
                                <th width="5%">Hapus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="emptyRow"><td colspan="7" class="text-center py-5 text-muted fst-italic">Belum ada item yang ditambahkan</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-success p-3 fw-bold shadow-sm text-uppercase" id="btnSubmit" onclick="submitPO()" disabled>
                    <i class="bi bi-save2 me-2"></i> Simpan Purchase Order
                </button>
            </div>
        </div>
    </div>

    <script>
      // ==========================================
      // GANTI DENGAN URL DEPLOY APP SCRIPT BARU KAMU
      const API_URL = "https://script.google.com/macros/s/AKfycbyzh45lQKzmyFORCRSnDZ6stoIWrIwKzI3X7eouEYXVe1P3E1obGj4qXkyxw0lgzX3a9w/exec"; 
      // ==========================================

      var allData = {};
      var cartItems = [];

      window.onload = function() {
        fetch(API_URL + "?action=getData")
          .then(response => response.json())
          .then(res => {
             if(res.status === 'success'){
                 populateVendors(res.data);
             } else {
                 throw new Error(res.message);
             }
          })
          .catch(error => {
             document.getElementById("loader").innerHTML = '<span class="text-danger fw-bold">Gagal koneksi: ' + error.message + '</span>';
          });
      };

      function populateVendors(data) {
        allData = data;
        var vendorSelect = document.getElementById("vendorSelect");
        document.getElementById("loader").style.display = 'none';

        vendorSelect.innerHTML = '<option value="" disabled selected>-- Pilih Vendor --</option>';
        Object.keys(allData).sort().forEach(function(vendorName) {
          var option = document.createElement("option");
          option.text = vendorName;
          option.value = vendorName;
          vendorSelect.add(option);
        });
      }

      function onVendorChange() {
        var selectedVendor = document.getElementById("vendorSelect").value;
        if (cartItems.length > 0 && cartItems[0].vendor !== selectedVendor) {
            if(!confirm("Mengganti vendor akan menghapus semua item di daftar. Lanjutkan?")) {
                document.getElementById("vendorSelect").value = cartItems[0].vendor;
                return;
            }
            cartItems = []; renderTable();
        }
        fillItems(selectedVendor);
      }

      function fillItems(vendorName) {
        var itemSelect = document.getElementById("itemSelect");
        document.getElementById("unitInput").value = "";
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="" disabled selected>-- Pilih Item --</option>';
        
        allData[vendorName].forEach(function(obj, index) {
            var option = document.createElement("option");
            option.text = obj.item;
            option.value = index; 
            itemSelect.add(option);
        });
      }

      function onItemChange() {
        var vendor = document.getElementById("vendorSelect").value;
        var idx = document.getElementById("itemSelect").value;
        if(vendor && idx) document.getElementById("unitInput").value = allData[vendor][idx].unit;
      }

      function addItemToTable() {
        var vendor = document.getElementById("vendorSelect").value;
        var idx = document.getElementById("itemSelect").value;
        var qty = document.getElementById("qtyInput").value;
        var unit = document.getElementById("unitInput").value;
        var note = document.getElementById("noteInput").value;

        if (!vendor || !idx || !qty || qty <= 0) return Swal.fire('Data Tidak Lengkap', 'Mohon lengkapi Vendor, Item, dan Jumlah Order (min 1)', 'warning');

        cartItems.push({ 
            vendor: vendor, 
            itemName: allData[vendor][idx].item, 
            qty: qty, 
            unit: unit,
            note: note 
        });

        renderTable();
        
        // Reset Input Fields
        document.getElementById("qtyInput").value = "";
        document.getElementById("noteInput").value = "";
        document.getElementById("itemSelect").focus();
      }

      function renderTable() {
        var tbody = document.querySelector("#poTable tbody");
        tbody.innerHTML = "";
        document.getElementById("btnSubmit").disabled = cartItems.length === 0;

        if (cartItems.length === 0) {
            tbody.innerHTML = '<tr id="emptyRow"><td colspan="7" class="text-center py-5 text-muted fst-italic">Belum ada item yang ditambahkan</td></tr>';
            return;
        }

        cartItems.forEach((item, index) => {
            var displayNote = item.note ? item.note : '<span class="text-muted small fst-italic">-</span>';
            
            tbody.innerHTML += `<tr>
                <td class="ps-4 fw-bold text-secondary">${index + 1}</td>
                <td class="fw-semibold text-primary">${item.itemName}</td>
                <td class="text-secondary small">${item.vendor}</td>
                <td class="fw-bold">${item.qty}</td>
                <td class="text-muted small">${item.unit}</td>
                <td class="text-break small">${displayNote}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteItem(${index})" title="Hapus Item">
                        <i class="bi bi-trash-fill"></i>
                    </button>
                </td>
            </tr>`;
        });
      }

      function deleteItem(index) {
        cartItems.splice(index, 1);
        renderTable();
      }

      function submitPO() {
        Swal.fire({ 
            title: 'Menyimpan PO...', 
            text: 'Mohon tunggu sebentar',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading() 
        });

        var payload = { vendor: cartItems[0].vendor, items: cartItems };

        fetch(API_URL + "?action=saveOrder", {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(res => {
            if(res.status === 'success') {
                Swal.fire({
                    title: 'Berhasil!',
                    text: 'PO berhasil disimpan dengan ID: ' + res.id,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
                
                // Reset Total
                cartItems = []; 
                renderTable();
                document.getElementById("vendorSelect").value = "";
                document.getElementById("itemSelect").innerHTML = '<option value="">-- Pilih Vendor Terlebih Dahulu --</option>';
                document.getElementById("itemSelect").disabled = true;
                document.getElementById("unitInput").value = "";
                document.getElementById("qtyInput").value = "";
                document.getElementById("noteInput").value = "";
            } else {
                throw new Error(res.message);
            }
        })
        .catch(error => {
            Swal.fire('Gagal!', error.message, 'error');
        });
      }
    </script>
</body>
</html>
