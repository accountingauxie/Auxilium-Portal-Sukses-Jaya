<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Order Entry - AUXILIUM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Style sama persis seperti sebelumnya */
        body { font-family: 'Inter', sans-serif; background-color: #f4f6f9; color: #333; }
        .navbar { background-color: #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 0.8rem 1.5rem; }
        .main-card { border: none; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); background: #ffffff; margin-top: 30px; padding: 40px; }
        .bg-readonly { background-color: #f8f9fa; color: #6c757d; cursor: not-allowed; }
        #loader { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #6c757d; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">AUXILIUM <span>Accounting Management Service</span></a>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px; max-width: 900px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold m-0">Buat Purchase Order</h3>
            <div id="loader">
                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                <span>Menghubungkan ke Server...</span>
            </div>
        </div>

        <div class="main-card">
            <div class="row g-4">
                <div class="col-12">
                    <label class="form-label">Pilih Vendor</label>
                    <select class="form-select" id="vendorSelect" onchange="onVendorChange()">
                        <option value="" disabled selected>Menunggu data...</option>
                    </select>
                </div>
                <div class="col-12">
                    <label class="form-label">Pilih Item</label>
                    <select class="form-select" id="itemSelect" disabled onchange="onItemChange()">
                        <option value="">-- Pilih Vendor Terlebih Dahulu --</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Satuan</label>
                    <input type="text" class="form-control bg-readonly" id="unitInput" readonly placeholder="-">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Jumlah Order</label>
                    <input type="number" class="form-control" id="qtyInput" placeholder="0" min="1">
                </div>
                <div class="col-12 text-end mt-4">
                     <button class="btn btn-primary px-4" onclick="addItemToTable()">Tambahkan ke Daftar</button>
                </div>
            </div>
        </div>

        <div class="mt-5 mb-5">
            <h5 class="fw-bold mb-3">Daftar Item PO</h5>
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0" id="poTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">No</th><th>Item</th><th>Vendor</th><th>Qty</th><th>Satuan</th><th>Hapus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="emptyRow"><td colspan="6" class="text-center py-4 text-muted">Belum ada item</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-success p-3 fw-bold shadow-sm" id="btnSubmit" onclick="submitPO()" disabled>SIMPAN PO</button>
            </div>
        </div>
    </div>

    <script>
      // ==========================================
      // PASTE URL DEPLOY WEB APP KAMU DI SINI
      const API_URL = "https://script.google.com/macros/s/AKfycbyvMV9llZfYhqa6Kd8kihxgdILQpPPuoq3uoTFo-tCTRNH7MVTyLqZQjygrRSS67Q4g3Q/exec"; 
      // Contoh: https://script.google.com/macros/s/AKfy.../exec
      // ==========================================

      var allData = {};
      var cartItems = [];

      // 1. Fetch Data saat Load (Pengganti google.script.run)
      window.onload = function() {
        fetch(API_URL + "?action=getData")
          .then(response => response.json())
          .then(res => {
             if(res.status === 'success'){
                 populateVendors(res.data);
             } else {
                 throw new Error(res.message);
             }
          })
          .catch(error => {
             document.getElementById("loader").innerHTML = '<span class="text-danger">Gagal koneksi: ' + error.message + '</span>';
          });
      };

      function populateVendors(data) {
        allData = data;
        var vendorSelect = document.getElementById("vendorSelect");
        document.getElementById("loader").style.display = 'none';

        vendorSelect.innerHTML = '<option value="" disabled selected>-- Pilih Vendor --</option>';
        Object.keys(allData).sort().forEach(function(vendorName) {
          var option = document.createElement("option");
          option.text = vendorName;
          option.value = vendorName;
          vendorSelect.add(option);
        });
      }

      function onVendorChange() {
        var selectedVendor = document.getElementById("vendorSelect").value;
        if (cartItems.length > 0 && cartItems[0].vendor !== selectedVendor) {
            if(!confirm("Ganti vendor akan menghapus item di tabel. Lanjut?")) {
                document.getElementById("vendorSelect").value = cartItems[0].vendor;
                return;
            }
            cartItems = []; renderTable();
        }
        fillItems(selectedVendor);
      }

      function fillItems(vendorName) {
        var itemSelect = document.getElementById("itemSelect");
        document.getElementById("unitInput").value = "";
        itemSelect.disabled = false;
        itemSelect.innerHTML = '<option value="" disabled selected>-- Pilih Item --</option>';
        
        allData[vendorName].forEach(function(obj, index) {
            var option = document.createElement("option");
            option.text = obj.item;
            option.value = index; 
            itemSelect.add(option);
        });
      }

      function onItemChange() {
        var vendor = document.getElementById("vendorSelect").value;
        var idx = document.getElementById("itemSelect").value;
        if(vendor && idx) document.getElementById("unitInput").value = allData[vendor][idx].unit;
      }

      function addItemToTable() {
        var vendor = document.getElementById("vendorSelect").value;
        var idx = document.getElementById("itemSelect").value;
        var qty = document.getElementById("qtyInput").value;
        var unit = document.getElementById("unitInput").value;

        if (!vendor || !idx || !qty || qty <= 0) return Swal.fire('Error', 'Lengkapi data', 'error');

        cartItems.push({ vendor: vendor, itemName: allData[vendor][idx].item, qty: qty, unit: unit });
        renderTable();
        document.getElementById("qtyInput").value = "";
      }

      function renderTable() {
        var tbody = document.querySelector("#poTable tbody");
        tbody.innerHTML = "";
        document.getElementById("btnSubmit").disabled = cartItems.length === 0;

        if (cartItems.length === 0) {
            tbody.innerHTML = '<tr id="emptyRow"><td colspan="6" class="text-center">Belum ada item</td></tr>';
            return;
        }

        cartItems.forEach((item, index) => {
            tbody.innerHTML += `<tr>
                <td class="ps-4">${index + 1}</td>
                <td class="fw-bold">${item.itemName}</td>
                <td>${item.vendor}</td>
                <td>${item.qty}</td>
                <td>${item.unit}</td>
                <td><button class="btn btn-sm btn-danger" onclick="deleteItem(${index})">X</button></td>
            </tr>`;
        });
      }

      function deleteItem(index) {
        cartItems.splice(index, 1);
        renderTable();
      }

      // 2. Kirim Data dengan Fetch POST
      function submitPO() {
        Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() });

        var payload = { vendor: cartItems[0].vendor, items: cartItems };

        // Gunakan 'no-cors' tidak disarankan karena kita butuh response JSON, 
        // tapi Apps Script redirect membuat fetch agak tricky.
        // Cara paling stabil untuk GitHub Pages -> Apps Script:
        fetch(API_URL + "?action=saveOrder", {
            method: "POST",
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(res => {
            if(res.status === 'success') {
                Swal.fire('Sukses!', 'ID PO: ' + res.id, 'success');
                cartItems = []; renderTable();
                document.getElementById("vendorSelect").value = "";
            } else {
                throw new Error(res.message);
            }
        })
        .catch(error => {
            Swal.fire('Gagal!', error.message, 'error');
        });
      }
    </script>
</body>
</html>
