<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input PO - Table Mode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f4f6f9; font-family: sans-serif; }
        .container { max-width: 1200px; margin-top: 80px; }
        .card { border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Table Styling agar input terlihat menyatu */
        .table-input { 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            width: 100%; 
            padding: 6px; 
        }
        .table-input:focus { outline: 2px solid #80bdff; border-color: #80bdff; }
        .bg-readonly { background-color: #e9ecef; cursor: not-allowed; }
        
        /* Agar kolom tabel fit content */
        td { vertical-align: middle; }
        .col-no { width: 50px; text-align: center; }
        .col-action { width: 50px; text-align: center; }
        .col-qty { width: 100px; }
        .col-unit { width: 100px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-light bg-white fixed-top shadow-sm">
        <div class="container-fluid px-4">
            <span class="navbar-brand fw-bold mb-0 h1">AUXILIUM <span class="fw-light fs-6">PO Entry System</span></span>
            <div id="connectionStatus" class="text-secondary small">
                <div class="spinner-border spinner-border-sm" role="status"></div> Loading Data...
            </div>
        </div>
    </nav>

    <div class="container mb-5">
        <div class="card p-4 mb-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="fw-bold mb-1">Pilih Vendor</label>
                    <select class="form-select form-select-lg" id="vendorSelect" onchange="onVendorChange()">
                        <option value="" disabled selected>-- Pilih Vendor Dahulu --</option>
                    </select>
                    <div class="form-text text-danger" id="vendorWarning" style="display:none;">
                        *Mengganti vendor akan menghapus semua baris item.
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-success fw-bold px-4 py-2" onclick="submitPO()">
                        <i class="bi bi-save2 me-2"></i> SIMPAN PO
                    </button>
                </div>
            </div>
        </div>

        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-bordered mb-0" id="itemTable">
                    <thead class="table-light">
                        <tr>
                            <th class="col-no">#</th>
                            <th>Nama Item</th>
                            <th class="col-qty">Qty</th>
                            <th class="col-unit">Satuan</th>
                            <th>Catatan (Opsional)</th>
                            <th class="col-action"><i class="bi bi-trash"></i></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
            
            <div class="p-3 bg-light border-top text-center">
                <button class="btn btn-outline-primary fw-bold w-100 dashed-border" onclick="addNewRow()">
                    <i class="bi bi-plus-circle me-1"></i> Tambah Baris Item
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // PASTE URL DEPLOY APP SCRIPT KAMU DI SINI
        const API_URL = "https://script.google.com/macros/s/AKfycbyzh45lQKzmyFORCRSnDZ6stoIWrIwKzI3X7eouEYXVe1P3E1obGj4qXkyxw0lgzX3a9w/exec"; 
        // ==========================================

        var allData = {};

        window.onload = function() {
            fetch(API_URL + "?action=getData")
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success'){
                    populateVendors(res.data);
                    document.getElementById("connectionStatus").innerHTML = '<span class="text-success fw-bold">Online</span>';
                }
            })
            .catch(e => {
                document.getElementById("connectionStatus").innerHTML = '<span class="text-danger">Offline/Error</span>';
            });
        };

        function populateVendors(data) {
            allData = data;
            var select = document.getElementById("vendorSelect");
            select.innerHTML = '<option value="" disabled selected>-- Pilih Vendor --</option>';
            Object.keys(data).sort().forEach(v => {
                let opt = document.createElement("option");
                opt.value = v; opt.text = v;
                select.add(opt);
            });
        }

        // Jika Vendor Berubah, Reset Tabel
        function onVendorChange() {
            var tbody = document.getElementById("tableBody");
            if(tbody.children.length > 0){
                if(!confirm("Ganti vendor akan menghapus item yang sudah diinput. Lanjut?")){
                    // Balikkan ke vendor sebelumnya (opsional logic kompleks), 
                    // disini kita clear saja untuk keamanan data
                }
            }
            tbody.innerHTML = ""; // Bersihkan tabel
            addNewRow(); // Tambah 1 baris kosong otomatis
        }

        // FUNGSI UTAMA: MENAMBAH BARIS TABLE (ROW)
        function addNewRow() {
            var vendor = document.getElementById("vendorSelect").value;
            if(!vendor) {
                Swal.fire("Pilih Vendor", "Silakan pilih vendor terlebih dahulu di bagian atas.", "warning");
                return;
            }

            var tbody = document.getElementById("tableBody");
            var rowIdx = tbody.children.length; // Index untuk array helper

            // Buat Options untuk Dropdown Item berdasarkan Vendor yang dipilih
            var itemOptions = '<option value="" disabled selected>-- Cari Item --</option>';
            allData[vendor].forEach((obj, index) => {
                // Kita simpan index array sebagai value agar mudah ambil data satuan nanti
                itemOptions += `<option value="${index}">${obj.item}</option>`;
            });

            var tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="text-center bg-light row-number">${rowIdx + 1}</td>
                <td>
                    <select class="form-select item-select" onchange="updateUnit(this)">
                        ${itemOptions}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control qty-input" placeholder="0" min="1">
                </td>
                <td>
                    <input type="text" class="form-control bg-readonly unit-input" readonly tabindex="-1">
                </td>
                <td>
                    <input type="text" class="form-control note-input" placeholder="Keterangan...">
                </td>
                <td class="text-center">
                    <button class="btn btn-sm btn-danger" onclick="removeRow(this)"><i class="bi bi-x-lg"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        }

        // Update Satuan saat Item dipilih
        function updateUnit(selectElement) {
            var vendor = document.getElementById("vendorSelect").value;
            var idx = selectElement.value; // Ini adalah index array dari data vendor
            
            // Cari elemen input satuan di baris (row) yang sama
            var row = selectElement.closest("tr");
            var unitInput = row.querySelector(".unit-input");

            if(allData[vendor] && allData[vendor][idx]){
                unitInput.value = allData[vendor][idx].unit;
            }
        }

        function removeRow(btn) {
            var row = btn.closest("tr");
            row.remove();
            renumberRows(); // Rapikan nomor urut
        }

        function renumberRows() {
            var rows = document.querySelectorAll("#tableBody tr .row-number");
            rows.forEach((td, index) => {
                td.innerText = index + 1;
            });
        }

        // FUNGSI SIMPAN DATA (LOOPING DARI TABEL HTML)
        function submitPO() {
            var vendor = document.getElementById("vendorSelect").value;
            if(!vendor) return Swal.fire("Error", "Pilih Vendor!", "error");

            var rows = document.querySelectorAll("#tableBody tr");
            if(rows.length === 0) return Swal.fire("Kosong", "Tambahkan item minimal satu.", "warning");

            var itemsToSave = [];
            var isValid = true;

            // Loop setiap baris tabel untuk ambil value
            rows.forEach((row, index) => {
                var itemIdx = row.querySelector(".item-select").value;
                var qty = row.querySelector(".qty-input").value;
                var unit = row.querySelector(".unit-input").value;
                var note = row.querySelector(".note-input").value;

                // Validasi sederhana per baris
                if(!itemIdx || !qty || qty <= 0) {
                    isValid = false;
                    row.classList.add("table-danger"); // Beri warna merah jika error
                } else {
                    row.classList.remove("table-danger");
                    // Ambil nama item asli dari data master
                    var realItemName = allData[vendor][itemIdx].item;
                    
                    itemsToSave.push({
                        vendor: vendor,
                        itemName: realItemName,
                        qty: qty,
                        unit: unit,
                        note: note
                    });
                }
            });

            if(!isValid) return Swal.fire("Data Belum Lengkap", "Cek baris yang berwarna merah (Item/Qty kosong).", "error");

            // Kirim ke Server
            Swal.fire({ title: 'Menyimpan PO...', didOpen: () => Swal.showLoading() });

            fetch(API_URL + "?action=saveOrder", {
                method: "POST",
                body: JSON.stringify({ vendor: vendor, items: itemsToSave })
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    Swal.fire('Berhasil!', 'PO ID: ' + res.id, 'success').then(() => {
                        // Reset form
                        document.getElementById("vendorSelect").value = "";
                        document.getElementById("tableBody").innerHTML = "";
                    });
                } else {
                    throw new Error(res.message);
                }
            })
            .catch(err => Swal.fire('Gagal', err.message, 'error'));
        }
    </script>
</body>
</html>
