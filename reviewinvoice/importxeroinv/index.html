<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import to Xero Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Custom Table Style untuk Xero View */
        .xero-table th { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; padding: 8px; border-bottom: 2px solid #e2e8f0; }
        .xero-table td { font-size: 12px; color: #334155; padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        .xero-row-disc td { color: #ef4444; font-style: italic; } /* Merah untuk diskon */
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div class="max-w-6xl mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold text-slate-800">Xero Import Dashboard</h1>
        <p class="text-slate-500 mb-6">Manage invoices ready for Xero synchronization.</p>
        
        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <input type="text" id="searchInput" onkeyup="filterData()" placeholder="Search Customer, Order No, or Invoice..." class="border rounded px-3 py-2 w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div id="order-container" class="space-y-4">
            <div id="loading" class="text-center py-10">
                <div class="loader"></div>
                <p class="text-gray-400 text-sm">Memuat data...</p>
            </div>
        </div>
    </div>

    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl m-4 overflow-hidden transform transition-all flex flex-col max-h-[90vh]">
            
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-slate-50">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">INVOICE DETAIL</h2>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="modal-status-badge" class="px-2 py-0.5 rounded text-xs font-bold uppercase border"></span>
                        <span class="text-xs text-gray-400">Review & Approval System</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="toggleView()" id="btn-toggle-view" class="flex items-center gap-2 bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded text-xs font-bold hover:bg-gray-50 hover:text-blue-600 transition shadow-sm">
                        <span>üëÅÔ∏è Switch to Xero View</span>
                    </button>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
                </div>
            </div>

            <div class="p-6 overflow-y-auto">
                <div class="grid grid-cols-4 gap-6 mb-6 p-4 bg-gray-50 rounded border border-gray-100">
                    <div><p class="text-xs text-gray-500 uppercase font-bold">Customer</p><p class="text-base font-semibold" id="modal-customer">-</p></div>
                    <div><p class="text-xs text-gray-500 uppercase font-bold">Order No</p><p class="text-base font-semibold text-gray-800" id="modal-orderno">-</p></div>
                    <div><p class="text-xs text-gray-500 uppercase font-bold">Date</p><p class="text-base font-semibold text-gray-800" id="modal-date">-</p></div>
                    <div><p class="text-xs text-gray-500 uppercase font-bold">Invoice Ref</p><p class="text-base font-semibold text-blue-600" id="modal-invoice">-</p></div>
                </div>

                <div id="view-normal">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-bold">
                            <tr>
                                <th class="px-3 py-2 border-b w-10">Type</th>
                                <th class="px-3 py-2 border-b">Product</th>
                                <th class="px-3 py-2 border-b text-center">Meter</th>
                                <th class="px-3 py-2 border-b text-center">Qty</th>
                                <th class="px-3 py-2 border-b text-right">Price</th>
                                <th class="px-3 py-2 border-b text-right">Disc</th>
                                <th class="px-3 py-2 border-b text-right">Net Price</th>
                                <th class="px-3 py-2 border-b text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="modal-items-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <div id="view-xero" class="hidden animate-fade-in">
                    <div class="bg-blue-50 border border-blue-100 p-3 rounded mb-4 text-xs text-blue-800 flex gap-2 items-center">
                        <span>‚ÑπÔ∏è</span> Simulasi tampilan data setelah masuk ke Xero (Baris Diskon dipisah otomatis).
                    </div>
                    <table class="w-full text-left xero-table">
                        <thead>
                            <tr>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th class="text-center">Qty</th>
                                <th class="text-right">Unit Price</th>
                                <th>Account</th>
                                <th>Tax Rate</th>
                                <th class="text-right">Line Amount</th>
                            </tr>
                        </thead>
                        <tbody id="xero-items-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-100 flex justify-between items-center bg-slate-50 mt-auto">
                <div class="text-right">
                    <p class="text-xs text-gray-500 uppercase">Grand Total (Inc. PPN 12%)</p>
                    <p class="text-2xl font-bold text-blue-600" id="modal-grandtotal">Rp 0</p>
                </div>
                <button id="btn-sync" onclick="syncToXero()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded shadow-md text-sm font-bold flex items-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>Sync to Xero</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // GANTI URL INI DENGAN DEPLOYMENT TERBARU
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQ6uojG_umdTK1AmHAZghLvdoUE-LXmqk3rucPxWXuUem9VFG3tGjZia6C_tp2TU-q/exec';

        let allData = [];
        let currentOrderNo = null;
        let currentOrderData = null;

        document.addEventListener('DOMContentLoaded', () => fetchData());

        function fetchData() {
            const container = document.getElementById('order-container');
            container.innerHTML = `<div class="text-center py-10"><div class="loader"></div><p class="text-gray-400 text-sm">Sedang mengambil data terbaru...</p></div>`;

            fetch(`${SCRIPT_URL}?action=getXeroData`)
                .then(response => response.json())
                .then(data => {
                    allData = data;
                    renderCards(data);
                })
                .catch(error => {
                    container.innerHTML = `<p class="text-red-500 text-center">Gagal memuat data. <br><small>${error}</small></p>`;
                });
        }

        function renderCards(data) {
            const container = document.getElementById('order-container');
            container.innerHTML = ''; 

            if(data.length === 0) {
                container.innerHTML = `<div class="text-center py-12 bg-white rounded-lg border border-dashed border-gray-300"><p class="text-gray-500">Semua data sudah di-import ke Xero!</p></div>`;
                return;
            }

            data.forEach(order => {
                let formattedTotal = formatRupiah(order.grand_total);
                
                // Logika Tampilan Status
                let statusBadge = '';
                let statusClass = '';
                let cardBorder = '';
                
                if (order.status === 'Processing') {
                    statusBadge = '‚è≥ Processing';
                    statusClass = 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    cardBorder = 'border-l-yellow-500';
                } else {
                    statusBadge = '‚úÖ Ready';
                    statusClass = 'bg-green-100 text-green-700 border-green-200';
                    cardBorder = 'border-l-green-500';
                }

                const cardHTML = `
                <div class="bg-white rounded-lg shadow-sm border-l-4 ${cardBorder} border border-gray-200 p-5 hover:shadow-md transition group">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-bold text-gray-800">${order.order_no}</h3>
                                <span class="text-xs ${statusClass} px-2 py-0.5 rounded border font-semibold">${statusBadge}</span>
                            </div>
                            <div class="text-sm text-gray-500 flex items-center gap-3 mt-2">
                                <span>üë§ ${order.customer}</span>
                                <span>üìÖ ${order.date}</span>
                                <span class="text-gray-400">|</span>
                                <span class="text-blue-600 font-medium">${order.invoice_no || 'No Inv Ref'}</span>
                            </div>
                            <div class="mt-2 text-xl font-bold text-gray-800">${formattedTotal}</div>
                        </div>
                        <div class="text-right flex flex-col items-end gap-2">
                            <button onclick="openDetail('${order.order_no}')" class="text-blue-600 text-sm font-medium hover:text-blue-800 transition flex items-center gap-1 bg-blue-50 px-3 py-1.5 rounded hover:bg-blue-100">
                                Review & Sync &rightarrow;
                            </button>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += cardHTML;
            });
        }

        function openDetail(orderId) {
            const order = allData.find(o => o.order_no == orderId);
            if (!order) return;
            currentOrderData = order;
            currentOrderNo = orderId;

            // Reset View
            document.getElementById('view-normal').classList.remove('hidden');
            document.getElementById('view-xero').classList.add('hidden');
            document.getElementById('btn-toggle-view').innerHTML = `<span>üëÅÔ∏è Switch to Xero View</span>`;

            // Isi Header
            document.getElementById('modal-customer').innerText = order.customer;
            document.getElementById('modal-invoice').innerText = order.invoice_no || "-";
            document.getElementById('modal-orderno').innerText = order.order_no;
            document.getElementById('modal-date').innerText = order.date;
            document.getElementById('modal-grandtotal').innerText = formatRupiah(order.grand_total);
            
            // Status Badge Modal
            const badge = document.getElementById('modal-status-badge');
            const btnSync = document.getElementById('btn-sync');
            
            if (order.status === 'Processing') {
                badge.innerText = "Processing in Xero";
                badge.className = "px-2 py-0.5 rounded text-xs font-bold uppercase border bg-yellow-100 text-yellow-700 border-yellow-200";
                // Disable button karena sudah diproses
                btnSync.disabled = true;
                btnSync.classList.add('bg-gray-400', 'cursor-not-allowed');
                btnSync.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btnSync.innerHTML = "<span>Already Synced</span>";
            } else {
                badge.innerText = "Ready to Import";
                badge.className = "px-2 py-0.5 rounded text-xs font-bold uppercase border bg-green-100 text-green-700 border-green-200";
                // Enable button
                btnSync.disabled = false;
                btnSync.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btnSync.classList.add('bg-blue-600', 'hover:bg-blue-700');
                btnSync.innerHTML = `<span>Sync to Xero</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>`;
            }

            // --- RENDER NORMAL TABLE ---
            const tbodyNormal = document.getElementById('modal-items-body');
            tbodyNormal.innerHTML = '';
            order.items.forEach(item => {
                tbodyNormal.innerHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 font-bold text-gray-700 bg-gray-50 text-center border-r border-gray-100">${item.type}</td>
                        <td class="px-3 py-2 font-medium text-gray-800">${item.product}</td>
                        <td class="px-3 py-2 text-center text-gray-600">${item.meter || '-'}</td>
                        <td class="px-3 py-2 text-center text-gray-600">${item.qty}</td>
                        <td class="px-3 py-2 text-right text-gray-600">${formatRupiah(item.price)}</td>
                        <td class="px-3 py-2 text-right text-red-500">${item.disc > 0 ? formatRupiah(item.disc) : '-'}</td>
                        <td class="px-3 py-2 text-right text-blue-600 font-medium">${formatRupiah(item.net_price)}</td>
                        <td class="px-3 py-2 text-right font-bold text-gray-800">${formatRupiah(item.total)}</td>
                    </tr>`;
            });

            // --- RENDER XERO TABLE (SIMULASI) ---
            const tbodyXero = document.getElementById('xero-items-body');
            tbodyXero.innerHTML = '';
            order.items.forEach(item => {
                // Baris 1: Item Utama
                tbodyXero.innerHTML += `
                    <tr>
                        <td>[PR-${item.type}-${item.product.substring(0,5)}...]</td>
                        <td>${item.product} ${item.meter ? item.meter+'m' : ''}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-right">${item.price.toLocaleString('en-US')}.00</td>
                        <td>4-4000 (Penjualan)</td>
                        <td>PPN 12%</td>
                        <td class="text-right font-semibold">${(item.price * item.qty).toLocaleString('en-US')}.00</td>
                    </tr>
                `;
                // Baris 2: Diskon (Jika ada) - Seperti di Xero
                if (item.disc > 0) {
                     tbodyXero.innerHTML += `
                    <tr class="xero-row-disc bg-red-50">
                        <td></td>
                        <td>Discount - ${item.product}</td>
                        <td class="text-center">${item.qty}</td>
                        <td class="text-right">-${item.disc.toLocaleString('en-US')}.00</td>
                        <td>4-4001 (Diskon)</td>
                        <td>PPN 12%</td>
                        <td class="text-right">-${(item.disc * item.qty).toLocaleString('en-US')}.00</td>
                    </tr>
                `;
                }
            });

            document.getElementById('detailModal').classList.remove('hidden');
        }

        function toggleView() {
            const normal = document.getElementById('view-normal');
            const xero = document.getElementById('view-xero');
            const btn = document.getElementById('btn-toggle-view');

            if (normal.classList.contains('hidden')) {
                normal.classList.remove('hidden');
                xero.classList.add('hidden');
                btn.innerHTML = `<span>üëÅÔ∏è Switch to Xero View</span>`;
                btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-300');
            } else {
                normal.classList.add('hidden');
                xero.classList.remove('hidden');
                btn.innerHTML = `<span>‚Ü©Ô∏è Back to Normal View</span>`;
                btn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-300');
            }
        }

        function syncToXero() {
            if (!currentOrderNo) return;
            const btn = document.getElementById('btn-sync');
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> <span>Processing...</span>`;
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateXeroStatus', orderNo: currentOrderNo })
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Synced!',
                        text: 'Order ditandai "Processing". Tunggu admin Xero update status ke Imported.',
                        timer: 2000, showConfirmButton: false
                    });
                    closeModal();
                    fetchData(); // Refresh untuk update status kartu jadi kuning
                } else { throw new Error(result.message); }
            })
            .catch(err => {
                Swal.fire({ icon: 'error', title: 'Oops...', text: 'Error: ' + err });
                btn.disabled = false;
                btn.innerHTML = "<span>Try Again</span>";
            });
        }

        function closeModal() { document.getElementById('detailModal').classList.add('hidden'); }
        function formatRupiah(num) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num); }
        function filterData() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(item => 
                item.customer.toLowerCase().includes(query) || 
                item.order_no.toLowerCase().includes(query) ||
                (item.invoice_no && item.invoice_no.toLowerCase().includes(query))
            );
            renderCards(filtered);
        }
        window.onclick = function(e) { if (e.target == document.getElementById('detailModal')) closeModal(); }
    </script>
</body>
</html>
