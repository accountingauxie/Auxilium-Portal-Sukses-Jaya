<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Approval System</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background-color: #f5f7fa; margin: 0; padding: 20px; }
    h1 { color: #333; margin-bottom: 20px; }

    /* Controls */
    .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .search-bar { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex-grow: 1; min-width: 200px; }
    .filter-btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; background: #ddd; color: #333; }
    .filter-btn.active { background-color: #007bff; color: white; }

    /* Cards */
    .invoice-card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-title { font-size: 1.1em; font-weight: bold; }
    
    /* Status Badges */
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; color: white; }
    .bg-pending { background-color: #ffc107; color: #333; }
    .bg-approved { background-color: #28a745; }
    .bg-canceled { background-color: #dc3545; }

    .card-info { font-size: 0.9em; color: #555; line-height: 1.6; }

    /* Expand Section */
    .expand-btn { margin-top: 10px; padding: 8px 12px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; width: 100%; text-align: center; }
    .expand-btn:hover { background: #e2e6ea; }
    
    .details-container { display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
    
    /* Table */
    table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-bottom: 15px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    th { background-color: #f8f9fa; font-weight: 600; }
    .text-right { text-align: right; }

    /* Action Buttons */
    .action-row { display: flex; gap: 10px; justify-content: flex-end; }
    .btn { padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; }
    .btn-approve { background-color: #007bff; }
    .btn-approve:hover { background-color: #0056b3; }
    .btn-cancel { background-color: #dc3545; }
    .btn-cancel:hover { background-color: #a71d2a; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Loading */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <h1>Invoice Approval Dashboard</h1>

  <div class="controls">
    <button class="filter-btn active" onclick="setFilter('All')">All</button>
    <button class="filter-btn" onclick="setFilter('Pending')">Pending</button>
    <button class="filter-btn" onclick="setFilter('Approved')">Approved</button>
    <button class="filter-btn" onclick="setFilter('Canceled')">Canceled</button>
    <input type="text" id="searchInput" class="search-bar" placeholder="Search Customer or Invoice..." onkeyup="renderInvoices()">
  </div>

  <div id="invoiceList"></div>

  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
  </div>

<script>
  // ================= CONFIGURATION =================
  // GANTI URL INI dengan URL Web App Script Anda yang baru
  const API_URL = "https://script.google.com/macros/s/AKfycbxWUCj6fAA9Abzc9g8ViGPSxDWr7nH06q2woHGQanw53mFmR0Vz9OHVRG7A27-hZoyAqw/exec"; 
  // =================================================

  let allInvoices = [];
  let currentFilter = 'All';

  // --- INITIALIZATION ---
  window.onload = fetchInvoices;

  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
  }

  // --- FORMATTER HELPERS ---
  function formatMoney(amount) {
    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
  }

  function getStatusClass(status) {
    if (!status || status === 'Pending') return 'bg-pending';
    if (status === 'Approved') return 'bg-approved';
    return 'bg-canceled';
  }

  // --- API CALLS ---
  function fetchInvoices() {
    showLoading(true);
    fetch(API_URL + "?action=listInvoices")
      .then(res => res.json())
      .then(response => {
        showLoading(false);
        if (response.ok) {
          allInvoices = response.data;
          renderInvoices();
        } else {
          alert("Gagal mengambil data: " + response.error);
        }
      })
      .catch(err => {
        showLoading(false);
        alert("Network Error: " + err.message);
      });
  }

  // --- RENDER LOGIC ---
  function setFilter(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.toggle('active', btn.textContent === status);
    });
    renderInvoices();
  }

  function renderInvoices() {
    const container = document.getElementById('invoiceList');
    container.innerHTML = '';
    const searchVal = document.getElementById('searchInput').value.toLowerCase();

    // Filter Logic
    const filtered = allInvoices.filter(inv => {
      const matchStatus = currentFilter === 'All' || (inv.status || 'Pending') === currentFilter;
      const matchSearch = inv.customer.toLowerCase().includes(searchVal) || 
                          inv.invoiceNumber.toString().toLowerCase().includes(searchVal);
      return matchStatus && matchSearch;
    });

    if (filtered.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#888;">No invoices found.</p>';
      return;
    }

    filtered.forEach(inv => {
      const card = document.createElement('div');
      card.className = 'invoice-card';
      
      // Hitung Grand Total (Display purposes)
      const grandTotal = inv.items.reduce((sum, item) => sum + (item.total || 0), 0);
      const status = inv.status || 'Pending';

      // Header Card
      card.innerHTML = `
        <div class="card-header">
          <div class="card-title">${inv.invoiceNumber} - ${inv.customer}</div>
          <span class="status-badge ${getStatusClass(status)}" id="badge-${inv.invoiceNumber}">${status}</span>
        </div>
        <div class="card-info">
          Date: ${inv.date ? new Date(inv.date).toLocaleDateString() : '-'}<br>
          Total Amount: <b>${formatMoney(grandTotal)}</b>
        </div>
        <button class="expand-btn" onclick="toggleDetails('${inv.invoiceNumber}')">Show Details</button>
        
        <div id="details-${inv.invoiceNumber}" class="details-container">
          ${renderTable(inv.items)}
          
          <div class="action-row">
            ${status === 'Pending' ? `
              <button class="btn btn-cancel" onclick="handleAction('${inv.invoiceNumber}', 'Canceled')">Cancel</button>
              <button class="btn btn-approve" onclick="handleApprove('${inv.invoiceNumber}')">Approve</button>
            ` : ''}
          </div>
        </div>
      `;
      container.appendChild(card);
    });
  }

  function renderTable(items) {
    if (!items || items.length === 0) return '<p>No items.</p>';
    
    return `
      <table>
        <thead>
          <tr>
            <th>Type</th>
            <th>Product</th>
            <th class="text-right">Meter</th>
            <th class="text-right">Qty</th>
            <th class="text-right">Unit Price</th>
            <th class="text-right">Disc</th>
            <th class="text-right">Price/Qty</th>
            <th class="text-right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(item => `
            <tr>
              <td>${item.type || '-'}</td>
              <td>${item.product}</td>
              <td class="text-right">${item.meter}</td>
              <td class="text-right">${item.qty}</td>
              <td class="text-right">${formatMoney(item.unitPrice)}</td>
              <td class="text-right">${formatMoney(item.discount)}</td>
              <td class="text-right">${formatMoney(item.priceQty)}</td>
              <td class="text-right"><b>${formatMoney(item.total)}</b></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function toggleDetails(id) {
    const el = document.getElementById(`details-${id}`);
    if (el.style.display === 'block') {
      el.style.display = 'none';
    } else {
      el.style.display = 'block';
    }
  }

  // --- ACTION HANDLERS ---

  // 1. Handle APPROVE (Kirim Full JSON)
  function handleApprove(invoiceNumber) {
    if (!confirm("Are you sure you want to approve this invoice? Data will be sent to Production.")) return;

    // Cari data invoice object secara utuh dari array local
    const invoiceObj = allInvoices.find(i => i.invoiceNumber == invoiceNumber);
    if (!invoiceObj) {
      alert("Error: Data invoice not found in local memory.");
      return;
    }

    // Siapkan Payload khusus backend baru (Code.gs yang terakhir kita buat)
    const payload = {
      invoiceNumber: invoiceObj.invoiceNumber,
      customerName: invoiceObj.customer,
      date: invoiceObj.date, // Pastikan format date aman
      items: invoiceObj.items // Kirim semua detail item
    };

    setLoadingBtn(invoiceNumber, true);

    // Gunakan fetch POST dengan body JSON
    fetch(API_URL + "?action=approveInvoice", {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      setLoadingBtn(invoiceNumber, false);
      if (data.ok) {
        alert("Success! Invoice Approved.");
        // Update tampilan lokal
        updateLocalStatus(invoiceNumber, 'Approved');
      } else {
        alert("Failed: " + data.error);
      }
    })
    .catch(err => {
      setLoadingBtn(invoiceNumber, false);
      alert("Error: " + err.message);
    });
  }

  // 2. Handle CANCEL (Cuma Update Status)
  function handleAction(invoiceNumber, newStatus) {
    if (!confirm(`Mark this invoice as ${newStatus}?`)) return;

    setLoadingBtn(invoiceNumber, true);

    // Pakai x-www-form-urlencoded untuk action simple
    const formData = new URLSearchParams();
    formData.append('action', 'updateStatus');
    formData.append('invoiceNumber', invoiceNumber);
    formData.append('status', newStatus);

    fetch(API_URL, {
      method: "POST",
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      setLoadingBtn(invoiceNumber, false);
      if (data.ok) {
        updateLocalStatus(invoiceNumber, newStatus);
      } else {
        alert("Failed: " + (data.error || "Unknown error"));
      }
    })
    .catch(err => {
      setLoadingBtn(invoiceNumber, false);
      alert("Error: " + err.message);
    });
  }

  // Helper untuk update UI tanpa reload page
  function updateLocalStatus(id, status) {
    // Update data di array memory
    const inv = allInvoices.find(i => i.invoiceNumber == id);
    if (inv) inv.status = status;
    
    // Render ulang agar pindah tab atau ganti warna badge
    renderInvoices();
  }

  function setLoadingBtn(id, isLoading) {
    const detailDiv = document.getElementById(`details-${id}`);
    const buttons = detailDiv.querySelectorAll('button');
    buttons.forEach(btn => {
      btn.disabled = isLoading;
      if (isLoading && btn.classList.contains('btn-approve')) btn.textContent = "Processing...";
      if (!isLoading && btn.classList.contains('btn-approve')) btn.textContent = "Approve";
    });
  }
</script>

</body>
</html>
