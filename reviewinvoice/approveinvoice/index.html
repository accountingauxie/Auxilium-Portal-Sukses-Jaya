<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Approval System | Auxilium Portal</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #2563eb; 
      --primary-hover: #1d4ed8;
      --bg-body: #f1f5f9; 
      --bg-card: #ffffff;
      --text-main: #0f172a; 
      --text-sub: #64748b;
      --border-color: #e2e8f0;
      
      /* Status Colors */
      --approved-bg: #dcfce7; --approved-text: #166534;
      --pending-bg: #fef9c3; --pending-text: #854d0e;
      --canceled-bg: #fee2e2; --canceled-text: #991b1b;
      --partial-bg: #e0f2fe; --partial-text: #075985;
      --version-bg: #f3e8ff; --version-text: #6b21a8;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); margin: 0; color: var(--text-main); -webkit-font-smoothing: antialiased; }
    
    /* Navbar & Layout (Sama seperti sebelumnya) */
    .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); padding: 0.75rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 2rem; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); }
    .nav-brand { font-weight: 800; font-size: 1.25rem; color: var(--primary); margin-right: auto; display: flex; align-items: center; gap: 10px; }
    .nav-menu { display: flex; gap: 8px; }
    .nav-link { text-decoration: none; color: var(--text-sub); font-weight: 500; font-size: 0.9rem; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.2s; }
    .nav-link:hover { background-color: #eff6ff; color: var(--primary); }
    .nav-link.active { background-color: #eff6ff; color: var(--primary); font-weight: 600; }

    .container { padding: 2rem; max-width: 1200px; margin: 0 auto; }
    h1 { font-weight: 800; color: var(--text-main); margin-bottom: 1.5rem; letter-spacing: -0.5px; }

    /* Controls */
    .controls { display: flex; gap: 12px; margin-bottom: 2rem; flex-wrap: wrap; align-items: center; background: var(--bg-card); padding: 1rem; border-radius: 16px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); border: 1px solid var(--border-color); }
    .filter-btn-group { display: flex; background: #f8fafc; padding: 4px; border-radius: 10px; gap: 4px; border: 1px solid var(--border-color); }
    .filter-btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; background: transparent; color: var(--text-sub); font-weight: 600; font-size: 0.85rem; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .filter-btn:hover { color: var(--text-main); background: rgba(0,0,0,0.05); }
    .filter-btn.active { background-color: var(--bg-card); color: var(--primary); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
    
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; top: 120%; left: 0; background-color: white; min-width: 190px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); border-radius: 12px; z-index: 20; border: 1px solid var(--border-color); overflow: hidden; animation: fadeIn 0.2s ease-out; }
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-item { padding: 10px 16px; text-decoration: none; display: flex; align-items: center; gap: 8px; color: var(--text-main); font-size: 0.85rem; cursor: pointer; transition: 0.1s; }
    .dropdown-item:hover { background-color: #f8fafc; color: var(--primary); }
    .dropdown-item.active-sub { background-color: #eff6ff; color: var(--primary); font-weight: 600; }

    .control-input, .search-bar { padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 10px; outline: none; color: var(--text-main); font-family: inherit; font-size: 0.9rem; transition: 0.2s; background: #fff; }
    .control-input:focus, .search-bar:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
    .search-bar { flex-grow: 1; min-width: 250px; }

    /* Invoice Card */
    .invoice-card { background: var(--bg-card); padding: 1.5rem; margin-bottom: 1rem; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; display: flex; flex-direction: column; }
    .invoice-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); border-color: #cbd5e1; }
    .invoice-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
    .border-pending::before { background-color: #eab308; }
    .border-approved::before { background-color: #22c55e; }
    .border-canceled::before { background-color: #ef4444; }
    .border-partial::before { background-color: #0ea5e9; }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; padding-left: 12px; }
    .card-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
    .card-sub { font-size: 0.85rem; color: var(--text-sub); margin-top: 4px; display: flex; align-items: center; gap: 6px; }
    .status-area { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    
    .badge-pill { padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.3px; display: inline-flex; align-items: center; gap: 5px; text-transform: capitalize; }
    .badge-we { background-color: #FFF3CD; color: #856404; border: 1px solid #ffeeba; }
    .badge-xero { background-color: #E3F2FD; color: #0c5460; border: 1px solid #b8daff; }
    .badge-approved { background-color: var(--approved-bg); color: var(--approved-text); }
    .badge-pending { background-color: var(--pending-bg); color: var(--pending-text); }
    .badge-canceled { background-color: var(--canceled-bg); color: var(--canceled-text); }
    .badge-partial { background-color: var(--partial-bg); color: var(--partial-text); }
    .badge-version { background-color: var(--version-bg); color: var(--version-text); border: 1px solid #ddd6fe; }

    .price-tag { font-size: 1.35rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; padding-left: 12px; margin-top: auto; }
    .btn-details { margin-top: 1.25rem; width: 100%; padding: 12px; background: #f8fafc; color: var(--primary); border: 1px solid transparent; border-radius: 10px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
    .btn-details:hover { background: #eff6ff; border-color: #bfdbfe; }

    /* Modal - Expanded Width for new columns */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.2s; }
    .invoice-paper { background: white; width: 100%; max-width: 1550px; max-height: 90vh; overflow-y: auto; padding: 2.5rem; border-radius: 16px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); animation: slideUp 0.3s ease-out forwards; }
    @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .paper-header { display: flex; justify-content: space-between; margin-bottom: 2rem; border-bottom: 2px solid var(--text-main); padding-bottom: 1rem; }
    .paper-table-container { overflow-x: auto; margin-bottom: 20px; }
    .paper-table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1400px; }
    .paper-table th { background: #f8fafc; color: var(--text-sub); font-size: 0.75rem; text-transform: uppercase; padding: 12px; font-weight: 700; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); vertical-align: middle; position: sticky; top: 0; z-index: 10; }
    .paper-table td { padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-main); font-size: 0.85rem; vertical-align: middle; background: white; }
    
    .invoice-footer { margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--text-main); display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem; flex-wrap: wrap; }
    .total-row { display: flex; justify-content: space-between; width: 100%; padding: 6px 0; font-size: 0.95rem; }
    .grand-total { font-size: 1.25rem; font-weight: 800; color: var(--primary); margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--border-color); }

    /* Action Buttons */
    .btn-action { padding: 12px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; border: none; transition: 0.2s; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .btn-approve { background: var(--primary); color: white; }
    .btn-approve:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-approve:disabled { background: #94a3b8; cursor: not-allowed; }
    .btn-reject { background: #ef4444; color: white; }
    .btn-partial { background: #d97706; color: white; }
    .btn-revert { background: #64748b; color: white; }

    /* Split Button */
    .btn-split { background: #facc15; color: #854d0e; font-size: 0.8rem; padding: 6px 12px; border-radius: 6px; font-weight: 700; border: 1px solid #eab308; cursor: pointer; display: flex; gap: 5px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .btn-split:hover { background: #eab308; }

    /* Delete Button */
    .btn-delete { background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .btn-delete:hover { background: #fecaca; }

    /* Input Fields in Table */
    .tbl-input { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.85rem; outline: none; transition: 0.2s; }
    .tbl-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
    .tbl-input[disabled], .tbl-input[readonly] { background-color: #f1f5f9; color: #94a3b8; border-color: #e2e8f0; cursor: not-allowed; }
    
    /* Sisa Label */
    .sisa-box { background: #fffbeb; border: 1px solid #fcd34d; color: #b45309; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem; display: inline-block; margin-top: 4px; width: 100%; text-align: center; }
    .sisa-ok { background: #f0fdf4; border-color: #86efac; color: #166534; }
    .sisa-err { background: #fef2f2; border-color: #fca5a5; color: #991b1b; }

    /* Parent Row Styling (Yellowish) */
    tr[data-is-parent="true"] td { background-color: #fffef2 !important; }
    
    /* Loading */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(2px); }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-brand"><i class="fa-solid fa-cube"></i> Auxilium Portal</div>
    <div class="nav-menu">
      <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/reviewinvoice/" class="nav-link active">Home Invoice</a>
      <a href="#" class="nav-link">Work Effort</a>
      <a href="#" class="nav-link">Import to Xero</a>
    </div>
  </nav>

  <div class="container">
    <h1>Approval Dashboard</h1>
    <div class="controls">
      <div class="filter-btn-group">
        <button class="filter-btn active" onclick="setFilter('All')" id="btn-All">All</button>
        <button class="filter-btn" onclick="setFilter('Pending')" id="btn-Pending">Pending</button>
        <div class="dropdown">
            <button class="filter-btn" id="btn-Approved">Approved <i class="fa-solid fa-chevron-down" style="font-size: 10px; margin-left: 4px;"></i></button>
            <div class="dropdown-content">
                <a class="dropdown-item" onclick="setApprovedFilter('All')">Show All</a>
                <a class="dropdown-item" onclick="setApprovedFilter('WE')">WE Generated</a>
                <a class="dropdown-item" onclick="setApprovedFilter('Xero')">Xero Imported</a>
            </div>
        </div>
        <button class="filter-btn" onclick="setFilter('Partially Delivered')" id="btn-Partial">Partial</button>
        <button class="filter-btn" onclick="setFilter('Canceled')" id="btn-Canceled">Canceled</button>
      </div>
      <div style="display:flex; gap:8px;">
        <input type="date" id="filterStartDate" class="control-input" onchange="renderInvoices()">
        <input type="date" id="filterEndDate" class="control-input" onchange="renderInvoices()">
      </div>
      <input type="text" id="searchInput" class="search-bar" placeholder="ðŸ” Search..." onkeyup="renderInvoices()">
    </div>
    <div id="invoiceList"></div>
  </div>

  <div id="invoiceModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="invoice-paper" onclick="event.stopPropagation()">
      <div class="paper-header">
        <div>
            <h2 style="margin:0; color:#0f172a;">INVOICE DETAIL</h2>
            <p style="margin:5px 0 0; color:#64748b;">Review & Production Planning</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <select id="invoiceSwitcher" class="control-input" onchange="switchInvoice(this.value)"></select>
          <button style="font-size:1.5rem; border:none; background:none; cursor:pointer;" onclick="document.getElementById('invoiceModal').style.display='none'">&times;</button>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; margin-bottom:30px;">
        <div><label style="font-size:11px; color:#94a3b8; font-weight:700;">CUSTOMER</label><div id="modalCustomer" style="font-weight:600;"></div></div>
        <div><label style="font-size:11px; color:#94a3b8; font-weight:700;">ORDER NO</label><div id="modalInvoiceNum" style="font-weight:600;"></div></div>
        <div><label style="font-size:11px; color:#94a3b8; font-weight:700;">DATE</label><div id="modalDate" style="font-weight:600;"></div></div>
        <div><label style="font-size:11px; color:#94a3b8; font-weight:700;">STATUS</label><div id="modalStatusContainer"></div></div>
      </div>

      <div class="paper-table-container">
        <table class="paper-table">
          <thead id="modalTableHead"></thead>
          <tbody id="modalTableBody"></tbody>
        </table>
      </div>

      <div class="invoice-footer">
        <div id="linkedInfoArea" style="flex-grow:1;"></div>
        <div style="width:300px;">
          <div class="total-row"><span>Subtotal</span><span id="valDPP">0</span></div>
          <div class="total-row"><span>PPN (12%)</span><span id="valPPN">0</span></div>
          <div class="total-row grand-total"><span>GRAND TOTAL</span><span id="valGrand">0</span></div>
        </div>
      </div>

      <div class="modal-actions" id="modalActions" style="margin-top:40px; display:flex; gap:12px; justify-content:flex-end; border-top: 1px solid var(--border-color); padding-top: 20px;"></div>
    </div>
  </div>

  <div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxhOkvFmzaD09cS2bAYNmhesjNr88yJ2QLEGvMLL3OgAv0R4LzCk-4n10b8_S27sq8-VQ/exec"; 

  let allInvoices = [], invoiceMap = {}, currentOpenInvoiceId = null; 
  let currentFilter = 'All', currentApprovedSubFilter = 'All';

  window.onload = fetchInvoices;
  function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
  function formatMoney(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }

  function fetchInvoices() {
    showLoading(true);
    fetch(API_URL + "?action=listInvoices")
      .then(res => res.json())
      .then(res => {
        showLoading(false);
        if (res.ok) {
          allInvoices = res.data.map(i => ({...i, invoiceNumber: String(i.invoiceNumber)}));
          processRelationships();
          renderInvoices();
        } else alert(res.error);
      })
      .catch(e => { showLoading(false); alert("Net Error"); });
  }

  function processRelationships() {
    invoiceMap = {};
    allInvoices.forEach(inv => {
        invoiceMap[inv.invoiceNumber] = inv;
        inv.children = []; inv.isFullyShipped = false;
    });
    allInvoices.forEach(inv => {
        if (inv.invoiceNumber.includes("-P")) {
            const pid = inv.invoiceNumber.split("-P")[0];
            if (invoiceMap[pid]) invoiceMap[pid].children.push(inv);
        }
    });
    // Check Fully Shipped logic if needed...
  }

  function setFilter(s) { currentFilter = s; renderInvoices(); }
  function setApprovedFilter(s) { currentFilter = 'Approved'; currentApprovedSubFilter = s; renderInvoices(); }

  function renderInvoices() {
      // (Kode render list invoice sama seperti sebelumnya, dipersingkat di sini)
      const container = document.getElementById('invoiceList');
      container.innerHTML = '';
      const filtered = allInvoices.filter(inv => {
         // Filter logic standard
         if(currentFilter === 'All') return true;
         return (inv.status || 'Pending') === currentFilter;
      });
      
      filtered.forEach(inv => {
          const card = document.createElement('div');
          card.className = 'invoice-card';
          card.innerHTML = `
            <div class="card-header">
                <div class="card-title">${inv.invoiceNumber}</div>
                <div class="card-sub">${inv.customer}</div>
            </div>
            <div class="price-tag">${formatMoney(inv.grandTotal)}</div>
            <button class="btn-details" onclick="openInvoiceModal('${inv.invoiceNumber}')">Details</button>
          `;
          container.appendChild(card);
      });
  }

  // --- MODAL & TABLE LOGIC (CORE) ---

  function openInvoiceModal(id) {
    currentOpenInvoiceId = id;
    renderModalContent(id);
    const modal = document.getElementById('invoiceModal');
    modal.style.display = 'flex';
    setTimeout(() => { modal.style.opacity = '1'; }, 10);
  }

  function closeModal(e) { if(e.target.id === 'invoiceModal') document.getElementById('invoiceModal').style.display='none'; }

  function renderModalContent(id) {
    const inv = invoiceMap[id];
    if(!inv) return;
    
    document.getElementById('modalCustomer').textContent = inv.customer;
    document.getElementById('modalInvoiceNum').textContent = inv.invoiceNumber;
    document.getElementById('modalDate').textContent = inv.date; // Format date appropriately
    document.getElementById('modalStatusContainer').innerHTML = `<span class="badge-pill badge-pending">${inv.status||'Pending'}</span>`;
    
    document.getElementById('valDPP').textContent = formatMoney(inv.dpp);
    document.getElementById('valPPN').textContent = formatMoney(inv.ppn);
    document.getElementById('valGrand').textContent = formatMoney(inv.grandTotal);

    // RENDER TABLE
    const thead = document.getElementById('modalTableHead');
    const tbody = document.getElementById('modalTableBody');
    tbody.innerHTML = '';

    thead.innerHTML = `
        <tr>
            <th style="width:70px; text-align:center;">Action</th>
            <th style="min-width:200px;">Product Name</th>
            <th style="text-align:center;">Type</th>
            <th style="text-align:right;">Meter</th>
            <th style="text-align:right; width:80px;">Qty</th>
            <th style="text-align:right;">Price</th>
            <th style="text-align:right;">Disc</th>
            <th style="text-align:right;">Total</th>
            
            <th style="width:140px; background:#f0f9ff;">Machine</th>
            <th style="width:120px; background:#f0f9ff;">KPC Number</th>
            <th style="width:100px; background:#f0f9ff;">Prod. Type</th>
            <th style="width:180px; background:#f0f9ff;">WE Number (Result)</th>
        </tr>
    `;

    inv.items.forEach((item, idx) => {
        renderParentRow(tbody, item, idx);
    });

    updateButtonLogic(inv);
  }

  function renderParentRow(tbody, item, idx) {
    const tr = document.createElement('tr');
    tr.setAttribute('data-parent-index', idx);
    tr.setAttribute('data-is-parent', 'true'); // Styling yellow
    
    const rawType = (item.type || "").toString().toUpperCase();
    let isSP = false; 
    let typeBadge = "NP", badgeColor = "#475569";

    // STRICT DETECTION: NP if "NP" or "NON" is in Type
    if (rawType.includes("NP") || rawType.includes("NON")) {
        isSP = false;
    } else if (rawType.includes("SPANDEK") || rawType.includes("SP")) {
        isSP = true; typeBadge = "SP"; badgeColor = "#16a34a";
    }

    const disableAttr = 'disabled style="background-color:#eee;"';
    const splitBtn = isSP ? 
        `<button class="btn-split" onclick="addSplitRow(${idx})"><i class="fa-solid fa-code-branch"></i> Split</button>` : '';

    // Hidden inputs to store original data for calculation
    const hiddenData = `
        <input type="hidden" class="orig-product" value="${item.product}">
        <input type="hidden" class="orig-type" value="${item.type}">
        <input type="hidden" class="orig-meter" value="${item.meter}">
        <input type="hidden" class="orig-qty" value="${item.qty}">
        <input type="hidden" class="orig-price" value="${item.unitPrice}">
        <input type="hidden" class="orig-disc" value="${item.discount}">
        <input type="hidden" class="orig-priceqty" value="${item.priceQty}">
        <input type="hidden" class="orig-total" value="${item.total}">
    `;

    // Untuk baris Parent SP, Qty ditampilkan sebagai "Sisa". 
    // Untuk baris Parent NP, Qty adalah Qty asli.
    const qtyDisplay = isSP ? 
        `<div class="sisa-box" id="sisa_disp_${idx}">Sisa: ${item.qty}</div><input type="hidden" id="sisa_val_${idx}" value="${item.qty}">` : 
        `<input type="text" class="tbl-input text-right" value="${item.qty}" readonly>`;

    tr.innerHTML = `
        <td class="text-center">${splitBtn}</td>
        <td><b>${item.product}</b>${hiddenData}</td>
        <td class="text-center"><span style="background:${badgeColor}; padding:2px 6px; border-radius:4px; color:white; font-size:0.75rem;">${typeBadge}</span></td>
        <td class="text-right">${item.meter||'-'}</td>
        <td class="text-right">${qtyDisplay}</td>
        <td class="text-right">${formatMoney(item.unitPrice)}</td>
        <td class="text-right">${formatMoney(item.discount)}</td>
        <td class="text-right"><b>${formatMoney(item.total)}</b></td>
        
        <td><select class="tbl-input" disabled><option>-- Select --</option></select></td>
        <td><input type="text" class="tbl-input" disabled placeholder="-"></td>
        <td><select class="tbl-input" disabled><option>-- Type --</option></select></td>
        <td><input type="text" class="tbl-input" disabled placeholder="-"></td>
    `;
    tbody.appendChild(tr);

    // Jika NP, kita butuh data ini saat approve, jadi kita beri class khusus
    if (!isSP) tr.classList.add('row-np-data');
    else tr.classList.add('row-sp-parent');
  }

  function addSplitRow(parentIdx) {
    const tbody = document.getElementById('modalTableBody');
    const parentRow = document.querySelector(`tr[data-parent-index="${parentIdx}"]`);
    
    // Ambil data dari parent
    const product = parentRow.querySelector('.orig-product').value;
    const meter = parentRow.querySelector('.orig-meter').value;
    
    // Hitung posisi insert (setelah anak terakhir dari parent ini)
    const existingChildren = document.querySelectorAll(`tr[data-child-of="${parentIdx}"]`);
    let insertAfterNode = existingChildren.length > 0 ? existingChildren[existingChildren.length-1] : parentRow;
    
    const tr = document.createElement('tr');
    tr.setAttribute('data-child-of', parentIdx);
    tr.style.backgroundColor = "#f8fafc"; // Sedikit beda warna

    // Generate unique ID
    const uid = Date.now() + Math.random().toString(16).slice(2);

    tr.innerHTML = `
        <td class="text-center">
            <button class="btn-delete" onclick="removeSplitRow(this, ${parentIdx})"><i class="fa-solid fa-trash"></i></button>
        </td>
        <td style="padding-left:30px; color:#64748b;">
            <i class="fa-solid fa-turn-up" style="transform: rotate(90deg); margin-right:5px;"></i> ${product}
        </td>
        <td class="text-center"><span style="background:#22c55e; padding:2px 6px; border-radius:4px; color:white; font-size:0.7rem;">SPLIT</span></td>
        <td class="text-right">${meter}</td>
        <td>
            <input type="number" class="tbl-input text-right split-qty" value="0" min="1" onchange="updateRemaining(${parentIdx})">
        </td>
        <td colspan="3" class="text-center" style="color:#94a3b8; font-size:0.8rem;"><i>-- Production Detail --</i></td>
        
        <td>
           <select class="tbl-input inp-machine" id="machine_${uid}" onchange="genWE('${uid}', ${parentIdx})">
              <option value="">-- Select --</option>
              <option value="MX PUMA08-NF">MX PUMA08-NF</option>
              <option value="MX PUMA14-NF">MX PUMA14-NF</option>
           </select>
        </td>
        <td>
           <input type="text" class="tbl-input inp-kpc" id="kpc_${uid}" placeholder="Input KPC" oninput="genWE('${uid}', ${parentIdx})">
        </td>
        <td>
           <select class="tbl-input inp-prodtype" id="prod_${uid}" onchange="genWE('${uid}', ${parentIdx})">
              <option value="">-- Type --</option>
              <option value="Custom">Custom</option>
              <option value="Plat">Plat</option>
           </select>
        </td>
        <td>
           <input type="text" class="tbl-input inp-wenum" id="we_${uid}" readonly style="background:#f0f9ff; color:#2563eb; font-weight:600;">
        </td>
    `;
    
    insertAfterNode.insertAdjacentElement('afterend', tr);
  }

  function removeSplitRow(btn, parentIdx) {
      btn.closest('tr').remove();
      updateRemaining(parentIdx);
  }

  function updateRemaining(parentIdx) {
      const parentRow = document.querySelector(`tr[data-parent-index="${parentIdx}"]`);
      const originalQty = parseFloat(parentRow.querySelector('.orig-qty').value) || 0;
      
      const children = document.querySelectorAll(`tr[data-child-of="${parentIdx}"]`);
      let usedQty = 0;
      children.forEach(row => {
          usedQty += parseFloat(row.querySelector('.split-qty').value) || 0;
      });

      const remaining = originalQty - usedQty;
      const sisaDisp = document.getElementById(`sisa_disp_${parentIdx}`);
      const sisaVal = document.getElementById(`sisa_val_${parentIdx}`);
      
      if(sisaDisp) {
        sisaDisp.textContent = `Sisa: ${remaining}`;
        sisaVal.value = remaining;
        
        if(remaining < 0) { sisaDisp.className = "sisa-box sisa-err"; }
        else if(remaining === 0) { sisaDisp.className = "sisa-box sisa-ok"; sisaDisp.textContent = "OK (0)"; }
        else { sisaDisp.className = "sisa-box"; }
      }
  }

  function genWE(uid, parentIdx) {
      const machine = document.getElementById(`machine_${uid}`).value;
      const kpc = document.getElementById(`kpc_${uid}`).value;
      const prod = document.getElementById(`prod_${uid}`).value;
      
      // Ambil No Order dari modal header
      const orderNo = document.getElementById('modalInvoiceNum').textContent;
      
      const res = document.getElementById(`we_${uid}`);
      if(machine && kpc && prod) {
          // Format: MACHINE_KPC_ORDERNO_TYPE
          res.value = `${machine}_${kpc}_${orderNo}_${prod}`;
      } else {
          res.value = "";
      }
  }

  function updateButtonLogic(inv) {
      const actionDiv = document.getElementById('modalActions');
      // Logic sederhana: Approve selalu muncul.
      // Validasi dilakukan saat klik Approve.
      let btns = `
        <button class="btn-action btn-reject" onclick="doAction('Canceled')">Reject</button>
        <button class="btn-action btn-partial">Partially Delivered</button>
        <button class="btn-action btn-approve" onclick="handleApprove()"> <i class="fa-solid fa-check"></i> Approve & Save</button>
      `;
      if(inv.status === 'Approved') btns = "<div>Already Approved</div>";
      actionDiv.innerHTML = btns;
  }

  function handleApprove() {
      // GATHER DATA
      const invNum = document.getElementById('modalInvoiceNum').textContent;
      const cust = document.getElementById('modalCustomer').textContent;
      const date = document.getElementById('modalDate').textContent;
      
      // Kita perlu menyusun ulang item list
      // 1. Ambil semua baris NP (Parent Row yang bukan SP)
      // 2. Ambil semua baris SPLIT (Child Row dari SP)
      
      const finalItems = [];
      const tbody = document.getElementById('modalTableBody');
      
      // Loop Parent Rows
      const parentRows = tbody.querySelectorAll('tr[data-is-parent="true"]');
      
      let errorMsg = "";

      parentRows.forEach(pRow => {
          if (pRow.classList.contains('row-np-data')) {
              // INI NP, ambil data as is
              finalItems.push({
                  product: pRow.querySelector('.orig-product').value,
                  type: pRow.querySelector('.orig-type').value,
                  meter: pRow.querySelector('.orig-meter').value,
                  qty: parseFloat(pRow.querySelector('.orig-qty').value),
                  unitPrice: parseFloat(pRow.querySelector('.orig-price').value),
                  priceQty: parseFloat(pRow.querySelector('.orig-priceqty').value),
                  discount: parseFloat(pRow.querySelector('.orig-disc').value),
                  total: parseFloat(pRow.querySelector('.orig-total').value),
                  // NP fields kosong
                  machine:"", kpc:"", prodType:"", weNumber:""
              });
          } else {
              // INI SP. Jangan ambil parentnya, tapi ambil anak-anaknya.
              const idx = pRow.getAttribute('data-parent-index');
              const children = document.querySelectorAll(`tr[data-child-of="${idx}"]`);
              
              if(children.length === 0) {
                  // Jika SP tapi tidak di split, apakah boleh? 
                  // Sesuai request: "Wajib buat WE". Jadi kita skip parent, 
                  // tapi kalau kosong berarti item ini hilang?
                  // Kita anggap user LUPA split.
                  errorMsg = "Item SP wajib di-split untuk mengisi Data WE!";
              }

              children.forEach(cRow => {
                  const qty = parseFloat(cRow.querySelector('.split-qty').value);
                  if(qty > 0) {
                      finalItems.push({
                          product: pRow.querySelector('.orig-product').value,
                          type: "SP",
                          meter: pRow.querySelector('.orig-meter').value,
                          qty: qty,
                          unitPrice: parseFloat(pRow.querySelector('.orig-price').value),
                          priceQty: parseFloat(pRow.querySelector('.orig-priceqty').value),
                          discount: 0, // Split row biasanya disc 0 atau prorate? Kita 0 kan atau ambil parent? Ambil parent aman.
                          total: qty * parseFloat(pRow.querySelector('.orig-priceqty').value), // Recalc Total
                          
                          machine: cRow.querySelector('.inp-machine').value,
                          kpc: cRow.querySelector('.inp-kpc').value,
                          prodType: cRow.querySelector('.inp-prodtype').value,
                          weNumber: cRow.querySelector('.inp-wenum').value
                      });
                  }
              });
          }
      });

      if(errorMsg) { alert(errorMsg); return; }
      if(finalItems.length === 0) { alert("Tidak ada item valid untuk diapprove."); return; }

      if(!confirm("Approve Invoice & Save Work Effort Data?")) return;
      
      // Construct Payload
      // Ambil grand total asli dr invMap
      const invData = invoiceMap[invNum];
      
      const payload = {
          invoiceNumber: invNum,
          customerName: cust,
          date: invData.date, // Use raw date
          catatan: invData.catatan,
          keySalesOrder: invData.keySalesOrder,
          items: finalItems,
          dpp: invData.dpp,
          ppn: invData.ppn,
          grandTotal: invData.grandTotal
      };

      showLoading(true);
      fetch(API_URL + "?action=approveInvoice", { method: "POST", body: JSON.stringify(payload) })
      .then(r=>r.json()).then(d => {
          showLoading(false);
          if(d.ok) { alert("Success!"); document.getElementById('invoiceModal').style.display='none'; fetchInvoices(); }
          else alert(d.error);
      });
  }

  function doAction(st) { /* ... existing cancel logic ... */ }
</script>
</body>
</html>
