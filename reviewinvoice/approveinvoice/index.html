<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Approval System</title>
  <style>
    /* --- BASE STYLES --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
    h1 { color: #1a1a1a; margin-bottom: 20px; }

    /* --- DASHBOARD CONTROLS --- */
    .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .search-bar { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; outline: none; }
    .filter-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #f0f0f0; color: #555; font-weight: 600; transition: 0.2s; }
    .filter-btn.active, .filter-btn:hover { background-color: #007bff; color: white; }

    /* --- INVOICE LIST CARD --- */
    .invoice-card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; border-left: 5px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .invoice-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-title { font-size: 1.2em; font-weight: 700; color: #2c3e50; }
    .card-sub { font-size: 0.9em; color: #7f8c8d; }
    
    /* Status Colors */
    .border-pending { border-left-color: #ffc107; }
    .border-approved { border-left-color: #28a745; }
    .border-canceled { border-left-color: #dc3545; }
    
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    .bg-pending { background-color: #fff3cd; color: #856404; }
    .bg-approved { background-color: #d4edda; color: #155724; }
    .bg-canceled { background-color: #f8d7da; color: #721c24; }

    .btn-details { margin-top: 15px; width: 100%; padding: 10px; background: #eef2f7; color: #007bff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-details:hover { background: #dbe4ef; }

    /* --- MODAL (INVOICE PAPER VIEW) --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; overflow-y: auto; padding: 20px; box-sizing: border-box; }
    
    .invoice-paper { background: white; width: 100%; max-width: 900px; min-height: 80vh; padding: 40px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }

    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Modal Header & Controls */
    .paper-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
    .company-info h2 { margin: 0; color: #333; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
    .company-info p { margin: 5px 0 0; color: #666; font-size: 14px; }

    .invoice-navigator { display: flex; gap: 10px; align-items: center; }
    .nav-select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; min-width: 150px; cursor: pointer; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .close-btn:hover { color: #dc3545; }

    /* Invoice Meta Data */
    .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .meta-box label { display: block; font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
    .meta-box div { font-size: 16px; font-weight: 600; color: #333; }

    /* Invoice Table */
    .paper-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-top: 2px solid #333; border-bottom: 2px solid #333; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    .paper-table td { padding: 12px 8px; border-bottom: 1px solid #eee; color: #444; vertical-align: middle; }
    .paper-table tr:last-child td { border-bottom: none; }
    
    /* Column Widths */
    .col-desc { width: 35%; }
    .col-type { width: 5%; text-align: center; }
    .col-num { text-align: right; width: 10%; }
    .col-unit { width: 8%; padding-left: 10px; }

    /* Footer Totals */
    .invoice-footer { display: flex; justify-content: flex-end; margin-top: auto; padding-top: 20px; border-top: 2px solid #333; }
    .totals-area { width: 300px; }
    .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
    .total-row.grand { font-size: 18px; font-weight: bold; color: #000; border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; }

    /* Action Buttons in Modal */
    .modal-actions { margin-top: 40px; display: flex; gap: 15px; justify-content: flex-end; }
    .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn-approve { background-color: #007bff; color: white; }
    .btn-approve:hover { background-color: #0056b3; }
    .btn-cancel { background-color: #dc3545; color: white; }
    .btn-cancel:hover { background-color: #a71d2a; }
    .btn-disabled { opacity: 0.6; cursor: not-allowed; }

    /* Loading Spinner */
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <h1>Approval Dashboard</h1>

  <div class="controls">
    <button class="filter-btn active" onclick="setFilter('All')">All</button>
    <button class="filter-btn" onclick="setFilter('Pending')">Pending</button>
    <button class="filter-btn" onclick="setFilter('Approved')">Approved</button>
    <button class="filter-btn" onclick="setFilter('Canceled')">Canceled</button>
    <input type="text" id="searchInput" class="search-bar" placeholder="Search Customer, Invoice..." onkeyup="renderInvoices()">
  </div>

  <div id="invoiceList"></div>

  <div id="invoiceModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="invoice-paper" onclick="event.stopPropagation()">
      
      <div class="paper-header">
        <div class="company-info">
          <h2>INVOICE DETAIL</h2>
          <p>Review & Approval System</p>
        </div>
        <div class="invoice-navigator">
          <select id="invoiceSwitcher" class="nav-select" onchange="switchInvoice(this.value)">
            </select>
          <button class="close-btn" onclick="document.getElementById('invoiceModal').style.display='none'">&times;</button>
        </div>
      </div>

      <div class="invoice-meta">
        <div class="meta-box">
          <label>Customer</label>
          <div id="modalCustomer">Vonny</div>
        </div>
        <div class="meta-box">
          <label>Order Number</label>
          <div id="modalInvoiceNum">INV-001</div>
        </div>
        <div class="meta-box">
          <label>Date</label>
          <div id="modalDate">12/09/2025</div>
        </div>
        <div class="meta-box">
          <label>Status</label>
          <div id="modalStatus" class="status-badge bg-pending">Pending</div>
        </div>
      </div>

      <table class="paper-table">
        <thead>
          <tr>
            <th class="col-desc">Description</th>
            <th class="col-type">Type</th>
            <th class="col-num">Length</th>
            <th class="col-num">Price</th>
            <th class="col-num">Disc</th>
            <th class="col-num">Qty</th>
            <th class="col-unit">Unit</th>
            <th class="col-num">Total</th>
          </tr>
        </thead>
        <tbody id="modalTableBody">
          </tbody>
      </table>

      <div class="invoice-footer">
        <div class="totals-area">
          <div class="total-row">
            <span>Subtotal (DPP)</span>
            <span id="valDPP">Rp 0</span>
          </div>
          <div class="total-row">
            <span>PPN (12%)</span>
            <span id="valPPN">Rp 0</span>
          </div>
          <div class="total-row grand">
            <span>GRAND TOTAL</span>
            <span id="valGrand">Rp 0</span>
          </div>
        </div>
      </div>

      <div class="modal-actions" id="modalActions">
        <button class="btn btn-cancel" onclick="handleActionFromModal('Canceled')">Reject / Cancel</button>
        <button class="btn btn-approve" id="btnApproveModal" onclick="handleApproveFromModal()">Approve Invoice</button>
      </div>

    </div>
  </div>

  <div id="loading" class="loading-overlay">
    <div class="spinner"></div>
  </div>

<script>
  // ================= CONFIGURATION =================
  const API_URL = "https://script.google.com/macros/s/AKfycbyLX3Yr1bu0XBoyVz2VeNANwVpguMoC9zey9GPc4osEACLaRyNdZf6QpSf2wP_DxTOn5A/exec"; 
  // =================================================

  let allInvoices = [];
  let currentFilter = 'All';
  let currentOpenInvoiceId = null; 

  window.onload = fetchInvoices;

  function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
  function formatMoney(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }

  // --- FETCH DATA ---
  function fetchInvoices() {
    showLoading(true);
    fetch(API_URL + "?action=listInvoices")
      .then(res => res.json())
      .then(response => {
        showLoading(false);
        if (response.ok) {
          allInvoices = response.data;
          renderInvoices();
        } else { alert("Error: " + response.error); }
      })
      .catch(err => { showLoading(false); alert("Network Error"); });
  }

  // --- RENDER LIST ---
  function setFilter(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.textContent === status));
    renderInvoices();
  }

  function renderInvoices() {
    const container = document.getElementById('invoiceList');
    container.innerHTML = '';
    const searchVal = document.getElementById('searchInput').value.toLowerCase();

    const filtered = allInvoices.filter(inv => {
      const matchStatus = currentFilter === 'All' || (inv.status || 'Pending') === currentFilter;
      const matchSearch = inv.customer.toLowerCase().includes(searchVal) || inv.invoiceNumber.toString().toLowerCase().includes(searchVal);
      return matchStatus && matchSearch;
    });

    if (filtered.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888;">No data found.</p>'; return; }

    filtered.forEach(inv => {
      const status = inv.status || 'Pending';
      const borderClass = status === 'Approved' ? 'border-approved' : (status === 'Canceled' ? 'border-canceled' : 'border-pending');
      const grandTotal = inv.items.reduce((s, i) => s + (i.total || 0), 0);

      const card = document.createElement('div');
      card.className = `invoice-card ${borderClass}`;
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">${inv.invoiceNumber}</div>
            <div class="card-sub">${inv.customer}</div>
          </div>
          <span class="status-badge ${status === 'Approved' ? 'bg-approved' : (status === 'Canceled' ? 'bg-canceled' : 'bg-pending')}">${status}</span>
        </div>
        <div style="font-size:0.9em; color:#666; margin-bottom:5px;">
          Date: ${inv.date ? new Date(inv.date).toLocaleDateString('id-ID') : '-'}
        </div>
        <div style="font-weight:bold; font-size:1.1em;">
          ${formatMoney(grandTotal)}
        </div>
        <button class="btn-details" onclick="openInvoiceModal('${inv.invoiceNumber}')">Show Details</button>
      `;
      container.appendChild(card);
    });
  }

  // ================= MODAL LOGIC =================

  function openInvoiceModal(invoiceId) {
    currentOpenInvoiceId = invoiceId;
    
    // 1. Populate Dropdown
    const select = document.getElementById('invoiceSwitcher');
    select.innerHTML = '';
    allInvoices.forEach(inv => {
      const option = document.createElement('option');
      option.value = inv.invoiceNumber;
      option.text = `${inv.invoiceNumber} - ${inv.customer}`;
      if (inv.invoiceNumber == invoiceId) option.selected = true;
      select.appendChild(option);
    });

    // 2. Render Isi Modal
    renderModalContent(invoiceId);

    // 3. Tampilkan Modal
    document.getElementById('invoiceModal').style.display = 'flex';
  }

  function switchInvoice(newId) {
    currentOpenInvoiceId = newId;
    renderModalContent(newId);
  }

  function renderModalContent(id) {
    const inv = allInvoices.find(i => i.invoiceNumber == id);
    if (!inv) return;

    // --- 1. HEADER INFO ---
    document.getElementById('modalCustomer').textContent = inv.customer;
    document.getElementById('modalInvoiceNum').textContent = inv.invoiceNumber;

    // Logika Tanggal
    let displayDate = "-";
    if (inv.date) {
      try {
        const d = new Date(inv.date);
        if (!isNaN(d.getTime())) {
          displayDate = d.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } else {
          displayDate = inv.date;
        }
      } catch (e) {
        displayDate = inv.date;
      }
    }
    document.getElementById('modalDate').textContent = displayDate;

    // --- 2. STATUS ---
    const statusEl = document.getElementById('modalStatus');
    statusEl.className = `status-badge ${inv.status === 'Approved' ? 'bg-approved' : (inv.status === 'Canceled' ? 'bg-canceled' : 'bg-pending')}`;
    statusEl.textContent = inv.status || 'Pending';

    // Show/Hide Buttons
    const actionDiv = document.getElementById('modalActions');
    if (inv.status === 'Approved' || inv.status === 'Canceled') {
      actionDiv.style.display = 'none'; 
    } else {
      actionDiv.style.display = 'flex'; 
    }

    // --- 3. TABEL (LOGIKA TYPE REVISI) ---
    const tbody = document.getElementById('modalTableBody');
    tbody.innerHTML = '';
    
    let subTotal = 0;

    inv.items.forEach(item => {
      subTotal += (item.total || 0);
      
      // LOGIKA BARU: Cek "NON" dulu sebelum cek "SPANDEK"
      let typeCode = "-";
      const rawType = item.type ? item.type.toString().toUpperCase() : "";
      
      // 1. Prioritas: Cek "NON" atau "NP"
      if (rawType.includes("NON") || rawType.includes("NP")) {
        typeCode = "NP";
      } 
      // 2. Jika tidak ada "NON", baru cek "SPANDEK" atau "SP"
      else if (rawType.includes("SPANDEK") || rawType.includes("SP")) {
        typeCode = "SP";
      } 
      // 3. Fallback: Cek Nama Produk
      else {
        const prodName = item.product ? item.product.toUpperCase() : "";
        if (prodName.includes("NON SPANDEK") || prodName.includes("ROOF") || prodName.includes("GENTENG")) {
           typeCode = "NP";
        } else if (prodName.includes("SPANDEK") || prodName.includes("PUMA")) {
           typeCode = "SP";
        }
      }

      // Logic Satuan (Unit)
      const unitLabel = item.meter > 0 ? "Lembar" : "Batang";

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.product}</td>
        <td style="text-align:center; font-weight:bold;">${typeCode}</td>
        <td style="text-align:right;">${item.meter > 0 ? item.meter : '-'}</td>
        <td style="text-align:right;">${formatMoney(item.unitPrice)}</td>
        <td style="text-align:right;">${formatMoney(item.discount)}</td>
        <td style="text-align:right;">${item.qty}</td>
        <td>${unitLabel}</td>
        <td style="text-align:right; font-weight:bold;">${formatMoney(item.total)}</td>
      `;
      tbody.appendChild(tr);
    });

    // --- 4. TOTAL ---
    const dpp = subTotal;
    const ppn = subTotal * 0.12; 
    const grandTotal = dpp + ppn;

    document.getElementById('valDPP').textContent = formatMoney(dpp);
    document.getElementById('valPPN').textContent = formatMoney(ppn);
    document.getElementById('valGrand').textContent = formatMoney(grandTotal);
  }

  function closeModal(event) {
    if (event.target.id === 'invoiceModal') {
      document.getElementById('invoiceModal').style.display = 'none';
    }
  }

  // --- APPROVE / CANCEL LOGIC ---

  function handleApproveFromModal() {
    if(!confirm("Approve this invoice?")) return;
    
    const inv = allInvoices.find(i => i.invoiceNumber == currentOpenInvoiceId);
    if (!inv) return;

    setModalLoading(true);

    const payload = {
      invoiceNumber: inv.invoiceNumber,
      customerName: inv.customer,
      date: inv.date,
      items: inv.items
    };

    fetch(API_URL + "?action=approveInvoice", {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      setModalLoading(false);
      if(data.ok) {
        alert("Approved successfully!");
        updateLocalStatus(inv.invoiceNumber, 'Approved');
        renderModalContent(inv.invoiceNumber); 
        renderInvoices(); 
      } else {
        alert("Failed: " + data.error);
      }
    });
  }

  function handleActionFromModal(newStatus) {
    if(!confirm("Are you sure you want to " + newStatus + " this invoice?")) return;
    setModalLoading(true);
    
    const formData = new URLSearchParams();
    formData.append('action', 'updateStatus');
    formData.append('invoiceNumber', currentOpenInvoiceId);
    formData.append('status', newStatus);

    fetch(API_URL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      setModalLoading(false);
      if(data.ok) {
        updateLocalStatus(currentOpenInvoiceId, newStatus);
        renderModalContent(currentOpenInvoiceId);
        renderInvoices();
      } else { alert("Failed"); }
    });
  }

  function setModalLoading(isLoading) {
    const btn = document.getElementById('btnApproveModal');
    if(isLoading) {
      btn.textContent = "Processing...";
      btn.classList.add('btn-disabled');
      btn.disabled = true;
    } else {
      btn.textContent = "Approve Invoice";
      btn.classList.remove('btn-disabled');
      btn.disabled = false;
    }
  }

  function updateLocalStatus(id, status) {
    const inv = allInvoices.find(i => i.invoiceNumber == id);
    if(inv) inv.status = status;
  }

</script>

</body>
</html>
