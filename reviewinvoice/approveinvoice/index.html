Tentu, ini bisa dilakukan. Logikanya adalah:

1.  **Backend (Get):** Script membaca kolom "Key Sales Order" dari Spreadsheet Awal.
2.  **Frontend (Web):** Data Key disimpan di memori browser (variabel `allInvoices`), tapi **tidak ditampilkan** di HTML (tabel/modal).
3.  **Frontend (Send):** Saat tombol Approve diklik, data Key yang tersembunyi tadi ikut dikirim balik ke Backend.
4.  **Backend (Save):** Script menerima data Key dan menuliskannya ke Kolom Q (setelah Catatan) di Spreadsheet Tujuan.

Berikut adalah **Full Source Code** yang sudah direvisi.

-----

### 1\. Backend (`Code.gs`)

**Perubahan:**

  * `getInvoices_`: Menambahkan logika pencarian kolom "Key Sales Order".
  * `saveToDestinationSheets_`: Menambahkan `keySalesOrder` ke dalam array yang ditulis ke Spreadsheet 2 (posisi setelah Catatan).

<!-- end list -->

```javascript
/************************************************************
 * 1. CONFIGURATION
 ************************************************************/
const ORDER_SPREADSHEET = SpreadsheetApp.getActive();
const ORDER_SHEET_NAME  = "OrderResult";  // Sheet sumber

// ID Spreadsheet ke-2 (Tujuan)
const DEST_SPREADSHEET_ID = "1VAzrgusC_jdLAB4IZe3qdaqAGXNIx4lm9GfdANxOx98"; 

const SHEET_APPROVED_NAME = "Sales Order Approved"; 
const SHEET_XERO_NAME     = "Import to Xero";     

/************************************************************
 * 2. HELPER: JSON RESPONSE
 ************************************************************/
function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

/************************************************************
 * 3. WEB APP ENTRY POINTS
 ************************************************************/
function doGet(e) {
  const action = e.parameter.action;

  if (action === "listInvoices") {
    try {
      const data = getInvoices_();
      return jsonResponse({ ok: true, data: data });
    } catch (err) {
      return jsonResponse({ ok: false, error: err.message });
    }
  }
  return HtmlService.createHtmlOutput("Backend System is Running.");
}

function doPost(e) {
  const action = e.parameter.action;

  try {
    if (action === "approveInvoice") {
      const invoiceData = JSON.parse(e.postData.contents);
      // Saat Approve, status Approved, tanpa note cancel
      updateInvoiceStatus_(invoiceData.invoiceNumber, "Approved", ""); 
      saveToDestinationSheets_(invoiceData);
      return jsonResponse({ ok: true, message: "Invoice Approved & Data Exported." });
    }

    if (action === "updateStatus") {
      const note = e.parameter.note || ""; 
      updateInvoiceStatus_(e.parameter.invoiceNumber, e.parameter.status, note);
      return jsonResponse({ ok: true });
    }

    return jsonResponse({ ok: false, error: "Unknown action: " + action });

  } catch (err) {
    return jsonResponse({ ok: false, error: err.message });
  }
}

/************************************************************
 * 4. CORE FUNCTIONS
 ************************************************************/

function getInvoices_() {
  const sh = ORDER_SPREADSHEET.getSheetByName(ORDER_SHEET_NAME);
  if (!sh) throw new Error(`Sheet "${ORDER_SHEET_NAME}" tidak ditemukan.`);
  
  const values = sh.getDataRange().getValues();
  const headers = values[0];

  const findCol = (keywords) => headers.findIndex(h => 
    keywords.some(k => h.toString().toLowerCase() === k.toLowerCase()) || 
    keywords.some(k => h.toString().toLowerCase().includes(k.toLowerCase()))
  );

  const idx = {
    orderNumber: findCol(["Order Number", "Invoice Number", "No Inv"]),
    customer: findCol(["Customer", "Pelanggan"]),
    date: findCol(["Date", "Tanggal", "Tgl"]),
    type: findCol(["Type", "Tipe", "Jenis"]),
    product: findCol(["Product", "Produk", "Description"]),
    meter: findCol(["Meter", "Length", "Panjang"]),
    qty: findCol(["Qty", "Quantity", "Jumlah"]),
    unitPrice: findCol(["Unit Price", "Harga"]),
    discount: findCol(["Discount", "Disc"]),
    total: findCol(["Total", "Amount"]),
    catatan: findCol(["Catatan", "Notes", "Keterangan"]), 
    status: findCol(["Status"]),
    noteCanceled: findCol(["Note - Canceled", "Alasan Cancel"]),
    // [BARU] Ambil Kolom Key Sales Order
    keySales: findCol(["Key Sales Order", "Key Sales", "SO Key", "Key"])
  };

  if (idx.orderNumber === -1) throw new Error("Kolom Order Number tidak ditemukan.");

  const map = {};

  for (let r = 1; r < values.length; r++) {
    const row = values[r];
    const inv = row[idx.orderNumber];
    if (!inv) continue;

    if (!map[inv]) {
      map[inv] = {
        invoiceNumber: inv,
        customer: (idx.customer > -1) ? row[idx.customer] : "No Name",
        date: (idx.date > -1) ? row[idx.date] : null,
        catatan: (idx.catatan > -1) ? row[idx.catatan] : "",
        status: (idx.status > -1) ? row[idx.status] : "",
        noteCanceled: (idx.noteCanceled > -1) ? row[idx.noteCanceled] : "",
        // [BARU] Simpan Key ke object invoice (Hidden dari UI nanti)
        keySalesOrder: (idx.keySales > -1) ? row[idx.keySales] : "", 
        items: []
      };
    }

    const parseNum = (v) => {
       if (typeof v === 'number') return v;
       if (!v) return 0;
       return parseFloat(String(v).replace(/Rp\s?/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
    };

    map[inv].items.push({
      type: (idx.type > -1) ? row[idx.type] : "",
      product: (idx.product > -1) ? row[idx.product] : "",
      meter: (idx.meter > -1) ? row[idx.meter] : 0,
      qty: (idx.qty > -1) ? row[idx.qty] : 0,
      unitPrice: (idx.unitPrice > -1) ? parseNum(row[idx.unitPrice]) : 0,
      discount: (idx.discount > -1) ? parseNum(row[idx.discount]) : 0,
      total: (idx.total > -1) ? parseNum(row[idx.total]) : 0
    });
  }

  return Object.values(map);
}

function updateInvoiceStatus_(invoiceNumber, newStatus, newNote) {
  const sh = ORDER_SPREADSHEET.getSheetByName(ORDER_SHEET_NAME);
  const values = sh.getDataRange().getValues();
  let headers = values[0]; 

  let statusCol = headers.findIndex(h => h.toString().toLowerCase() === "status");
  if (statusCol === -1) {
    statusCol = headers.length;
    sh.getRange(1, statusCol + 1).setValue("Status");
    headers[statusCol] = "Status"; 
  }

  let noteCancelCol = headers.findIndex(h => h.toString().toLowerCase() === "note - canceled");
  if (noteCancelCol === -1) {
    noteCancelCol = headers.length; 
    sh.getRange(1, noteCancelCol + 1).setValue("Note - Canceled");
  }

  const orderCol = headers.findIndex(h => ["order number", "invoice number", "no inv"].some(k => h.toString().toLowerCase().includes(k)));

  for (let r = 1; r < values.length; r++) {
    if (String(values[r][orderCol]).trim() === String(invoiceNumber).trim()) {
      sh.getRange(r + 1, statusCol + 1).setValue(newStatus);
      
      if (newStatus === "Canceled" && newNote) {
         sh.getRange(r + 1, noteCancelCol + 1).setValue(newNote);
      } else if (newStatus === "Pending" || newStatus === "Approved") {
         sh.getRange(r + 1, noteCancelCol + 1).setValue(""); 
      }
    }
  }
}

function saveToDestinationSheets_(data) {
  const ssDest = SpreadsheetApp.openById(DEST_SPREADSHEET_ID);
  
  // --- A. SHEET "Sales Order Approved" ---
  const sheetApproved = ssDest.getSheetByName(SHEET_APPROVED_NAME);
  if (!sheetApproved) throw new Error(`Sheet "${SHEET_APPROVED_NAME}" tidak ditemukan.`);

  let globalDPP = 0;
  data.items.forEach(item => { globalDPP += Number(item.total) || 0; });

  const globalPPN = globalDPP * 0.12;
  const globalGrandTotal = globalDPP + globalPPN;
  const cleanCatatan = data.catatan || ""; 
  const keySO = data.keySalesOrder || ""; // [BARU] Ambil Key dari data yang dikirim frontend

  const approvedRows = [];
  data.items.forEach(item => {
    approvedRows.push([
      new Date(),          // Col A
      data.invoiceNumber,  // Col B
      data.customerName,   // Col C
      data.date,           // Col D
      item.type,           // Col E
      item.product,        // Col F
      item.meter,          // Col G
      item.qty,            // Col H
      item.unitPrice,      // Col I
      item.discount,       // Col J
      item.priceQty || (item.total / item.qty), // Col K
      item.total,          // Col L
      globalDPP,           // Col M
      globalPPN,           // Col N
      globalGrandTotal,    // Col O
      cleanCatatan,        // Col P (Catatan)
      keySO                // Col Q (KEY SALES ORDER) - MASUK SINI
    ]);
  });

  if (approvedRows.length > 0) {
    sheetApproved.getRange(sheetApproved.getLastRow() + 1, 1, approvedRows.length, approvedRows[0].length)
      .setValues(approvedRows);
  }

  // --- B. SHEET "Import to Xero" ---
  const sheetXero = ssDest.getSheetByName(SHEET_XERO_NAME);
  if (sheetXero) { 
    const xeroRows = [];
    data.items.forEach(item => {
      xeroRows.push([
        data.customerName, data.invoiceNumber, data.date, data.date, 
        item.product, item.qty, item.total, "200", "Tax Exclusive"
      ]);
    });
    if (xeroRows.length > 0) {
      sheetXero.getRange(sheetXero.getLastRow() + 1, 1, xeroRows.length, xeroRows[0].length).setValues(xeroRows);
    }
  }
}
```

-----

### 2\. Frontend (`index.html`)

**Perubahan:**

  * Saya tidak menambahkan tampilan visual baru untuk Key.
  * Pada fungsi `handleApproveFromModal`, saya menambahkan `keySalesOrder: inv.keySalesOrder` ke dalam paket data (`payload`) yang dikirim ke backend agar bisa disimpan.

<!-- end list -->

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Approval System</title>
  <style>
    /* --- BASE STYLES --- */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; }
    
    /* --- NAVIGATION BAR --- */
    .navbar { background-color: #fff; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; gap: 20px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .nav-brand { font-weight: bold; font-size: 1.2em; color: #007bff; margin-right: auto; }
    .nav-link { text-decoration: none; color: #555; font-weight: 500; font-size: 14px; padding: 8px 12px; border-radius: 5px; transition: 0.2s; }
    .nav-link:hover { background-color: #f0f0f0; color: #007bff; }
    .nav-link.active { background-color: #eef2f7; color: #007bff; font-weight: bold; }

    /* --- CONTAINER --- */
    .container { padding: 0 20px 20px 20px; max-width: 1200px; margin: 0 auto; }
    h1 { color: #1a1a1a; margin-bottom: 20px; margin-top: 10px; }

    /* --- CONTROLS --- */
    .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); align-items: center; }
    
    .search-bar { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex-grow: 1; outline: none; min-width: 200px; }
    
    .filter-btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background: #f0f0f0; color: #555; font-weight: 600; transition: 0.2s; }
    .filter-btn.active, .filter-btn:hover { background-color: #007bff; color: white; }

    /* DATE & SORT INPUTS */
    .control-input { padding: 9px; border: 1px solid #ddd; border-radius: 6px; outline: none; color: #555; font-family: inherit; }
    .filter-group { display: flex; align-items: center; gap: 5px; }

    /* --- INVOICE LIST CARD --- */
    .invoice-card { background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; border-left: 5px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .invoice-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .card-title { font-size: 1.2em; font-weight: 700; color: #2c3e50; }
    .card-sub { font-size: 0.9em; color: #7f8c8d; }
    
    /* Status Styles */
    .status-wrapper { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
    .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
    
    .cancel-note { font-size: 0.85em; color: #dc3545; margin-top: 5px; display: flex; align-items: center; gap: 5px; background: #fff5f5; padding: 4px 8px; border-radius: 4px; border: 1px solid #f5c6cb; max-width: 250px; }
    
    .border-pending { border-left-color: #ffc107; }
    .border-approved { border-left-color: #28a745; }
    .border-canceled { border-left-color: #dc3545; }
    
    .bg-pending { background-color: #fff3cd; color: #856404; }
    .bg-approved { background-color: #d4edda; color: #155724; }
    .bg-canceled { background-color: #f8d7da; color: #721c24; }

    .btn-details { margin-top: 15px; width: 100%; padding: 10px; background: #eef2f7; color: #007bff; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-details:hover { background: #dbe4ef; }

    /* --- MODAL --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; overflow-y: auto; padding: 20px; box-sizing: border-box; }
    .invoice-paper { background: white; width: 100%; max-width: 900px; min-height: 80vh; padding: 40px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    .paper-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
    .company-info h2 { margin: 0; color: #333; font-size: 24px; text-transform: uppercase; letter-spacing: 1px; }
    .company-info p { margin: 5px 0 0; color: #666; font-size: 14px; }

    .invoice-navigator { display: flex; gap: 10px; align-items: center; }
    .nav-select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; min-width: 150px; cursor: pointer; }
    .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .close-btn:hover { color: #dc3545; }

    .invoice-meta { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .meta-box label { display: block; font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
    .meta-box div { font-size: 16px; font-weight: 600; color: #333; }

    .paper-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 13px; }
    .paper-table th { text-align: left; padding: 12px 8px; border-top: 2px solid #333; border-bottom: 2px solid #333; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
    .paper-table td { padding: 12px 8px; border-bottom: 1px solid #eee; color: #444; vertical-align: middle; }
    
    .col-desc { width: 35%; }
    .col-type { width: 5%; text-align: center; }
    .col-num { text-align: right; width: 10%; }
    .col-unit { width: 8%; padding-left: 10px; }

    .invoice-footer { display: flex; justify-content: flex-end; margin-top: auto; padding-top: 20px; border-top: 2px solid #333; }
    .totals-area { width: 300px; }
    .total-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
    .total-row.grand { font-size: 18px; font-weight: bold; color: #000; border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px; }

    .modal-actions { margin-top: 40px; display: flex; gap: 15px; justify-content: flex-end; }
    .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .btn-approve { background-color: #007bff; color: white; }
    .btn-approve:hover { background-color: #0056b3; }
    .btn-cancel { background-color: #dc3545; color: white; }
    .btn-cancel:hover { background-color: #a71d2a; }
    .btn-disabled { opacity: 0.6; cursor: not-allowed; }

    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-brand">Auxilium Portal</div>
    <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/reviewinvoice/index.html" class="nav-link active">Home Invoice</a>
    <a href="reviewinvoice/wespandek/Index.html" class="nav-link">Work Effort</a>
    <a href="reviewinvoice/importxeroinv" class="nav-link">Import Xero</a>
  </nav>

  <div class="container">
    <h1>Approval Dashboard</h1>
    <div class="controls">
      <button class="filter-btn active" onclick="setFilter('All')">All</button>
      <button class="filter-btn" onclick="setFilter('Pending')">Pending</button>
      <button class="filter-btn" onclick="setFilter('Approved')">Approved</button>
      <button class="filter-btn" onclick="setFilter('Canceled')">Canceled</button>
      
      <div class="filter-group">
        <input type="date" id="filterStartDate" class="control-input" onchange="renderInvoices()" title="Start Date">
        <span style="color:#aaa">-</span>
        <input type="date" id="filterEndDate" class="control-input" onchange="renderInvoices()" title="End Date">
      </div>

      <select id="sortOrder" class="control-input" onchange="renderInvoices()" title="Sort By">
        <option value="desc">Order No (Desc)</option>
        <option value="asc">Order No (Asc)</option>
      </select>

      <input type="text" id="searchInput" class="search-bar" placeholder="Search Customer, Invoice..." onkeyup="renderInvoices()">
    </div>
    <div id="invoiceList"></div>
  </div>

  <div id="invoiceModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="invoice-paper" onclick="event.stopPropagation()">
      <div class="paper-header">
        <div class="company-info"><h2>INVOICE DETAIL</h2><p>Review & Approval System</p></div>
        <div class="invoice-navigator">
          <select id="invoiceSwitcher" class="nav-select" onchange="switchInvoice(this.value)"></select>
          <button class="close-btn" onclick="document.getElementById('invoiceModal').style.display='none'">&times;</button>
        </div>
      </div>

      <div class="invoice-meta">
        <div class="meta-box"><label>Customer</label><div id="modalCustomer"></div></div>
        <div class="meta-box"><label>Order Number</label><div id="modalInvoiceNum"></div></div>
        <div class="meta-box"><label>Date</label><div id="modalDate"></div></div>
        <div class="meta-box"><label>Status</label><div id="modalStatus" class="status-badge"></div></div>
      </div>

      <table class="paper-table">
        <thead>
          <tr>
            <th class="col-desc">Description</th>
            <th class="col-type">Type</th>
            <th class="col-num">Length</th>
            <th class="col-num">Price</th>
            <th class="col-num">Disc</th>
            <th class="col-num">Qty</th>
            <th class="col-unit">Unit</th>
            <th class="col-num">Total</th>
          </tr>
        </thead>
        <tbody id="modalTableBody"></tbody>
      </table>

      <div class="invoice-footer">
        <div class="totals-area">
          <div class="total-row"><span>Subtotal (DPP)</span><span id="valDPP">Rp 0</span></div>
          <div class="total-row"><span>PPN (12%)</span><span id="valPPN">Rp 0</span></div>
          <div class="total-row grand"><span>GRAND TOTAL</span><span id="valGrand">Rp 0</span></div>
        </div>
      </div>

      <div class="modal-actions" id="modalActions">
        </div>

    </div>
  </div>

  <div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<script>
  // ================= CONFIGURATION =================
  // Jangan lupa update URL Web App setelah Deploy New Version
  const API_URL = "https://script.google.com/macros/s/AKfycbzRE0QUtrfOUlWGqtDdJ-FdVM_4VlH113qAJGlG2-qmPOQRJTpaO3rRSR9ZtUHSimpgxA/exec"; 
  // =================================================

  let allInvoices = [];
  let currentFilter = 'All';
  let currentOpenInvoiceId = null; 

  window.onload = fetchInvoices;

  function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }
  function formatMoney(amount) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount); }

  function fetchInvoices() {
    showLoading(true);
    fetch(API_URL + "?action=listInvoices")
      .then(res => res.json())
      .then(response => {
        showLoading(false);
        if (response.ok) {
          allInvoices = response.data;
          renderInvoices();
        } else { alert("Error: " + response.error); }
      })
      .catch(err => { showLoading(false); alert("Network Error"); });
  }

  function setFilter(status) {
    currentFilter = status;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.textContent === status));
    renderInvoices();
  }

  function renderInvoices() {
    const container = document.getElementById('invoiceList');
    container.innerHTML = '';
    
    // Get Filter Values
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    const startDateVal = document.getElementById('filterStartDate').value;
    const endDateVal = document.getElementById('filterEndDate').value;
    const sortVal = document.getElementById('sortOrder').value;

    // 1. FILTERING
    const filtered = allInvoices.filter(inv => {
      // Status & Search Filter
      const matchStatus = currentFilter === 'All' || (inv.status || 'Pending') === currentFilter;
      const matchSearch = inv.customer.toLowerCase().includes(searchVal) || inv.invoiceNumber.toString().toLowerCase().includes(searchVal);
      
      // Date Range Filter
      let matchDate = true;
      if (inv.date) {
        const invDate = new Date(inv.date);
        if (!isNaN(invDate.getTime())) {
          invDate.setHours(0,0,0,0);
          if (startDateVal) {
             const sDate = new Date(startDateVal);
             sDate.setHours(0,0,0,0);
             if (invDate < sDate) matchDate = false;
          }
          if (endDateVal && matchDate) {
             const eDate = new Date(endDateVal);
             eDate.setHours(0,0,0,0);
             if (invDate > eDate) matchDate = false;
          }
        }
      }
      return matchStatus && matchSearch && matchDate;
    });

    // 2. SORTING
    filtered.sort((a, b) => {
        const numA = parseInt(String(a.invoiceNumber).replace(/\D/g, '')) || 0;
        const numB = parseInt(String(b.invoiceNumber).replace(/\D/g, '')) || 0;
        return (sortVal === 'asc') ? (numA - numB) : (numB - numA);
    });

    // 3. RENDERING
    if (filtered.length === 0) { container.innerHTML = '<p style="text-align:center; color:#888;">No data found.</p>'; return; }

    filtered.forEach(inv => {
      const status = inv.status || 'Pending';
      const borderClass = status === 'Approved' ? 'border-approved' : (status === 'Canceled' ? 'border-canceled' : 'border-pending');
      const grandTotal = inv.items.reduce((s, i) => s + (i.total || 0), 0);

      // --- LOGIC NOTE DISPLAY (GUNAKAN NOTE CANCELED) ---
      let noteHtml = '';
      if (status === 'Canceled' && inv.noteCanceled) {
        noteHtml = `<div class="cancel-note">ðŸ’¬ ${inv.noteCanceled}</div>`;
      }

      const card = document.createElement('div');
      card.className = `invoice-card ${borderClass}`;
      card.innerHTML = `
        <div class="card-header">
          <div>
            <div class="card-title">${inv.invoiceNumber}</div>
            <div class="card-sub">${inv.customer}</div>
          </div>
          <div class="status-wrapper">
             <span class="status-badge ${status === 'Approved' ? 'bg-approved' : (status === 'Canceled' ? 'bg-canceled' : 'bg-pending')}">${status}</span>
             ${noteHtml}
          </div>
        </div>
        <div style="font-size:0.9em; color:#666; margin-bottom:5px;">
          Date: ${inv.date ? new Date(inv.date).toLocaleDateString('id-ID') : '-'}
        </div>
        <div style="font-weight:bold; font-size:1.1em;">
          ${formatMoney(grandTotal)}
        </div>
        <button class="btn-details" onclick="openInvoiceModal('${inv.invoiceNumber}')">Show Details</button>
      `;
      container.appendChild(card);
    });
  }

  function openInvoiceModal(invoiceId) {
    currentOpenInvoiceId = invoiceId;
    const select = document.getElementById('invoiceSwitcher');
    select.innerHTML = '';
    allInvoices.forEach(inv => {
      const option = document.createElement('option');
      option.value = inv.invoiceNumber;
      option.text = `${inv.invoiceNumber} - ${inv.customer}`;
      if (inv.invoiceNumber == invoiceId) option.selected = true;
      select.appendChild(option);
    });
    renderModalContent(invoiceId);
    document.getElementById('invoiceModal').style.display = 'flex';
  }

  function switchInvoice(newId) {
    currentOpenInvoiceId = newId;
    renderModalContent(newId);
  }

  function renderModalContent(id) {
    const inv = allInvoices.find(i => i.invoiceNumber == id);
    if (!inv) return;

    document.getElementById('modalCustomer').textContent = inv.customer;
    document.getElementById('modalInvoiceNum').textContent = inv.invoiceNumber;

    let displayDate = "-";
    if (inv.date) {
      try {
        const d = new Date(inv.date);
        if (!isNaN(d.getTime())) {
          displayDate = d.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' });
        } else { displayDate = inv.date; }
      } catch (e) { displayDate = inv.date; }
    }
    document.getElementById('modalDate').textContent = displayDate;

    const statusEl = document.getElementById('modalStatus');
    statusEl.className = `status-badge ${inv.status === 'Approved' ? 'bg-approved' : (inv.status === 'Canceled' ? 'bg-canceled' : 'bg-pending')}`;
    statusEl.textContent = inv.status || 'Pending';

    const actionDiv = document.getElementById('modalActions');
    actionDiv.innerHTML = ''; 
    actionDiv.style.display = 'flex'; 

    if (inv.status === 'Approved') {
       actionDiv.style.display = 'none'; 
    } 
    else if (inv.status === 'Canceled') {
       // REVERT BUTTON
       actionDiv.innerHTML = `
         <div style="color:#dc3545; font-size:0.9em; margin-right:auto; align-self:center;">
            <b>Alasan Cancel:</b> ${inv.noteCanceled || '-'}
         </div>
         <button class="btn" style="background-color:#6c757d; color:white;" onclick="handleActionFromModal('Pending')">
           Revert to Pending
         </button>
       `;
    } 
    else {
       actionDiv.innerHTML = `
         <button class="btn btn-cancel" onclick="handleActionFromModal('Canceled')">Reject / Cancel</button>
         <button class="btn btn-approve" id="btnApproveModal" onclick="handleApproveFromModal()">Approve Invoice</button>
       `;
    }

    const tbody = document.getElementById('modalTableBody');
    tbody.innerHTML = '';
    let subTotal = 0;

    inv.items.forEach(item => {
      subTotal += (item.total || 0);
      let typeCode = "-";
      const rawType = item.type ? item.type.toString().toUpperCase() : "";
      
      if (rawType.includes("NON") || rawType.includes("NP")) {
        typeCode = "NP";
      } else if (rawType.includes("SPANDEK") || rawType.includes("SP")) {
        typeCode = "SP";
      } else {
        const prodName = item.product ? item.product.toUpperCase() : "";
        if (prodName.includes("NON SPANDEK") || prodName.includes("ROOF") || prodName.includes("GENTENG")) {
           typeCode = "NP";
        } else if (prodName.includes("SPANDEK") || prodName.includes("PUMA")) {
           typeCode = "SP";
        }
      }

      const unitLabel = item.meter > 0 ? "Lembar" : "Batang";
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.product}</td>
        <td style="text-align:center; font-weight:bold;">${typeCode}</td>
        <td style="text-align:right;">${item.meter > 0 ? item.meter : '-'}</td>
        <td style="text-align:right;">${formatMoney(item.unitPrice)}</td>
        <td style="text-align:right;">${formatMoney(item.discount)}</td>
        <td style="text-align:right;">${item.qty}</td>
        <td>${unitLabel}</td>
        <td style="text-align:right; font-weight:bold;">${formatMoney(item.total)}</td>
      `;
      tbody.appendChild(tr);
    });

    const dpp = subTotal;
    const ppn = subTotal * 0.12; 
    const grandTotal = dpp + ppn;

    document.getElementById('valDPP').textContent = formatMoney(dpp);
    document.getElementById('valPPN').textContent = formatMoney(ppn);
    document.getElementById('valGrand').textContent = formatMoney(grandTotal);
  }

  function closeModal(event) {
    if (event.target.id === 'invoiceModal') {
      document.getElementById('invoiceModal').style.display = 'none';
    }
  }

  // --- ACTIONS ---

  function handleApproveFromModal() {
    if(!confirm("Approve this invoice?")) return;
    const inv = allInvoices.find(i => i.invoiceNumber == currentOpenInvoiceId);
    if (!inv) return;

    setModalLoading(true);

    const payload = {
      invoiceNumber: inv.invoiceNumber,
      customerName: inv.customer,
      date: inv.date,
      catatan: inv.catatan, 
      keySalesOrder: inv.keySalesOrder, // [NEW] Kirim Key Tersembunyi
      items: inv.items
    };

    fetch(API_URL + "?action=approveInvoice", {
      method: "POST", body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      setModalLoading(false);
      if(data.ok) {
        alert("Approved successfully!");
        updateLocalStatus(inv.invoiceNumber, 'Approved', '');
        renderModalContent(inv.invoiceNumber); 
        renderInvoices(); 
      } else { alert("Failed: " + data.error); }
    });
  }

  function handleActionFromModal(newStatus) {
    let note = "";

    if (newStatus === 'Canceled') {
       note = prompt("Mohon masukkan alasan Reject/Cancel (Wajib):");
       if (note === null) return; 
       if (note.trim() === "") {
          alert("Alasan tidak boleh kosong!");
          return;
       }
    } 
    else if (newStatus === 'Pending') {
       if(!confirm("Revert status kembali ke Pending? (Alasan cancel akan dihapus)")) return;
    }

    setModalLoading(true);
    
    const formData = new URLSearchParams();
    formData.append('action', 'updateStatus');
    formData.append('invoiceNumber', currentOpenInvoiceId);
    formData.append('status', newStatus);
    formData.append('note', note); 

    fetch(API_URL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      setModalLoading(false);
      if(data.ok) {
        updateLocalStatus(currentOpenInvoiceId, newStatus, note);
        renderModalContent(currentOpenInvoiceId);
        renderInvoices();
      } else { alert("Failed"); }
    });
  }

  function setModalLoading(isLoading) {
    const actionDiv = document.getElementById('modalActions');
    const buttons = actionDiv.querySelectorAll('button');
    buttons.forEach(btn => {
      btn.disabled = isLoading;
      if (isLoading) {
        if (!btn.dataset.originalText) { btn.dataset.originalText = btn.innerText; }
        btn.innerText = "Processing...";
        btn.classList.add('btn-disabled');
      } else {
        if (btn.dataset.originalText) { btn.innerText = btn.dataset.originalText; }
        btn.classList.remove('btn-disabled');
      }
    });
  }

  function updateLocalStatus(id, status, note) {
    const inv = allInvoices.find(i => i.invoiceNumber == id);
    if(inv) {
        inv.status = status;
        if (status === 'Canceled') {
            inv.noteCanceled = note;
        } else if (status === 'Pending') {
            inv.noteCanceled = "";
        }
    }
  }
</script>

</body>
</html>
```
