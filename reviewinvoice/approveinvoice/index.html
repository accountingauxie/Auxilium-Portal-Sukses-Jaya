<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Review Invoice - Auxilium Portal</title>

<link rel="stylesheet" href="https://unpkg.com/choices.js/public/assets/styles/choices.min.css">
<script src="https://unpkg.com/choices.js/public/assets/scripts/choices.min.js"></script>

<style>
/* --- VARIABLES --- */
:root {
  --xero-blue: #116999;
  --xero-hover: #f5f9fc;
  --aux-text: #222;
  --border-color: #e0e0e0;
  --bg-color: #f4f5f6;
  
  /* Status Colors */
  --badge-draft-bg: #eee; --badge-draft-text: #555;
  --badge-await-bg: #dcfce7; --badge-await-text: #166534;
  --badge-paid-bg: #dbeafe; --badge-paid-text: #1e40af;
  --badge-cancel-bg: #fee2e2; --badge-cancel-text: #991b1b;
  --badge-approve-bg: #fff4e5; --badge-approve-text: #b75900;
}

* { box-sizing: border-box; }
body { margin: 0; font-family: 'Arial', sans-serif; font-size: 13px; color: var(--aux-text); background: var(--bg-color); }

/* --- NAVBAR --- */
.aux-navbar { background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 9999; }
.aux-logo img { height: 40px; width: auto; display: block; }
.aux-menu { display: flex; gap: 25px; align-items: center; }
.aux-link { text-decoration: none; color: #666; font-weight: 600; font-size: 14px; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; }
.aux-link:hover { color: var(--xero-blue); background-color: #f5f9fc; }
.aux-link.active { color: var(--xero-blue); background-color: #e6f0fa; font-weight: 700; }
.user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid #eee; }
.user-details { display: flex; flex-direction: column; text-align: right; line-height: 1.3; }
.user-name { font-weight: 700; font-size: 13px; color: #333; }
.user-role { font-size: 11px; color: #888; }
.user-avatar { width: 36px; height: 36px; background-color: var(--xero-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }

/* --- PAGE LAYOUT & TABS --- */
.page-wrap { padding: 20px 40px; }

/* Level 1: Category Tabs (General vs Pre-Order) */
.category-tabs { 
    display: flex; gap: 20px; margin-bottom: 0; 
    border-bottom: 1px solid #ccc;
    padding-bottom: 0;
}
.cat-btn { 
    background: none; border: none; padding: 10px 15px; 
    font-size: 16px; font-weight: 600; color: #666; 
    cursor: pointer; border-bottom: 4px solid transparent; 
    transition: 0.2s;
    margin-bottom: -1px; /* Overlap border */
}
.cat-btn:hover { color: var(--xero-blue); }
.cat-btn.active { color: var(--xero-blue); border-bottom-color: var(--xero-blue); }

/* Level 2: Status Tabs (All | Awaiting | etc) */
.status-tabs {
    display: flex; gap: 25px; padding: 15px 0;
    margin-bottom: 10px;
}
.status-link {
    text-decoration: none; color: var(--xero-blue); 
    font-size: 13px; cursor: pointer; position: relative; 
}
.status-link:hover { text-decoration: underline; }
.status-link.active { font-weight: 700; color: #222; text-decoration: none; cursor: default; }

/* Level 3: Search Bar Area */
.search-area {
    background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 3px;
    display: flex; align-items: center; margin-bottom: 20px;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
}
.search-icon { color: #999; font-size: 16px; margin-right: 10px; margin-left: 5px; }
.search-input {
    border: none; width: 100%; font-size: 13px; outline: none; background: transparent;
    color: #333;
}

/* --- TABLE STYLE --- */
.table-card {
    background: #fff; border: 1px solid #ccc; border-radius: 3px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px;
}
table.xero-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
table.xero-table th {
    text-align: left; padding: 10px 15px; border-bottom: 1px solid #ccc; background: #fff;
    font-weight: 600; color: #444; font-size: 13px; white-space: nowrap;
}
table.xero-table td {
    padding: 10px 15px; border-bottom: 1px solid #e0e0e0; color: #222; font-size: 13px; vertical-align: middle;
}
table.xero-table tr:hover { background-color: var(--xero-hover); }
.col-right { text-align: right; }
.col-center { text-align: center; }
.col-view { width: 50px; text-align: center; }

/* Icons & Badges */
.btn-view {
    background: none; border: none; cursor: pointer; color: var(--xero-blue); font-size: 16px;
    display: flex; align-items: center; justify-content: center; width: 100%;
}
.btn-view:hover { color: #0b4d75; transform: scale(1.1); }

.badge { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-block; white-space: nowrap; }
.badge-approve { background: var(--badge-approve-bg); color: var(--badge-approve-text); }
.badge-prod { background: var(--badge-await-bg); color: var(--badge-await-text); }
.badge-done { background: var(--badge-paid-bg); color: var(--badge-paid-text); }
.badge-cancel { background: var(--badge-cancel-bg); color: var(--badge-cancel-text); }

/* --- MODAL DETAIL --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
.modal-box { background: #fff; width: 600px; max-width: 90%; border-radius: 5px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
.modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.modal-title { font-size: 18px; font-weight: 700; color: var(--xero-blue); margin: 0; }
.modal-close { background: none; border: none; font-size: 24px; color: #999; cursor: pointer; }
.modal-body { padding: 30px; }
.detail-row { display: flex; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
.detail-label { color: #666; font-weight: 600; }
.detail-val { font-weight: 700; color: #222; }
.modal-footer { padding: 20px 30px; border-top: 1px solid #eee; background: #f9f9f9; text-align: right; border-radius: 0 0 5px 5px; }

.btn-action { padding: 8px 16px; border-radius: 3px; font-weight: 600; border: none; cursor: pointer; margin-left: 8px; font-size: 13px; }
.btn-approve { background: #166534; color: white; } .btn-approve:hover { background: #14532d; }
.btn-reject { background: #991b1b; color: white; } .btn-reject:hover { background: #7f1d1d; }
.btn-complete { background: var(--xero-blue); color: white; }
.btn-close { background: #ccc; color: #333; }

/* Skeleton & Toast */
@keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
.skeleton-bar { height: 16px; width: 100%; background: #f0f0f0; background-image: linear-gradient(to right, #f0f0f0 0%, #e0e0e0 20%, #f0f0f0 40%, #f0f0f0 100%); background-size: 1000px 100%; animation: shimmer 1.5s infinite linear; border-radius: 3px; display:block; }
.toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: #333; color: white; border-radius: 5px; opacity: 0; transform: translateY(20px); transition: 0.3s; z-index: 100000; }
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>

<body>

<div id="toast" class="toast">Notifikasi</div>

<div class="aux-navbar">
    <div class="aux-logo"><img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo"></div>
    <div class="aux-menu">
        <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/" class="aux-link">Home</a>
        <a href="../inventory/" class="aux-link">Inventory</a>
        <a href="../orderform/" class="aux-link">Order Form</a>
        <a href="../production/" class="aux-link">Production</a>
        <a href="../receiving/" class="aux-link">Receiving</a>
        <a href="../reviewinvoice/" class="aux-link active">Review Invoice</a>
    </div>
    <div class="user-panel">
        <div class="user-details"><span class="user-name">Manager</span><span class="user-role">Approver</span></div>
        <div class="user-avatar">MG</div>
    </div>
</div>

<div class="page-wrap">
    <h2 style="margin-top:0; margin-bottom:15px; color:#222;">Review Invoices</h2>
    
    <div class="category-tabs">
        <button class="cat-btn active" onclick="setCategory('General Order')">General Order</button>
        <button class="cat-btn" onclick="setCategory('Pre-Order')">Pre-Order</button>
    </div>

    <div class="status-tabs">
        <a class="status-link active" onclick="setStatusFilter('All')">All</a>
        <a class="status-link" onclick="setStatusFilter('Awaiting Approval')">Awaiting Approval</a>
        <a class="status-link" onclick="setStatusFilter('Awaiting Production')">Awaiting Production</a>
        <a class="status-link" onclick="setStatusFilter('Completed Order')">Completed</a>
        <a class="status-link" onclick="setStatusFilter('Cancel Order')">Canceled</a>
    </div>

    <div class="search-area">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Enter a contact, amount, or order number" onkeyup="renderTable()">
    </div>

    <div class="table-card">
        <div style="overflow-x: auto;">
            <table class="xero-table">
                <thead>
                    <tr>
                        <th class="col-view">View</th>
                        <th>Order Number</th>
                        <th>Customer</th>
                        <th>Order Date</th>
                        <th>Est. Delivery</th>
                        <th>Jatuh Tempo</th>
                        <th class="col-right">Total Amount</th>
                        <th class="col-center">Status</th>
                    </tr>
                </thead>
                <tbody id="invoiceTableBody">
                    </tbody>
            </table>
        </div>
        <div id="emptyState" style="display:none; text-align:center; padding:50px; color:#888;">
            No orders found matching criteria.
        </div>
    </div>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Order Detail</h3>
            <button class="modal-close" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
            <div class="detail-row">
                <span class="detail-label">Order Number</span>
                <span class="detail-val" id="modalOrderNo">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Customer</span>
                <span class="detail-val" id="modalCustomer">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order Date</span>
                <span class="detail-val" id="modalDate">-</span>
            </div>
             <div class="detail-row">
                <span class="detail-label">Due Date</span>
                <span class="detail-val" id="modalDue">-</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Current Status</span>
                <span class="detail-val" id="modalStatus">-</span>
            </div>
            <div class="detail-row" style="border-bottom:none; margin-top:20px; font-size:16px;">
                <span class="detail-label">Total Amount</span>
                <span class="detail-val" style="color:var(--xero-blue); font-size:20px;" id="modalTotal">Rp 0</span>
            </div>
        </div>
        <div class="modal-footer" id="modalActions">
            </div>
    </div>
</div>

<script>
// =========================================================================
// !!! PASTIKAN URL INI BENAR (Web App URL dari Deploy Apps Script) !!!
// =========================================================================
const baseURL = "https://script.google.com/macros/s/AKfycby-ZuXJyPv-4G9zTPh4r0s2LfdtH39jYkMR18sexKltSikYgWHcwJqGirEzGf_sY3Pg6Q/exec"; 

let allOrders = []; 
let currentCategory = 'General Order';
let currentStatusFilter = 'All';

window.onload = function() { fetchData(); };

async function fetchData() {
    const tbody = document.getElementById('invoiceTableBody');
    // Skeleton Loading
    let skeleton = '';
    for(let i=0; i<6; i++) {
        skeleton += `<tr>
            <td><span class="skeleton-bar" style="width:20px; margin:auto;"></span></td>
            <td><span class="skeleton-bar" style="width:80px;"></span></td>
            <td><span class="skeleton-bar" style="width:150px;"></span></td>
            <td><span class="skeleton-bar" style="width:90px;"></span></td>
            <td><span class="skeleton-bar" style="width:90px;"></span></td>
            <td><span class="skeleton-bar" style="width:90px;"></span></td>
            <td><span class="skeleton-bar" style="width:100px; float:right;"></span></td>
            <td><span class="skeleton-bar" style="width:80px; margin:auto;"></span></td>
        </tr>`;
    }
    tbody.innerHTML = skeleton;
    
    try {
        const res = await fetch(baseURL + "?action=getorders");
        const data = await res.json();
        if(Array.isArray(data)) {
            allOrders = data;
            renderTable();
            showToast("Data synced with Sheet", "success");
        } else { throw new Error("Format Data Invalid"); }
    } catch (e) {
        console.error(e);
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:red;">Failed to load data. Check Apps Script URL.</td></tr>`;
    }
}

function formatMoney(n) { return (Number(n)||0).toLocaleString("id-ID", {style:"currency", currency:"IDR"}); }

function setCategory(cat) {
    currentCategory = cat;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.textContent === cat));
    renderTable();
}

function setStatusFilter(status) {
    currentStatusFilter = status;
    document.querySelectorAll('.status-link').forEach(l => {
        l.classList.toggle('active', l.textContent.trim() === status);
    });
    renderTable();
}

function renderTable() {
    const tbody = document.getElementById('invoiceTableBody');
    const emptyState = document.getElementById('emptyState');
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    
    tbody.innerHTML = '';
    const filtered = allOrders.filter(o => {
        // Filter Category (Case Insensitive Safety)
        if((o.type || "").toLowerCase() !== currentCategory.toLowerCase()) return false;
        
        // Filter Status
        const s = o.status || 'Awaiting Approval';
        if(currentStatusFilter !== 'All' && s !== currentStatusFilter) return false;
        
        // Filter Search
        const term = searchVal;
        if(term && !String(o.id).toLowerCase().includes(term) && !String(o.customer).toLowerCase().includes(term)) return false;
        
        return true;
    });

    if(filtered.length === 0) { emptyState.style.display = 'block'; return; }
    emptyState.style.display = 'none';

    filtered.forEach(o => {
        const tr = document.createElement('tr');
        const status = o.status || 'Awaiting Approval';
        
        let badgeClass = 'badge-approve'; 
        if(status === 'Awaiting Production') badgeClass = 'badge-prod'; 
        else if(status === 'Completed Order') badgeClass = 'badge-done'; 
        else if(status === 'Cancel Order') badgeClass = 'badge-cancel'; 

        // PERBAIKAN: Pastikan ID dikirim sebagai string di onclick
        tr.innerHTML = `
            <td class="col-view">
                <button class="btn-view" onclick="openOrderDetails('${o.id}')" title="View Details">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                </button>
            </td>
            <td><a href="#" onclick="openOrderDetails('${o.id}')" style="color:var(--xero-blue); text-decoration:none; font-weight:600;">${o.id}</a></td>
            <td>${o.customer}</td>
            <td>${o.date}</td>
            <td>${o.dueDate}</td>
            <td>${o.dueDate}</td> 
            <td class="col-right" style="font-weight:600;">${formatMoney(o.total)}</td>
            <td class="col-center"><span class="badge ${badgeClass}">${status}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

// --- PERBAIKAN LOGIC VIEW INVOICE ---
function openOrderDetails(id) {
    // Pakai String() agar perbandingan "25100" (string) dan 25100 (number) tetap cocok
    const order = allOrders.find(x => String(x.id) === String(id));
    
    if(!order) {
        console.error("Order ID not found:", id);
        showToast("Error: Data order tidak ditemukan", "error");
        return;
    }

    document.getElementById('modalTitle').textContent = "Order #" + order.id;
    document.getElementById('modalOrderNo').textContent = order.id;
    document.getElementById('modalCustomer').textContent = order.customer;
    document.getElementById('modalDate').textContent = order.date;
    document.getElementById('modalDue').textContent = order.dueDate;
    document.getElementById('modalStatus').textContent = order.status || "Awaiting Approval";
    document.getElementById('modalTotal').textContent = formatMoney(order.total);

    const footer = document.getElementById('modalActions');
    const status = order.status || 'Awaiting Approval';
    
    // Logic Tombol Approval
    let btns = `<button class="btn-action btn-close" onclick="closeModal()">Close</button>`;
    
    if(status === 'Awaiting Approval') {
        btns = `
            <button class="btn-action btn-close" onclick="closeModal()">Close</button>
            <button class="btn-action btn-reject" onclick="processStatus('${order.id}', 'Cancel Order')">Reject</button>
            <button class="btn-action btn-approve" onclick="processStatus('${order.id}', 'Awaiting Production')">Approve Order</button>
        `;
    } else if (status === 'Awaiting Production') {
        btns = `
            <button class="btn-action btn-close" onclick="closeModal()">Close</button>
            <button class="btn-action btn-reject" onclick="processStatus('${order.id}', 'Cancel Order')">Cancel</button>
            <button class="btn-action btn-complete" onclick="processStatus('${order.id}', 'Completed Order')">Mark as Completed</button>
        `;
    }

    footer.innerHTML = btns;
    document.getElementById('orderModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('orderModal').style.display = 'none';
}

async function processStatus(id, newStatus) {
    if(!confirm("Change status to " + newStatus + "?")) return;
    
    const footer = document.getElementById('modalActions');
    footer.innerHTML = '<span style="color:#666; font-weight:600;">Processing update...</span>';

    try {
        // Gunakan no-cors jika perlu, atau POST biasa
        // Pastikan Apps Script handle doPost dengan benar
        const payload = JSON.stringify({ action: "updatestatus", id: id, status: newStatus });
        
        // Catatan: fetch POST ke Apps Script kadang butuh setup CORS di script side
        // Jika gagal, pastikan script doGet/doPost return ContentService dg JSONP atau JSON correct headers
        const res = await fetch(baseURL, { method: 'POST', body: payload });
        const result = await res.json();

        if(result.result === "success") {
            showToast("Success! Order updated.", "success");
            
            // Update lokal array biar UI langsung berubah
            const idx = allOrders.findIndex(x => String(x.id) === String(id));
            if(idx >= 0) allOrders[idx].status = newStatus;
            
            closeModal();
            renderTable(); // Re-render table agar pindah tab/ubah status badge
        } else {
            alert("Failed to update status on server.");
            closeModal();
        }
    } catch(e) {
        console.error(e);
        // Fallback simulasi jika fetch gagal karena CORS (untuk demo)
        // Hapus blok ini jika sudah live production
        alert("Server response error (CORS/Network). Check Console.");
        closeModal();
    }
}

function showToast(msg, type="info") {
  const t = document.getElementById("toast"); t.textContent = msg;
  t.style.background = type==="success"?"#3fba13":type==="error"?"#d93c3c":"#333";
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2500);
}
</script>

</body>
</html>
