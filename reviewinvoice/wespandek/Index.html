<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WE Generator - Spandek</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; --text: #333; --disabled-bg: #e9ecef; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        
        /* Layout Container */
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; }
        
        /* Card Style */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        h1, h2 { margin-top: 0; color: #2c3e50; }
        .subtitle { color: #7f8c8d; margin-bottom: 20px; }

        /* --- MENU SECTION (STEP 1) --- */
        #menuSection { text-align: center; max-width: 600px; margin: 50px auto; }
        select.big-select { padding: 15px; font-size: 18px; width: 100%; border: 2px solid #ddd; border-radius: 8px; outline: none; margin: 20px 0; }
        select.big-select:focus { border-color: var(--primary); }
        
        .btn-primary { background-color: var(--primary); color: white; padding: 12px 30px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background-color: #0056b3; }

        /* --- WORKSPACE SECTION (STEP 2) --- */
        #workSection { display: none; }
        
        /* Header Grid untuk Tgl & Invoice */
        .meta-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: end; margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        
        .form-group label { display: block; font-size: 0.85em; font-weight: bold; color: #555; margin-bottom: 5px; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .form-control:focus { border-color: var(--primary); outline: none; }
        .form-control[readonly], .form-control:disabled { background-color: var(--disabled-bg); color: #6c757d; cursor: not-allowed; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th { background-color: #2c3e50; color: white; text-align: left; padding: 12px; }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background-color: #f1f1f1; }

        /* Badges for Type */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8em; color: white; }
        .badge-sp { background-color: #28a745; } /* Hijau untuk Spandek */
        .badge-np { background-color: #6c757d; } /* Abu untuk Non-Spandek */

        .we-result { font-family: 'Courier New', monospace; font-weight: bold; color: var(--primary); background: #eef2f7; border: none; }

        .btn-secondary { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        .btn-success { background: #198754; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; float: right; }

        .loading-overlay { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>

<div class="container">

    <div id="menuSection" class="card">
        <h1><i class="fas fa-industry"></i> Spandek Production</h1>
        <p class="subtitle">Select an Order Number to start.</p>
        
        <div id="loadingData" class="loading-overlay">
            <i class="fas fa-spinner fa-spin"></i> Connecting to Server...
        </div>

        <div id="selectorArea" style="display:none;">
            <select id="orderDropdown" class="big-select">
                <option value="">-- Choose Order No --</option>
            </select>
            <button class="btn-primary" onclick="openWorkspace()">
                Process Order <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="workSection">
        <div class="card">
            <div style="margin-bottom: 20px; display:flex; justify-content:space-between;">
                <button class="btn-secondary" onclick="backToMenu()"><i class="fas fa-arrow-left"></i> Back</button>
                <h3 style="margin:0;">Order: <span id="displayOrderNo" style="color:var(--primary)">-</span> | Customer: <span id="displayCustomer">-</span></h3>
            </div>

            <div class="meta-grid">
                <div class="form-group">
                    <label>Tanggal Produksi</label>
                    <input type="date" id="prodDate" class="form-control">
                </div>
                <div class="form-group">
                    <label>Invoice Number (Auto)</label>
                    <input type="text" id="invNumber" class="form-control" readonly style="font-weight:bold; letter-spacing:1px;">
                </div>
                <div style="text-align: right;">
                    <button class="btn-success" onclick="exportData()"><i class="fas fa-save"></i> Save & Export</button>
                </div>
            </div>

            <table id="prodTable">
                <thead>
                    <tr>
                        <th width="20%">Product</th>
                        <th width="5%" class="text-center">Type</th>
                        <th width="7%" class="text-center">Meter</th>
                        <th width="5%" class="text-center">Qty</th>
                        <th width="15%">Machine</th>
                        <th width="12%">KCP Number</th>
                        <th width="12%">Prod. Type</th>
                        <th width="24%">WE Number (Result)</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    let globalData = [];
    let currentOrderNo = "";

    // 1. INIT SAAT LOAD
    window.onload = function() {
        // Ambil Data dari Server (Code.gs)
        google.script.run.withSuccessHandler(onDataLoaded).getOrderData();
        
        // Set Default Date ke Hari Ini
        document.getElementById('prodDate').valueAsDate = new Date();
    };

    function onDataLoaded(data) {
        globalData = data;
        
        // Isi Dropdown
        const dropdown = document.getElementById('orderDropdown');
        const uniqueOrders = [...new Set(data.map(item => item.orderNumber))];
        
        uniqueOrders.forEach(orderNo => {
            let option = document.createElement('option');
            option.value = orderNo;
            let sample = data.find(d => d.orderNumber === orderNo);
            option.text = `${orderNo} - ${sample.customer}`;
            dropdown.appendChild(option);
        });

        document.getElementById('loadingData').style.display = 'none';
        document.getElementById('selectorArea').style.display = 'block';
    }

    // 2. BUKA WORKSPACE
    function openWorkspace() {
        const selectedOrder = document.getElementById('orderDropdown').value;
        if (!selectedOrder) return alert("Pilih Order No dulu!");

        currentOrderNo = selectedOrder;

        // Ambil Invoice Baru dari Server
        google.script.run.withSuccessHandler(function(inv) {
            document.getElementById('invNumber').value = inv;
            // Setelah Invoice ada, baru render tabel supaya rumus WE jalan
            renderTable(selectedOrder);
        }).generateInvoiceNumber();

        document.getElementById('menuSection').style.display = 'none';
        document.getElementById('workSection').style.display = 'block';
    }

    function backToMenu() {
        document.getElementById('workSection').style.display = 'none';
        document.getElementById('menuSection').style.display = 'block';
        document.getElementById('tableBody').innerHTML = "";
    }

    // 3. RENDER TABEL (INTI LOGIKA)
    function renderTable(orderNo) {
        const data = globalData.filter(d => d.orderNumber == orderNo);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        
        // Update Info Header
        document.getElementById('displayOrderNo').innerText = orderNo;
        document.getElementById('displayCustomer').innerText = data[0].customer;

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            
            // Cek Type SP atau NP
            const isSpandek = (row.type === 'SP');
            const disabledAttr = isSpandek ? '' : 'disabled'; // Kalau NP, disabled
            const badgeClass = isSpandek ? 'badge-sp' : 'badge-np';
            
            tr.innerHTML = `
                <td>${row.product}</td>
                <td align="center"><span class="badge ${badgeClass}">${row.type}</span></td>
                <td align="center">${row.meter}</td>
                <td align="center">${row.qty}</td>
                
                <td>
                    <select class="form-control machine-select" id="machine_${index}" onchange="calcWE(${index})" ${disabledAttr}>
                        <option value="">-- Select --</option>
                        <option value="M01">M01 - Puma 8</option>
                        <option value="M02">M02 - Puma 14</option>
                    </select>
                </td>

                <td>
                    <input type="text" class="form-control kcp-input" id="kcp_${index}" placeholder="Input No" oninput="calcWE(${index})" ${disabledAttr}>
                </td>

                <td>
                    <select class="form-control type-select" id="prodType_${index}" onchange="calcWE(${index})" ${disabledAttr}>
                        <option value="">-- Type --</option>
                        <option value="Plat">Plat</option>
                        <option value="Custom">Custom</option>
                    </select>
                </td>

                <td>
                    <input type="text" class="form-control we-result" id="weResult_${index}" readonly value="${isSpandek ? '-' : 'N/A (Non-Spandek)'}">
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 4. GENERATOR RUMUS WE NUMBER
    // Format: Machine_KCP_Order(3digit)_Inv(3digit)_TipeProd
    function calcWE(idx) {
        const machineFull = document.getElementById(`machine_${idx}`).value; // Misal M01
        const kcp = document.getElementById(`kcp_${idx}`).value;
        const prodType = document.getElementById(`prodType_${idx}`).value;
        const invFull = document.getElementById('invNumber').value;

        const output = document.getElementById(`weResult_${idx}`);

        // Jika data belum lengkap, jangan generate
        if (!machineFull || !kcp || !prodType || !invFull) {
            output.value = "-";
            return;
        }

        // Logic String Manipulation
        const machine = machineFull; // Bisa juga ambil substring kalau mau
        const last3Order = currentOrderNo.slice(-3);
        const last3Inv = invFull.slice(-3);
        const typeCode = (prodType === "Plat") ? "PLT" : "CTM";

        // GABUNGKAN
        output.value = `${machine}_${kcp}_${last3Order}_${last3Inv}_${typeCode}`;
    }

    // 5. EXPORT / SAVE
    function exportData() {
        alert("Data siap disimpan/export! Cek WE Number yang sudah tergenerate.");
        // Anda bisa tambahkan fungsi google.script.run.saveData(...) disini
    }

</script>

</body>
</html>
