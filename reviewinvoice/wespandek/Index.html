<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Production Dashboard - Auxilium</title>
<link rel="stylesheet" href="https://unpkg.com/choices.js/public/assets/styles/choices.min.css">
<script src="https://unpkg.com/choices.js/public/assets/scripts/choices.min.js"></script>

<style>
/* --- STYLE SAMA PERSIS (XERO THEME) --- */
:root { --xero-blue: #116999; --xero-hover: #f5f9fc; --aux-text: #222; --border-color: #e0e0e0; --bg-color: #f4f5f6; --badge-prod-bg: #dcfce7; --badge-prod-text: #166534; --btn-complete-bg: #3b82f6; --btn-complete-hover: #2563eb; --btn-reject-bg: #f43f5e; --btn-reject-hover: #e11d48; }
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Arial', sans-serif; font-size: 13px; color: var(--aux-text); background: var(--bg-color); }

.aux-navbar { background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 9999; }
.aux-logo img { height: 40px; width: auto; display: block; }
.aux-menu { display: flex; gap: 25px; align-items: center; }
.aux-link { text-decoration: none; color: #666; font-weight: 600; font-size: 14px; padding: 8px 12px; border-radius: 4px; transition: all 0.2s; }
.aux-link:hover { color: var(--xero-blue); background-color: #f5f9fc; }
.aux-link.active { color: var(--xero-blue); background-color: #e6f0fa; font-weight: 700; }
.user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid #eee; }
.user-details { display: flex; flex-direction: column; text-align: right; line-height: 1.3; }
.user-name { font-weight: 700; font-size: 13px; color: #333; }
.user-role { font-size: 11px; color: #888; }
.user-avatar { width: 36px; height: 36px; background-color: var(--xero-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }

.page-wrap { padding: 20px 40px; }
.category-tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 0; }
.cat-btn { background: none; border: none; padding: 10px 15px; font-size: 16px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 4px solid transparent; transition: 0.2s; margin-bottom: -1px; }
.cat-btn:hover { color: var(--xero-blue); }
.cat-btn.active { color: var(--xero-blue); border-bottom-color: var(--xero-blue); }

.search-area { background: #fff; padding: 10px; border: 1px solid #ccc; border-radius: 3px; display: flex; align-items: center; margin-bottom: 20px; }
.search-icon { color: #999; font-size: 16px; margin-right: 10px; }
.search-input { border: none; width: 100%; font-size: 13px; outline: none; }

.table-card { background: #fff; border: 1px solid #ccc; border-radius: 3px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table.xero-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
table.xero-table th { text-align: left; padding: 12px 15px; border-bottom: 1px solid #ccc; background: #fff; font-weight: 600; color: #444; vertical-align: middle; }
table.xero-table td { padding: 12px 15px; border-bottom: 1px solid #e0e0e0; color: #222; vertical-align: middle; }
table.xero-table tr:hover { background-color: var(--xero-hover); }
.btn-view { background: none; border: none; cursor: pointer; color: var(--xero-blue); font-size: 16px; }
.badge-prod { background: var(--badge-prod-bg); color: var(--badge-prod-text); padding: 4px 10px; border-radius: 12px; font-weight: 700; font-size: 10px; text-transform: uppercase; }

/* MODAL STYLE (WIDE FOR PRODUCTION) */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(2px); }
.modal-box { background: #fff; width: 1200px; max-width: 95%; border-radius: 8px; box-shadow: 0 20px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; max-height: 95vh; }
.modal-header { padding: 15px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
.modal-body { padding: 25px 30px; overflow-y: auto; flex: 1; }
.info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
.info-label { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; }
.info-value { font-size: 14px; font-weight: 600; color: #111; }
.notes-box { grid-column: span 3; background: #f9fafb; padding: 10px; border-radius: 4px; border: 1px dashed #ccc; margin-top: 5px; color: #555; }

.items-table-container { border: 1px solid #e5e7eb; border-radius: 6px; overflow-x: auto; margin-bottom: 20px; }
table.modal-items { width: 100%; border-collapse: collapse; min-width: 1000px; }
table.modal-items th { background: #f9fafb; text-align: left; padding: 12px; font-size: 11px; font-weight: 700; color: #374151; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; }
table.modal-items td { padding: 8px 12px; border-bottom: 1px solid #f3f4f6; }
.t-right { text-align: right; }

/* PRODUCTION SPLIT STYLES */
.split-row { background-color: #f0f9ff; }
.split-container { padding: 5px 0 5px 20px; border-left: 3px solid var(--xero-blue); }
.split-table { width: 100%; font-size: 12px; background: transparent; }
.split-table td { border: none !important; padding: 4px 8px !important; }
.btn-split { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600; margin-top: 5px; }
.input-split { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; }
.kpc-select { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 3px; font-size: 12px; }
.btn-del-split { color: #ef4444; background: none; border: none; cursor: pointer; font-weight: bold; font-size: 14px; }

.modal-footer { padding: 15px 30px; border-top: 1px solid #eee; background: #f9fafb; text-align: right; }
.btn-action { padding: 10px 24px; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; margin-left: 10px; transition: 0.2s; color: white; }
.btn-complete { background-color: var(--btn-complete-bg); } .btn-complete:hover { background-color: var(--btn-complete-hover); }
.btn-reject { background-color: var(--btn-reject-bg); } .btn-reject:hover { background-color: var(--btn-reject-hover); }
.btn-close { background: #fff; color: #333; border: 1px solid #ddd; }

/* Toast & Loading */
@keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
.skeleton-bar { height: 16px; width: 100%; background: #f0f0f0; background-image: linear-gradient(to right, #f0f0f0 0%, #e0e0e0 20%, #f0f0f0 40%, #f0f0f0 100%); background-size: 1000px 100%; animation: shimmer 1.5s infinite linear; border-radius: 3px; display:block; }
.toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: #333; color: white; border-radius: 5px; opacity: 0; transform: translateY(20px); transition: 0.3s; z-index: 100000; }
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>
<body>

<div id="toast" class="toast">Notifikasi</div>

<div class="aux-navbar">
    <div class="aux-logo"><img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo"></div>
    <div class="aux-menu">
        <a href="review_approval.html" class="aux-link">Awaiting Approval</a>
        <a href="#" class="aux-link active">Production</a> </div>
    <div class="user-panel"><div class="user-details"><span class="user-name">Head Prod.</span><span class="user-role">Factory</span></div><div class="user-avatar">HP</div></div>
</div>

<div class="page-wrap">
    <h2 style="color:#222; margin-bottom: 5px;">Production Dashboard</h2>
    <p style="color:#666; margin-bottom: 20px; font-size:12px;">Halaman ini khusus untuk memproses order yang sudah disetujui (Prepare, Produce & Split KPC).</p>
    
    <div class="category-tabs">
        <button class="cat-btn active" onclick="setCategory('General Order')">General Order</button>
        <button class="cat-btn" onclick="setCategory('Pre-Order')">Pre-Order</button>
    </div>

    <div class="search-area">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" class="search-input" placeholder="Search Order # or Customer..." onkeyup="renderTable()">
    </div>

    <div class="table-card">
        <div style="overflow-x: auto;">
            <table class="xero-table">
                <thead><tr><th style="width:50px; text-align:center;">Process</th><th>Order #</th><th>Customer</th><th>Est. Delivery</th><th style="text-align:center;">Status</th></tr></thead>
                <tbody id="invoiceTableBody"></tbody>
            </table>
        </div>
        <div id="emptyState" style="display:none; text-align:center; padding:50px; color:#888;">No production tasks pending.</div>
    </div>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3 class="modal-title" id="modalTitle">Order #</h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div class="info-grid">
                <div class="info-item"><span class="info-label">Customer</span><span class="info-value" id="modalCustomer">-</span></div>
                <div class="info-item"><span class="info-label">Est. Delivery</span><span class="info-value" id="modalDelivery">-</span></div>
                <div class="info-item"><span class="info-label">Due Date</span><span class="info-value" id="modalDue">-</span></div>
                <div class="notes-box" id="modalNotes"><strong>Notes:</strong> <span>-</span></div>
            </div>
            
            <div class="items-table-container">
                <table class="modal-items">
                    <thead><tr><th style="width:40px;">#</th><th>Item to Produce</th><th class="t-right">Meter</th><th class="t-right">Total Qty</th><th style="width:120px; text-align:center;">Action</th></tr></thead>
                    <tbody id="modalItemsBody"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer" id="modalActions">
            <button class="btn-action btn-close" onclick="closeModal()">Close</button>
            <button class="btn-action btn-reject" onclick="processStatus(currentOrderId, 'Cancel Order')">Cancel Order</button>
            <button class="btn-action btn-complete" onclick="processStatus(currentOrderId, 'Completed Order')">Complete Production</button>
        </div>
    </div>
</div>

<script>
const baseURL = "https://script.google.com/macros/s/AKfycbz_u8qdDyzwqsb2B1mnuSWfNtYlVIn0ZDNF2PKuEu4O8AL7G7FV6lzMdX2LO-YVee_A-Q/exec"; 
let allOrders = []; 
let currentCategory = 'General Order';
let currentOrderId = '';

// Mock Data KPC (Bahan Baku)
const kpcData = [
    { id: "KPC-001", name: "COIL AZ 150 G550 - 914MM (3.5T)", stock: 3500 },
    { id: "KPC-002", name: "COIL AZ 100 G550 - 1219MM (4.2T)", stock: 4200 },
    { id: "KPC-003", name: "COIL AZ 70 G550 - 914MM (2.1T)", stock: 2100 }
];

window.onload = function() { fetchData(); };

async function fetchData() {
    const tbody = document.getElementById('invoiceTableBody');
    tbody.innerHTML = '<tr><td colspan="5"><span class="skeleton-bar" style="margin:10px;"></span></td></tr>';
    try {
        const res = await fetch(baseURL + "?action=getorders");
        const data = await res.json();
        allOrders = data.filter(o => o.status === "Awaiting Production"); // FILTER HANYA AWAITING PRODUCTION
        renderTable();
        showToast("Data Refreshed", "success");
    } catch (e) { console.error(e); }
}

function renderTable() {
    const tbody = document.getElementById('invoiceTableBody');
    const searchVal = document.getElementById('searchInput').value.toLowerCase();
    tbody.innerHTML = '';
    const filtered = allOrders.filter(o => {
        if((o.type || "").toLowerCase() !== currentCategory.toLowerCase()) return false;
        if(searchVal && !String(o.id).toLowerCase().includes(searchVal) && !String(o.customer).toLowerCase().includes(searchVal)) return false;
        return true;
    });

    if(filtered.length === 0) { document.getElementById('emptyState').style.display = 'block'; return; }
    document.getElementById('emptyState').style.display = 'none';

    filtered.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="text-align:center;"><button class="btn-view" onclick="openOrderDetails('${o.id}')">‚öôÔ∏è</button></td>
            <td><strong>${o.id}</strong></td>
            <td>${o.customer}</td>
            <td>${o.estDelivery}</td>
            <td style="text-align:center;"><span class="badge badge-prod">IN PRODUCTION</span></td>
        `;
        tbody.appendChild(tr);
    });
}

function openOrderDetails(id) {
    currentOrderId = id;
    const order = allOrders.find(x => String(x.id) === String(id));
    if(!order) return;

    document.getElementById('modalTitle').textContent = "Order #" + order.id;
    document.getElementById('modalCustomer').textContent = order.customer;
    document.getElementById('modalDelivery').textContent = order.estDelivery;
    document.getElementById('modalDue').textContent = order.dueDate;
    document.getElementById('modalNotes').style.display = order.notes ? 'block' : 'none';
    document.querySelector('#modalNotes span').textContent = order.notes;

    const itemsBody = document.getElementById('modalItemsBody');
    itemsBody.innerHTML = '';
    
    // RENDER PRODUCTION ITEMS (WITH SPLIT & CHECKBOX)
    order.items.forEach((item, index) => {
        const tr = document.createElement('tr');
        const isSpandek = (item.type && item.type.toLowerCase().includes('spandek'));
        
        tr.innerHTML = `
            <td style="text-align:center;"><input type="checkbox" class="prod-check" value="${index}"></td>
            <td><span style="font-weight:700; color:#333;">${item.name}</span><br><small style="color:#666;">${item.type}</small></td>
            <td class="t-right">${Number(item.meter) > 0 ? item.meter : '-'}</td>
            <td class="t-right"><strong>${item.qty} ${item.unit}</strong></td>
            <td style="text-align:center;">
                ${isSpandek ? `<button class="btn-split" onclick="addSplitRow(this, '${index}')">+ Split KPC</button>` : '<span style="color:#aaa;">-</span>'}
            </td>
        `;
        itemsBody.appendChild(tr);
    });

    document.getElementById('orderModal').style.display = 'flex';
}

function addSplitRow(btn, itemIndex) {
    const mainRow = btn.closest('tr');
    const splitRow = document.createElement('tr');
    splitRow.className = 'split-row';
    let kpcOptions = `<option value="">-- Pilih Coil KPC --</option>`;
    kpcData.forEach(k => { kpcOptions += `<option value="${k.id}">${k.name}</option>`; });

    splitRow.innerHTML = `
        <td></td>
        <td colspan="4">
            <div class="split-container">
                <table class="split-table">
                    <tr>
                        <td style="width:40%;"><select class="kpc-select">${kpcOptions}</select></td>
                        <td style="width:20%;"><input type="number" class="input-split" placeholder="Qty Produce"></td>
                        <td style="width:20%;"><input type="text" class="input-split" placeholder="Notes/Potongan"></td>
                        <td style="width:10%;"><button class="btn-del-split" onclick="this.closest('tr').closest('tr.split-row').remove()">√ó</button></td>
                    </tr>
                </table>
            </div>
        </td>
    `;
    mainRow.parentNode.insertBefore(splitRow, mainRow.nextSibling);
}

function closeModal() { document.getElementById('orderModal').style.display = 'none'; }
function setCategory(cat) { currentCategory = cat; document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.textContent === cat)); renderTable(); }
function showToast(msg, type) { const t = document.getElementById("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2500); }

async function processStatus(id, newStatus) {
    if(newStatus === 'Completed Order') {
        const checks = document.querySelectorAll('.prod-check:checked');
        if(checks.length === 0 && !confirm("No items checked. Complete anyway?")) return;
    }
    if(!confirm("Process order to " + newStatus + "?")) return;
    
    document.querySelector('#modalActions .btn-complete').innerText = 'Processing...';
    try {
        await fetch(baseURL, { method: 'POST', body: JSON.stringify({ action: "updatestatus", id: id, status: newStatus }) });
        showToast("Success", "success");
        closeModal(); fetchData(); 
    } catch(e) { alert("Error"); closeModal(); }
}
</script>
</body>
</html>
