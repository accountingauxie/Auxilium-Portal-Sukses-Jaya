<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel – AUXILIUM Portal</title>

  <style>
    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background: #f5f6fa;
    }

    .header {
      background: white;
      padding: 18px 32px;
      font-size: 22px;
      font-weight: 700;
      border-bottom: 1px solid #e5e5e5;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: white;
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 18px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #efefef;
      font-size: 14px;
    }

    th {
      background: #fafafa;
      font-weight: 600;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 600;
    }

    .approved { background: #d1fae5; color: #065f46; }
    .pending { background: #fde68a; color: #92400e; }
    .admin { background: #dbeafe; color: #1e40af; }

    .btn {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      border: none;
    }

    .btn-approve { background: #22c55e; color: white; }
    .btn-pending { background: #fca5a5; color: #7f1d1d; }
    .btn-on { background: #22c55e; color: white; }
    .btn-off { background: #e5e7eb; color: #374151; }
  </style>
</head>

<body>

  <div class="header">Admin Panel – AUXILIUM Portal</div>

  <div class="container">
    <h2>Daftar User</h2>

    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>Status</th>
          <th>Role</th>
          <th>Receiving PO</th>
          <th>Finished Goods</th>
          <th>Order Form</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="user-list"></tbody>
    </table>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwN0utWHD8LSdGPkVx5bzgxkkZ3fup7W7i0a58G1bW6c3b2YlSAWCQFw2H3Sc9nhRKErA/exec";

/* CEK ADMIN LOGIN */
const current = JSON.parse(localStorage.getItem("uxilium_current_user") || "null");

if (!current || current.role !== "admin") {
  alert("Hanya admin yang boleh mengakses halaman ini.");
  window.location.href = "login.html";
}

/* AMBIL LIST USER */
async function fetchUsers() {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "getUsers" })
  });

  const data = await res.json();
  if (!data.ok) return [];
  return data.users;
}

/* UPDATE STATUS */
async function updateStatus(email, status) {
  await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "updateStatus", email, status })
  });
  renderUsers();
}

/* UPDATE ACCESS RIGHTS */
async function updateAccess(email, type, value) {
  const payload = {
    action: "updateAccess",
    email
  };

  if (type === "receiving") payload.receiving = value;
  if (type === "finished_goods") payload.finished_goods = value;
  if (type === "order_form") payload.order_form = value;

  await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  renderUsers();
}

/* RENDER TABLE */
async function renderUsers() {
  const users = await fetchUsers();
  const body = document.getElementById("user-list");
  body.innerHTML = "";

  users.forEach(user => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${user.email}</td>
      <td><span class="badge ${user.status === "Approved" ? "approved" : "pending"}">${user.status}</span></td>
      <td><span class="badge ${user.role === "admin" ? "admin" : ""}">${user.role}</span></td>
      <td></td><td></td><td></td>
      <td></td>
    `;

    const cells = tr.querySelectorAll("td");

    addToggle(cells[3], user, "receiving", "Receiving");
    addToggle(cells[4], user, "finished_goods", "FG");
    addToggle(cells[5], user, "order_form", "Order");

    if (user.role !== "admin") {
      const btn = document.createElement("button");
      if (user.status === "Approved") {
        btn.className = "btn btn-pending";
        btn.textContent = "Set Pending";
        btn.onclick = () => updateStatus(user.email, "Pending");
      } else {
        btn.className = "btn btn-approve";
        btn.textContent = "Approve";
        btn.onclick = () => updateStatus(user.email, "Approved");
      }
      cells[6].appendChild(btn);
    } else {
      cells[6].textContent = "—";
    }

    body.appendChild(tr);
  });
}

/* BUILDER UNTUK TOGGLE AKSES */
function addToggle(cell, user, key, label) {
  const isOn =
    (key === "receiving" && user.receiving === "On") ||
    (key === "finished_goods" && user.finished_goods === "On") ||
    (key === "order_form" && user.order_form === "On");

  const btn = document.createElement("button");
  btn.className = "btn " + (isOn ? "btn-on" : "btn-off");
  btn.textContent = (isOn ? "On " : "Off ") + label;

  btn.onclick = () => updateAccess(user.email, key, !isOn);

  cell.appendChild(btn);
}

renderUsers();
</script>

</body>
</html>
