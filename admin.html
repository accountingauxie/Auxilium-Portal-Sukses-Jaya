<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzJsRqURzkVhMUVK7Z7QblgR23fc4gL6S38bY_ym6KVjXbmBxtcBdMC9V9lxCrTbjCnNg/exec";

// Cek apakah admin login
const current = JSON.parse(localStorage.getItem("uxilium_current_user") || "null");
if (!current) {
  alert("Silakan login terlebih dahulu.");
  window.location.href = "login.html";
} else {
  const role = (current.role || "").toLowerCase();
  if (role !== "owner" && role !== "admin") {
    alert("Hanya admin yang boleh mengakses halaman ini.");
    window.location.href = "login.html";
  }
}

function logout() {
  localStorage.removeItem("uxilium_current_user");
  window.location.href = "login.html";
}

// Ambil daftar user
async function loadUsers() {
  try {
    const res = await fetch(API_URL + "?action=getusers");
    const data = await res.json();
    if (!data.success) {
      alert(data.message || "Gagal mengambil data user.");
      return;
    }
    renderUsers(data.users);
  } catch (err) {
    console.error(err);
    alert("Kesalahan koneksi server.");
  }
}

// Render user list
function renderUsers(users) {
  const list = document.getElementById("user-list");
  list.innerHTML = "";

  users.forEach(u => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${u.email}</td>
      <td><span class="badge ${u.status === "Approved" ? "approved" : "pending"}">${u.status}</span></td>
      <td><span class="badge ${u.role === "Owner" || u.role === "Admin" ? "admin" : ""}">${u.role}</span></td>
      <td></td><td></td><td></td><td></td>
    `;

    const cells = tr.querySelectorAll("td");

    function addBtn(key, label, cell, active) {
      const btn = document.createElement("button");
      btn.className = "btn " + (active ? "btn-on" : "btn-off");
      btn.textContent = (active ? "On " : "Off ") + label;
      btn.onclick = () => toggleAccess(u.row, key);
      cell.appendChild(btn);
    }

    addBtn("receiving",       "Receiving", cells[3], u.access.receiving);
    addBtn("finished_goods",  "FG",        cells[4], u.access.finished_goods);
    addBtn("order_form",      "Order",     cells[5], u.access.order_form);

    // Approval button
    if (u.role === "Owner") {
      cells[6].textContent = "â€”";
    } else {
      const approved = u.status === "Approved";
      const b = document.createElement("button");

      b.className = "btn " + (approved ? "btn-pending" : "btn-approve");
      b.textContent = approved ? "Set Pending" : "Approve";
      b.onclick = () => updateApprove(u.row, !approved);

      cells[6].appendChild(b);
    }

    list.appendChild(tr);
  });
}

// Toggle akses modul user
async function toggleAccess(row, key) {
  try {
    const res = await fetch(API_URL + "?action=toggleaccess", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ row, key })
    });
    const data = await res.json();
    if (!data.success) return alert("Gagal update akses.");
    loadUsers();
  } catch (err) {
    console.error(err);
    alert("Kesalahan server.");
  }
}

// Approve / Pending user
async function updateApprove(row, approved) {
  try {
    const res = await fetch(API_URL + "?action=updateapprove", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ row, approved })
    });

    const data = await res.json();
    if (!data.success) return alert("Gagal update status.");
    loadUsers();
  } catch (err) {
    console.error(err);
    alert("Kesalahan server.");
  }
}

loadUsers();
</script>
