<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BackOrder Production - Auxilium</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- SYSTEM STYLES (MATCHING GENERAL ORDER) --- */
:root { --primary: #7e22ce; --bg: #f4f7f6; --text: #333; --red: #b91c1c; --green: #047857; --orange: #b75900; }
* { box-sizing: border-box; }
body { margin: 0; font-family: "Arial", sans-serif; font-size: 13px; background: var(--bg); color: var(--text); }
.aux-navbar { background: #fff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
.aux-menu { display: flex; gap: 10px; height: 100%; align-items: center; }
.aux-link { text-decoration: none; color: #666; font-weight: 600; padding: 8px 14px; border-radius: 6px; }
.aux-link.active { color: var(--primary); background: #f3e8ff; } 

.page-wrap { padding: 30px 40px; max-width: 98%; margin: 0 auto; }
.category-tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
.cat-btn { background: none; border: none; padding: 10px 20px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
.cat-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table.xero-table { width: 100%; border-collapse: collapse; }
table.xero-table th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; color: #555; font-size: 12px; font-weight: bold; text-transform: uppercase; }
table.xero-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }

.order-link { color: var(--primary); font-weight: bold; text-decoration: none; cursor: pointer; }
.badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; }
.badge-awaiting { background: #fff7e6; color: var(--orange); border: 1px solid #ffe8cc; }
.badge-process { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
.badge-completed { background: #ecfdf5; color: var(--green); border: 1px solid #a7f3d0; }
.badge-delivery { background: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
.badge-cancel { background: #fef2f2; color: var(--red); border: 1px solid #fecaca; }

/* MODAL STYLES */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 10000; padding-top: 50px; overflow-y: auto; }
.modal-box { background: #fff; width: 1350px; max-width: 98%; height: auto; max-height: 90vh; display: flex; flex-direction: column; border-radius: 8px; margin-bottom: 50px; }
.modal-header, .modal-footer { padding: 20px 30px; background: #fff; border-bottom: 1px solid #eee; }
.modal-footer { background: #f9fafb; text-align: right; border-top: 1px solid #eee; }
.modal-body { flex: 1; overflow-y: auto; padding: 20px; }

/* FORM ELEMENTS */
.prod-input, .prod-select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
.split-row { background-color: #fffde7; }
.disabled-row { background-color: #f9fafb; color: #9ca3af; pointer-events: none; }
.disabled-row input, .disabled-row select { background: #e5e7eb; border-color: #d1d5db; pointer-events: none; }
.disabled-row .btn-split { display: inline-block; pointer-events: auto; opacity: 1; }
.non-spandek-input { background-color: #f3f4f6 !important; border-color: #e5e7eb !important; color: #9ca3af !important; pointer-events: none; }

/* BUTTONS */
.btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; color: white; display: inline-flex; align-items: center; gap: 5px; }
.btn-sm { padding: 4px 8px; font-size: 11px; }
.btn-process { background: var(--primary); }
.btn-complete { background: var(--green); }
.btn-deliver { background: #4f46e5; }
.btn-print { background: #0891b2; }
.btn-cancel { background: var(--red); }
.btn-secondary { background: #fff; border: 1px solid #ccc; color: #333; }
.btn-split { background: #d8b4fe; color: #6b21a8; }
.btn-remove { background: #fee2e2; color: #991b1b; }
.check-production { width: 18px; height: 18px; cursor: pointer; accent-color: var(--green); }

/* KHUSUS BACKORDER */
.stock-warning { color: var(--red); font-weight: bold; }
.stock-ok { color: var(--green); font-weight: bold; }
.insufficient-row { background-color: #fff1f2 !important; }
.date-input-group { background: #f0fdf4; padding: 15px; border: 1px solid #bbf7d0; border-radius: 6px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
.date-input-group label { font-weight: bold; color: #166534; }

/* PDF STYLES */
#pdf-hidden-container { position: absolute; left: -9999px; top: 0; }
#pdfContent { background: #fff; width: 100%; padding: 0; font-family: "Arial", sans-serif; color: #000; }
.pdf-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
.pdf-title { font-size: 24px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-top: 5px; color:#000; }
.company-details { text-align: right; font-size: 9px; color: #333; line-height: 1.4; }
.company-name { font-weight: 700; font-size: 11px; color: #F59E0B; text-transform: uppercase; margin-bottom: 2px; }
.pdf-info { display: flex; justify-content: space-between; margin-bottom: 15px; }
.bill-to { width: 60%; }
.pdf-bill-label { font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; color:#000; }
.pdf-cust-name { font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; color:#000; }
.pdf-cust-addr { font-size: 9px; line-height: 1.5; color: #444; }
.meta-data { width: 35%; }
.pdf-meta-row { display: flex; justify-content: space-between; font-size: 9px; margin-bottom: 4px; width: 100%; }
.pdf-meta-key { font-weight: 700; color:#000; }
table.pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
table.pdf-table th { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 6px 4px; color: #000; border-top: 1px solid #000; border-bottom: 1px solid #000; letter-spacing: 0.5px; }
table.pdf-table td { padding: 6px 4px; font-size: 10px; vertical-align: top; }
.pdf-signature-wrapper { margin-top: 25px; display: flex; justify-content: space-between; page-break-inside: avoid; padding-bottom: 10px; }
.sig-box { text-align: center; flex: 1; }
.sig-title { font-size: 10px; font-weight: 700; color: #000; margin-bottom: 45px; }
.sig-name { font-size: 10px; font-weight: 700; color: #000; border-top: 1px solid #333; display: inline-block; padding-top: 4px; min-width: 120px; }
.t-left { text-align: left; } .t-center { text-align: center; } .t-right { text-align: right; }
</style>
</head>
<body>

<div class="aux-navbar">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" style="height:40px;">
    </div>
    <nav class="aux-menu">
        <div class="nav-item"><a href="#" class="aux-link active">BackOrder Production</a></div>
    </nav>
</div>

<div class="page-wrap">
    <h2>Daftar BackOrder</h2>
    <div class="category-tabs">
        <button class="cat-btn active" id="tab-awaiting" onclick="switchTab('Awaiting')">Awaiting</button>
        <button class="cat-btn" id="tab-process" onclick="switchTab('In Process')">In Process</button>
        <button class="cat-btn" id="tab-completed" onclick="switchTab('Completed')">Completed</button>
        <button class="cat-btn" id="tab-delivery" onclick="switchTab('Delivered')">Delivery</button>
        <button class="cat-btn" id="tab-cancel" onclick="switchTab('Cancel')">Cancelled</button>
    </div>
    <div class="table-card">
        <table class="xero-table">
            <thead>
                <tr>
                    <th>BO ID #</th><th>Type</th><th>Customer</th><th>Order Date</th><th>Est. Delivery</th><th>Status</th><th>Items</th>
                </tr>
            </thead>
            <tbody id="dashboardBody">
                <tr><td colspan="7" style="text-align:center; padding:30px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>BackOrder: <span id="modalOrderNo" style="color:#7e22ce;"></span></h3>
            <button onclick="closeModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            
            <div id="deliveryDateSection" class="date-input-group" style="display:none;">
                <label><i class="fas fa-calendar-alt"></i> Set Tanggal Pengiriman Baru:</label>
                <input type="date" id="newDeliveryDate" class="prod-input" style="width: 200px; border-color: #bbf7d0;">
                <span style="font-size:11px; color:#666;">(Wajib diisi sebelum Process)</span>
            </div>

            <div id="modalAlert" class="alert" style="background:#e0f2fe; color:#0c4a6e; padding:10px; border-radius:6px; margin-bottom:15px; font-size:12px;"></div>
            
            <table class="xero-table">
                <thead><tr id="tableHeaderRow"></tr></thead>
                <tbody id="setupBody"></tbody>
            </table>
            
            <div id="validationMsg" style="color:red; font-weight:bold; margin-top:10px; display:none; background:#fee2e2; padding:10px; border-radius:4px;"></div>
            
            <div id="stockValidationMsg" style="color:var(--red); font-weight:bold; margin-top:5px; display:none;">
                <i class="fas fa-exclamation-triangle"></i> Stok tidak mencukupi. Process disabled.
            </div>
        </div>
        <div class="modal-footer">
            <div id="footerLeft" style="float:left;"></div>
            <div id="footerRight" style="display:flex; gap:10px; justify-content:flex-end;"></div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-box" style="width: 400px; margin-top: 150px;">
        <div class="modal-header" style="justify-content: center; border-bottom: none;">
            <h4 style="margin:0;">Konfirmasi</h4>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p id="confirmMessage" style="font-size:16px;">Apakah anda yakin?</p>
        </div>
        <div class="modal-footer" style="justify-content: center;">
            <button class="btn btn-secondary" onclick="closeConfirm(false)">Tidak</button>
            <button class="btn btn-process" id="confirmYesBtn">Ya, Lanjutkan</button>
        </div>
    </div>
</div>

<div id="pdf-hidden-container">
    <div id="pdfContent">
        <div class="pdf-header">
            <div class="pdf-title" id="pdfTitle">SURAT</div>
            <div class="company-details">
                <div class="company-name">CV. SUKSES JAYA MAKMUR LESTARI</div>
                <div>JL. D.I Panjaitan, RT/RW. 008/003<br>Kel. Wundudopi, Kec. Baruga, Kendari<br>Sulawesi Tenggara | Telp. 0822 4708 4908</div>
            </div>
        </div>
        <div class="pdf-info">
            <div class="bill-to">
                <div class="pdf-bill-label">KEPADA YTH.</div>
                <div class="pdf-cust-name" id="pdfCustName">CUSTOMER NAME</div>
                <div class="pdf-cust-addr"><span id="pdfRegion">-</span></div>
            </div>
            <div class="meta-data">
                <div class="pdf-meta-row"><span class="pdf-meta-key">No Order</span><span id="pdfOrderNo">-</span></div>
                <div class="pdf-meta-row"><span class="pdf-meta-key">Tanggal</span><span id="pdfDate">-</span></div>
                <div class="pdf-meta-row"><span class="pdf-meta-key">Tipe Order</span><span id="pdfType">-</span></div>
            </div>
        </div>
        
        <table class="pdf-table">
            <thead>
                <tr>
                    <th class="t-center" style="width:5%;">NO</th>
                    <th class="t-left" style="width:40%;">NAMA BARANG</th>
                    <th class="t-center" style="width:10%;">METER</th>
                    <th class="t-center" style="width:10%;">QTY</th>
                    <th class="t-left" style="width:20%;" id="pdfHeadDetail">KETERANGAN</th>
                    <th class="t-left" style="width:15%;" id="pdfHeadWE">WE CODE</th>
                </tr>
            </thead>
            <tbody id="pdfItemsBody"></tbody>
        </table>
        
        <div id="pdfSignatureRow" class="pdf-signature-wrapper"></div>
    </div>
</div>

<script>
// --- URL API APPSCRIPT (Update dengan URL Deployment terbaru) ---
const API_URL = "https://script.google.com/macros/s/AKfycbzChnwQd89aWf7fgIATTU9TztXANtNjUnuhVXUML3vzZZuwHpDSujOCI7Bv9YybxfSd4g/exec";
const ORDER_CATEGORY = 'backorder'; 

let currentOrders = {}; 
let masterStock = {}; // Data Stock
let activeOrderId = null;
let currentTab = 'Awaiting';
const TYPE_CODES = { 'Custom': 'CS', 'Plat': 'PL' };

// --- HELPERS ---
function closeModal() { document.getElementById('setupModal').style.display = 'none'; }
function fmtDate(val) {
    if (!val) return "-";
    const d = new Date(val);
    return isNaN(d.getTime()) ? val : d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

// --- MODAL KONFIRMASI ---
let confirmCallback = null;
function showConfirm(message, callback) {
    document.getElementById('confirmMessage').innerText = message;
    confirmCallback = callback;
    document.getElementById('confirmModal').style.display = 'flex';
}
function closeConfirm(isConfirmed) {
    document.getElementById('confirmModal').style.display = 'none';
    if (isConfirmed && confirmCallback) confirmCallback();
    confirmCallback = null;
}
document.getElementById('confirmYesBtn').onclick = () => closeConfirm(true);

// --- INIT ---
window.onload = async () => {
    await fetchStockData();
    switchTab('Awaiting');
};

async function fetchStockData() {
    try {
        const response = await fetch(`${API_URL}?action=getBackOrderStock`);
        masterStock = await response.json();
    } catch(e) { console.error("Stock Error:", e); }
}

function switchTab(tabName) {
    currentTab = tabName;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    
    let btnId = 'tab-awaiting';
    if(tabName === 'In Process') btnId = 'tab-process';
    if(tabName === 'Completed') btnId = 'tab-completed';
    if(tabName === 'Delivered') btnId = 'tab-delivery';
    if(tabName === 'Cancel') btnId = 'tab-cancel';
    
    const btn = document.getElementById(btnId);
    if (btn) btn.classList.add('active');
    loadOrders(tabName);
}

async function loadOrders(status) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px;">Loading...</td></tr>';
    try {
        const response = await fetch(`${API_URL}?action=getProductionOrders&status=${encodeURIComponent(status)}&category=${ORDER_CATEGORY}`);
        const data = await response.json();
        renderDashboard(data, status);
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">Failed to fetch. ${err}</td></tr>`;
    }
}

function renderDashboard(data, status) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '';
    if (!data || Object.keys(data).length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#999;">No BackOrders found in ${status}</td></tr>`;
        return;
    }
    currentOrders = data; 
    Object.keys(data).forEach(key => {
        const o = data[key];
        let badgeClass = 'badge-awaiting';
        if (o.status === 'In Process') badgeClass = 'badge-process';
        if (o.status === 'Completed Production') badgeClass = 'badge-completed';
        if (o.status === 'Delivered') badgeClass = 'badge-delivery';
        if (o.status === 'Cancel Production') badgeClass = 'badge-cancel';

        const tr = document.createElement('tr');
        tr.className = 'data-row';
        tr.innerHTML = `
            <td><a class="order-link" onclick="openSetup('${o.orderNo}')">${o.orderNo}</a></td>
            <td>${o.type}</td>
            <td>${o.customer}</td>
            <td>${fmtDate(o.date)}</td>
            <td>${fmtDate(o.delivery)}</td>
            <td><span class="badge ${badgeClass}">${o.status}</span></td>
            <td>${o.items.length} Items</td>
        `;
        tbody.appendChild(tr);
    });
}

// --- SETUP MODAL LOGIC ---
function openSetup(orderId) {
    activeOrderId = orderId;
    const order = currentOrders[orderId];
    document.getElementById('modalOrderNo').innerText = orderId;
    
    // UI Reset
    const deliverySection = document.getElementById('deliveryDateSection');
    const dateInput = document.getElementById('newDeliveryDate');
    const stockMsg = document.getElementById('stockValidationMsg');
    stockMsg.style.display = 'none';

    // Header Generator
    const headerRow = document.getElementById('tableHeaderRow');
    let headers = `<th style="width:20%">Item</th>`;
    
    if (currentTab === 'Awaiting') {
        // Kolom khusus Awaiting
        headers += `<th style="width:5%; text-align:center;">Meter</th>
                    <th style="width:5%; text-align:center;">Qty</th>
                    <th style="width:10%; text-align:center;">Total Req</th>
                    <th style="width:10%; text-align:center;">Stock</th>
                    <th style="width:8%; text-align:center;">Status</th>`;
        deliverySection.style.display = 'flex'; 
        dateInput.value = ""; 
    } else {
        headers += `<th style="width:5%; text-align:center;">M</th><th style="width:5%; text-align:center;">Qty</th>`;
        deliverySection.style.display = 'none';
    }

    headers += `<th style="width:12%">Mesin</th><th style="width:14%">KPC</th><th style="width:8%">Type</th><th style="width:14%">WE Code</th><th style="width:5%; text-align:center;">Act</th>`;
    if (currentTab === 'In Process') headers += `<th style="width:5%; text-align:center;">Selesai?</th>`;
    headerRow.innerHTML = headers;

    const alertBox = document.getElementById('modalAlert');
    alertBox.style.display = 'block';
    
    // Alert Logic
    let isOverallStockInsufficient = false;

    if (currentTab === 'Awaiting') {
         alertBox.innerHTML = '<strong>Awaiting:</strong> Gunakan tombol <strong>(+)</strong> untuk Split Qty/Mesin. Pastikan Stock Cukup.';
    } else if (currentTab === 'In Process') {
        alertBox.innerHTML = '<strong>Produksi:</strong> Centang barang yang selesai. Klik Update untuk simpan progres.';
    } else {
        alertBox.style.display = 'none';
    }

    const tbody = document.getElementById('setupBody');
    tbody.innerHTML = '';

    order.items.forEach((item, idx) => {
        const isSpandek = (item.type && item.type.toLowerCase().includes('spandek') && !item.type.toLowerCase().includes('non'));
        const tr = document.createElement('tr');
        tr.className = 'main-row';
        tr.dataset.id = idx; 
        tr.dataset.type = isSpandek ? 'spandek' : 'non-spandek';
        tr.dataset.original = item.fullRowData; 
        
        let nameHtml = `<strong>${item.item}</strong><br><small style="color:#888;">${item.type}</small>`;
        let isEditable = (currentTab === 'Awaiting' || currentTab === 'In Process');
        let spandekClass = isSpandek ? 'prod-input' : 'prod-input non-spandek-input';
        let readonlyAttr = isSpandek && isEditable ? '' : 'disabled';
        
        let middleCols = '';
        
        // --- LOGIKA COMPARISON STOCK ---
        if (currentTab === 'Awaiting') {
            const reqQty = parseFloat(item.qty);
            const meterPerPcs = parseFloat(item.meter) || 0;
            const availStock = masterStock[item.item] || 0; 
            
            // Hitung Total Requirement
            let totalReq = reqQty;
            let unitLabel = "Pcs";
            if (isSpandek && meterPerPcs > 0) {
                totalReq = reqQty * meterPerPcs;
                unitLabel = "M'";
            }

            const isEnough = availStock >= totalReq;
            
            if (!isEnough) {
                isOverallStockInsufficient = true;
                tr.classList.add('insufficient-row');
            }

            const statusIcon = isEnough ? 
                `<span class="stock-ok"><i class="fas fa-check"></i> OK</span>` : 
                `<span class="stock-warning"><i class="fas fa-times"></i> Kurang</span>`;
            
            middleCols = `
                <td style="text-align:center;">${meterPerPcs > 0 ? meterPerPcs : '-'}</td>
                <td style="text-align:center;">
                    <span class="target-qty badge" style="background:#e0f2fe; color:#0369a1; font-size:12px;">${reqQty}</span>
                    <input type="hidden" class="qty-input" value="${reqQty}">
                </td>
                <td style="text-align:center; font-weight:bold; color:#555;">${totalReq.toFixed(2)} ${unitLabel}</td>
                <td style="text-align:center; font-weight:bold;">${availStock.toFixed(2)}</td>
                <td style="text-align:center;">${statusIcon}</td>
            `;
        } else {
            middleCols = `
                <td style="text-align:center;"><span class="meter-val">${item.meter}</span></td>
                <td style="text-align:center;">
                    <input type="number" class="${spandekClass} qty-input" value="${item.qty}" min="1" ${readonlyAttr} onchange="validateQty(${idx})">
                    <span class="target-qty" style="display:none;">${item.qty}</span>
                </td>
            `;
        }
        
        let valMesin = item.machine || "";
        let valKPC = item.kpc || "";
        let valType = "Custom"; 
        if(item.we && item.we.includes('_PL_')) valType = "Plat";

        let showSplit = isEditable;

        let inputs = `
            ${middleCols}
            <td>
                <select class="${spandekClass} machine-select" ${readonlyAttr} onchange="generateWE(this)">
                    <option value="">-</option>
                    <option value="PM08" ${valMesin==='PM08'?'selected':''}>PM08</option>
                    <option value="PM14" ${valMesin==='PM14'?'selected':''}>PM14</option>
                </select>
            </td>
            <td>
                <select class="${spandekClass} kpc-select" ${readonlyAttr} onchange="generateWE(this)">
                    <option value="">-</option>
                    <option value="KPC-001" ${valKPC==='KPC-001'?'selected':''}>KPC-001</option>
                    <option value="KPC-002" ${valKPC==='KPC-002'?'selected':''}>KPC-002</option>
                </select>
            </td>
            <td>
                <select class="${spandekClass} type-select" ${readonlyAttr} onchange="generateWE(this)">
                    <option value="Custom" ${valType==='Custom'?'selected':''}>Custom</option>
                    <option value="Plat" ${valType==='Plat'?'selected':''}>Plat</option>
                </select>
            </td>
            <td><input type="text" class="${spandekClass} we-code" readonly value="${item.we||''}"></td>
            <td style="text-align:center;">
                ${showSplit ? `<button class="btn-sm btn-split" onclick="splitRow(this, ${idx})"><i class="fas fa-plus"></i></button>` : '-'}
            </td>
        `;

        if (currentTab === 'In Process') {
            let checked = item.isFinished ? 'checked' : '';
            inputs += `<td style="text-align:center;"><input type="checkbox" class="check-production" ${checked} onchange="checkAllDone()"></td>`;
        }

        tr.innerHTML = `<td>${nameHtml}</td>${inputs}`;
        tbody.appendChild(tr);
    });

    renderFooterButtons(isOverallStockInsufficient);
    if(isOverallStockInsufficient && currentTab === 'Awaiting') {
        stockMsg.style.display = 'block';
    }

    document.getElementById('validationMsg').style.display = 'none';
    document.getElementById('setupModal').style.display = 'flex';
    if(currentTab === 'In Process') checkAllDone();
}

function renderFooterButtons(isStockProblem) {
    const footerLeft = document.getElementById('footerLeft');
    const footerRight = document.getElementById('footerRight');
    footerLeft.innerHTML = ''; footerRight.innerHTML = '';
    const btnClose = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
    
    if (currentTab === 'Awaiting') {
        let processDisabled = isStockProblem ? 'disabled style="background:#ccc; cursor:not-allowed;"' : '';
        let processTitle = isStockProblem ? 'Stock Kurang' : 'Process';
        
        footerRight.innerHTML = `${btnClose} 
            <button class="btn btn-cancel" onclick="triggerAction('cancel')">Cancel Order</button>
            <button class="btn btn-process" onclick="triggerAction('process')" ${processDisabled}>${processTitle}</button>`;
            
    } else if (currentTab === 'In Process') {
        footerLeft.innerHTML = `<button class="btn btn-print" onclick="generatePDF('SPK')"><i class="fas fa-print"></i> Print SPK</button>`;
        footerRight.innerHTML = `${btnClose} <button class="btn btn-cancel" onclick="triggerAction('cancel')">Cancel</button><button class="btn btn-process" onclick="triggerAction('update')">Update</button><button class="btn btn-complete" id="btnComplete" onclick="triggerAction('complete')" disabled>Selesai Produksi</button>`;
    } else if (currentTab === 'Completed') {
        footerRight.innerHTML = `${btnClose} <button class="btn btn-deliver" onclick="triggerAction('deliver')">Delivery (Kirim)</button>`;
    } else if (currentTab === 'Delivered') {
        footerLeft.innerHTML = `<button class="btn btn-print" onclick="generatePDF('SJ')"><i class="fas fa-print"></i> Print Surat Jalan</button>`;
        footerRight.innerHTML = btnClose;
    } else {
        footerRight.innerHTML = btnClose;
    }
}

function checkAllDone() {
    const checkboxes = document.querySelectorAll('#setupBody tr:not(.disabled-row) .check-production');
    let allChecked = true;
    if (checkboxes.length === 0) allChecked = false;
    checkboxes.forEach(cb => { if (!cb.checked) allChecked = false; });
    const btn = document.getElementById('btnComplete');
    if(btn) btn.disabled = !allChecked;
}

// --- LOGIKA SPLIT (DIPERBAIKI) ---
function splitRow(btn, groupId) {
    const originalRow = btn.closest('tr');
    
    // 1. Disable Row Asli (Parent)
    if (!originalRow.classList.contains('disabled-row')) {
        originalRow.classList.add('disabled-row');
        originalRow.querySelector('.qty-input').value = 0; 
        originalRow.querySelectorAll('input, select').forEach(el => el.disabled = true);
        const cb = originalRow.querySelector('.check-production');
        if(cb) cb.disabled = true; 
    }

    // 2. Clone Row
    const newRow = originalRow.cloneNode(true);
    newRow.classList.remove('main-row', 'disabled-row', 'insufficient-row'); 
    newRow.classList.add('split-row');
    
    // 3. FIX: Pastikan Kolom Qty menjadi INPUT TEXT, bukan Badge/Hidden
    const qtyCell = newRow.cells[1]; // Kolom index 1 adalah Qty
    qtyCell.innerHTML = ''; // Hapus isi lama (Badge + Hidden Input)
    
    const newInput = document.createElement('input');
    newInput.type = 'number';
    newInput.className = 'prod-input qty-input';
    newInput.style.width = '100%';
    newInput.style.textAlign = 'center';
    newInput.value = ''; // Biarkan kosong agar user isi
    newInput.placeholder = 'Qty';
    newInput.onchange = function() { validateQty(groupId); };
    qtyCell.appendChild(newInput);
    
    // 4. Bersihkan kolom Info Stock/Total di row split
    if (currentTab === 'Awaiting') {
        newRow.cells[2].innerText = "-"; // Total
        newRow.cells[3].innerText = "-"; // Stock
        newRow.cells[4].innerHTML = "";  // Status
    }

    // 5. Reset Dropdown
    newRow.querySelectorAll('select').forEach(s => { s.value = ""; s.disabled = false; s.onchange = function(){ generateWE(this); } });
    newRow.querySelector('.we-code').value = "";
    
    // 6. Tombol Hapus Split
    const btnContainer = newRow.querySelector('.btn-split').parentElement;
    btnContainer.innerHTML = `<button class="btn-sm btn-remove" onclick="removeSplit(this, ${groupId})"><i class="fas fa-trash"></i></button>`;
    
    // 7. Insert Row
    const tbody = originalRow.parentNode;
    const groupRows = tbody.querySelectorAll(`tr[data-id="${groupId}"]`);
    groupRows[groupRows.length-1].after(newRow);
    
    // 8. Focus ke Input baru
    newInput.focus();
}

function removeSplit(btn, groupId) {
    const row = btn.closest('tr');
    const tbody = row.parentNode;
    row.remove();
    
    // Cek sisa split
    const remainingSplits = tbody.querySelectorAll(`.split-row[data-id="${groupId}"]`);
    if(remainingSplits.length === 0) {
        // Aktifkan kembali Main Row
        const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
        main.classList.remove('disabled-row');
        
        // Reset Value Main Row
        let target = 0;
        const targetBadge = main.querySelector('.target-qty');
        if(targetBadge) target = parseInt(targetBadge.innerText);
        
        main.querySelector('.qty-input').value = target;
        main.querySelectorAll('select, input').forEach(el => el.disabled = false);
        const cb = main.querySelector('.check-production');
        if(cb) cb.disabled = false;
    }
    validateQty(groupId);
}

function generateWE(el) {
    const row = el.closest('tr');
    const mach = row.querySelector('.machine-select').value;
    const kpc = row.querySelector('.kpc-select').value;
    const type = TYPE_CODES[row.querySelector('.type-select').value] || 'XX';
    let shortInv = activeOrderId ? String(activeOrderId) : "";
    if (shortInv.length > 5) shortInv = shortInv.slice(-5);
    if(mach && kpc) row.querySelector('.we-code').value = `${mach}_${kpc}_${type}_${shortInv}`;
}

function validateQty(groupId) {
    const tbody = document.getElementById('setupBody');
    const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
    const target = parseInt(main.querySelector('.target-qty').innerText);

    let current = 0;
    // Hitung semua Qty (Split rows + Main Row jika aktif)
    tbody.querySelectorAll(`tr[data-id="${groupId}"]`).forEach(r => {
        const inp = r.querySelector('.qty-input');
        if(inp && !r.classList.contains('disabled-row')) {
            current += parseInt(inp.value || 0);
        }
    });
    
    const msg = document.getElementById('validationMsg');
    const isErr = current !== target;
    
    tbody.querySelectorAll(`tr[data-id="${groupId}"] .qty-input`).forEach(el => el.style.borderColor = isErr ? 'red' : '#ccc');
    
    if(isErr) { 
        msg.style.display = 'block'; 
        msg.innerHTML = `<i class="fas fa-times-circle"></i> Error: Total Qty Split (${current}) tidak sama dengan Order Asli (${target})`; 
    } else { 
        msg.style.display = 'none'; 
    }
    return !isErr;
}

function triggerAction(actionType) {
    let msg = "";
    let func = null;
    
    if (actionType === 'process') {
        const dateInput = document.getElementById('newDeliveryDate');
        
        if(document.getElementById('validationMsg').style.display === 'block') {
            alert("Jumlah Qty Split tidak sesuai dengan Qty Asli!");
            return;
        }

        if (!dateInput.value) {
            alert("Harap isi Tanggal Pengiriman Baru!");
            dateInput.focus();
            return;
        }
        
        if(document.querySelector('.insufficient-row')) {
            alert("Tidak bisa proses: Ada item dengan stock kurang!");
            return;
        }

        msg = "Stock Cukup & Qty Sesuai. Lanjutkan Proses?"; 
        func = () => submitProduction('new'); 
    }
    else if (actionType === 'update') { msg = "Simpan perubahan?"; func = () => submitProduction('update'); }
    else if (actionType === 'complete') { msg = "Barang fisik sudah selesai?"; func = () => completeOrder(activeOrderId); }
    else if (actionType === 'deliver') { msg = "Kirim barang sekarang?"; func = () => deliverOrder(activeOrderId); }
    else if (actionType === 'cancel') { msg = "Yakin batalkan BackOrder?"; func = () => cancelOrder(activeOrderId); }
    
    if (msg && func) showConfirm(msg, func);
}

async function submitProduction(mode) {
    const rows = document.querySelectorAll('#setupBody tr:not(.disabled-row)');
    let data = [], valid = true;
    const newDateVal = document.getElementById('newDeliveryDate').value;

    rows.forEach(r => {
        const type = r.dataset.type;
        const q = r.querySelector('.qty-input')?.value;
        if (!q || parseInt(q) === 0) return;

        let item = { originalData: r.dataset.original, qty: q, isSplit: r.classList.contains('split-row') };
        if(currentTab === 'In Process') item.isFinished = r.querySelector('.check-production')?.checked || false;
        
        if(currentTab !== 'Awaiting' && type === 'spandek') {
            const m = r.querySelector('.machine-select').value;
            const k = r.querySelector('.kpc-select').value;
            const w = r.querySelector('.we-code').value;
            if(!m || !k) { r.style.backgroundColor = '#fee2e2'; valid = false; }
            else { item.machine = m; item.kpc = k; item.we = w; }
        }
        data.push(item);
    });
    
    if(!valid && currentTab !== 'Awaiting') return alert("Lengkapi Data Mesin/KPC!");
    
    await sendAPI(mode === 'new' ? 'submitProduction' : 'updateProductionData', { 
        orderId: activeOrderId, 
        data: data, 
        category: ORDER_CATEGORY,
        deliveryDate: newDateVal 
    });
}

async function completeOrder(id) { await sendAPI('completeOrder', { orderId: id }); }
async function deliverOrder(id) { await sendAPI('deliverOrder', { orderId: id }); }
async function cancelOrder(id) { await sendAPI('cancelOrder', { orderId: id }); }

async function sendAPI(action, payload) {
    payload.category = ORDER_CATEGORY;
    try {
        payload.action = action;
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        const json = await res.json();
        if(json.result === 'error') throw json.message;
        alert("Sukses!"); closeModal(); loadOrders(currentTab);
    } catch(e) { alert("Error: " + e); }
}

function generatePDF(type) {
    const o = currentOrders[activeOrderId];
    document.getElementById('pdfOrderNo').innerText = activeOrderId;
    document.getElementById('pdfCustName').innerText = o.customer;
    document.getElementById('pdfDate').innerText = fmtDate(new Date()); 
    document.getElementById('pdfTitle').innerText = (type === 'SPK') ? "SPK BACKORDER" : "SURAT JALAN BACKORDER";
    document.getElementById('pdfType').innerText = "BackOrder";
    
    const headDetail = document.getElementById('pdfHeadDetail');
    const headWE = document.getElementById('pdfHeadWE');
    if (type === 'SJ') { headDetail.innerText = "KETERANGAN"; headWE.style.display = 'none'; } 
    else { headDetail.innerText = "DETAIL MESIN/KPC"; headWE.style.display = 'table-cell'; }

    let itemsToPrint = o.items; 
    const tbody = document.getElementById('pdfItemsBody');
    tbody.innerHTML = '';
    itemsToPrint.forEach((i, idx) => {
        let weCell = (type === 'SPK') ? `<td class="t-left" style="border-bottom:1px solid #ccc;">${i.we||'-'}</td>` : '';
        let detail = (type === 'SPK') ? `${i.machine||'-'} / ${i.kpc||'-'}` : ''; 
        tbody.innerHTML += `<tr>
            <td class="t-center" style="border-bottom:1px solid #ccc;">${idx+1}</td>
            <td class="t-left" style="border-bottom:1px solid #ccc;"><strong>${i.item}</strong><br><small>${i.type}</small></td>
            <td class="t-center" style="border-bottom:1px solid #ccc;">${i.meter}</td>
            <td class="t-center" style="border-bottom:1px solid #ccc;">${i.qty}</td>
            <td class="t-left" style="border-bottom:1px solid #ccc;">${detail}</td>
            ${weCell}
        </tr>`;
    });

    const sigContainer = document.getElementById('pdfSignatureRow');
    sigContainer.innerHTML = '';
    let titles = (type === 'SJ') ? ['Pembuat Nota', 'Kepala Gudang', 'Sopir', 'Penerima Barang'] : ['Admin Produksi', 'Kepala Gudang'];
    titles.forEach(t => {
        sigContainer.innerHTML += `<div class="sig-box"><div class="sig-title">${t}</div><div class="sig-name">&nbsp;</div></div>`;
    });

    const el = document.getElementById('pdfContent');
    const opt = { margin:[0.39, 0.29, 0.39, 0.29], filename:`${type}_${activeOrderId}.pdf`, image:{ type:'jpeg', quality:0.98 }, html2canvas:{ scale:2 }, jsPDF:{ unit:'in', format:'a5', orientation:'landscape' } };
    html2pdf().set(opt).from(el).save();
}
</script>
</body>
</html>
