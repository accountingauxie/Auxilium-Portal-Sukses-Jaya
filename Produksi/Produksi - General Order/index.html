<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Persiapan Produksi - Auxilium</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- SYSTEM STYLE --- */
:root { --primary: #116999; --bg: #f4f7f6; --text: #333; --red: #b91c1c; --green: #047857; --orange: #b75900; }
* { box-sizing: border-box; }
body { margin: 0; font-family: "Arial", sans-serif; font-size: 13px; background: var(--bg); color: var(--text); }

/* --- NAVBAR --- */
.aux-navbar { background: #fff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
.aux-logo img { height: 40px; }
.aux-menu { display: flex; gap: 10px; height: 100%; align-items: center; }
.aux-link { text-decoration: none; color: #666; font-weight: 600; padding: 8px 14px; border-radius: 6px; }
.aux-link.active { color: var(--primary); background: #eff8ff; }

/* --- CONTENT --- */
.page-wrap { padding: 30px 40px; max-width: 98%; margin: 0 auto; }
.category-tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
.cat-btn { background: none; border: none; padding: 10px 20px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
.cat-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table.xero-table { width: 100%; border-collapse: collapse; }
table.xero-table th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; color: #555; font-size: 12px; font-weight: bold; text-transform: uppercase; }
table.xero-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
table.xero-table tr:hover { background-color: #f9fafb; }

/* Badges */
.badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
.badge-gen { background: #e0f2fe; color: #0369a1; }
.badge-pre { background: #f3e8ff; color: #7e22ce; }
.status-process { background: #fff7e6; color: var(--orange); }
.status-completed { background: #ecfdf5; color: var(--green); }
.status-cancel { background: #fef2f2; color: var(--red); }

/* --- MODAL --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 10000; padding-top: 50px; overflow-y: auto; }
.modal-box { background: #fff; width: 1350px; max-width: 98%; height: auto; max-height: 90vh; display: flex; flex-direction: column; border-radius: 8px; margin-bottom: 50px; }
.modal-header, .modal-footer { padding: 20px 30px; background: #fff; border-bottom: 1px solid #eee; }
.modal-footer { background: #f9fafb; text-align: right; border-top: 1px solid #eee; }
.modal-body { flex: 1; overflow-y: auto; padding: 20px; }

/* Production Inputs */
.prod-input, .prod-select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
.split-row { background-color: #fffde7; }
.disabled-row { background-color: #f3f4f6; color: #9ca3af; pointer-events: none; }
.disabled-row input, .disabled-row select { background: #e5e7eb; border-color: #d1d5db; }

/* Buttons */
.btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; color: white; }
.btn-setup { background: var(--primary); }
.btn-complete { background: var(--green); }
.btn-cancel { background: var(--red); }
.btn-split { background: #d8b4fe; color: #6b21a8; }
.btn-remove { background: #fee2e2; color: #991b1b; }
.btn-secondary { background: #fff; border: 1px solid #ccc; color: #333; }

/* PDF Hidden */
#pdf-hidden-container { position: absolute; left: -9999px; }
</style>
</head>
<body>

<div class="aux-navbar">
    <div class="aux-logo"><img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png"></div>
    <nav class="aux-menu">
        <div class="nav-item"><a href="#" class="aux-link active">Produksi</a></div>
    </nav>
</div>

<div class="page-wrap">
    <h2>Persiapan Produksi</h2>
    
    <div class="category-tabs">
        <button class="cat-btn active" id="tab-awaiting" onclick="switchTab('Awaiting')">Awaiting Production</button>
        <button class="cat-btn" id="tab-process" onclick="switchTab('In Process')">In Process</button>
        <button class="cat-btn" id="tab-completed" onclick="switchTab('Completed')">Completed</button>
        <button class="cat-btn" id="tab-cancel" onclick="switchTab('Cancel')">Cancelled</button>
    </div>

    <div class="table-card">
        <table class="xero-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Type</th> <th>Customer</th>
                    <th>Order Date</th>
                    <th>Est. Delivery</th>
                    <th>Status</th> <th>Items</th>
                    <th style="text-align:center;">Action</th>
                </tr>
            </thead>
            <tbody id="dashboardBody">
                <tr><td colspan="8" style="text-align:center; padding:30px;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Setup: <span id="modalOrderNo" style="color:#116999;"></span></h3>
            <button onclick="closeModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div class="alert" style="background:#e0f2fe; color:#0c4a6e; padding:10px; border-radius:6px; margin-bottom:15px; font-size:12px;">
                <i class="fas fa-info-circle"></i> Gunakan tombol <strong>Split</strong> jika stok KPC kurang. Baris utama akan dinonaktifkan.
            </div>
            <table class="xero-table" id="productionTable">
                <thead>
                    <tr>
                        <th style="width:20%">Item</th>
                        <th style="width:5%">M</th>
                        <th style="width:5%">Qty</th>
                        <th style="width:8%">Set Qty</th>
                        <th style="width:8%">Total M'</th>
                        <th style="width:12%">Mesin</th>
                        <th style="width:14%">KPC</th>
                        <th style="width:8%">Type</th>
                        <th style="width:14%">WE Code</th>
                        <th style="width:6%">Act</th>
                    </tr>
                </thead>
                <tbody id="setupBody"></tbody>
            </table>
            <div id="validationMsg" style="color:red; font-weight:bold; margin-top:10px; display:none;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn btn-setup" onclick="submitProduction()">Process & Print PDF</button>
        </div>
    </div>
</div>

<div id="pdf-hidden-container">
    <div id="pdfContent" style="padding:20px; background:#fff; color:#000;">
        <h2 style="text-align:center;">WORK ORDER PRODUKSI</h2>
        <div style="border-bottom:2px solid #000; margin-bottom:20px;"></div>
        <table style="width:100%; margin-bottom:20px;">
            <tr><td><strong>Order No:</strong> <span id="pdfOrderNo"></span></td><td style="text-align:right;"><strong>Date:</strong> <span id="pdfDate"></span></td></tr>
            <tr><td><strong>Customer:</strong> <span id="pdfCustomer"></span></td><td style="text-align:right;"><strong>Est. Del:</strong> <span id="pdfEst"></span></td></tr>
        </table>
        <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead><tr style="background:#eee;"><th style="border:1px solid #000; padding:5px;">Item</th><th style="border:1px solid #000;">M</th><th style="border:1px solid #000;">Qty</th><th style="border:1px solid #000;">Detail</th><th style="border:1px solid #000;">WE Code</th></tr></thead>
            <tbody id="pdfItemsBody"></tbody>
        </table>
    </div>
</div>

<script>
// --- CONFIG ---
const BASE_URL = "https://script.google.com/macros/s/AKfycbxCYnBYUv8wLe1IcJ0vORsUxfLYYOXPsQLVhPB3mc66FHbeo58aW1pneKXHAndU-TIfkg/exec"; 
let currentOrders = {}; 
let activeOrderId = null;
let currentTab = 'Awaiting';

const TYPE_CODES = { 'Custom': 'CS', 'Plat': 'PL' };

window.onload = () => switchTab('Awaiting');

function switchTab(tabName) {
    currentTab = tabName;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    
    let btnId = 'tab-awaiting';
    if(tabName === 'In Process') btnId = 'tab-process';
    if(tabName === 'Completed') btnId = 'tab-completed';
    if(tabName === 'Cancel') btnId = 'tab-cancel';
    
    document.getElementById(btnId).classList.add('active');
    loadOrders(tabName);
}

// --- LOAD DATA ---
async function loadOrders(status) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px;">Loading Data...</td></tr>';
    
    try {
        // Kirim parameter status ke backend
        const response = await fetch(`${BASE_URL}?action=getProductionOrders&status=${encodeURIComponent(status)}`);
        const data = await response.json();
        renderDashboard(data, status);
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">Error: ${err}</td></tr>`;
    }
}

function renderDashboard(data, status) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '';
    
    if (!data || Object.keys(data).length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:30px; color:#999;">No orders in ${status}</td></tr>`;
        return;
    }

    currentOrders = data; 

    Object.keys(data).forEach(key => {
        const o = data[key];
        
        // Badge Logic
        let typeBadge = o.type.includes('Pre') ? 'badge-pre' : 'badge-gen';
        let statusBadge = 'status-process';
        if(status === 'Completed') statusBadge = 'status-completed';
        if(status === 'Cancel') statusBadge = 'status-cancel';

        // Action Buttons Logic
        let buttons = '';
        if (status === 'Awaiting') {
            buttons = `<button class="btn btn-setup" onclick="openSetup('${o.orderNo}')">Setup</button>
                       <button class="btn btn-cancel" style="margin-left:5px;" onclick="cancelOrder('${o.orderNo}')"><i class="fas fa-times"></i></button>`;
        } else if (status === 'In Process') {
            buttons = `<button class="btn btn-complete" onclick="completeOrder('${o.orderNo}')">Selesai</button>
                       <button class="btn btn-cancel" style="margin-left:5px;" onclick="cancelOrder('${o.orderNo}')">Batal</button>`;
        } else {
            buttons = `<span style="color:#999;">-</span>`;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${o.orderNo}</strong></td>
            <td><span class="badge ${typeBadge}">${o.type || 'General'}</span></td>
            <td>${o.customer}</td>
            <td>${o.date}</td>
            <td>${o.delivery}</td>
            <td><span class="badge ${statusBadge}">${status}</span></td>
            <td>${o.items.length}</td>
            <td style="text-align:center;">${buttons}</td>
        `;
        tbody.appendChild(tr);
    });
}

// --- ACTIONS (COMPLETE / CANCEL) ---
async function completeOrder(id) {
    if(!confirm('Tandai pesanan ini sebagai SELESAI?')) return;
    await sendStatusUpdate('completeOrder', id);
}

async function cancelOrder(id) {
    if(!confirm('Yakin ingin MEMBATALKAN pesanan ini?')) return;
    await sendStatusUpdate('cancelOrder', id);
}

async function sendStatusUpdate(action, id) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Updating...</td></tr>';
    
    try {
        await fetch(BASE_URL, {
            method: 'POST',
            body: JSON.stringify({ action: action, orderId: id })
        });
        loadOrders(currentTab); // Refresh current tab
    } catch(e) { alert(e); }
}

// --- MODAL SETUP (Logic Split/Input sama seperti sebelumnya) ---
function openSetup(orderId) {
    activeOrderId = orderId;
    const order = currentOrders[orderId];
    
    document.getElementById('modalOrderNo').innerText = orderId;
    document.getElementById('setupModal').style.display = 'flex';
    const tbody = document.getElementById('setupBody');
    tbody.innerHTML = '';

    order.items.forEach((item, idx) => {
        const isSpandek = (item.type && item.type.toLowerCase().includes('spandek') && !item.type.toLowerCase().includes('non'));
        const tr = document.createElement('tr');
        tr.className = 'main-row';
        tr.dataset.id = idx; 
        tr.dataset.type = isSpandek ? 'spandek' : 'non-spandek';
        tr.dataset.original = item.fullRowData;
        
        const initialTotalM = (parseFloat(item.meter) * parseInt(item.qty)).toFixed(2);

        let inputHTML = isSpandek ? `
            <td><input type="number" class="prod-input qty-input" value="${item.qty}" min="1" onchange="validateQty(${idx}); updateCalc(this)"></td>
            <td style="text-align:center;"><span class="total-m">${initialTotalM}</span></td>
            <td><select class="prod-select machine-select" onchange="generateWE(this)"><option value="">-</option><option value="PM08">PM08</option><option value="PM14">PM14</option></select></td>
            <td><select class="prod-select kpc-select" onchange="generateWE(this)"><option value="">-</option><option value="KPC-001">KPC-001</option><option value="KPC-002">KPC-002</option></select></td>
            <td><select class="prod-select type-select" onchange="generateWE(this)"><option value="Custom">Custom</option><option value="Plat">Plat</option></select></td>
            <td><input type="text" class="prod-input we-code" readonly></td>
            <td style="text-align:center;"><button class="btn btn-split" onclick="splitRow(this, ${idx})">Split</button></td>` 
            : `<td colspan="7" style="text-align:center; color:#999;">Non-Spandek</td>`;

        tr.innerHTML = `
            <td><strong>${item.item}</strong></td>
            <td style="text-align:center;"><span class="meter-val">${item.meter}</span></td>
            <td style="text-align:center;"><span class="target-qty badge badge-gen">${item.qty}</span></td>
            ${inputHTML}
        `;
        tbody.appendChild(tr);
    });
}

function closeModal() { document.getElementById('setupModal').style.display = 'none'; }

// --- LOGIC SPLIT (ABU-ABU) ---
function splitRow(btn, groupId) {
    const row = btn.closest('tr');
    const mainQty = parseInt(row.querySelector('.qty-input').value || 0);
    
    // Disable Main Row
    row.classList.add('disabled-row');
    row.querySelector('.qty-input').value = 0; // Visual 0
    row.querySelector('.total-m').innerText = "0.00";
    
    // Split 50:50
    const q1 = Math.floor(mainQty / 2);
    const q2 = mainQty - q1;
    
    createSplit(row, groupId, q1);
    createSplit(row, groupId, q2);
    validateQty(groupId);
}

function createSplit(refRow, groupId, qty) {
    const newRow = refRow.cloneNode(true);
    newRow.classList.remove('main-row', 'disabled-row');
    newRow.classList.add('split-row');
    
    // Enable inputs
    newRow.querySelector('.qty-input').value = qty;
    const inputs = newRow.querySelectorAll('input, select, button');
    inputs.forEach(el => el.disabled = false);
    
    // Reset selects/WE
    newRow.querySelectorAll('select').forEach(s => { s.value = ""; s.onchange = function(){ generateWE(this); } });
    newRow.querySelector('.we-code').value = "";
    
    // Change Button
    const btnDiv = newRow.lastElementChild;
    btnDiv.innerHTML = `<button class="btn btn-remove" onclick="removeSplit(this, ${groupId})"><i class="fas fa-trash"></i></button>`;
    
    // Event Listener
    const qInput = newRow.querySelector('.qty-input');
    qInput.onchange = function() { validateQty(groupId); updateCalc(this); };
    
    // Calculate M
    const m = parseFloat(newRow.querySelector('.meter-val').innerText);
    newRow.querySelector('.total-m').innerText = (m * qty).toFixed(2);

    // Insert
    const tbody = refRow.parentNode;
    const group = tbody.querySelectorAll(`tr[data-id="${groupId}"]`);
    group[group.length-1].after(newRow);
}

function removeSplit(btn, groupId) {
    const row = btn.closest('tr');
    const tbody = row.parentNode;
    row.remove();
    
    // Jika tidak ada split tersisa, enable main row
    const splits = tbody.querySelectorAll(`.split-row[data-id="${groupId}"]`);
    if(splits.length === 0) {
        const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
        main.classList.remove('disabled-row');
        const target = parseInt(main.querySelector('.target-qty').innerText);
        main.querySelector('.qty-input').value = target;
        updateCalc(main.querySelector('.qty-input'));
    }
    validateQty(groupId);
}

function updateCalc(input) {
    const row = input.closest('tr');
    if(row.classList.contains('disabled-row')) return;
    const m = parseFloat(row.querySelector('.meter-val').innerText || 0);
    const q = parseInt(input.value || 0);
    row.querySelector('.total-m').innerText = (m * q).toFixed(2);
}

function generateWE(el) {
    const row = el.closest('tr');
    const mach = row.querySelector('.machine-select').value;
    const kpc = row.querySelector('.kpc-select').value;
    const type = TYPE_CODES[row.querySelector('.type-select').value] || 'XX';
    if(mach && kpc) row.querySelector('.we-code').value = `${mach}_${kpc}_${type}_${activeOrderId}`;
    else row.querySelector('.we-code').value = "";
}

function validateQty(groupId) {
    const tbody = document.getElementById('setupBody');
    const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
    const target = parseInt(main.querySelector('.target-qty').innerText);
    const rows = tbody.querySelectorAll(`tr[data-id="${groupId}"]:not(.disabled-row)`);
    
    let current = 0;
    rows.forEach(r => current += parseInt(r.querySelector('.qty-input').value||0));
    
    const msg = document.getElementById('validationMsg');
    const isErr = current !== target;
    rows.forEach(r => r.querySelector('.qty-input').style.borderColor = isErr ? 'red' : '#ccc');
    
    if(isErr) {
        msg.style.display = 'block';
        msg.innerText = `Total Qty (${current}) tidak sama dengan Target (${target})`;
    } else {
        msg.style.display = 'none';
    }
    return !isErr;
}

// --- SUBMIT ---
async function submitProduction() {
    if(document.getElementById('validationMsg').style.display === 'block') return alert("Fix Qty Error first!");
    
    const rows = document.querySelectorAll('#setupBody tr:not(.disabled-row)');
    let data = [], pdfData = [];
    let valid = true;

    rows.forEach(r => {
        const type = r.dataset.type;
        const q = r.querySelector('.qty-input')?.value;
        
        let item = { originalData: r.dataset.original, qty: q, isSplit: r.classList.contains('split-row') };
        let pdf = { name: r.cells[0].innerText, m: r.cells[1].innerText, q: q, det: '-', we: '-' };

        if(type === 'spandek') {
            const m = r.querySelector('.machine-select').value;
            const k = r.querySelector('.kpc-select').value;
            const w = r.querySelector('.we-code').value;
            if(!m || !k) { r.style.background = '#fee2e2'; valid = false; }
            else { 
                item.machine = m; item.kpc = k; item.we = w; 
                pdf.det = `${m}/${k}`; pdf.we = w;
            }
        }
        data.push(item); pdfData.push(pdf);
    });

    if(!valid) return alert("Lengkapi data produksi!");

    // Generate PDF & Submit
    generatePDF(pdfData);
    
    document.querySelector('.btn-setup').innerText = "Processing...";
    try {
        await fetch(BASE_URL, { method: 'POST', body: JSON.stringify({ action: 'submitProduction', orderId: activeOrderId, data: data }) });
        alert("Sukses!");
        closeModal();
        loadOrders('Awaiting');
    } catch(e) { alert(e); }
    document.querySelector('.btn-setup').innerText = "Process & Print PDF";
}

function generatePDF(items) {
    const o = currentOrders[activeOrderId];
    document.getElementById('pdfOrderNo').innerText = activeOrderId;
    document.getElementById('pdfCustomer').innerText = o.customer;
    document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
    
    const tbody = document.getElementById('pdfItemsBody');
    tbody.innerHTML = '';
    items.forEach(i => tbody.innerHTML += `<tr><td style="border:1px solid #000;">${i.name}</td><td style="border:1px solid #000; text-align:center;">${i.m}</td><td style="border:1px solid #000; text-align:center;">${i.q}</td><td style="border:1px solid #000;">${i.det}</td><td style="border:1px solid #000;">${i.we}</td></tr>`);
    
    html2pdf().from(document.getElementById('pdfContent')).save(`SPK_${activeOrderId}.pdf`);
}
</script>
</body>
</html>
