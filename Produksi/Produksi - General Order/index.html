<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Persiapan Produksi - Auxilium</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- 1. SYSTEM STYLE --- */
:root { 
    --primary-color: #116999; 
    --bg-color: #f4f7f6; 
    --text-color: #333; 
    --red-bg: #fee2e2; --red-text: #991b1b;
    --green-bg: #ecfdf5; --green-text: #047857;
    --orange-bg: #fff7e6; --orange-text: #b75900;
}

* { box-sizing: border-box; }
body { margin: 0; font-family: "Arial", sans-serif; font-size: 13px; background: var(--bg-color); color: var(--text-color); }

/* --- NAVBAR --- */
.aux-navbar { background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
.aux-logo img { height: 40px; width: auto; display: block; }
.aux-menu { display: flex; gap: 10px; align-items: center; height: 100%; }
.nav-item { position: relative; height: 100%; display: flex; align-items: center; }
.aux-link { text-decoration: none; color: #666; font-weight: 600; font-size: 14px; padding: 8px 14px; border-radius: 6px; transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.aux-link:hover, .nav-item:hover .aux-link { color: #1d2939; background-color: #f9fafb; }
.aux-link.active { color: var(--primary-color); background-color: #eff8ff; font-weight: 700; }

/* Dropdown */
.dropdown-menu { visibility: hidden; opacity: 0; position: absolute; top: 90%; left: 50%; transform: translateX(-50%) translateY(-10px); background: white; min-width: 220px; border: 1px solid #eaecf0; border-radius: 8px; box-shadow: 0 12px 16px -4px rgba(16, 24, 40, 0.08); padding: 6px; z-index: 200; transition: all 0.2s ease; }
.nav-item:hover .dropdown-menu { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
.dropdown-item { display: block; padding: 10px 12px; color: #344054; text-decoration: none; font-size: 14px; border-radius: 6px; transition: background 0.2s; text-align: left; font-weight: 400; }
.dropdown-item:hover { background-color: #f9fafb; color: #2f54eb; }

/* User Panel */
.user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid #eee; }
.user-details { display: flex; flex-direction: column; text-align: right; line-height: 1.3; }
.user-name { font-weight: 700; font-size: 13px; color: #333; }
.user-role { font-size: 11px; color: #888; }
.user-avatar { width: 36px; height: 36px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; user-select: none; }

/* --- CONTENT STYLE --- */
.page-wrap { padding: 30px 40px; max-width: 98%; margin: 0 auto; }
.category-tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
.cat-btn { background: none; border: none; padding: 10px 20px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
.cat-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table.xero-table { width: 100%; border-collapse: collapse; }
table.xero-table th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; color: #555; font-size: 12px; text-transform: uppercase; font-weight: bold; }
table.xero-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
table.xero-table tr.data-row { cursor: pointer; transition: background-color 0.2s; }
table.xero-table tr.data-row:hover { background-color: #e0f2fe; }

/* Link Order # */
.order-link { color: var(--primary-color); font-weight: bold; text-decoration: none; cursor: pointer; }
.order-link:hover { text-decoration: underline; }

/* STATUS BADGES (Pill Shape) */
.badge { padding: 5px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; border: 1px solid transparent; letter-spacing: 0.5px; }
.badge-awaiting { background: var(--orange-bg); color: var(--orange-text); border-color: #ffe8cc; }
.badge-process { background: #e0f2fe; color: #0369a1; border-color: #bae6fd; }
.badge-completed { background: var(--green-bg); color: var(--green-text); border-color: #a7f3d0; }
.badge-cancel { background: var(--red-bg); color: var(--red-text); border-color: #fecaca; }

/* --- STYLE KHUSUS PRODUKSI --- */
.prod-input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
.prod-select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; background: #fff; }
.prod-input[readonly] { background-color: #eee; color: #666; }

/* Non Spandek Style */
.non-spandek-input { background-color: #f3f4f6 !important; border-color: #e5e7eb !important; color: #9ca3af !important; pointer-events: none; }

.main-row { background-color: #fff; transition: 0.3s; }
.split-row { background-color: #fffde7; } 
.disabled-row { background-color: #f9fafb; color: #9ca3af; }
.disabled-row input, .disabled-row select { background: #e5e7eb; border-color: #d1d5db; pointer-events: none; }
.disabled-row .btn-split { display: inline-block; pointer-events: auto; opacity: 1; }

.btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; color: white; display: inline-flex; align-items: center; gap: 5px; }
.btn-sm { padding: 4px 8px; font-size: 11px; }
.btn-process { background: var(--primary-color); }
.btn-complete { background: #047857; }
.btn-cancel { background: #b91c1c; }
.btn-secondary { background: #fff; border: 1px solid #ccc; color: #333; }
.btn-split { background: #d8b4fe; color: #6b21a8; }
.btn-remove { background: #fee2e2; color: #991b1b; }

/* --- MODAL STYLE --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 10000; backdrop-filter: blur(2px); padding-top: 50px; overflow-y: auto; }
.modal-box { background: #fff; width: 1350px; max-width: 98%; height: auto; max-height: 90vh; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 50px; }
.modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; border-radius: 8px 8px 0 0; }
.modal-body { flex: 1; overflow-y: auto; padding: 20px; background: #fff; }
.modal-footer { padding: 15px 30px; background: #f9fafb; border-top: 1px solid #eee; text-align: right; border-radius: 0 0 8px 8px; display: flex; justify-content: flex-end; gap: 10px; }

/* PDF HIDDEN */
#pdf-hidden-container { position: absolute; left: -9999px; }
.we-code { font-family: "Courier New", monospace; font-weight: bold; letter-spacing: 1px; }
</style>
</head>
<body>

<div class="aux-navbar">
    <div class="aux-logo"><img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo"></div>
    <nav class="aux-menu">
        <div class="nav-item"><a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/" class="aux-link">Home</a></div>
        <div class="nav-item">
            <div class="aux-link">Penjualan <i class="fas fa-chevron-down" style="font-size:10px; margin-left:4px;"></i></div>
            <div class="dropdown-menu">
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Review%20Penjualan/" class="dropdown-item">Review Penjualan</a>
            </div>
        </div>
        <div class="nav-item">
            <div class="aux-link active">Produksi <i class="fas fa-chevron-down" style="font-size:10px; margin-left:4px;"></i></div>
            <div class="dropdown-menu">
                <a href="#" class="dropdown-item">Persiapan Pesanan</a>
            </div>
        </div>
    </nav>
    <div class="user-panel">
        <div class="user-details"><span class="user-name">Admin Produksi</span><span class="user-role">CV Sukses Jaya</span></div>
        <div class="user-avatar">AP</div>
    </div>
</div>

<div class="page-wrap">
    <h2>Persiapan Produksi (General Order)</h2>
    <div class="category-tabs">
        <button class="cat-btn active" id="tab-awaiting" onclick="switchTab('Awaiting')">Awaiting Production</button>
        <button class="cat-btn" id="tab-process" onclick="switchTab('In Process')">In Process</button>
        <button class="cat-btn" id="tab-completed" onclick="switchTab('Completed')">Completed</button>
        <button class="cat-btn" id="tab-cancel" onclick="switchTab('Cancel')">Cancelled</button>
    </div>
    <div class="table-card">
        <table class="xero-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Type</th>
                    <th>Customer</th>
                    <th>Order Date</th>
                    <th>Est. Delivery</th>
                    <th>Status</th>
                    <th>Items</th>
                </tr>
            </thead>
            <tbody id="dashboardBody">
                <tr><td colspan="7" style="text-align:center; padding:50px; color:#999;">Loading Data...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <div>
                <h3 style="margin:0; font-size: 18px;">Review Produksi: <span id="modalOrderNo" style="font-weight:bold; color:var(--primary-color);"></span></h3>
                <span style="font-size:12px; color:#666;" id="modalCustomer"></span>
            </div>
            <button class="btn-close" onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modalAlert" class="alert" style="background:#e0f2fe; color:#0c4a6e; padding:10px; border-radius:6px; margin-bottom:15px; font-size:12px;">
                <i class="fas fa-info-circle"></i> <strong>Instruksi:</strong> Tekan tombol "Split" untuk menambah baris. Qty baris utama otomatis non-aktif. Total split harus sama dengan target.
            </div>
            <table class="xero-table" id="productionTable">
                <thead>
                    <tr>
                        <th style="width:25%">Nama Barang</th>
                        <th style="width:5%; text-align:center;">Meter</th>
                        <th style="width:5%; text-align:center;">Total Qty</th>
                        <th style="width:8%; text-align:center;">Assigned Qty</th>
                        <th style="width:8%; text-align:center;">Total M'</th>
                        <th style="width:12%">Mesin</th>
                        <th style="width:14%">KPC Code</th>
                        <th style="width:8%">Type</th>
                        <th style="width:14%">Work Effort Code</th>
                        <th style="width:5%">Action</th>
                    </tr>
                </thead>
                <tbody id="setupBody"></tbody>
            </table>
            <div id="validationMsg" style="color:red; font-weight:bold; margin-top:10px; display:none;"></div>
        </div>
        <div class="modal-footer" id="modalFooter"></div>
    </div>
</div>

<div id="pdf-hidden-container">
    <div id="pdfContent" style="padding:20px; font-family:Arial, sans-serif;">
        <h2 style="text-align:center;">SURAT PERINTAH KERJA</h2>
        <div style="border-bottom:2px solid #000; margin-bottom:15px;"></div>
        <table style="width:100%; margin-bottom:15px;">
            <tr><td><strong>Order No:</strong> <span id="pdfOrderNo"></span></td><td style="text-align:right;"><strong>Date:</strong> <span id="pdfDate"></span></td></tr>
            <tr><td><strong>Customer:</strong> <span id="pdfCustomer"></span></td><td style="text-align:right;"><strong>Del:</strong> <span id="pdfEst"></span></td></tr>
        </table>
        <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead><tr style="background:#eee;"><th style="border:1px solid #000; padding:5px;">Item</th><th style="border:1px solid #000; text-align:center;">M</th><th style="border:1px solid #000; text-align:center;">Qty</th><th style="border:1px solid #000; padding:5px;">Detail</th><th style="border:1px solid #000; padding:5px;">WE Code</th></tr></thead>
            <tbody id="pdfItemsBody"></tbody>
        </table>
    </div>
</div>

<script>
// --- CONFIG ---
const BASE_URL = "https://script.google.com/macros/s/AKfycbyynqUUyp5WGyQS7ZTnTwWmIOWLKhx0URcVqXT7XK0ilbqAWd7cYYcwATUjfe0_Exd36w/exec"; 
let currentOrders = {}; 
let activeOrderId = null;
let currentTab = 'Awaiting';
const TYPE_CODES = { 'Custom': 'CS', 'Plat': 'PL' };

window.onload = () => switchTab('Awaiting');

// --- HELPER FORMAT TANGGAL ---
function fmtDate(val) {
    if (!val) return "-";
    const d = new Date(val);
    if (isNaN(d.getTime())) return val;
    return d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function fmtTimestamp(val) {
    if (!val) return "-";
    const d = new Date(val);
    if (isNaN(d.getTime())) return val;
    // Format DD/MM/YYYY HH:mm:ss
    return d.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' }) + 
           ' ' + d.toLocaleTimeString('id-ID', { hour12: false });
}

function switchTab(tabName) {
    currentTab = tabName;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    let btnId = 'tab-awaiting';
    if(tabName === 'In Process') btnId = 'tab-process';
    if(tabName === 'Completed') btnId = 'tab-completed';
    if(tabName === 'Cancel') btnId = 'tab-cancel';
    document.getElementById(btnId).classList.add('active');
    loadOrders(tabName);
}

async function loadOrders(status) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px;">Loading Data...</td></tr>';
    try {
        const response = await fetch(`${BASE_URL}?action=getProductionOrders&status=${encodeURIComponent(status)}`);
        const data = await response.json();
        renderDashboard(data, status);
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="7" style="color:red; text-align:center;">Error: ${err}</td></tr>`;
    }
}

function renderDashboard(data, status) {
    const tbody = document.getElementById('dashboardBody');
    tbody.innerHTML = '';
    
    if (!data || Object.keys(data).length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px; color:#999;">No orders in ${status}</td></tr>`;
        return;
    }
    currentOrders = data; 

    Object.keys(data).forEach(key => {
        const o = data[key];
        // Status Badge Style
        let badgeClass = 'badge-awaiting';
        if (o.status === 'In Process') badgeClass = 'badge-process';
        if (o.status === 'Completed Production') badgeClass = 'badge-completed';
        if (o.status === 'Cancel Order') badgeClass = 'badge-cancel';

        const tr = document.createElement('tr');
        tr.className = 'data-row';
        tr.innerHTML = `
            <td><a class="order-link" onclick="openSetup('${o.orderNo}')">${o.orderNo}</a></td>
            <td>${o.type}</td>
            <td>${o.customer}</td>
            <td>${fmtDate(o.date)}</td>
            <td>${fmtDate(o.delivery)}</td>
            <td><span class="badge ${badgeClass}">${o.status}</span></td>
            <td>${o.items.length} Items</td>
        `;
        tbody.appendChild(tr);
    });
}

function openSetup(orderId) {
    activeOrderId = orderId;
    const order = currentOrders[orderId];
    
    document.getElementById('modalOrderNo').innerText = orderId;
    document.getElementById('modalCustomer').innerText = order.customer;
    
    // Alert Text Beda jika In Process
    const alertBox = document.getElementById('modalAlert');
    if (currentTab === 'In Process') {
        alertBox.innerHTML = '<i class="fas fa-edit"></i> <strong>Mode Edit:</strong> Anda dapat mengubah alokasi produksi. Pastikan update data setelah selesai.';
    } else if (currentTab === 'Completed' || currentTab === 'Cancel') {
        alertBox.style.display = 'none';
    } else {
        alertBox.style.display = 'block';
        alertBox.innerHTML = '<i class="fas fa-info-circle"></i> <strong>Instruksi:</strong> Tekan tombol "Split" untuk menambah baris. Qty baris utama otomatis non-aktif.';
    }

    const tbody = document.getElementById('setupBody');
    tbody.innerHTML = '';

    order.items.forEach((item, idx) => {
        const isSpandek = (item.type && item.type.toLowerCase().includes('spandek') && !item.type.toLowerCase().includes('non'));
        
        const tr = document.createElement('tr');
        tr.className = 'main-row';
        tr.dataset.id = idx; 
        tr.dataset.type = isSpandek ? 'spandek' : 'non-spandek';
        tr.dataset.original = item.fullRowData; 
        
        const initialTotalM = (parseFloat(item.meter) * parseInt(item.qty)).toFixed(2);

        // Style Nama Barang
        let nameHtml = `<strong>${item.item}</strong><br><small style="color:#888;">${item.type}</small>`;

        // Non-Spandek Render Kolom tapi Disabled (Gray)
        // Jika 'In Process', field enable (kecuali non-spandek)
        let isEditable = (currentTab === 'Awaiting' || currentTab === 'In Process');
        let spandekClass = isSpandek ? 'prod-input' : 'prod-input non-spandek-input';
        let readonlyAttr = isSpandek && isEditable ? '' : 'disabled';
        let valKPC = isSpandek ? (item.kpc || '') : '-'; 
        let valMesin = isSpandek ? (item.machine || '') : '-'; 
        
        // Render Baris
        let inputs = `
            <td><input type="number" class="${spandekClass} qty-input" value="${item.qty}" min="1" ${readonlyAttr} onchange="validateQty(${idx}); updateCalc(this)"></td>
            <td style="text-align:center;"><span class="total-m">${initialTotalM}</span></td>
            <td>
                <select class="${isSpandek?'prod-select':'prod-select non-spandek-input'} machine-select" ${readonlyAttr} onchange="generateWE(this)">
                    <option value="">-</option><option value="PM08">PM08</option><option value="PM14">PM14</option>
                </select>
            </td>
            <td>
                <select class="${isSpandek?'prod-select':'prod-select non-spandek-input'} kpc-select" ${readonlyAttr} onchange="generateWE(this)">
                    <option value="">-</option><option value="KPC-001">KPC-001</option><option value="KPC-002">KPC-002</option>
                </select>
            </td>
            <td>
                <select class="${isSpandek?'prod-select':'prod-select non-spandek-input'} type-select" ${readonlyAttr} onchange="generateWE(this)">
                    <option value="Custom">Custom</option><option value="Plat">Plat</option>
                </select>
            </td>
            <td><input type="text" class="${spandekClass} we-code" readonly value="${item.we||''}"></td>
            <td style="text-align:center;">
                ${isSpandek && isEditable ? `<button class="btn-sm btn-split" onclick="splitRow(this, ${idx})"><i class="fas fa-plus"></i></button>` : '-'}
            </td>
        `;

        tr.innerHTML = `
            <td>${nameHtml}</td>
            <td style="text-align:center;"><span class="meter-val">${item.meter}</span></td>
            <td style="text-align:center;"><span class="target-qty badge bg-info text-dark" style="background:#e0f2fe; color:#0369a1;">${item.qty}</span></td>
            ${inputs}
        `;
        tbody.appendChild(tr);

        // Set Values for Selects if data exists (In Process edit mode)
        if(isSpandek && item.machine) {
             tr.querySelector('.machine-select').value = item.machine;
             tr.querySelector('.kpc-select').value = item.kpc;
        }
    });

    renderFooterButtons();
    document.getElementById('validationMsg').style.display = 'none';
    document.getElementById('setupModal').style.display = 'flex';
}

function renderFooterButtons() {
    const footer = document.getElementById('modalFooter');
    footer.innerHTML = '';
    const btnClose = `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;
    
    if (currentTab === 'Awaiting') {
        footer.innerHTML = `${btnClose} 
                            <button class="btn btn-cancel" onclick="cancelOrder('${activeOrderId}')">Cancel Order</button>
                            <button class="btn btn-process" onclick="submitProduction('new')">Process & Print PDF</button>`;
    } else if (currentTab === 'In Process') {
        footer.innerHTML = `${btnClose} 
                            <button class="btn btn-cancel" onclick="cancelOrder('${activeOrderId}')">Cancel</button>
                            <button class="btn btn-process" onclick="submitProduction('update')">Update Changes</button>
                            <button class="btn btn-complete" onclick="completeOrder('${activeOrderId}')">Complete Order</button>`;
    } else {
        footer.innerHTML = btnClose;
    }
}

function closeModal() { document.getElementById('setupModal').style.display = 'none'; }

// --- LOGIC SPLIT (Infinite) ---
function splitRow(btn, groupId) {
    const originalRow = btn.closest('tr');
    
    // 1. Disable Main Row (Jika belum)
    if (!originalRow.classList.contains('disabled-row')) {
        originalRow.classList.add('disabled-row');
        originalRow.querySelector('.qty-input').value = 0; 
        originalRow.querySelector('.total-m').innerText = "0.00";
        originalRow.querySelectorAll('input, select').forEach(el => el.disabled = true);
    }

    // 2. Tambah Baris Split Baru
    const newRow = originalRow.cloneNode(true);
    newRow.classList.remove('main-row', 'disabled-row');
    newRow.classList.add('split-row');
    
    // Reset Inputs
    const qtyInput = newRow.querySelector('.qty-input');
    qtyInput.value = 0; qtyInput.disabled = false;
    newRow.querySelectorAll('select').forEach(s => { s.value = ""; s.disabled = false; s.onchange = function(){ generateWE(this); } });
    newRow.querySelector('.we-code').value = "";
    
    newRow.querySelector('.target-qty').parentElement.innerHTML = '<small>(Split)</small>';
    newRow.lastElementChild.innerHTML = `<button class="btn-sm btn-remove" onclick="removeSplit(this, ${groupId})"><i class="fas fa-trash"></i></button>`;
    
    const tbody = originalRow.parentNode;
    const groupRows = tbody.querySelectorAll(`tr[data-id="${groupId}"]`);
    groupRows[groupRows.length-1].after(newRow);

    qtyInput.onchange = function() { validateQty(groupId); updateCalc(this); };
}

function removeSplit(btn, groupId) {
    const row = btn.closest('tr');
    const tbody = row.parentNode;
    row.remove();
    
    const remainingSplits = tbody.querySelectorAll(`.split-row[data-id="${groupId}"]`);
    if(remainingSplits.length === 0) {
        const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
        main.classList.remove('disabled-row');
        const target = parseInt(main.querySelector('.target-qty').innerText);
        main.querySelector('.qty-input').value = target;
        main.querySelectorAll('select, input').forEach(el => el.disabled = false);
        updateCalc(main.querySelector('.qty-input'));
    }
    validateQty(groupId);
}

function updateCalc(input) {
    const row = input.closest('tr');
    if(row.classList.contains('disabled-row')) return;
    const m = parseFloat(row.querySelector('.meter-val').innerText || 0);
    const q = parseInt(input.value || 0);
    row.querySelector('.total-m').innerText = (m * q).toFixed(2);
}

function generateWE(el) {
    const row = el.closest('tr');
    const mach = row.querySelector('.machine-select').value;
    const kpc = row.querySelector('.kpc-select').value;
    const type = TYPE_CODES[row.querySelector('.type-select').value] || 'XX';
    if(mach && kpc) row.querySelector('.we-code').value = `${mach}_${kpc}_${type}_${activeOrderId}`;
}

function validateQty(groupId) {
    const tbody = document.getElementById('setupBody');
    const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
    const target = parseInt(main.querySelector('.target-qty').innerText);
    
    let current = 0;
    tbody.querySelectorAll(`tr[data-id="${groupId}"]:not(.disabled-row)`).forEach(r => {
        current += parseInt(r.querySelector('.qty-input').value || 0);
    });

    const msg = document.getElementById('validationMsg');
    const isErr = current !== target;
    tbody.querySelectorAll(`tr[data-id="${groupId}"] .qty-input`).forEach(el => el.style.borderColor = isErr ? 'red' : '#ccc');
    
    if(isErr) { msg.style.display = 'block'; msg.innerText = `Total Qty (${current}) != Target (${target})`; } 
    else { msg.style.display = 'none'; }
    return !isErr;
}

// --- SUBMIT ACTIONS ---
async function submitProduction(mode) {
    if(!confirm(mode === 'new' ? "Yakin ingin memproses produksi?" : "Simpan perubahan data produksi?")) return;
    if(document.getElementById('validationMsg').style.display === 'block') return alert("Perbaiki error Qty!");

    const rows = document.querySelectorAll('#setupBody tr:not(.disabled-row)');
    let data = [], pdfData = [];
    let valid = true;

    rows.forEach(r => {
        const type = r.dataset.type;
        const q = r.querySelector('.qty-input')?.value;
        let item = { originalData: r.dataset.original, qty: q, isSplit: r.classList.contains('split-row') };
        let pdf = { name: r.querySelector('strong').innerText, m: r.querySelector('.meter-val').innerText, q: q, det: '-', we: '-' };

        if(type === 'spandek') {
            const m = r.querySelector('.machine-select').value;
            const k = r.querySelector('.kpc-select').value;
            const w = r.querySelector('.we-code').value;
            if(!m || !k) { r.style.backgroundColor = '#fee2e2'; valid = false; }
            else { 
                item.machine = m; item.kpc = k; item.we = w; 
                pdf.det = `${m}/${k}`; pdf.we = w;
            }
        }
        data.push(item); pdfData.push(pdf);
    });

    if(!valid) return alert("Lengkapi Data Mesin/KPC!");

    const action = mode === 'new' ? 'submitProduction' : 'updateProductionData';
    await sendAPI(action, { orderId: activeOrderId, data: data });
    
    if(mode === 'new' || confirm("Download PDF ulang?")) generatePDF(pdfData);
}

async function completeOrder(id) {
    if(!confirm("Order selesai?")) return;
    await sendAPI('completeOrder', { orderId: id });
}

async function cancelOrder(id) {
    if(!confirm("Yakin batalkan order?")) return;
    await sendAPI('cancelOrder', { orderId: id });
}

async function sendAPI(action, payload) {
    try {
        payload.action = action;
        const res = await fetch(BASE_URL, { method: 'POST', body: JSON.stringify(payload) });
        const json = await res.json();
        if(json.result === 'error') throw json.message;
        alert("Sukses!");
        closeModal();
        loadOrders(currentTab);
    } catch(e) { alert("Error: " + e); }
}

function generatePDF(items) {
    const o = currentOrders[activeOrderId];
    document.getElementById('pdfOrderNo').innerText = activeOrderId;
    document.getElementById('pdfCustomer').innerText = o.customer;
    document.getElementById('pdfDate').innerText = fmtDate(o.date); // Use Order Date
    document.getElementById('pdfEst').innerText = fmtDate(o.delivery); // Use Est Delivery
    const tbody = document.getElementById('pdfItemsBody');
    tbody.innerHTML = '';
    items.forEach(i => tbody.innerHTML += `<tr><td style="border:1px solid #000;">${i.name}</td><td style="border:1px solid #000; text-align:center;">${i.m}</td><td style="border:1px solid #000; text-align:center;">${i.q}</td><td style="border:1px solid #000;">${i.det}</td><td style="border:1px solid #000;">${i.we}</td></tr>`);
    html2pdf().from(document.getElementById('pdfContent')).save(`SPK_${activeOrderId}.pdf`);
}
</script>
</body>
</html>
