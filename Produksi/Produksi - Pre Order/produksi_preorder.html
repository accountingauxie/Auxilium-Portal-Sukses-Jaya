<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Preorder Production System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
/* --- STYLE DASAR --- */
:root { --primary: #0f766e; --bg: #f3f4f6; --text: #1f2937; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; font-size: 13px; }

/* --- HEADER & NAV --- */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; padding: 15px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.header h2 { margin: 0; color: var(--primary); font-size: 18px; }

.tabs { display: flex; gap: 5px; margin-bottom: 0; border-bottom: 1px solid #ddd; }
.tab-btn { padding: 10px 15px; border: none; background: #e5e7eb; cursor: pointer; border-radius: 6px 6px 0 0; font-weight: 600; color: #666; transition: 0.2s; }
.tab-btn.active { background: #fff; color: var(--primary); border-bottom: 3px solid var(--primary); }
.tab-btn:hover { background: #d1d5db; }

/* --- TABLE --- */
.card { background: #fff; border-radius: 0 0 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table { width: 100%; border-collapse: collapse; }
th { background: #f9fafb; padding: 12px; text-align: left; font-size: 12px; border-bottom: 2px solid #eee; color: #555; text-transform: uppercase; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
tr:hover { background: #f0fdfa; }

/* --- BADGES & PROGRESS --- */
.badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
.bg-open { background: #dbeafe; color: #1e40af; }
.bg-partial { background: #ffedd5; color: #9a3412; }
.bg-closed { background: #dcfce7; color: #166534; }

.progress-bar { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; width: 100%; }
.progress-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.5s; }

/* --- BUTTONS & MODAL --- */
.btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-sm { padding: 5px 10px; font-size: 11px; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal { background: #fff; width: 900px; max-height: 90vh; border-radius: 8px; display: flex; flex-direction: column; }
.modal-body { padding: 20px; overflow-y: auto; flex: 1; }
.input-group { display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 4px; margin-bottom: 5px; }

/* PDF Hidden */
#pdf-container { position: absolute; left: -9999px; }
</style>
</head>
<body>

<div class="header">
    <div>
        <h2>Preorder Production Dashboard</h2>
        <span style="color:#666; font-size:12px;">Kelola kontrak preorder dan produksi harian</span>
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i class="fas fa-plus-circle"></i> Create Request (Saldo)
    </button>
</div>

<div class="tabs">
    <button class="tab-btn" id="tab-master" onclick="loadData('Master')">Master List (All)</button>
    <button class="tab-btn active" id="tab-remaining" onclick="loadData('Remaining')">Remaining (Ongoing)</button>
    <button class="tab-btn" id="tab-awaiting" onclick="loadData('Awaiting')">Awaiting</button>
    <button class="tab-btn" id="tab-process" onclick="loadData('In Process')">In Process</button>
    <button class="tab-btn" id="tab-completed" onclick="loadData('Completed')">Completed</button>
    <button class="tab-btn" id="tab-delivered" onclick="loadData('Delivered')">Delivered</button>
    <button class="tab-btn" id="tab-cancel" onclick="loadData('Cancel')">Cancelled</button>
</div>

<div class="card">
    <table id="mainTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody">
            <tr><td colspan="6" style="text-align:center; padding:50px;">Loading Data...</td></tr>
        </tbody>
    </table>
</div>

<div id="createModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-body">
            <h3>Buat Request Produksi</h3>
            <p>Pilih Customer untuk melihat sisa saldo kontrak berjalan (Remaining).</p>
            <select id="selCustomer" onchange="loadCustomerItems(this.value)" style="padding:10px; width:100%; margin-bottom:20px;">
                <option value="">-- Loading Data... --</option>
            </select>
            <div id="createItemsContainer"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-sm" onclick="closeModal('createModal')" style="background:#eee;">Batal</button>
                <button class="btn btn-primary" onclick="submitRequest()">Submit Request</button>
            </div>
        </div>
    </div>
</div>

<div id="actionModal" class="modal-overlay">
    <div class="modal">
        <div class="modal-body">
            <h3 id="actTitle">Order Detail</h3>
            <table style="width:100%; margin-bottom:15px;">
                <thead><tr><th>Item</th><th>Meter</th><th>Qty</th><th>Ket</th></tr></thead>
                <tbody id="actBody"></tbody>
            </table>
            <div id="actFooter" style="text-align:right;"></div>
            <button class="btn btn-sm" onclick="closeModal('actionModal')" style="margin-top:10px; background:#eee;">Close</button>
        </div>
    </div>
</div>

<div id="pdf-container">
    <div id="pdf-content" style="padding:20px; font-family:Arial; width:100%;">
        <h2 id="pdf-doc-title">SURAT JALAN / SPK</h2>
        <div style="margin-bottom:15px;">Order ID: <span id="pdf-orderno"></span> | Date: <span id="pdf-date"></span></div>
        <div style="margin-bottom:15px;">Customer: <span id="pdf-customer"></span></div>
        <table style="width:100%; border-collapse:collapse; border:1px solid #000;">
            <thead><tr style="background:#eee;"><th style="border:1px solid #000; padding:5px;">Item</th><th style="border:1px solid #000; padding:5px;">Meter</th><th style="border:1px solid #000; padding:5px;">Qty</th><th style="border:1px solid #000; padding:5px;">Ket</th></tr></thead>
            <tbody id="pdf-tbody"></tbody>
        </table>
    </div>
</div>

<script>
// --- KONFIGURASI API (HARDCODED) ---
const API_URL = "https://script.google.com/macros/s/AKfycby2yE547Tpba5Cym_AyHg3z65qPmsdkQrMr_WV00t0AoBfXNjj7SqWntFk6khNTi42W8A/exec";

let currentView = 'Remaining';
let globalRemainingData = []; 
let currentOrders = {};

window.onload = () => loadData('Remaining');

async function loadData(view) {
    currentView = view;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    // Mapping button ID
    let btnId = 'tab-remaining';
    if(view === 'Master') btnId = 'tab-master';
    if(view === 'Awaiting') btnId = 'tab-awaiting';
    if(view === 'In Process') btnId = 'tab-process';
    if(view === 'Completed') btnId = 'tab-completed';
    if(view === 'Delivered') btnId = 'tab-delivered';
    if(view === 'Cancel') btnId = 'tab-cancel';
    
    const btn = document.getElementById(btnId);
    if(btn) btn.classList.add('active');

    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;"><i class="fas fa-spinner fa-spin"></i> Fetching Data...</td></tr>';
    const thead = document.getElementById('tableHead');

    // MENGGUNAKAN FETCH (AGAR URL HARDCODED BERFUNGSI)
    try {
        let url = API_URL + "?dummy=" + new Date().getTime(); // Anti-cache

        // TENTUKAN ACTION BERDASARKAN TAB
        if(view === 'Master' || view === 'Remaining') {
            thead.innerHTML = `<tr><th>PO ID</th><th>Customer</th><th>Date</th><th style="width:40%;">Items Progress</th><th>Status</th></tr>`;
            url += "&action=getPreOrdersMaster&viewType=" + view;
            
            const req = await fetch(url);
            const data = await req.json();
            renderPreOrders(data);

        } else {
            // TAB PRODUCTION STAGES
            thead.innerHTML = `<tr><th>Prod ID</th><th>Customer</th><th>Date</th><th>Item Detail</th><th>Status</th><th style="text-align:right;">Action</th></tr>`;
            url += "&action=getProductionOrders&status=" + encodeURIComponent(view) + "&category=preorder";
            
            const req = await fetch(url);
            const data = await req.json();
            renderProduction(data);
        }

    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error: ${error.message}<br>Coba refresh halaman.</td></tr>`;
        console.error(error);
    }
}

function renderPreOrders(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    // Simpan data Remaining untuk dropdown Create Request
    if(currentView === 'Remaining') globalRemainingData = data;

    if(!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No Data Found.</td></tr>';
        return;
    }

    data.forEach(po => {
        let itemsHtml = '';
        po.items.forEach(item => {
            let pct = item.totalMeter > 0 ? (item.processedMeter / item.totalMeter) * 100 : 0;
            if(pct > 100) pct = 100;
            itemsHtml += `
                <div style="margin-bottom:5px;">
                    <div style="display:flex; justify-content:space-between; font-size:11px;">
                        <strong>${item.name}</strong>
                        <span>${item.processedMeter.toFixed(2)} / ${item.totalMeter.toFixed(2)}m</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${item.isLineClosed?'#999':'#10b981'};"></div></div>
                </div>`;
        });
        tbody.innerHTML += `<tr><td style="font-weight:bold; color:#0f766e;">${po.poId}</td><td>${po.customer}</td><td>${po.date}</td><td>${itemsHtml}</td><td><span class="badge bg-${po.status.toLowerCase()}">${po.status}</span></td></tr>`;
    });
}

function renderProduction(data) {
    currentOrders = data;
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if(!data || Object.keys(data).length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No Orders.</td></tr>';
        return;
    }

    Object.values(data).forEach(o => {
        let detail = o.items.map(i => `${i.item} (${i.qty}x${i.meter})`).join('<br>');
        let btns = '';
        if(o.status === 'Awaiting') btns = `<button class="btn-sm btn-primary" onclick="openAction('${o.orderNo}','process')">Process</button>`;
        if(o.status === 'In Process') btns = `<button class="btn-sm" onclick="printPDF('SPK','${o.orderNo}')">SPK</button> <button class="btn-sm btn-primary" onclick="openAction('${o.orderNo}','complete')">Finish</button>`;
        if(o.status === 'Completed Production') btns = `<button class="btn-sm btn-primary" onclick="openAction('${o.orderNo}','deliver')">Deliver</button>`;
        if(o.status === 'Delivered') btns = `<button class="btn-sm" onclick="printPDF('SJ','${o.orderNo}')">Print SJ</button>`;

        tbody.innerHTML += `<tr><td>${o.orderNo}</td><td>${o.customer}</td><td>${o.date}</td><td>${detail}</td><td><span class="badge" style="background:#eee;">${o.status}</span></td><td style="text-align:right;">${btns}</td></tr>`;
    });
}

// CREATE REQUEST
function openCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('createItemsContainer').innerHTML = '';
    
    // Auto populate jika data remaining sudah ada
    if(globalRemainingData.length === 0) {
        google.script.run.withSuccessHandler(d => {
            globalRemainingData = d;
            populateCust();
        }).doGet({parameter:{action:'getPreOrdersMaster', viewType:'Remaining'}});
    } else {
        populateCust();
    }
}

function populateCust() {
    const sel = document.getElementById('selCustomer');
    sel.innerHTML = '<option value="">-- Pilih Customer --</option>';
    if(!globalRemainingData || globalRemainingData.length === 0) {
        sel.innerHTML = '<option value="">-- Data Kosong --</option>';
        return;
    }
    [...new Set(globalRemainingData.map(d=>d.customer))].forEach(c => {
        let opt = document.createElement('option'); opt.value=c; opt.innerText=c; sel.appendChild(opt);
    });
}

function loadCustomerItems(cust) {
    const box = document.getElementById('createItemsContainer'); box.innerHTML = '';
    if(!cust) return;
    globalRemainingData.filter(d => d.customer === cust).forEach(po => {
        po.items.forEach(i => {
            if(!i.isLineClosed && i.remainingMeter > 0.1) {
                let div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                <div style="flex:1;"><strong>${i.name}</strong><br><small>Sisa: ${i.remainingMeter.toFixed(2)}m</small></div>
                <input type="number" class="inp-meter" placeholder="M" style="width:60px;" data-max="${i.remainingMeter}">
                <input type="number" class="inp-qty" placeholder="Qty" style="width:50px;">
                `;
                div.dataset.po = po.poId; div.dataset.row = i.rowIndex; div.dataset.name = i.name;
                box.appendChild(div);
            }
        });
    });
}

function submitRequest() {
    let batches = [];
    const cust = document.getElementById('selCustomer').value;
    let valid = true;
    
    document.querySelectorAll('#createItemsContainer .input-group').forEach(div => {
        let m = parseFloat(div.querySelector('.inp-meter').value)||0;
        let q = parseFloat(div.querySelector('.inp-qty').value)||0;
        let max = parseFloat(div.querySelector('.inp-meter').dataset.max);
        let tot = m*q;
        
        if(tot > max) valid = false;
        if(tot > 0) batches.push({poId:div.dataset.po, rowIndex:div.dataset.row, itemName:div.dataset.name, length:m, qty:q, totalMeter:tot});
    });

    if(!valid) return alert("Error: Input melebihi sisa kuota!");
    if(batches.length===0) return alert("Isi minimal satu item.");
    
    const payload = { action:'submitPartialPO', data: { customer: cust, poId: batches[0].poId, batches: batches } };
    google.script.run.withSuccessHandler(r => {
        if(r.result === 'success') {
            alert("Sukses: " + r.newOrderId);
            closeModal('createModal');
            loadData('Awaiting');
            // Refresh cache
            google.script.run.withSuccessHandler(d=>globalRemainingData=d).doGet({parameter:{action:'getPreOrdersMaster',viewType:'Remaining'}});
        } else {
            alert("Error: " + r.message);
        }
    }).doPost({postData:{contents:JSON.stringify(payload)}});
}

// ACTION HANDLER
function openAction(id, type) {
    activeOrder = currentOrders[id];
    document.getElementById('actionModal').style.display = 'flex';
    document.getElementById('actTitle').innerText = id + " (" + type + ")";
    const tbody = document.getElementById('actBody'); tbody.innerHTML = '';
    activeOrder.items.forEach(i => tbody.innerHTML += `<tr><td>${i.item}</td><td>${i.meter}</td><td>${i.qty}</td><td>${i.machine||'-'}</td></tr>`);
    
    let btnHtml = '';
    if(type === 'process') btnHtml = `<button class="btn btn-primary" onclick="doApi('${id}','submitProduction')">Kirim Produksi</button>`;
    if(type === 'complete') btnHtml = `<button class="btn btn-primary" onclick="doApi('${id}','completeOrder')">Selesai</button>`;
    if(type === 'deliver') btnHtml = `<button class="btn btn-primary" onclick="doApi('${id}','deliverOrder')">Kirim Barang</button>`;
    document.getElementById('actFooter').innerHTML = btnHtml;
}

function doApi(id, act) {
    const payload = { action: act, orderId: id, category: 'preorder', data: activeOrder.items };
    google.script.run.withSuccessHandler(r => {
        alert(r.message); closeModal('actionModal');
        if(act==='submitProduction') loadData('In Process');
        if(act==='completeOrder') loadData('Completed');
        if(act==='deliverOrder') loadData('Delivered');
    }).doPost({postData:{contents:JSON.stringify(payload)}});
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function printPDF(type, id) {
    const o = currentOrders[id];
    document.getElementById('pdf-doc-title').innerText = type === 'SPK' ? "SURAT PERINTAH KERJA" : "SURAT JALAN";
    document.getElementById('pdf-orderno').innerText = id;
    document.getElementById('pdf-customer').innerText = o.customer;
    document.getElementById('pdf-date').innerText = new Date().toLocaleDateString();
    const tbody = document.getElementById('pdf-tbody'); tbody.innerHTML = '';
    o.items.forEach(i => tbody.innerHTML += `<tr><td style="border:1px solid #000; padding:5px;">${i.item}</td><td style="border:1px solid #000; padding:5px;">${i.meter}</td><td style="border:1px solid #000; padding:5px;">${i.qty}</td><td style="border:1px solid #000; padding:5px;">${i.machine||'-'}</td></tr>`);
    html2pdf().from(document.getElementById('pdf-content')).save(`${type}_${id}.pdf`);
}
</script>
</body>
</html>
