<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Preorder Production System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
/* --- SYSTEM STYLE --- */
:root { --primary: #116999; --bg: #f4f7f6; --text: #333; --red: #b91c1c; --green: #047857; --orange: #b75900; }
* { box-sizing: border-box; }
body { margin: 0; font-family: "Arial", sans-serif; font-size: 13px; background: var(--bg); color: var(--text); }
.aux-navbar { background: #fff; height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 1px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
.aux-menu { display: flex; gap: 10px; height: 100%; align-items: center; }
.aux-link { text-decoration: none; color: #666; font-weight: 600; padding: 8px 14px; border-radius: 6px; }
.aux-link.active { color: var(--primary); background: #eff8ff; }
.page-wrap { padding: 30px 40px; max-width: 98%; margin: 0 auto; }
.header-action { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.action-buttons { display: flex; gap: 10px; }
.category-tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; display: flex; }
.cat-btn { background: none; border: none; padding: 10px 20px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
.cat-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table.xero-table { width: 100%; border-collapse: collapse; }
table.xero-table th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; color: #555; font-size: 12px; font-weight: bold; text-transform: uppercase; }
table.xero-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
.order-link { color: var(--primary); font-weight: bold; text-decoration: none; cursor: pointer; }
.badge { padding: 4px 8px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; }
.bg-open { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
.badge-awaiting { background: #fff7e6; color: var(--orange); border: 1px solid #ffe8cc; }
.badge-process { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
.badge-completed { background: #ecfdf5; color: var(--green); border: 1px solid #a7f3d0; }
.badge-delivery { background: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
.badge-cancel { background: #fef2f2; color: var(--red); border: 1px solid #fecaca; }
.btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; color: white; display: inline-flex; align-items: center; gap: 5px; }
.btn-sm { padding: 4px 8px; font-size: 11px; }
.btn-primary { background: var(--primary); }
.btn-process { background: #0891b2; }
.btn-complete { background: var(--green); }
.btn-deliver { background: #4f46e5; }
.btn-cancel { background: var(--red); }
.btn-split { background: #d8b4fe; color: #6b21a8; }
.btn-remove { background: #fee2e2; color: #991b1b; }
.btn-secondary { background: #fff; border: 1px solid #ccc; color: #333; }
.btn-report { background: #7c3aed; color: white; }
.btn-add-line { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; font-size: 11px; margin-top: 5px; padding: 4px 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
.btn-add-line:hover { background: #bbf7d0; }
.progress-bar { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; width: 100%; }
.progress-fill { height: 100%; background: #10b981; width: 0%; transition: width 0.5s; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 10000; padding-top: 50px; overflow-y: auto; }
.modal-box { background: #fff; width: 1350px; max-width: 98%; height: auto; max-height: 90vh; display: flex; flex-direction: column; border-radius: 8px; margin-bottom: 50px; }
.modal-header, .modal-footer { padding: 20px 30px; background: #fff; border-bottom: 1px solid #eee; }
.modal-footer { background: #f9fafb; text-align: right; border-top: 1px solid #eee; }
.modal-body { flex: 1; overflow-y: auto; padding: 20px; }
.prod-input, .prod-select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
.split-row { background-color: #fffde7; }
.disabled-row { background-color: #f9fafb; color: #9ca3af; }
.disabled-row input, .disabled-row select { background: #e5e7eb; border-color: #d1d5db; pointer-events: none; }
.check-production { width: 18px; height: 18px; cursor: pointer; accent-color: var(--green); }
.request-item { background: #fff; border: 1px solid #e5e7eb; border-radius: 6px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
.request-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; align-items: center; }
.rows-container { display: flex; flex-direction: column; gap: 8px; }
.input-row { display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #e2e8f0; }
.input-row label { width: 50px; font-weight: bold; color: #555; }
.item-summary { margin-top: 10px; text-align: right; font-weight: bold; font-size: 12px; color: #555; padding-top: 5px; border-top: 1px dashed #ddd; }
.balance-text { font-size: 13px; font-weight: bold; color: var(--primary); }
.over-limit { color: var(--red); }
.row-remove-btn { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; width: 28px; height: 28px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
table.report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
table.report-table th { background: #f3f4f6; padding: 10px; border: 1px solid #ddd; text-align: left; font-size: 12px; }
table.report-table td { padding: 8px 10px; border: 1px solid #ddd; font-size: 12px; }
.group-header { background-color: #e0f2fe; font-weight: bold; color: #0c4a6e; }
.sub-row td { background-color: #fff; color: #555; font-style: italic; padding-left: 30px; }
#pdf-hidden-container { position: absolute; left: -9999px; top: 0; }
#pdfContent { background: #fff; width: 100%; padding: 0; font-family: "Arial", sans-serif; color: #000; }
.pdf-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 2px solid #000; padding-bottom: 10px; }
.pdf-title { font-size: 24px; font-weight: 700; text-transform: uppercase; }
table.pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
table.pdf-table th { font-size: 9px; font-weight: 700; border: 1px solid #000; padding: 5px; background: #eee; }
table.pdf-table td { font-size: 10px; border: 1px solid #000; padding: 5px; }
</style>
</head>
<body>

<div class="aux-navbar">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" style="height:40px;">
    </div>
    <nav class="aux-menu">
        <div class="nav-item"><a href="#" class="aux-link active">Preorder Production</a></div>
    </nav>
</div>

<div class="page-wrap">
    <div class="header-action">
        <h2>Preorder Production Dashboard</h2>
        <div class="action-buttons">
            <button class="btn btn-report" onclick="openReportModal()"><i class="fas fa-file-alt"></i> Saldo Report</button>
            <button class="btn btn-process" onclick="openCreateModal()"><i class="fas fa-plus-circle"></i> Create Request (Saldo)</button>
        </div>
    </div>

    <div class="category-tabs">
        <button class="cat-btn" id="tab-master" onclick="loadData('Master')">Master List</button>
        <button class="cat-btn active" id="tab-remaining" onclick="loadData('Remaining')">Remaining</button>
        <button class="cat-btn" id="tab-awaiting" onclick="loadData('Awaiting')">Awaiting</button>
        <button class="cat-btn" id="tab-process" onclick="loadData('In Process')">In Process</button>
        <button class="cat-btn" id="tab-completed" onclick="loadData('Completed')">Completed</button>
        <button class="cat-btn" id="tab-delivery" onclick="loadData('Delivered')">Delivered</button>
        <button class="cat-btn" id="tab-cancel" onclick="loadData('Cancel')">Cancelled</button>
    </div>

    <div class="table-card">
        <table class="xero-table">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"><tr><td colspan="7" style="text-align:center; padding:30px;">Loading...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="createModal" class="modal-overlay">
    <div class="modal-box" style="width: 900px;">
        <div class="modal-header">
            <h3>Buat Request Produksi</h3>
            <button onclick="closeModal('createModal')" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <div style="flex:1;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Customer:</label>
                    <select id="selCustomer" onchange="loadCustomerItemsAggregated(this.value)" class="prod-select">
                        <option value="">-- Pilih Customer --</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label style="font-weight:bold; display:block; margin-bottom:5px;">Est. Delivery Date:</label>
                    <input type="date" id="inpDate" class="prod-input">
                </div>
            </div>
            <div id="createItemsContainer">
                </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('createModal')">Batal</button>
            <button class="btn btn-primary" id="btnSubmitRequest" onclick="submitRequestAggregated()">Submit Request</button>
        </div>
    </div>
</div>

<div id="reportModal" class="modal-overlay">
    <div class="modal-box" style="width: 900px;">
        <div class="modal-header">
            <h3>Laporan Saldo Customer</h3>
            <button onclick="closeModal('reportModal')" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <label style="font-weight:bold; margin-right:10px;">Pilih Customer:</label>
                <select id="selReportCustomer" onchange="generateCustomerReport(this.value)" class="prod-select" style="width:300px;">
                    <option value="">-- Pilih Customer --</option>
                </select>
                <button class="btn btn-secondary" onclick="printReportDiv()" style="margin-left:10px;"><i class="fas fa-print"></i> Print View</button>
            </div>
            <div id="reportContentArea">
                <div style="text-align:center; color:#888; margin-top:50px;">Silakan pilih customer untuk melihat laporan.</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('reportModal')">Close</button>
        </div>
    </div>
</div>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>Order: <span id="modalOrderNo" style="color:#116999;"></span></h3>
            <button onclick="closeModal('setupModal')" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <div id="modalAlert" class="alert" style="background:#e0f2fe; color:#0c4a6e; padding:10px; border-radius:6px; margin-bottom:15px; font-size:12px;"></div>
            <table class="xero-table">
                <thead><tr id="tableHeaderRow"></tr></thead>
                <tbody id="setupBody"></tbody>
            </table>
            <div id="validationMsg" style="color:red; font-weight:bold; margin-top:10px; display:none;"></div>
        </div>
        <div class="modal-footer">
            <div id="footerLeft" style="float:left;"></div>
            <div id="footerRight" style="display:flex; gap:10px; justify-content:flex-end;"></div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal-overlay" style="z-index: 10001;">
    <div class="modal-box" style="width: 400px; margin-top: 150px;">
        <div class="modal-header" style="justify-content: center; border-bottom: none;"><h4>Konfirmasi</h4></div>
        <div class="modal-body" style="text-align: center;"><p id="confirmMessage" style="font-size:16px;">Yakin?</p></div>
        <div class="modal-footer" style="justify-content: center;">
            <button class="btn btn-secondary" onclick="closeConfirm(false)">Tidak</button>
            <button class="btn btn-primary" id="confirmYesBtn">Ya</button>
        </div>
    </div>
</div>

<div id="pdf-hidden-container">
    <div id="pdfContent">
        <div class="pdf-header">
            <div class="pdf-title" id="pdfTitle">SURAT</div>
            <div style="text-align:right; font-size:9px;">
                <div style="font-weight:bold; font-size:11px;">CV. SUKSES JAYA MAKMUR LESTARI</div>
                <div>Kendari, Sulawesi Tenggara</div>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:10px;">
            <div>
                <strong>KEPADA YTH.</strong><br>
                <span id="pdfCustName" style="font-size:12px; font-weight:bold;">-</span>
            </div>
            <div style="text-align:right;">
                <strong>No Order:</strong> <span id="pdfOrderNo">-</span><br>
                <strong>Tanggal:</strong> <span id="pdfDate">-</span>
            </div>
        </div>
        <table class="pdf-table">
            <thead>
                <tr>
                    <th style="width:5%; text-align:center;">NO</th>
                    <th style="width:40%;">NAMA BARANG</th>
                    <th style="width:10%; text-align:center;">METER</th>
                    <th style="width:10%; text-align:center;">QTY</th>
                    <th style="width:20%;" id="pdfHeadDetail">KET</th>
                    <th style="width:15%;" id="pdfHeadWE">WE CODE</th>
                </tr>
            </thead>
            <tbody id="pdfItemsBody"></tbody>
        </table>
        <div style="display:flex; justify-content:space-between; margin-top:40px; text-align:center; font-size:10px;">
            <div style="width:30%;">Dibuat Oleh,<br><br><br><br>( Admin )</div>
            <div style="width:30%;">Diketahui Oleh,<br><br><br><br>( .................... )</div>
        </div>
    </div>
</div>

<script>
// --- KONFIGURASI API ---
const API_URL = "https://script.google.com/macros/s/AKfycbyXS4HZALNgggpEwOucoNhtAeE21boEi6tFM_sy16z-qnkWISK2gg9ysy06jx4pvio_5Q/exec";
const TYPE_CODES = { 'Custom': 'CS', 'Plat': 'PL' };

let currentView = 'Remaining';
let globalRemainingData = []; 
let currentOrders = {};
let aggregatedItemsMap = {};
let activeOrderId = null;
let confirmCallback = null;

window.onload = () => loadData('Remaining');

// --- NAVIGATION & LOAD DATA ---
async function loadData(view) {
    currentView = view;
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    let btnId = 'tab-remaining';
    if(view === 'Master') btnId = 'tab-master';
    if(view === 'Awaiting') btnId = 'tab-awaiting';
    if(view === 'In Process') btnId = 'tab-process';
    if(view === 'Completed') btnId = 'tab-completed';
    if(view === 'Delivered') btnId = 'tab-delivery';
    if(view === 'Cancel') btnId = 'tab-cancel';
    
    document.getElementById(btnId).classList.add('active');
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px;">Loading...</td></tr>';
    const thead = document.getElementById('tableHead');

    try {
        let url = API_URL + "?dummy=" + new Date().getTime(); 
        if(view === 'Master' || view === 'Remaining') {
            thead.innerHTML = `<tr><th>PO ID</th><th>Customer</th><th>Date</th><th style="width:40%;">Items Progress</th><th>Status</th></tr>`;
            url += "&action=getPreOrdersMaster&viewType=" + view;
            const req = await fetch(url);
            const data = await req.json();
            renderPreOrders(data);
        } else {
            thead.innerHTML = `<tr><th>Order #</th><th>Type</th><th>Customer</th><th>Order Date</th><th>Est. Delivery</th><th>Status</th><th>Items</th></tr>`;
            url += "&action=getProductionOrders&status=" + encodeURIComponent(view) + "&category=preorder";
            const req = await fetch(url);
            const data = await req.json();
            renderProduction(data);
        }
    } catch (error) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:red;">Error: ${error.message}</td></tr>`;
    }
}

function renderPreOrders(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if(currentView === 'Remaining') globalRemainingData = data;
    if(!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No Data Found.</td></tr>'; return; }

    data.forEach(po => {
        let itemsHtml = '';
        po.items.forEach(item => {
            let pct = item.totalMeter > 0 ? (item.processedMeter / item.totalMeter) * 100 : 0;
            if(pct > 100) pct = 100;
            itemsHtml += `<div style="margin-bottom:5px;"><div style="display:flex; justify-content:space-between; font-size:11px;"><strong>${item.name}</strong><span>${item.processedMeter.toFixed(2)} / ${item.totalMeter.toFixed(2)}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${pct}%; background:${item.isLineClosed?'#999':'#10b981'};"></div></div></div>`;
        });
        tbody.innerHTML += `<tr><td style="font-weight:bold; color:#116999;">${po.poId}</td><td>${po.customer}</td><td>${po.date}</td><td>${itemsHtml}</td><td><span class="badge bg-open">${po.status}</span></td></tr>`;
    });
}

function renderProduction(data) {
    currentOrders = data;
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    if(!data || Object.keys(data).length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No Orders.</td></tr>'; return; }

    Object.values(data).forEach(o => {
        let badgeClass = 'badge-awaiting';
        if (o.status === 'In Process') badgeClass = 'badge-process';
        if (o.status === 'Completed Production') badgeClass = 'badge-completed';
        if (o.status === 'Delivered') badgeClass = 'badge-delivery';
        if (o.status === 'Cancel Production') badgeClass = 'badge-cancel';

        tbody.innerHTML += `<tr><td><a class="order-link" onclick="openSetup('${o.orderNo}')">${o.orderNo}</a></td><td>${o.type}</td><td>${o.customer}</td><td>${o.date}</td><td>${o.delivery}</td><td><span class="badge ${badgeClass}">${o.status}</span></td><td>${o.items.length} Items</td></tr>`;
    });
}

// --- REPORT LOGIC ---
function openReportModal() {
    if(globalRemainingData.length === 0) {
        alert("Data belum siap, mohon tunggu loading selesai.");
        return;
    }
    document.getElementById('reportModal').style.display = 'flex';
    document.getElementById('reportContentArea').innerHTML = '<div style="text-align:center; color:#888; margin-top:50px;">Silakan pilih customer untuk melihat laporan.</div>';
    
    const sel = document.getElementById('selReportCustomer');
    sel.innerHTML = '<option value="">-- Pilih Customer --</option>';
    [...new Set(globalRemainingData.map(d=>d.customer))].sort().forEach(c => {
        let opt = document.createElement('option'); opt.value=c; opt.innerText=c; sel.appendChild(opt);
    });
}

function generateCustomerReport(cust) {
    const box = document.getElementById('reportContentArea');
    if(!cust) {
        box.innerHTML = ''; return;
    }
    let reportMap = {};
    globalRemainingData.filter(d => d.customer === cust).forEach(po => {
        po.items.forEach(item => {
            // FIX LOGIC REPORT: Menangani Qty Based
            let hasBalance = item.isQtyBased ? (item.remainingMeter > 0) : (item.remainingMeter > 0.1);

            if(!item.isLineClosed && hasBalance) {
                if(!reportMap[item.name]) {
                    reportMap[item.name] = { name: item.name, totalBalance: 0, details: [] };
                }
                reportMap[item.name].totalBalance += item.remainingMeter;
                reportMap[item.name].details.push({ 
                    inv: po.poId, date: po.date, balance: item.remainingMeter, 
                    type: item.type, unit: item.unit 
                });
            }
        });
    });

    if(Object.keys(reportMap).length === 0) {
        box.innerHTML = '<div style="text-align:center; padding:20px; color:red;">Tidak ada saldo tersisa untuk customer ini.</div>';
        return;
    }

    let html = `<h4 style="border-bottom:2px solid #ddd; padding-bottom:5px;">Laporan Saldo: ${cust}</h4>`;
    html += `<table class="report-table"><thead><tr><th>Nama Barang</th><th>Invoice / PO</th><th>Tanggal PO</th><th>Satuan</th><th style="text-align:right;">Sisa</th></tr></thead><tbody>`;
    Object.values(reportMap).forEach(group => {
        let unitLabel = group.details[0].unit || "Pcs";
        // Jika Spandek, paksa label 'Meter' di header group supaya jelas, tapi data detail ikut unit row
        let displayUnit = (group.details[0].type && group.details[0].type.toLowerCase().includes("spandek")) ? "Meter" : unitLabel;

        html += `<tr class="group-header"><td colspan="4">${group.name} <small>(${group.details[0].type})</small></td><td style="text-align:right; font-size:13px;">Total: ${group.totalBalance.toFixed(2)}</td></tr>`;
        group.details.forEach(det => {
            let rowUnit = det.unit || "-";
            if(det.type && det.type.toLowerCase().includes("spandek")) rowUnit = "Meter"; // Spandek selalu meter
            
            html += `<tr class="sub-row"><td></td><td>${det.inv}</td><td>${det.date}</td><td>${rowUnit}</td><td style="text-align:right;">${det.balance.toFixed(2)}</td></tr>`;
        });
    });
    html += `</tbody></table>`;
    box.innerHTML = html;
}

function printReportDiv() {
    const content = document.getElementById('reportContentArea').innerHTML;
    const win = window.open('', '', 'height=700,width=900');
    win.document.write('<html><head><title>Print Report</title><style>body{font-family:Arial, sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; font-size:12px;} .group-header{background:#eee; font-weight:bold;}</style></head><body>');
    win.document.write(content);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
}

// --- SETUP & PRODUCTION LOGIC (No Changes) ---
function openSetup(orderId) {
    activeOrderId = orderId;
    const order = currentOrders[orderId];
    document.getElementById('modalOrderNo').innerText = orderId;
    
    const headerRow = document.getElementById('tableHeaderRow');
    let headers = `<th style="width:20%">Item</th><th style="width:5%; text-align:center;">M</th><th style="width:5%; text-align:center;">Qty</th><th style="width:8%; text-align:center;">Set Qty</th><th style="width:8%; text-align:center;">Tot M'</th><th style="width:12%">Mesin</th><th style="width:14%">KPC</th><th style="width:8%">Type</th><th style="width:14%">WE Code</th><th style="width:5%; text-align:center;">Act</th>`;
    if (currentView === 'In Process') headers += `<th style="width:5%; text-align:center;">Selesai?</th>`;
    headerRow.innerHTML = headers;

    const alertBox = document.getElementById('modalAlert');
    if (currentView === 'In Process') {
        alertBox.innerHTML = '<i class="fas fa-check-circle"></i> <strong>Produksi:</strong> Centang barang yang sudah selesai. Jangan lupa klik <strong>Update</strong> untuk menyimpan progres.';
        alertBox.style.display = 'block';
    } else if (['Completed', 'Delivered', 'Cancel'].includes(currentView)) {
        alertBox.style.display = 'none';
    } else {
        alertBox.style.display = 'block';
        alertBox.innerHTML = '<strong>Instruksi:</strong> Gunakan tombol (+) untuk split jika stok kurang. Total Qty harus sama dengan target.';
    }

    const tbody = document.getElementById('setupBody');
    tbody.innerHTML = '';

    order.items.forEach((item, idx) => {
        const isSpandek = (item.type && item.type.toLowerCase().includes('spandek') && !item.type.toLowerCase().includes('non'));
        const tr = document.createElement('tr');
        tr.className = 'main-row';
        tr.dataset.id = idx;
        tr.dataset.type = isSpandek ? 'spandek' : 'non-spandek';
        tr.dataset.original = item.fullRowData;
        
        const initialTotalM = (parseFloat(item.meter) * parseInt(item.qty)).toFixed(2);
        let nameHtml = `<strong>${item.item}</strong><br><small style="color:#888;">${item.type}</small>`;
        let isEditable = (currentView === 'Awaiting' || currentView === 'In Process');
        let spandekClass = isSpandek ? 'prod-input' : 'prod-input non-spandek-input';
        let readonlyAttr = isSpandek && isEditable ? '' : 'disabled';
        
        let valMesin = item.machine || "";
        let valKPC = item.kpc || "";
        let valType = "Custom";
        if(item.we && item.we.includes('_PL_')) valType = "Plat";

        let inputs = `
            <td><input type="number" class="${spandekClass} qty-input" value="${item.qty}" min="0" oninput="validity.valid||(value='');" ${readonlyAttr} onchange="updateCalc(this)"></td>
            <td style="text-align:center;"><span class="total-m">${initialTotalM}</span></td>
            <td><select class="${spandekClass} machine-select" ${readonlyAttr} onchange="generateWE(this)"><option value="">-</option><option value="PM08" ${valMesin==='PM08'?'selected':''}>PM08</option><option value="PM14" ${valMesin==='PM14'?'selected':''}>PM14</option></select></td>
            <td><select class="${spandekClass} kpc-select" ${readonlyAttr} onchange="generateWE(this)"><option value="">-</option><option value="KPC-001" ${valKPC==='KPC-001'?'selected':''}>KPC-001</option><option value="KPC-002" ${valKPC==='KPC-002'?'selected':''}>KPC-002</option></select></td>
            <td><select class="${spandekClass} type-select" ${readonlyAttr} onchange="generateWE(this)"><option value="Custom" ${valType==='Custom'?'selected':''}>Custom</option><option value="Plat" ${valType==='Plat'?'selected':''}>Plat</option></select></td>
            <td><input type="text" class="${spandekClass} we-code" readonly value="${item.we||''}"></td>
            <td style="text-align:center;">${isSpandek && isEditable ? `<button class="btn-sm btn-split" onclick="splitRow(this, ${idx})"><i class="fas fa-plus"></i></button>` : '-'}</td>
        `;

        if (currentView === 'In Process') {
            let checked = item.isFinished ? 'checked' : '';
            inputs += `<td style="text-align:center;"><input type="checkbox" class="check-production" ${checked} onchange="checkAllDone()"></td>`;
        }

        tr.innerHTML = `<td>${nameHtml}</td><td style="text-align:center;"><span class="meter-val">${item.meter}</span></td><td style="text-align:center;"><span class="target-qty badge bg-open">${item.qty}</span></td>${inputs}`;
        tbody.appendChild(tr);
    });

    renderFooterButtons();
    document.getElementById('validationMsg').style.display = 'none';
    document.getElementById('setupModal').style.display = 'flex';
    if(currentView === 'In Process') checkAllDone();
}

function renderFooterButtons() {
    const footerLeft = document.getElementById('footerLeft');
    const footerRight = document.getElementById('footerRight');
    footerLeft.innerHTML = ''; footerRight.innerHTML = '';
    const btnClose = `<button class="btn btn-secondary" onclick="closeModal('setupModal')">Close</button>`;
    
    if (currentView === 'Awaiting') {
        footerRight.innerHTML = `${btnClose} <button class="btn btn-cancel" onclick="triggerAction('cancel')">Cancel Production</button><button class="btn btn-primary" onclick="triggerAction('process')">Process</button>`;
    } else if (currentView === 'In Process') {
        footerLeft.innerHTML = `<button class="btn btn-process" onclick="generatePDF('SPK')"><i class="fas fa-print"></i> Print SPK</button>`;
        footerRight.innerHTML = `${btnClose} <button class="btn btn-cancel" onclick="triggerAction('cancel')">Cancel</button><button class="btn btn-primary" onclick="triggerAction('update')">Update</button><button class="btn btn-complete" id="btnComplete" onclick="triggerAction('complete')" disabled>Selesai Produksi</button>`;
    } else if (currentView === 'Completed') {
        footerRight.innerHTML = `${btnClose} <button class="btn btn-deliver" onclick="triggerAction('deliver')">Delivery (Kirim)</button>`;
    } else if (currentView === 'Delivered') {
        footerLeft.innerHTML = `<button class="btn btn-process" onclick="generatePDF('SJ')"><i class="fas fa-print"></i> Print Surat Jalan</button>`;
        footerRight.innerHTML = btnClose;
    } else {
        footerRight.innerHTML = btnClose;
    }
}

function checkAllDone() {
    const checkboxes = document.querySelectorAll('#setupBody tr:not(.disabled-row) .check-production');
    let allChecked = checkboxes.length > 0;
    checkboxes.forEach(cb => { if (!cb.checked) allChecked = false; });
    const btn = document.getElementById('btnComplete');
    if(btn) btn.disabled = !allChecked;
}

function triggerAction(actionType) {
    let msg = "";
    let func = null;
    if (actionType === 'process') { msg = "Yakin data sudah benar?"; func = () => submitProduction('new'); }
    else if (actionType === 'update') { msg = "Simpan perubahan?"; func = () => submitProduction('update'); }
    else if (actionType === 'complete') { msg = "Barang fisik sudah selesai?"; func = () => sendAPI('completeOrder', { orderId: activeOrderId }); }
    else if (actionType === 'deliver') { msg = "Kirim barang sekarang?"; func = () => sendAPI('deliverOrder', { orderId: activeOrderId }); }
    else if (actionType === 'cancel') { msg = "Yakin batalkan produksi?"; func = () => sendAPI('cancelOrder', { orderId: activeOrderId }); }
    if (msg && func) showConfirm(msg, func);
}

function showConfirm(message, callback) {
    document.getElementById('confirmMessage').innerText = message;
    confirmCallback = callback;
    document.getElementById('confirmModal').style.display = 'flex';
}
function closeConfirm(isConfirmed) {
    document.getElementById('confirmModal').style.display = 'none';
    if (isConfirmed && confirmCallback) confirmCallback();
    confirmCallback = null;
}
document.getElementById('confirmYesBtn').onclick = () => closeConfirm(true);

// --- SPLIT & CALCULATION LOGIC ---
function splitRow(btn, groupId) {
    const originalRow = btn.closest('tr');
    const tbody = originalRow.parentNode;
    if (!originalRow.classList.contains('disabled-row')) {
        originalRow.classList.add('disabled-row');
        originalRow.querySelector('.qty-input').value = 0; 
        originalRow.querySelector('.total-m').innerText = "0.00";
        originalRow.querySelectorAll('input, select').forEach(el => el.disabled = true);
        const cb = originalRow.querySelector('.check-production');
        if(cb) cb.disabled = true; 
    }
    const newRow = originalRow.cloneNode(true);
    newRow.classList.remove('main-row', 'disabled-row');
    newRow.classList.add('split-row');
    const qtyInput = newRow.querySelector('.qty-input');
    qtyInput.value = 0; 
    qtyInput.disabled = false;
    qtyInput.setAttribute("min", "0");
    qtyInput.setAttribute("oninput", "validity.valid||(value='');");
    newRow.querySelectorAll('select').forEach(s => { 
        s.value = ""; s.disabled = false; s.onchange = function(){ generateWE(this); } 
    });
    newRow.querySelector('.we-code').value = "";
    const newCb = newRow.querySelector('.check-production');
    if(newCb) { 
        newCb.disabled = false; newCb.checked = false; newCb.onchange = checkAllDone; 
    }
    newRow.querySelector('.target-qty').parentElement.innerHTML = '<small style="color:#666;">â†³ (Split)</small>';
    const btnContainer = newRow.querySelector('.btn-split').parentElement;
    btnContainer.innerHTML = `<button class="btn-sm btn-remove" onclick="removeSplit(this, ${groupId})"><i class="fas fa-trash"></i></button>`;
    const groupRows = tbody.querySelectorAll(`tr[data-id="${groupId}"]`);
    const lastRow = groupRows[groupRows.length-1];
    lastRow.after(newRow);
    qtyInput.onchange = function() { updateCalc(this); };
    if(currentView === 'In Process') checkAllDone();
}

function removeSplit(btn, groupId) {
    const row = btn.closest('tr');
    const tbody = row.parentNode;
    row.remove();
    const remainingSplits = tbody.querySelectorAll(`.split-row[data-id="${groupId}"]`);
    if(remainingSplits.length === 0) {
        const main = tbody.querySelector(`.main-row[data-id="${groupId}"]`);
        main.classList.remove('disabled-row');
        const target = parseInt(main.querySelector('.target-qty').innerText);
        main.querySelector('.qty-input').value = target;
        main.querySelectorAll('select, input').forEach(el => el.disabled = false);
        const cb = main.querySelector('.check-production');
        if(cb) cb.disabled = false;
        updateCalc(main.querySelector('.qty-input'));
    }
    if(currentView === 'In Process') checkAllDone();
}

function updateCalc(input) {
    const row = input.closest('tr');
    if(row.classList.contains('disabled-row')) return;
    const m = parseFloat(row.querySelector('.meter-val').innerText || 0);
    const q = parseInt(input.value || 0);
    row.querySelector('.total-m').innerText = (m * q).toFixed(2);
}

function generateWE(el) {
    const row = el.closest('tr');
    const mach = row.querySelector('.machine-select').value;
    const kpc = row.querySelector('.kpc-select').value;
    const type = TYPE_CODES[row.querySelector('.type-select').value] || 'XX';
    let shortInv = activeOrderId ? String(activeOrderId) : "";
    if (shortInv.length > 5) shortInv = shortInv.slice(-5);
    if(mach && kpc) row.querySelector('.we-code').value = `${mach}_${kpc}_${type}_${shortInv}`;
}

async function submitProduction(mode) {
    const rows = document.querySelectorAll('#setupBody tr:not(.disabled-row)');
    let data = [], valid = true, errorMsg = "";
    
    const groupIds = new Set([...document.querySelectorAll('.main-row')].map(r => r.dataset.id));
    groupIds.forEach(gid => {
        const main = document.querySelector(`.main-row[data-id="${gid}"]`);
        const target = parseInt(main.querySelector('.target-qty').innerText);
        let current = 0;
        document.querySelectorAll(`tr[data-id="${gid}"]:not(.disabled-row)`).forEach(r => {
            let val = parseInt(r.querySelector('.qty-input').value || 0);
            if (val < 0) { valid = false; errorMsg = "Qty tidak boleh minus!"; }
            current += val;
        });
        if (valid && current !== target) {
            valid = false;
            errorMsg = `Total Qty untuk item ${gid+1} harus ${target}, saat ini ${current}.`;
        }
    });
    
    if(!valid) return alert("Validasi Gagal:\n" + errorMsg);

    rows.forEach(r => {
        const type = r.dataset.type;
        const q = r.querySelector('.qty-input')?.value;
        let item = { originalData: r.dataset.original, qty: q, isSplit: r.classList.contains('split-row') };
        if(currentView === 'In Process') item.isFinished = r.querySelector('.check-production')?.checked || false;
        if(type === 'spandek') {
            const m = r.querySelector('.machine-select').value;
            const k = r.querySelector('.kpc-select').value;
            const w = r.querySelector('.we-code').value;
            if(!m || !k) { r.style.backgroundColor = '#fee2e2'; valid = false; errorMsg = "Data Mesin/KPC belum lengkap"; }
            else { item.machine = m; item.kpc = k; item.we = w; }
        }
        data.push(item);
    });
    
    if(!valid) return alert(errorMsg || "Lengkapi Data Mesin/KPC!");
    await sendAPI(mode === 'new' ? 'submitProduction' : 'updateProductionData', { orderId: activeOrderId, category: 'preorder', data: data });
}

async function sendAPI(action, payload) {
    try {
        payload.action = action;
        payload.category = 'preorder';
        const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        const json = await res.json();
        if(json.result === 'error') throw json.message;
        alert("Sukses!"); closeModal('setupModal'); loadData(currentView);
    } catch(e) { alert("Error: " + e); }
}

function generatePDF(type) {
    const o = currentOrders[activeOrderId];
    document.getElementById('pdfOrderNo').innerText = activeOrderId;
    document.getElementById('pdfCustName').innerText = o.customer;
    document.getElementById('pdfDate').innerText = new Date().toLocaleDateString();
    document.getElementById('pdfTitle').innerText = (type === 'SPK') ? "SURAT PERINTAH KERJA" : "SURAT JALAN";
    const headDetail = document.getElementById('pdfHeadDetail');
    const headWE = document.getElementById('pdfHeadWE');
    if (type === 'SJ') { headDetail.innerText = "KETERANGAN"; headWE.style.display = 'none'; } 
    else { headDetail.innerText = "DETAIL MESIN/KPC"; headWE.style.display = 'table-cell'; }
    let itemsToPrint = o.items; 
    const tbody = document.getElementById('pdfItemsBody');
    tbody.innerHTML = '';
    itemsToPrint.forEach((i, idx) => {
        let weCell = (type === 'SPK') ? `<td style="border:1px solid #000; padding:5px;">${i.we||'-'}</td>` : '';
        let detail = (type === 'SPK') ? `${i.machine||'-'} / ${i.kpc||'-'}` : '-';
        tbody.innerHTML += `<tr><td style="border:1px solid #000; text-align:center;">${idx+1}</td><td style="border:1px solid #000;">${i.item}</td><td style="border:1px solid #000; text-align:center;">${i.meter}</td><td style="border:1px solid #000; text-align:center;">${i.qty}</td><td style="border:1px solid #000;">${detail}</td>${weCell}</tr>`;
    });
    html2pdf().set({ margin:0.5, filename:`${type}_${activeOrderId}.pdf` }).from(document.getElementById('pdfContent')).save();
}

// --- CREATE REQUEST LOGIC (MULTI-LINE & QTY BASED SUPPORT) ---
function openCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('createItemsContainer').innerHTML = '';
    document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
    if(globalRemainingData.length === 0) loadData('Remaining').then(() => populateCust());
    else populateCust();
}
function populateCust() {
    const sel = document.getElementById('selCustomer');
    sel.innerHTML = '<option value="">-- Pilih Customer --</option>';
    [...new Set(globalRemainingData.map(d=>d.customer))].sort().forEach(c => {
        let opt = document.createElement('option'); opt.value=c; opt.innerText=c; sel.appendChild(opt);
    });
}

function loadCustomerItemsAggregated(cust) {
    const box = document.getElementById('createItemsContainer'); 
    box.innerHTML = '';
    aggregatedItemsMap = {}; 
    if(!cust) return;

    // 1. Group Data by Item Name & Detect Type (Meter/Qty)
    globalRemainingData.filter(d => d.customer === cust).forEach(po => {
        po.items.forEach(item => {
            let isQtyBased = item.isQtyBased; // Flag dari backend
            let hasBalance = isQtyBased ? (item.remainingMeter > 0) : (item.remainingMeter > 0.1);

            if(!item.isLineClosed && hasBalance) {
                if(!aggregatedItemsMap[item.name]) {
                    aggregatedItemsMap[item.name] = { 
                        name: item.name, 
                        totalRemaining: 0, 
                        isQtyBased: isQtyBased,
                        poList: [] 
                    };
                }
                aggregatedItemsMap[item.name].totalRemaining += item.remainingMeter;
                aggregatedItemsMap[item.name].poList.push({ 
                    poId: po.poId, rowIndex: item.rowIndex, 
                    remaining: item.remainingMeter, 
                    price: item.price, unit: item.unit, type: item.type 
                });
            }
        });
    });

    // 2. Render UI
    Object.keys(aggregatedItemsMap).forEach((itemName, index) => {
        const data = aggregatedItemsMap[itemName];
        const safeName = index;
        const div = document.createElement('div');
        div.className = 'request-item';
        div.dataset.name = itemName;
        div.dataset.safeId = safeName;
        div.dataset.max = data.totalRemaining;
        div.dataset.isQty = data.isQtyBased; 

        // Label Satuan
        let unitLabel = data.isQtyBased ? (data.poList[0].unit || 'Pcs') : 'm';
        // Style untuk menyembunyikan input meter jika QtyBased
        let hideMeterStyle = data.isQtyBased ? 'display:none;' : '';

        div.innerHTML = `
            <div class="request-header">
                <strong>${itemName}</strong>
                <span class="balance-text">Saldo Tersedia: ${data.totalRemaining.toFixed(2)} ${unitLabel}</span>
            </div>
            <div class="rows-container" id="rows-${safeName}">
                <div class="input-row">
                    <div style="${hideMeterStyle}">
                        <label>P (m):</label>
                        <input type="number" class="prod-input inp-meter" step="0.01" min="0" placeholder="Panjang" onkeyup="calcMultiTotal('${safeName}')">
                    </div>
                    <label>Qty:</label>
                    <input type="number" class="prod-input inp-qty" step="1" min="0" placeholder="Lembar/Btg" onkeyup="calcMultiTotal('${safeName}')">
                    <div style="flex:1;"></div>
                    <button class="row-remove-btn" onclick="removeRequestRow(this, '${safeName}')" title="Hapus Baris"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            <button class="btn-add-line" onclick="addRequestRow('${safeName}')"><i class="fas fa-plus"></i> Tambah Ukuran</button>
            <div class="item-summary">
                Total Request: <span class="calc-res" id="total-${safeName}">0.00</span> ${unitLabel}
            </div>
        `;
        box.appendChild(div);
    });
}

function addRequestRow(safeId) {
    const container = document.getElementById(`rows-${safeId}`);
    const parent = container.closest('.request-item');
    const isQtyBased = parent.dataset.isQty === "true";
    let hideMeterStyle = isQtyBased ? 'display:none;' : '';
    
    const div = document.createElement('div');
    div.className = 'input-row';
    div.innerHTML = `
        <div style="${hideMeterStyle}">
            <label>P (m):</label>
            <input type="number" class="prod-input inp-meter" step="0.01" min="0" placeholder="Panjang" onkeyup="calcMultiTotal('${safeId}')">
        </div>
        <label>Qty:</label>
        <input type="number" class="prod-input inp-qty" step="1" min="0" placeholder="Lembar/Btg" onkeyup="calcMultiTotal('${safeId}')">
        <div style="flex:1;"></div>
        <button class="row-remove-btn" onclick="removeRequestRow(this, '${safeId}')" title="Hapus Baris"><i class="fas fa-trash"></i></button>
    `;
    container.appendChild(div);
}

function removeRequestRow(btn, safeId) {
    btn.closest('.input-row').remove();
    calcMultiTotal(safeId);
}

function calcMultiTotal(safeId) {
    const container = document.getElementById(`rows-${safeId}`);
    const parent = container.closest('.request-item');
    const maxBalance = parseFloat(parent.dataset.max);
    const isQtyBased = parent.dataset.isQty === "true"; 
    const totalDisplay = document.getElementById(`total-${safeId}`);
    
    let totalUsed = 0;
    container.querySelectorAll('.input-row').forEach(row => {
        const m = parseFloat(row.querySelector('.inp-meter')?.value) || 0;
        const qRaw = row.querySelector('.inp-qty').value;
        let q = parseFloat(qRaw) || 0;
        if(qRaw.includes('.')) { row.querySelector('.inp-qty').value = Math.floor(q); q = Math.floor(q); }
        
        // FIX: Jika Qty Based, total adalah SUM Qty. Jika Spandek, SUM (Meter * Qty)
        if (isQtyBased) {
             totalUsed += q;
        } else {
             totalUsed += (m * q);
        }
    });

    totalDisplay.innerText = totalUsed.toFixed(2);
    const btn = document.getElementById('btnSubmitRequest');

    if(totalUsed > maxBalance + 0.05) {
        totalDisplay.classList.add('over-limit');
        totalDisplay.innerText += " (OVER LIMIT!)";
        parent.style.border = "1px solid red";
        parent.style.background = "#fee2e2";
        btn.disabled = true;
    } else {
        totalDisplay.classList.remove('over-limit');
        parent.style.border = "1px solid #e5e7eb";
        parent.style.background = "#fff";
        btn.disabled = false;
    }
    
    const allOver = document.querySelectorAll('.over-limit');
    if(allOver.length > 0) btn.disabled = true;
}

async function submitRequestAggregated() {
    const cust = document.getElementById('selCustomer').value;
    const dateVal = document.getElementById('inpDate').value;
    if(!cust || !dateVal) return alert("Mohon Pilih Customer & Tanggal Delivery!");

    let requestItems = []; 
    let isValid = true;
    let hasItems = false;

    document.querySelectorAll('.request-item').forEach(div => {
        const itemName = div.dataset.name;
        const maxBalance = parseFloat(div.dataset.max);
        const isQtyBased = div.dataset.isQty === "true";
        let itemTotalUsed = 0;

        const rows = div.querySelectorAll('.input-row');
        rows.forEach(row => {
            const reqLen = parseFloat(row.querySelector('.inp-meter')?.value) || 0;
            const reqQty = parseFloat(row.querySelector('.inp-qty').value) || 0;
            
            // Hitung deduction value berdasarkan tipe
            const deductionValue = isQtyBased ? reqQty : (reqLen * reqQty);

            if (reqQty < 0) { isValid = false; }
            if (!isQtyBased && reqLen < 0) { isValid = false; }

            if (deductionValue > 0) {
                hasItems = true;
                itemTotalUsed += deductionValue;
                const refData = aggregatedItemsMap[itemName] && aggregatedItemsMap[itemName].poList[0];
                
                requestItems.push({
                    itemName: itemName,
                    length: isQtyBased ? 0 : reqLen,
                    qty: reqQty,
                    totalDeduction: deductionValue, // Backend akan membaca ini
                    isQtyBased: isQtyBased,
                    type: refData ? refData.type : '',
                    unit: refData ? refData.unit : ''
                });
            }
        });

        if (itemTotalUsed > maxBalance + 0.05) {
            isValid = false;
            div.style.background = "#fee2e2";
        }
    });

    if(!isValid) return alert("Gagal: Ada input minus atau melebihi sisa saldo!");
    if(!hasItems) return alert("Gagal: Belum ada item yang diisi.");

    const btn = document.getElementById('btnSubmitRequest');
    const originalText = btn.innerText;
    
    try {
        btn.disabled = true; 
        btn.innerText = "Processing Backend...";
        const payload = {
            action: 'submitPreorderRequest',
            data: { customer: cust, estDelivery: dateVal, items: requestItems }
        };
        const req = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
        const res = await req.json();

        if(res.result === 'success') {
            alert("Request Berhasil Dibuat! \nID: " + res.orderId);
            closeModal('createModal'); 
            loadData('Awaiting'); 
            loadData('Remaining').then(d => globalRemainingData = d);
        } else {
            throw new Error(res.message || "Unknown Error from Backend");
        }
    } catch(e) {
        console.error(e);
        alert("Terjadi Kesalahan: " + e.message);
    } finally {
        btn.disabled = false; 
        btn.innerText = originalText;
    }
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
