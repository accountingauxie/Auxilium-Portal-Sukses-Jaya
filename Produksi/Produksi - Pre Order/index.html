<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Pre-Order Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
/* CSS MINIMALIS */
:root { --primary: #7e22ce; --bg: #f4f7f6; --text: #333; }
body { margin: 0; font-family: "Arial", sans-serif; font-size: 13px; background: var(--bg); color: var(--text); }
.page-wrap { padding: 30px; max-width: 1200px; margin: 0 auto; }
.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; font-size: 12px; font-weight: bold; text-transform: uppercase; }
td { padding: 12px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
.btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; color: white; background: var(--primary); }
.btn-sec { background: #fff; color: #333; border: 1px solid #ccc; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 1000; padding-top: 50px; }
.modal-box { background: #fff; width: 850px; max-width: 95%; border-radius: 8px; padding: 20px; }
.inp-sm { padding:5px; border:1px solid #ccc; border-radius:3px; }
</style>
</head>
<body>

<div class="page-wrap">
    <h2>Daftar Pre-Order (Bulk)</h2>
    <div style="margin-bottom:15px; display:flex; justify-content:space-between;">
        <div>
            <button class="btn btn-sec" onclick="switchTab('Open')">Open & Partial</button>
            <button class="btn btn-sec" onclick="switchTab('Closed')">History Closed</button>
            <button class="btn" onclick="loadData()">Refresh</button>
        </div>
        <a href="produksi_general.html" style="text-decoration:none; color:#7e22ce; font-weight:bold;">Ke General Production &rarr;</a>
    </div>

    <div class="table-card">
        <table id="poTable">
            <thead>
                <tr><th>No. PO</th><th>Customer</th><th>Date</th><th>Progress</th><th>Status</th><th>Action</th></tr>
            </thead>
            <tbody id="tableBody"><tr><td colspan="6" style="text-align:center;">Loading...</td></tr></tbody>
        </table>
    </div>
</div>

<div id="prodModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Produksi Partial: <span id="modalTitle"></span></h3>
        <div id="modalItems" style="max-height:60vh; overflow-y:auto; margin-bottom:20px;"></div>
        <div style="text-align:right;">
            <button class="btn btn-sec" onclick="closeModal()">Close</button>
            <button class="btn" onclick="submitProduction()" id="btnSubmit">Submit ke Produksi</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/accountingauxie/Auxilium-Portal-Sukses-Jaya/assets/config.js"></script>

<script>
const SCRIPT_URL = window.GAS_URL;
if (!SCRIPT_URL) alert("Error: GAS_URL tidak ditemukan. Cek config.js.");

let currentData = [];
let activePO = null;
let currentTab = 'Open';

window.onload = loadData;

function switchTab(tab) {
    currentTab = tab;
    loadData(); 
}

async function loadData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading Data...</td></tr>';
    
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getPreOrders&status=${currentTab}`);
        const result = await response.json();
        
        if (result.error) {
             tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Backend Error: ${result.message}</td></tr>`;
             return;
        }

        currentData = result;
        renderTable(currentData);
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Connection Error: ${err}.</td></tr>`;
    }
}

function renderTable(data) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if(!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">Tidak ada data.</td></tr>';
        return;
    }

    data.forEach(po => {
        let total = 0, done = 0;
        po.items.forEach(i => { total += i.totalMeter; done += i.processedMeter; });
        let pct = total > 0 ? (done/total)*100 : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${po.poId}</td>
            <td>${po.customer}</td>
            <td>${po.date}</td>
            <td>${done.toFixed(2)} / ${total.toFixed(2)} m (${pct.toFixed(0)}%)</td>
            <td>${po.status}</td>
            <td>${po.status !== 'Closed' ? `<button class="btn" style="font-size:11px;" onclick="openModal('${po.poId}')">Produksi</button>` : 'Done'}</td>
        `;
        tbody.appendChild(tr);
    });
}

function openModal(poId) {
    activePO = currentData.find(p => p.poId === poId);
    document.getElementById('modalTitle').innerText = poId;
    const container = document.getElementById('modalItems');
    container.innerHTML = '';

    activePO.items.forEach(item => {
        if(item.isLineClosed) return;
        const remain = item.totalMeter - item.processedMeter;
        
        const div = document.createElement('div');
        div.style.border = "1px solid #eee"; div.style.padding="10px"; div.style.marginBottom="10px";
        div.dataset.rowIndex = item.rowIndex; 
        div.dataset.itemName = item.name;

        div.innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <b>${item.name}</b>
                <span>Sisa: <b style="color:red">${remain.toFixed(2)}m</b></span>
            </div>
            <div style="margin-top:5px; font-size:12px;">Input Potongan:</div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="number" placeholder="Panjang (m)" class="inp-sm inp-len" style="width:100px">
                <input type="number" placeholder="Qty (Lembar)" class="inp-sm inp-qty" style="width:100px">
            </div>
        `;
        container.appendChild(div);
    });
    document.getElementById('prodModal').style.display = 'flex';
}

function closeModal() { document.getElementById('prodModal').style.display = 'none'; }

async function submitProduction() {
    let batches = [];
    const items = document.querySelectorAll('[data-row-index]');
    
    items.forEach(div => {
        const len = parseFloat(div.querySelector('.inp-len').value) || 0;
        const qty = parseFloat(div.querySelector('.inp-qty').value) || 0;
        if(len > 0 && qty > 0) {
            batches.push({
                rowIndex: div.dataset.rowIndex,
                itemName: div.dataset.itemName,
                length: len, qty: qty, totalMeter: len * qty
            });
        }
    });

    if(batches.length === 0) return alert("Isi minimal 1 data produksi.");
    
    const btn = document.getElementById('btnSubmit');
    const oriText = btn.innerText;
    btn.innerText = "Processing...";
    btn.disabled = true;
    
    try {
        const payload = { poId: activePO.poId, customer: activePO.customer, batches: batches };
        const res = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'submitPartialPO', data: payload }) 
        });
        const json = await res.json();
        
        if(json.result === 'success') {
            alert("Sukses! Data dikirim ke Awaiting Production.");
            closeModal();
            loadData();
        } else {
            alert("Error: " + json.message);
        }
    } catch(e) { alert("Error: " + e); }
    finally { btn.innerText = oriText; btn.disabled = false; }
}
</script>
</body>
</html>
