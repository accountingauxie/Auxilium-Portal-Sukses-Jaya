<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Production Entry - Auxilium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
/* =========================================
   1. GLOBAL VARIABLES & RESET
   ========================================= */
:root { 
  --primary-color: #116999; 
  --primary-hover: #0e5a85;
  --bg-color: #f8fafc; 
  --text-color: #333; 
  --border-color: #eaecf0;
  --red-bg: #fee2e2; 
  --red-text: #991b1b;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
}

* { box-sizing: border-box; outline: none; }
body { margin: 0; background: var(--bg-color); font-family: 'Inter', sans-serif; font-size: 14px; color: var(--text-color); -webkit-font-smoothing: antialiased; }

/* =========================================
   2. NAVBAR STYLES (Uniform Standard)
   ========================================= */
.aux-navbar {
    background-color: #ffffff; height: 70px; display: flex; align-items: center; justify-content: space-between;
    padding: 0 32px; box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 1000;
}
.aux-logo img { height: 32px; width: auto; }
.aux-menu { display: flex; gap: 4px; align-items: center; height: 100%; }
.nav-item { position: relative; height: 100%; display: flex; align-items: center; }

/* Link Style */
.aux-link { 
    text-decoration: none; color: #475467; font-weight: 600; font-size: 14px; 
    padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;
    display: flex; align-items: center; gap: 6px;
}
.aux-link:hover, .nav-item:hover .aux-link { background-color: #f2f4f7; color: #101828; }
.aux-link.active { background-color: #eff8ff; color: var(--primary-color); font-weight: 700; }
.chevron-down { width: 14px; height: 14px; transition: transform 0.2s; }
.nav-item:hover .chevron-down { transform: rotate(180deg); }

/* Dropdown */
.dropdown-menu {
    visibility: hidden; opacity: 0; position: absolute; top: 100%; left: 0;
    background: white; min-width: 240px; border: 1px solid var(--border-color);
    border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    padding: 8px; z-index: 1001; transform: translateY(10px); transition: all 0.2s ease-in-out;
}
.nav-item:hover .dropdown-menu { visibility: visible; opacity: 1; transform: translateY(0); margin-top: -10px; }
.dropdown-item { display: flex; align-items: center; padding: 10px 12px; color: #344054; text-decoration: none; font-size: 14px; border-radius: 6px; transition: background 0.2s; }
.dropdown-item:hover { background-color: #f9fafb; color: var(--primary-color); }
.dropdown-header { font-size: 11px; text-transform: uppercase; color: #98a2b3; font-weight: 600; padding: 8px 12px 4px; }
.dropdown-divider { height: 1px; background-color: #eaecf0; margin: 6px 0; }

/* User Panel */
.user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid var(--border-color); margin-left: 10px; }
.user-details { display: flex; flex-direction: column; text-align: right; line-height: 1.3; }
.user-name { font-weight: 700; font-size: 13px; color: #101828; }
.user-role { font-size: 11px; color: #667085; }
.user-avatar { width: 36px; height: 36px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; border: 2px solid #e0f2fe; }
.logout-btn { background: none; border: 1px solid var(--border-color); color: #666; width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.logout-btn:hover { background-color: var(--red-bg); color: var(--red-text); border-color: var(--red-bg); }

/* --- LOGOUT MODAL --- */
.modal { display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
.modal-content { background-color: #fff; margin: 15% auto; padding: 32px; border-radius: 16px; width: 360px; text-align: center; }
.modal-buttons { display: flex; justify-content: center; gap: 12px; margin-top: 24px; }
.btn-modal { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; }
.btn-yes { background-color: #d92d20; color: #fff; }
.btn-cancel { background-color: #f2f4f7; color: #344054; }

/* =========================================
   3. PAGE CONTENT STYLES
   ========================================= */
.page { max-width: 1400px; margin: 40px auto; padding: 0 24px; }
.card { background: #fff; border-radius: 12px; box-shadow: var(--shadow-sm); padding: 32px; border: 1px solid var(--border-color); }
.card-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #101828; display: flex; justify-content: space-between; align-items: center; }

/* FORMS */
label { font-size: 12px; font-weight: 600; color: #344054; display: block; margin-bottom: 6px; }
.input-box { width: 100%; height: 40px; padding: 0 12px; font-size: 14px; border: 1px solid #d0d5dd; border-radius: 8px; background: #fff; color: #101828; transition: all 0.2s; box-shadow: 0 1px 2px rgba(16, 24, 40, 0.05); }
.input-box:focus { border-color: #84CAFF; box-shadow: 0 0 0 4px #F2F4F7; outline: none; }
.input-box[readonly] { background: #f9fafb; color: #667085; cursor: not-allowed; border-color: #eaecf0; }
.row-flex { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 28px; }

/* TABLE */
table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
th { background: #f9fafb; padding: 12px 16px; font-size: 12px; font-weight: 600; color: #475467; border-bottom: 1px solid var(--border-color); text-align: left; }
td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); background: #fff; vertical-align: top; }
tr:last-child td { border-bottom: none; }
.hidden-col { display: none; }

.table-input { width: 100%; height: 38px; border: 1px solid #d0d5dd; border-radius: 6px; padding: 0 10px; font-size: 13.5px; }
.table-input:focus { border-color: var(--primary-color); outline: none; }
.we-number { background: #f8fafc; border: 1px solid #e2e8f0; color: #475569; font-weight: 600; font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; }

/* BUTTONS */
.action-btn { border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; height: 40px; }
.add-row-btn { background: #fff; color: var(--primary-color); border: 1px dashed #b2ddff; width: 100%; margin-top: 10px; }
.add-row-btn:hover { background: #eff8ff; border-color: var(--primary-color); }
.submit-btn { background: var(--primary-color); color: #fff; padding: 0 32px; float: right; margin-top: 16px; box-shadow: 0 1px 2px rgba(16, 24, 40, 0.05); }
.submit-btn:hover { background: var(--primary-hover); }
.view-list-btn { float: left; margin-top: 16px; background: #fff; color: #344054; border: 1px solid #d0d5dd; text-decoration: none; padding: 0 20px; box-shadow: 0 1px 2px rgba(16, 24, 40, 0.05); }
.view-list-btn:hover { background: #f9fafb; color: #1d2939; }

.delete-btn { color: #98a2b3; cursor: pointer; padding: 8px; border-radius: 6px; transition: 0.2s; text-align: center; font-size: 16px; height: 38px; display: flex; align-items: center; justify-content: center; }
.delete-btn:hover { color: var(--red-text); background: var(--red-bg); }
.row-handle { cursor: grab; color: #d0d5dd; text-align: center; vertical-align: middle; font-size: 18px; width: 30px; padding-top: 18px; }

/* UTILS */
textarea { width: 100%; border: 1px solid #d0d5dd; border-radius: 8px; padding: 12px; font-family: inherit; font-size: 14px; resize: vertical; min-height: 100px; transition: all 0.2s; }
textarea:focus { border-color: #84CAFF; box-shadow: 0 0 0 4px #F2F4F7; outline: none; }

#loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.85); display: none; justify-content: center; align-items: center; z-index: 10001; backdrop-filter: blur(2px); }
.spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Choices.js Custom Overrides */
.choices { margin-bottom: 0; }
.choices__inner { min-height: 38px !important; padding: 0 8px !important; border: 1px solid #d0d5dd !important; background-color: #fff !important; border-radius: 6px !important; display: flex !important; align-items: center !important; font-size: 13.5px !important; box-shadow: none !important; }
.choices.is-focused .choices__inner { border-color: var(--primary-color) !important; box-shadow: 0 0 0 3px rgba(17, 105, 153, 0.1) !important; }
.choices__input { background: transparent !important; border: none !important; }
.choices__list--dropdown { border: 1px solid #d0d5dd !important; border-radius: 8px !important; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important; margin-top: 4px !important; z-index: 9000 !important; }
.choices__item--choice { padding: 8px 12px !important; font-size: 13px !important; }

/* KPC Balance Badge */
.kpc-balance { float: right; font-size: 11px; background: #eff8ff; color: var(--primary-color); padding: 2px 8px; border-radius: 99px; font-weight: 600; border: 1px solid #b2ddff; }
</style>
</head>

<body>
<div id="loadingOverlay"><div class="spinner"></div></div>

<div class="aux-navbar">
    <div class="aux-logo">
        <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo">
    </div>
    
    <nav class="aux-menu">
        <div class="nav-item">
            <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/" class="aux-link">Home</a>
        </div>

        <div class="nav-item">
            <div class="aux-link">
                Penjualan 
                <i data-feather="chevron-down" class="chevron-down"></i>
            </div>
            <div class="dropdown-menu">
                <div class="dropdown-header">Sales Orders</div>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Order%20Penjualan/index.html" class="dropdown-item">Order Penjualan</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Review%20Penjualan/review_penjualan.html" class="dropdown-item">Review Penjualan</a>
            </div>
        </div>

        <div class="nav-item">
            <div class="aux-link">
                Pembelian
                <i data-feather="chevron-down" class="chevron-down"></i>
            </div>
            <div class="dropdown-menu">
                <div class="dropdown-header">Purchasing</div>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/PurchaseOrder/index.html" class="dropdown-item">Pemesanan Pembelian</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html" class="dropdown-item">Penerimaan Barang (Entry)</a>
                
                <div class="dropdown-divider"></div>
                
                <div class="dropdown-header">Finance</div>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/CreateBill/index.html" class="dropdown-item">Daftar Tagihan (Bill)</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/ImportXeroPO/index.html" class="dropdown-item">Import Xero PO</a>
            </div>
        </div>

        <div class="nav-item">
            <div class="aux-link active">
                Produksi
                <i data-feather="chevron-down" class="chevron-down"></i>
            </div>
            <div class="dropdown-menu">
                <div class="dropdown-header">Input Mesin</div>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Produksi/Produksi%20-%20Back%20Order/produksi_backorder.html" class="dropdown-item">Back Order</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Produksi/Produksi%20-%20General%20Order/produksi_general.html" class="dropdown-item">General Order</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Produksi/Produksi%20-%20Pre%20Order/produksi_preorder.html" class="dropdown-item">Pre Order</a>

                <div class="dropdown-divider"></div>
                
                <div class="dropdown-header">Hasil Produksi</div>
                <a href="#" class="dropdown-item" style="color:var(--primary-color); font-weight:600; background:#f9fafb;">Input Hasil Produksi (Entry)</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/daftarproduksi/index.html" class="dropdown-item">List Barang Jadi</a>
            </div>
        </div>

        <div class="nav-item">
            <div class="aux-link">
                Persediaan
                <i data-feather="chevron-down" class="chevron-down"></i>
            </div>
            <div class="dropdown-menu">
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/inventory/index.html" class="dropdown-item">Cek Stok Inventory</a>
            </div>
        </div>
    </nav>

    <div class="user-panel">
        <div class="user-details">
            <span class="user-name">Admin Gudang</span>
            <span class="user-role">CV Sukses Jaya</span>
        </div>
        <div class="user-avatar">AG</div>
        <button class="logout-btn" onclick="showLogoutModal()" title="Keluar Akun">
            <i data-feather="log-out" style="width:16px; height:16px;"></i>
        </button>
    </div>
</div>

<div id="logoutModal" class="modal">
    <div class="modal-content">
      <div style="background:#fee2e2; width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
        <i data-feather="alert-circle" style="color:#d92d20;"></i>
      </div>
      <p style="font-size:18px; font-weight:600; color:#101828; margin-bottom:10px; margin-top:0;">Konfirmasi Keluar</p>
      <p style="color:#667085; font-size:14px; margin-bottom:24px;">Apakah Anda yakin ingin keluar dari sistem?</p>
      <div class="modal-buttons">
        <button class="btn-modal btn-cancel" onclick="closeLogoutModal()">Batal</button>
        <button class="btn-modal btn-yes" onclick="logout()">Keluar</button>
      </div>
    </div>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">
      <div>
          Input Hasil Produksi
          <p style="font-size:13px; font-weight:400; color:#667085; margin-top:4px;">Masukkan data hasil produksi barang jadi untuk digenerate menjadi SPK.</p>
      </div>
      <span style="font-size:12px; font-weight:600; color:#027a48; background:#ecfdf5; padding:6px 12px; border-radius:20px; border:1px solid #d1fadf;">
          <i class="fas fa-plus-circle mr-1"></i> New Entry
      </span>
    </div>

    <div class="row-flex">
      <div>
        <label>Tanggal Produksi</label>
        <input type="date" id="productionDate" class="input-box">
      </div>
      <div>
        <label>Production Entry ID</label>
        <input type="text" id="entryId" class="input-box" readonly placeholder="Generating ID...">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:40px;"></th>
          <th style="width:22%;">Machine</th> 
          <th style="width:22%;">Item</th>
          <th class="hidden-col">Meter</th>
          <th class="hidden-col">Qty</th>
          <th class="hidden-col">Total</th>
          <th style="width:25%;">KPC</th> 
          <th>WE Number</th>
          <th style="width:50px;"></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <button class="action-btn add-row-btn" onclick="addRow()">
        <i class="fas fa-plus mr-2"></i> Tambah Baris
    </button>
    
    <div style="margin-top: 24px;">
      <label>Catatan Tambahan (Opsional)</label>
      <textarea id="notes" placeholder="Contoh: Produksi prioritas untuk Order #123..."></textarea>
    </div>
    
    <div style="margin-top:24px; border-top:1px solid #eaecf0; padding-top:24px;">
      <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/daftarproduksi/index.html" class="view-list-btn action-btn">
        <i class="fas fa-list mr-2"></i> Lihat Daftar
      </a>

      <button class="action-btn submit-btn" onclick="submitForm()">
          Simpan Data
      </button>
      
      <div style="clear:both;"></div>
    </div>
  </div>
</div>

<script>
// --- INITIALIZE ICONS ---
feather.replace();

// --- LOGOUT LOGIC ---
function showLogoutModal() { document.getElementById("logoutModal").style.display = "block"; }
function closeLogoutModal() { document.getElementById("logoutModal").style.display = "none"; }
// Close modal if clicked outside
window.onclick = function(event) {
    if (event.target == document.getElementById("logoutModal")) {
        closeLogoutModal();
    }
}
function logout() {
    document.getElementById("loadingOverlay").style.display = "flex";
    setTimeout(() => {
        localStorage.removeItem("uxilium_current_user");
        window.location.href = "login.html"; 
    }, 800);
}

// --- APP LOGIC ---
// !!! PERHATIKAN: URL INI HARUS DIGANTI JIKA ADA DEPLOYMENT BARU !!!
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwL7aC8V1yubOABo4Te-UduMin9pWJDVS8Jo0TIUEvc00Xp7NuGIYO3LZ8A9BqN-g0lug/exec";

let allItemsData = []; 
let allKPCData = [];    
let uniqueMachines = [];

/* --- INITIAL LOAD --- */
window.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("loadingOverlay").style.display = "flex";
  
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("productionDate").value = `${yyyy}-${mm}-${dd}`;

  await loadNextEntryId();  

  try {
    const [itemRes, kpcRes] = await Promise.all([
      fetch(`${SCRIPT_URL}?action=getitem`),
      fetch(`${SCRIPT_URL}?action=getkpc`)
    ]);

    allItemsData = await itemRes.json();
    allKPCData = await kpcRes.json(); 

    const machinesSet = new Set(allItemsData.map(i => i.machine).filter(m => m));
    uniqueMachines = Array.from(machinesSet).sort();

    addRow(); 
    setupSortable();
  } catch (e) {
    Swal.fire({
        icon: 'error',
        title: 'Gagal Memuat Data',
        text: 'Mohon periksa koneksi internet Anda.',
        confirmButtonColor: '#ef4444'
    });
    console.error(e);
  }
  document.getElementById("loadingOverlay").style.display = "none";
});

/* --- ROW MANAGEMENT --- */
function addRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td class="row-handle"><i class="fas fa-grip-vertical"></i></td>
    <td><select class="machine-select"></select></td>
    <td><select class="item-select"></select></td>
    <td class="hidden-col"><input class="table-input meter" type="number" value="0"></td>
    <td class="hidden-col"><input class="table-input qty" type="number" value="0"></td>
    <td class="hidden-col"><input class="table-input total" type="number" value="0"></td>
    <td><select class="kpc-select"></select></td>
    <td><input class="table-input we-number" readonly placeholder="Auto Generated..."></td>
    <td class="delete-cell">
       <div class="delete-btn" onclick="removeRow(this)"><i class="fas fa-trash-alt"></i></div>
    </td>
  `;
  document.getElementById("tableBody").appendChild(row);

  const machineSelect = row.querySelector(".machine-select");
  const itemSelect = row.querySelector(".item-select");
  const kpcSelect = row.querySelector(".kpc-select");

  initChoices(machineSelect, uniqueMachines.map(m => ({value: m, label: m})), "Select Machine");
  initChoices(itemSelect, [], "Select Machine First");
  initChoices(kpcSelect, [], "Select Item First", true); 

  // EVENT: Machine Change
  machineSelect.addEventListener("change", function(e) {
    updateDropdown(itemSelect, [], "Select Machine First");
    updateDropdown(kpcSelect, [], "Select Item First", true);
    row.querySelector(".we-number").value = "";

    if (e.target.value) {
      const filtered = allItemsData
        .filter(i => i.machine === e.target.value)
        .map(i => ({ value: i.name, label: i.name }));
      updateDropdown(itemSelect, filtered, "Select Item");
    }
  });

  // EVENT: Item Change (Filter KPC options)
  itemSelect.addEventListener("change", function(e) {
    const selectedItem = e.target.value;
    let placeholder = "Select Item First";
    
    row.querySelector(".we-number").value = ""; 
    
    let kpcOptions = [];
    if (selectedItem) {
        placeholder = "Select KPC";
        kpcOptions = allKPCData.filter(k => k.relatedItem === selectedItem);
    }

    refreshKPCOptionsForElement(kpcSelect, kpcOptions, placeholder);
  });

  // EVENT: KPC Change (Trigger WE Number)
  kpcSelect.addEventListener("change", function(e) {
      calculateWENumber(row); 
  });
}

function removeRow(btn) {
  const row = btn.closest('tr');
  if(document.querySelectorAll('#tableBody tr').length > 1) {
    row.remove();
  }
}

/* --- LOGIC: WE NUMBER GENERATOR --- */
function calculateWENumber(row) {
    const machine = row.querySelector(".machine-select").value;
    const item = row.querySelector(".item-select").value;
    const kpc = row.querySelector(".kpc-select").value;
    const prodId = document.getElementById("entryId").value; 
    const weInput = row.querySelector(".we-number");

    if(!machine || !item || !kpc || !prodId) {
        weInput.value = "";
        return;
    }

    // 1. Machine Code
    let machineCode = "XX";
    const mUpper = machine.toUpperCase();
    if(mUpper.includes("RENG")) machineCode = "RG";
    else if(mUpper.includes("TRUSS")) machineCode = "TS";
    else machineCode = mUpper.substring(0,2);

    const machineDigits = machine.match(/\d+/);
    const machineNum = machineDigits ? machineDigits[0].slice(-2) : "00";
    const finalMachineSegment = machineCode + machineNum;

    // 2. Item Suffix
    const itemDigitsMatch = item.match(/\d+/g); 
    let itemSuffix = "00";
    if(itemDigitsMatch && itemDigitsMatch.length > 0) {
        const lastGroup = itemDigitsMatch[itemDigitsMatch.length - 1];
        itemSuffix = lastGroup.slice(-2);
    }

    // 3. ID Suffix
    const idSuffix = prodId.slice(-3); 

    // Format: Machine_KPC_010_ItemSuffix
    weInput.value = `${finalMachineSegment}_${kpc}_${idSuffix}_${itemSuffix}`;
}

/* --- LOGIC: PREVENT DUPLICATE KPC --- */
function refreshKPCOptionsForElement(el, rawData, placeholder) {
    const allSelects = document.querySelectorAll(".kpc-select");
    const usedValues = [];
    allSelects.forEach(sel => {
        if(sel !== el && sel.value) { 
            usedValues.push(sel.value);
        }
    });

    const filteredOptions = rawData
        .filter(k => !usedValues.includes(k.name))
        .map(k => {
            const formattedSisa = new Intl.NumberFormat('id-ID').format(k.sisa || 0);
            return {
                value: k.name,              
                label: k.name,              
                customProperties: { sisa: formattedSisa }
            };
        });

    updateDropdown(el, filteredOptions, placeholder, true);
}


/* --- CHOICES HELPER --- */
function updateDropdown(el, options, placeholder, useTemplate = false) {
  if (el.choicesInstance) {
    el.choicesInstance.destroy();
    el.choicesInstance = null;
  }
  el.innerHTML = ""; 
  initChoices(el, options, placeholder, useTemplate);
}

function initChoices(el, options, placeholder, useTemplate = false) {
  const config = {
    searchEnabled: true,
    itemSelectText: "",
    shouldSort: false,
    placeholder: true,
    placeholderValue: placeholder,
    allowHTML: true,
    removeItemButton: true, 
  };

  if (useTemplate) {
    config.callbackOnCreateTemplates = function(template) {
      return {
        item: ({ classNames }, data) => {
          return template(`
            <div class="${classNames.item} ${classNames.itemChoice} ${classNames.itemSelectable}" data-item data-id="${data.id}" data-value="${data.value}" ${data.active ? 'aria-selected="true"' : ''} ${data.disabled ? 'aria-disabled="true"' : ''}>
              ${data.label}
            </div>
          `);
        },
        choice: ({ classNames }, data) => {
          const sisa = data.customProperties && data.customProperties.sisa 
                        ? `<span class="kpc-balance">Sisa: ${data.customProperties.sisa}</span>` 
                        : '';
          
          return template(`
            <div class="${classNames.item} ${classNames.itemChoice} ${data.disabled ? classNames.itemDisabled : classNames.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${data.disabled ? 'data-choice-disabled aria-disabled="true"' : 'data-choice-selectable'} data-id="${data.id}" data-value="${data.value}" ${data.groupId > 0 ? 'role="treeitem"' : 'role="option"'}>
              <span style="font-weight:600; color:#1e293b;">${data.label}</span> ${sisa}
            </div>
          `);
        },
      };
    };
  }

  const choices = new Choices(el, config);
  if(options.length > 0) {
      choices.setChoices(options, 'value', 'label', true);
  }
  el.choicesInstance = choices;
}

/* --- SERVER LOGIC --- */
async function loadNextEntryId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastid`);
    const data = await res.json();
    const today = new Date();
    const prefix = `FGP${String(today.getFullYear()).slice(2)}${String(today.getMonth()+1).padStart(2,"0")}`;
    const lastId = data.lastId;
    
    let nextId = prefix + "0000001";
    if (lastId && lastId.startsWith(prefix)) {
      const num = parseInt(lastId.substring(7), 10);
      nextId = prefix + String(num + 1).padStart(7, "0");
    }
    document.getElementById("entryId").value = nextId;
  } catch(e) {}
}

/* --- SUBMIT LOGIC --- */
function submitForm() {
  const dateVal = document.getElementById("productionDate").value;
  
  // Validation 1: Date
  if (!dateVal) {
    Swal.fire({
      icon: 'warning',
      title: 'Tanggal Kosong',
      text: 'Mohon pilih tanggal produksi.',
      confirmButtonColor: '#116999'
    });
    return;
  }
  
  const rows = document.querySelectorAll("#tableBody tr");
  // Validation 2: Rows
  if (!rows.length) {
    Swal.fire({
      icon: 'warning',
      title: 'Daftar Kosong',
      text: 'Mohon tambahkan setidaknya satu baris item.',
      confirmButtonColor: '#116999'
    });
    return;
  }

  const items = [];
  let isValid = true;

  rows.forEach(r => {
    const mSelect = r.querySelector(".machine-select");
    const iSelect = r.querySelector(".item-select");
    const kSelect = r.querySelector(".kpc-select");
    
    const m = mSelect.choicesInstance ? mSelect.choicesInstance.getValue(true) : mSelect.value;
    const i = iSelect.choicesInstance ? iSelect.choicesInstance.getValue(true) : iSelect.value;
    const k = kSelect.choicesInstance ? kSelect.choicesInstance.getValue(true) : kSelect.value;
    const we = r.querySelector(".we-number").value;

    if(!m || !i || !k) {
        isValid = false;
        // Visual indicator for invalid fields
        if(!m) mSelect.closest('.choices').style.borderColor = "#ef4444";
        if(!i) iSelect.closest('.choices').style.borderColor = "#ef4444";
        if(!k) kSelect.closest('.choices').style.borderColor = "#ef4444";
    }

    items.push({ 
        machine: m, 
        item: i, 
        kpc: k, 
        weNumber: we,
        meter: r.querySelector(".meter").value, 
        qty: r.querySelector(".qty").value, 
        total: r.querySelector(".total").value 
    });
  });

  if (!isValid) {
    Swal.fire({
      icon: 'error',
      title: 'Data Belum Lengkap',
      text: 'Mohon lengkapi Mesin, Item, dan KPC pada setiap baris.',
      confirmButtonColor: '#ef4444'
    });
    return;
  }

  Swal.fire({
    title: 'Simpan Entry?',
    text: "Pastikan data sudah benar. Data akan masuk ke antrian produksi.",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#116999',
    cancelButtonColor: '#f2f4f7',
    confirmButtonText: 'Ya, Simpan!',
    cancelButtonText: '<span style="color:#333">Batal</span>',
    reverseButtons: true
  }).then((result) => {
    if (result.isConfirmed) {
      document.getElementById("loadingOverlay").style.display = "flex";

      fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({
          productionEntryId: document.getElementById("entryId").value,
          productionDate: dateVal,
          notes: document.getElementById("notes").value,
          items: items
        })
      })
      .then(res => res.json())
      .then(r => {
        document.getElementById("loadingOverlay").style.display = "none";
        
        if(r.status === "success") { 
            Swal.fire({
              icon: 'success',
              title: 'Berhasil!',
              text: 'Data produksi telah disimpan.',
              confirmButtonColor: '#116999',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
               window.location.reload(); 
            });
        } else { 
            Swal.fire({
              icon: 'error',
              title: 'Gagal Menyimpan',
              text: r.message,
              confirmButtonColor: '#ef4444'
            });
        }
      })
      .catch(err => {
          document.getElementById("loadingOverlay").style.display = "none";
          Swal.fire({
              icon: 'error',
              title: 'Koneksi Gagal',
              text: 'Tidak dapat terhubung ke server: ' + err,
              confirmButtonColor: '#ef4444'
          });
      });
    }
  });
}

function setupSortable() {
  const tbody = document.getElementById("tableBody");
  Sortable.create(tbody, { 
      handle: ".row-handle", 
      animation: 150,
      ghostClass: "bg-gray-50"
  });
}
</script>
</body>
</html>
