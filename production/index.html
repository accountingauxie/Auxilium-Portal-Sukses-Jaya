<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Production Entry - Auxilium</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<link href="https://unpkg.com/feather-icons" rel="stylesheet"> <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/feather-icons"></script>

<style>
/* --- 1. GLOBAL RESET & VARIABLES --- */
:root { 
  /* Warna Standard Auxilium */
  --primary-color: #116999; 
  --primary-hover: #0e5a85;
  --bg-color: #f4f7f6; 
  --text-color: #333; 
  --border-color: #e2e8f0;
  --red-bg: #fee2e2; 
  --red-text: #991b1b;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
}

* { box-sizing: border-box; outline: none; }
body { margin: 0; background: var(--bg-color); font-family: 'Inter', system-ui, -apple-system, sans-serif; font-size: 14px; color: var(--text-color); -webkit-font-smoothing: antialiased; }

/* =========================================
   2. STANDARD NAVBAR STYLES (New)
   ========================================= */
.aux-navbar {
    background-color: #ffffff;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.05);
    position: sticky; top: 0; z-index: 1000;
}

.aux-logo img { height: 40px; width: auto; display: block; }

/* Wrapper Menu Utama */
.aux-menu { 
    display: flex; 
    gap: 10px; 
    align-items: center; 
    height: 100%; 
}

/* Item Menu Individual */
.nav-item {
    position: relative;
    height: 100%;
    display: flex;
    align-items: center;
}

/* Link Menu Utama */
.aux-link { 
    text-decoration: none; 
    color: #666; 
    font-weight: 600; 
    font-size: 14px; 
    padding: 8px 14px; 
    border-radius: 6px; 
    transition: all 0.2s; 
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.aux-link:hover, .nav-item:hover .aux-link { 
    color: #1d2939; 
    background-color: #f9fafb; 
}

.aux-link.active { 
    color: var(--primary-color); 
    background-color: #eff8ff; 
    font-weight: 700; 
}

/* --- DROPDOWN STYLES --- */
.dropdown-menu {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    top: 90%; 
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    background: white;
    min-width: 220px;
    border: 1px solid #eaecf0;
    border-radius: 8px;
    box-shadow: 0 12px 16px -4px rgba(16, 24, 40, 0.08);
    padding: 6px;
    z-index: 100000;
    transition: all 0.2s ease;
}

.dropdown-menu::before {
    content: "";
    position: absolute;
    top: -20px; left: 0; width: 100%; height: 20px; background: transparent;
}

.nav-item:hover .dropdown-menu {
    visibility: visible;
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.dropdown-item {
    display: block;
    padding: 10px 12px;
    color: #344054;
    text-decoration: none;
    font-size: 14px;
    border-radius: 6px;
    transition: background 0.2s;
    text-align: left;
    font-weight: 400;
}

.dropdown-item:hover {
    background-color: #f9fafb;
    color: var(--primary-color);
}

/* --- USER PANEL --- */
.user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid #eee; }
.user-details { display: flex; flex-direction: column; text-align: right; line-height: 1.3; }
.user-name { font-weight: 700; font-size: 13px; color: #333; }
.user-role { font-size: 11px; color: #888; }
.user-avatar { width: 36px; height: 36px; background-color: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; user-select: none; }
.logout-btn { background: none; border: 1px solid #ddd; color: #666; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; }
.logout-btn:hover { background-color: var(--red-bg); color: var(--red-text); border-color: var(--red-bg); }

/* --- LOGOUT MODAL --- */
.modal { display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
.modal-content { background-color: #fff; margin: 15% auto; padding: 32px; border-radius: 16px; width: 360px; text-align: center; }
.modal-buttons { display: flex; justify-content: center; gap: 12px; margin-top: 24px; }
.btn-modal { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; }
.btn-yes { background-color: #d92d20; color: #fff; }
.btn-cancel { background-color: #f2f4f7; color: #344054; }

/* =========================================
   3. PAGE CONTENT STYLES
   ========================================= */
.page { max-width: 1380px; margin: 40px auto; padding: 0 24px; }
.card { background: #fff; border-radius: 12px; box-shadow: var(--shadow-sm); padding: 32px; border: 1px solid var(--border-color); }
.card-title { font-size: 20px; font-weight: 700; margin-bottom: 24px; color: #101828; display: flex; justify-content: space-between; align-items: center; }

/* FORMS */
label { font-size: 12px; font-weight: 700; color: #64748b; display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.03em; }
.input-box { width: 100%; height: 40px; padding: 0 12px; font-size: 13.5px; border: 1px solid var(--border-color); border-radius: 6px; background: #fff; color: #333; transition: border 0.15s; }
.input-box:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(17, 105, 153, 0.1); }
.input-box[readonly] { background: #f1f5f9; color: #64748b; cursor: not-allowed; }
.row-flex { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 28px; }

/* TABLE */
table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; }
th { background: #f8fafc; padding: 12px 12px; font-size: 12px; font-weight: 700; text-transform: uppercase; color: #64748b; border-bottom: 1px solid var(--border-color); text-align: left; }
td { padding: 10px 12px; border-bottom: 1px solid var(--border-color); background: #fff; vertical-align: top; }
tr:last-child td { border-bottom: none; }
.hidden-col { display: none; }
.table-input { width: 100%; height: 38px; border: 1px solid var(--border-color); border-radius: 6px; padding: 0 10px; font-size: 13.5px; }
.we-number { background: #f1f5f9; border: 1px solid #cbd5e1; color: #475569; font-weight: 600; font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; }

/* BUTTONS */
.action-btn { border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; height: 38px; }
.add-row-btn { background: #fff; color: var(--primary-color); border: 1px dashed var(--border-color); width: 100%; margin-top: 10px; }
.add-row-btn:hover { background: #eff6ff; border-color: var(--primary-color); }
.submit-btn { background: var(--primary-color); color: #fff; padding: 0 32px; height: 44px; float: right; margin-top: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
.submit-btn:hover { background: var(--primary-hover); }
.view-list-btn { float: left; margin-top: 16px; background: #fff; color: #64748b; border: 1px solid var(--border-color); text-decoration: none; padding: 0 20px; }
.view-list-btn:hover { background: #f1f5f9; color: #333; border-color: #cbd5e1; }
.delete-btn { color: #94a3b8; cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; text-align: center; font-size: 16px; }
.delete-btn:hover { color: var(--red-text); background: var(--red-bg); }
.row-handle { cursor: grab; color: #cbd5e1; text-align: center; vertical-align: middle; font-size: 20px; width: 30px; }

/* UTILS & CHOICES FIXES */
textarea { width: 100%; border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-family: inherit; font-size: 13.5px; resize: vertical; min-height: 100px; }
textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(17, 105, 153, 0.1); }
#loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; justify-content: center; align-items: center; z-index: 10001; backdrop-filter: blur(2px); }
.spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Choices Override */
.choices { margin-bottom: 0; overflow: visible; }
.choices__inner { min-height: 40px !important; padding: 0 8px !important; border: 1px solid var(--border-color) !important; background-color: #fff !important; border-radius: 6px !important; display: flex !important; align-items: center !important; font-size: 13.5px !important; }
.choices.is-focused .choices__inner { border-color: var(--primary-color) !important; box-shadow: 0 0 0 3px rgba(17, 105, 153, 0.1) !important; }
.choices__input { background: transparent !important; border: none !important; }
.choices__list--dropdown { border: 1px solid var(--border-color) !important; border-radius: 8px !important; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1) !important; margin-top: 6px !important; z-index: 9000 !important; }
.kpc-balance { float: right; font-size: 11px; background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 99px; font-weight: 600; border: 1px solid #e2e8f0; }

/* SweetAlert Font */
.swal2-popup { font-family: 'Inter', sans-serif !important; border-radius: 12px !important; }
</style>
</head>

<body>
<div id="loadingOverlay"><div class="spinner"></div></div>

<div class="aux-navbar">
    <div class="aux-logo">
        <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo">
    </div>
    
    <nav class="aux-menu">
        <div class="nav-item">
            <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/" class="aux-link">Home</a>
        </div>

        <div class="nav-item">
            <div class="aux-link">
                Penjualan 
                <i data-feather="chevron-down" style="width:14px; height:14px;"></i>
            </div>
            <div class="dropdown-menu">
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Order%20Penjualan/" class="dropdown-item">Order Penjualan</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/Penjualan/Review%20Penjualan/" class="dropdown-item">Review Penjualan</a>
            </div>
        </div>

        <div class="nav-item">
            <div class="aux-link">
                Pembelian
                <i data-feather="chevron-down" style="width:14px; height:14px;"></i>
            </div>
            <div class="dropdown-menu">
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/PurchaseOrder/index.html" class="dropdown-item">Pemesanan Pembelian</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/CreateBill/index.html" class="dropdown-item">Daftar Tagihan</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html" class="dropdown-item">Penerimaan Pemesanan</a>
            </div>
        </div>

        <div class="nav-item">
            <div class="aux-link active"> Produksi
                <i data-feather="chevron-down" style="width:14px; height:14px;"></i>
            </div>
            <div class="dropdown-menu">
                <a href="#" class="dropdown-item">Persiapan Pemesanan</a>
                <a href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/production/" class="dropdown-item">Produksi Barang Jadi</a>
                <a href="#" class="dropdown-item">Retur Penjualan</a>
            </div>
        </div>

        <div class="nav-item">
            <div class="aux-link">
                Persediaan
                <i data-feather="chevron-down" style="width:14px; height:14px;"></i>
            </div>
            <div class="dropdown-menu">
                <a href="#" class="dropdown-item">Stok KPC</a>
                <a href="#" class="dropdown-item">Stok Spandek</a>
                <a href="#" class="dropdown-item">Gudang BS</a>
            </div>
        </div>
    </nav>

    <div class="user-panel">
        <div class="user-details">
            <span class="user-name">Admin Gudang</span>
            <span class="user-role">CV Sukses Jaya</span>
        </div>
        <div class="user-avatar">AG</div>
        <button class="logout-btn" onclick="showLogoutModal()" title="Keluar Akun">
            <i data-feather="log-out" style="width:16px; height:16px;"></i>
        </button>
    </div>
</div>

<div id="logoutModal" class="modal">
    <div class="modal-content">
      <p style="font-size:18px; font-weight:600; color:#101828; margin-bottom:10px;">Log out</p>
      <p style="color:#667085; font-size:14px; margin-bottom:24px;">Are you sure you want to log out?</p>
      <div class="modal-buttons">
        <button class="btn-modal btn-yes" onclick="logout()">Log out</button>
        <button class="btn-modal btn-cancel" onclick="closeLogoutModal()">Cancel</button>
      </div>
    </div>
</div>

<div class="page">
  <div class="card">
    <div class="card-title">
      Production Entry
      <span style="font-size:12px; font-weight:500; color:#64748b; background:#f1f5f9; padding:4px 10px; border-radius:20px;">New Entry</span>
    </div>

    <div class="row-flex">
      <div>
        <label>Date</label>
        <input type="date" id="productionDate" class="input-box">
      </div>
      <div>
        <label>Production Entry ID</label>
        <input type="text" id="entryId" class="input-box" readonly placeholder="Generating ID...">
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:30px;"></th>
          <th style="width:20%;">Machine</th> 
          <th style="width:20%;">Item</th>
          <th class="hidden-col">Meter</th>
          <th class="hidden-col">Qty</th>
          <th class="hidden-col">Total</th>
          <th style="width:25%;">KPC</th> 
          <th>WE Number</th>
          <th style="width:40px;"></th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <button class="action-btn add-row-btn" onclick="addRow()">+ Add Row</button>
    
    <div style="margin-top: 24px;">
      <label>Additional Notes</label>
      <textarea id="notes" placeholder="Enter any specific notes regarding this production batch..."></textarea>
    </div>
    
    <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:20px;">
      
      <a href="daftarproduksi/index.html" class="action-btn view-list-btn">
        Lihat Daftar
      </a>

      <button class="action-btn submit-btn" onclick="submitForm()">Submit Entry</button>
      
      <div style="clear:both;"></div>
    </div>
  </div>
</div>

<script>
// --- INITIALIZE ICONS ---
feather.replace();

// --- LOGOUT LOGIC ---
function showLogoutModal() { document.getElementById("logoutModal").style.display = "block"; }
function closeLogoutModal() { document.getElementById("logoutModal").style.display = "none"; }
function logout() {
    document.getElementById("loadingOverlay").style.display = "flex";
    setTimeout(() => {
        localStorage.removeItem("uxilium_current_user");
        window.location.href = "login.html"; // Adjust if needed
    }, 800);
}

// --- APP LOGIC (EXISTING) ---
// !!! GANTI URL INI DENGAN DEPLOYMENT ID TERBARU ANDA !!!
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8yMkeTBz9MmpkHvBDAXAMwebvdwpjjkpeyPhruGQO5rDqKtzcMuiCMOFAes9D7Xca4A/exec";

let allItemsData = []; 
let allKPCData = [];    
let uniqueMachines = [];

/* --- INITIAL LOAD --- */
window.addEventListener("DOMContentLoaded", async () => {
  document.getElementById("loadingOverlay").style.display = "flex";
  
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0');
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById("productionDate").value = `${yyyy}-${mm}-${dd}`;

  await loadNextEntryId();  

  try {
    const [itemRes, kpcRes] = await Promise.all([
      fetch(`${SCRIPT_URL}?action=getitem`),
      fetch(`${SCRIPT_URL}?action=getkpc`)
    ]);

    allItemsData = await itemRes.json();
    allKPCData = await kpcRes.json(); 

    const machinesSet = new Set(allItemsData.map(i => i.machine).filter(m => m));
    uniqueMachines = Array.from(machinesSet).sort();

    addRow(); 
    setupSortable();
  } catch (e) {
    Swal.fire({
        icon: 'error',
        title: 'Network Error',
        text: 'Failed to load data. Please check your internet connection.',
        confirmButtonColor: '#ef4444'
    });
    console.error(e);
  }
  document.getElementById("loadingOverlay").style.display = "none";
});

/* --- ROW MANAGEMENT --- */
function addRow() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td class="row-handle">⋮⋮</td>
    <td><select class="machine-select"></select></td>
    <td><select class="item-select"></select></td>
    <td class="hidden-col"><input class="table-input meter" type="number" value="0"></td>
    <td class="hidden-col"><input class="table-input qty" type="number" value="0"></td>
    <td class="hidden-col"><input class="table-input total" type="number" value="0"></td>
    <td><select class="kpc-select"></select></td>
    <td><input class="table-input we-number" readonly placeholder="Auto..."></td>
    <td class="delete-cell">
       <div class="delete-btn" onclick="removeRow(this)">✕</div>
    </td>
  `;
  document.getElementById("tableBody").appendChild(row);

  const machineSelect = row.querySelector(".machine-select");
  const itemSelect = row.querySelector(".item-select");
  const kpcSelect = row.querySelector(".kpc-select");

  initChoices(machineSelect, uniqueMachines.map(m => ({value: m, label: m})), "Select Machine");
  initChoices(itemSelect, [], "Select Machine First");
  initChoices(kpcSelect, [], "Select Item First", true); 

  // EVENT: Machine Change
  machineSelect.addEventListener("change", function(e) {
    updateDropdown(itemSelect, [], "Select Machine First");
    updateDropdown(kpcSelect, [], "Select Item First", true);
    row.querySelector(".we-number").value = "";

    if (e.target.value) {
      const filtered = allItemsData
        .filter(i => i.machine === e.target.value)
        .map(i => ({ value: i.name, label: i.name }));
      updateDropdown(itemSelect, filtered, "Select Item");
    }
  });

  // EVENT: Item Change (Filter KPC options)
  itemSelect.addEventListener("change", function(e) {
    const selectedItem = e.target.value;
    let placeholder = "Select Item First";
    
    row.querySelector(".we-number").value = ""; 
    
    let kpcOptions = [];
    if (selectedItem) {
        placeholder = "Select KPC";
        kpcOptions = allKPCData.filter(k => k.relatedItem === selectedItem);
    }

    refreshKPCOptionsForElement(kpcSelect, kpcOptions, placeholder);
  });

  // EVENT: KPC Change (Trigger WE Number & Lock other rows)
  kpcSelect.addEventListener("change", function(e) {
      calculateWENumber(row); 
  });
}

function removeRow(btn) {
  const row = btn.closest('tr');
  if(document.querySelectorAll('#tableBody tr').length > 1) {
    row.remove();
  }
}

/* --- LOGIC: WE NUMBER GENERATOR --- */
function calculateWENumber(row) {
    const machine = row.querySelector(".machine-select").value;
    const item = row.querySelector(".item-select").value;
    const kpc = row.querySelector(".kpc-select").value;
    const prodId = document.getElementById("entryId").value;
    const weInput = row.querySelector(".we-number");

    if(!machine || !item || !kpc || !prodId) {
        weInput.value = "";
        return;
    }

    // 1. Machine Code
    let machineCode = "XX";
    const mUpper = machine.toUpperCase();
    if(mUpper.includes("RENG")) machineCode = "RG";
    else if(mUpper.includes("TRUSS")) machineCode = "TS";
    else machineCode = mUpper.substring(0,2);

    const machineDigits = machine.match(/\d+/);
    const machineNum = machineDigits ? machineDigits[0].slice(-2) : "00";
    const finalMachineSegment = machineCode + machineNum;

    // 2. Item Suffix
    const itemDigitsMatch = item.match(/\d+/g); 
    let itemSuffix = "00";
    if(itemDigitsMatch && itemDigitsMatch.length > 0) {
        const lastGroup = itemDigitsMatch[itemDigitsMatch.length - 1];
        itemSuffix = lastGroup.slice(-2);
    }

    weInput.value = `${finalMachineSegment}_${kpc}_${prodId}_${itemSuffix}`;
}

/* --- LOGIC: PREVENT DUPLICATE KPC --- */
function refreshKPCOptionsForElement(el, rawData, placeholder) {
    const allSelects = document.querySelectorAll(".kpc-select");
    const usedValues = [];
    allSelects.forEach(sel => {
        if(sel !== el && sel.value) { 
            usedValues.push(sel.value);
        }
    });

    const filteredOptions = rawData
        .filter(k => !usedValues.includes(k.name))
        .map(k => {
            const formattedSisa = new Intl.NumberFormat('id-ID').format(k.sisa || 0);
            return {
                value: k.name,              
                label: k.name,              
                customProperties: { sisa: formattedSisa }
            };
        });

    updateDropdown(el, filteredOptions, placeholder, true);
}


/* --- CHOICES HELPER --- */
function updateDropdown(el, options, placeholder, useTemplate = false) {
  if (el.choicesInstance) {
    el.choicesInstance.destroy();
    el.choicesInstance = null;
  }
  el.innerHTML = ""; 
  initChoices(el, options, placeholder, useTemplate);
}

function initChoices(el, options, placeholder, useTemplate = false) {
  const config = {
    searchEnabled: true,
    itemSelectText: "",
    shouldSort: false,
    placeholder: true,
    placeholderValue: placeholder,
    allowHTML: true,
    removeItemButton: true, 
  };

  if (useTemplate) {
    config.callbackOnCreateTemplates = function(template) {
      return {
        item: ({ classNames }, data) => {
          return template(`
            <div class="${classNames.item} ${classNames.itemChoice} ${classNames.itemSelectable}" data-item data-id="${data.id}" data-value="${data.value}" ${data.active ? 'aria-selected="true"' : ''} ${data.disabled ? 'aria-disabled="true"' : ''}>
              ${data.label}
            </div>
          `);
        },
        choice: ({ classNames }, data) => {
          const sisa = data.customProperties && data.customProperties.sisa 
                        ? `<span class="kpc-balance">Sisa: ${data.customProperties.sisa}</span>` 
                        : '';
          
          return template(`
            <div class="${classNames.item} ${classNames.itemChoice} ${data.disabled ? classNames.itemDisabled : classNames.itemSelectable}" data-select-text="${this.config.itemSelectText}" data-choice ${data.disabled ? 'data-choice-disabled aria-disabled="true"' : 'data-choice-selectable'} data-id="${data.id}" data-value="${data.value}" ${data.groupId > 0 ? 'role="treeitem"' : 'role="option"'}>
              <span style="font-weight:600; color:#1e293b;">${data.label}</span> ${sisa}
            </div>
          `);
        },
      };
    };
  }

  const choices = new Choices(el, config);
  if(options.length > 0) {
      choices.setChoices(options, 'value', 'label', true);
  }
  el.choicesInstance = choices;
}

/* --- SERVER LOGIC --- */
async function loadNextEntryId() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getlastid`);
    const data = await res.json();
    const today = new Date();
    const prefix = `FGP${String(today.getFullYear()).slice(2)}${String(today.getMonth()+1).padStart(2,"0")}`;
    const lastId = data.lastId;
    
    let nextId = prefix + "0000001";
    if (lastId && lastId.startsWith(prefix)) {
      const num = parseInt(lastId.substring(7), 10);
      nextId = prefix + String(num + 1).padStart(7, "0");
    }
    document.getElementById("entryId").value = nextId;
  } catch(e) {}
}

/* --- UPDATED SUBMIT LOGIC WITH MODERN POPUP --- */
function submitForm() {
  const dateVal = document.getElementById("productionDate").value;
  
  // Validation 1: Date
  if (!dateVal) {
    Swal.fire({
      icon: 'warning',
      title: 'Missing Date',
      text: 'Please select a Production Date.',
      confirmButtonColor: '#116999'
    });
    return;
  }
  
  const rows = document.querySelectorAll("#tableBody tr");
  // Validation 2: Rows
  if (!rows.length) {
    Swal.fire({
      icon: 'warning',
      title: 'Empty List',
      text: 'Please add at least one item row.',
      confirmButtonColor: '#116999'
    });
    return;
  }

  const items = [];
  let isValid = true;

  rows.forEach(r => {
    const mSelect = r.querySelector(".machine-select");
    const iSelect = r.querySelector(".item-select");
    const kSelect = r.querySelector(".kpc-select");
    
    const m = mSelect.choicesInstance ? mSelect.choicesInstance.getValue(true) : mSelect.value;
    const i = iSelect.choicesInstance ? iSelect.choicesInstance.getValue(true) : iSelect.value;
    const k = kSelect.choicesInstance ? kSelect.choicesInstance.getValue(true) : kSelect.value;
    const we = r.querySelector(".we-number").value;

    if(!m || !i || !k) {
        isValid = false;
        if(!m) mSelect.closest('.choices').style.borderColor = "#ef4444";
        if(!i) iSelect.closest('.choices').style.borderColor = "#ef4444";
        if(!k) kSelect.closest('.choices').style.borderColor = "#ef4444";
    }

    items.push({ 
        machine: m, 
        item: i, 
        kpc: k, 
        weNumber: we,
        meter: r.querySelector(".meter").value, 
        qty: r.querySelector(".qty").value, 
        total: r.querySelector(".total").value 
    });
  });

  // Validation 3: Incomplete fields
  if (!isValid) {
    Swal.fire({
      icon: 'error',
      title: 'Incomplete Data',
      text: 'Please fill all required fields marked in red.',
      confirmButtonColor: '#ef4444'
    });
    return;
  }

  // MODERN CONFIRMATION POPUP
  Swal.fire({
    title: 'Submit Entry?',
    text: "Are you sure you want to submit this production entry?",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#116999',
    cancelButtonColor: '#f2f4f7',
    confirmButtonText: 'Yes, Submit!',
    cancelButtonText: '<span style="color:#333">Cancel</span>',
    reverseButtons: true
  }).then((result) => {
    if (result.isConfirmed) {
      // IF USER CLICKS YES -> SHOW LOADING & FETCH
      document.getElementById("loadingOverlay").style.display = "flex";

      fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify({
          productionEntryId: document.getElementById("entryId").value,
          productionDate: dateVal,
          notes: document.getElementById("notes").value,
          items: items
        })
      })
      .then(res => res.json())
      .then(r => {
        document.getElementById("loadingOverlay").style.display = "none";
        
        if(r.status === "success") { 
            // SUCCESS POPUP
            Swal.fire({
              icon: 'success',
              title: 'Submitted!',
              text: 'Data has been saved successfully.',
              confirmButtonColor: '#116999',
              timer: 2000,
              showConfirmButton: false
            }).then(() => {
               window.location.reload(); 
            });
        } else { 
            // SERVER ERROR POPUP
            Swal.fire({
              icon: 'error',
              title: 'Submission Error',
              text: r.message,
              confirmButtonColor: '#ef4444'
            });
        }
      })
      .catch(err => {
          document.getElementById("loadingOverlay").style.display = "none";
          // NETWORK ERROR POPUP
          Swal.fire({
              icon: 'error',
              title: 'Connection Failed',
              text: 'Could not connect to server: ' + err,
              confirmButtonColor: '#ef4444'
          });
      });
    }
  });
}

function setupSortable() {
  const tbody = document.getElementById("tableBody");
  Sortable.create(tbody, { 
      handle: ".row-handle", 
      animation: 150,
      ghostClass: "bg-gray-50"
  });
}
</script>
</body>
</html>
