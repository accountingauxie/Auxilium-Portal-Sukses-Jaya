<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Purchase Order - Xero Style</title>

<link rel="stylesheet" href="https://unpkg.com/choices.js/public/assets/styles/choices.min.css">
<script src="https://unpkg.com/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
/* --- XERO THEME VARIABLES --- */
:root {
  --xero-blue: #116999; /* Xero Blue color */
  --xero-blue-hover: #0e5a85;
  --border-color: #cccccc;
  --bg-color: #f4f5f6; /* Light gray background like Xero dashboard */
  --text-color: #222222;
  --input-bg: #ffffff;
  
  --green-bg: #dcfce7; --green-text: #166534;
  --red-bg: #fee2e2; --red-text: #991b1b;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; /* Xero fonts */
  background: var(--bg-color);
  font-size: 13px;
  color: var(--text-color);
}

/* --- LAYOUT UTILS --- */
.page-wrap { padding: 40px 20px; display: flex; justify-content: center; }

.invoice-card {
  width: 100%;
  max-width: 1600px; /* Lebar maksimal */
  background: #fff;
  padding: 40px;
  border: 1px solid #dcdcdc;
  /* Xero cards are usually flat or have very subtle shadow */
  box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
}

/* --- HEADER SECTION --- */
.top-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 30px;
  border-bottom: 1px solid #eee;
  padding-bottom: 20px;
}
.brand-title { font-size: 24px; color: var(--text-color); font-weight: 500; margin: 0; }
.brand-sub { font-size: 14px; color: #888; font-weight: 400; }

.header-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}

.field-group { margin-bottom: 5px; }
.field-label { 
  display: block; 
  margin-bottom: 6px; 
  font-size: 12px; 
  font-weight: 700; 
  color: #444; 
}

/* INPUT STYLES (XERO LOOK) */
input, select, textarea {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid var(--border-color);
  border-radius: 3px;
  font-size: 13px;
  color: #333;
  transition: border-color 0.2s;
  background: #fff;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--xero-blue);
  outline: none;
  box-shadow: 0 0 0 1px rgba(17, 105, 153, 0.2);
}

/* Readonly fields styling */
input[readonly], .detail-readonly {
  background-color: #fbfbfb;
  color: #555;
  border-color: #ddd;
}

/* --- CUSTOMER DETAILS SECTION --- */
.detail-grid {
  display: grid;
  grid-template-columns: 1.5fr 2fr 1.5fr 1fr;
  gap: 15px;
  padding: 15px;
  background: #f9f9f9; /* Subtle contrast */
  border: 1px solid #eee;
  margin-bottom: 25px;
  border-radius: 3px;
}

/* --- TABLE STYLES (THE CORE XERO LOOK) --- */
.table-container {
  overflow-x: auto;
  margin-bottom: 10px;
}

table.xero-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

/* Header Tabel Putih Clean */
table.xero-table th {
  background: #fff; /* Xero headers are white */
  text-align: left;
  padding: 10px 8px;
  font-size: 12px;
  font-weight: 700;
  color: #333;
  border-bottom: 1px solid #ccc; /* Stronger line for header */
  border-top: 1px solid #ccc;
}

table.xero-table td {
  padding: 0; /* Remove padding to make inputs fit flush */
  border-bottom: 1px solid #eee;
  border-right: 1px solid #f0f0f0;
  vertical-align: top;
}

/* Inputs inside table - Borderless feel until focus */
table.xero-table td input {
  border: 1px solid transparent; /* Invisible border by default */
  border-radius: 0;
  padding: 12px 8px;
  height: 100%;
  background: transparent;
}
table.xero-table td input:focus {
  border: 1px solid var(--xero-blue);
  background: #fff;
  z-index: 2;
  position: relative;
}
/* Except for stock display or readonly calculation */
table.xero-table td input[readonly] {
  background: #fcfcfc;
  color: #777;
}

/* COLUMN WIDTHS */
.col-drag { width: 30px; }
.col-type { width: 110px; }
.col-item { width: 300px; }
.col-unit { width: 80px; }
.col-meter { width: 70px; }
.col-qty { width: 70px; }
.col-price { width: 120px; }
.col-disc { width: 90px; }
.col-total { width: 130px; }
.col-stock { width: 80px; }
.col-status { width: 90px; }
.col-del { width: 40px; }

/* DROPDOWNS INSIDE TABLE (Choices.js override) */
.choices__inner {
  border: 1px solid transparent !important;
  background-color: transparent !important;
  min-height: 38px;
  padding: 4px !important;
}
.choices__inner:focus-within {
  border: 1px solid var(--xero-blue) !important;
  background-color: #fff !important;
}

/* DRAG & DELETE */
.drag-handle { 
  cursor: grab; 
  text-align: center; 
  color: #ccc; 
  padding-top: 10px !important; 
}
.delete-btn {
  border: none;
  background: none;
  color: #999;
  font-size: 18px;
  cursor: pointer;
  width: 100%;
  height: 100%;
  padding-top: 8px !important;
}
.delete-btn:hover { color: #d33; }

/* --- XERO STYLE BUTTON (ADD ROW) --- */
.xero-btn-group {
  display: inline-flex;
  margin-top: 0;
  margin-bottom: 20px;
}
.xero-btn {
  background-color: #fff;
  color: var(--xero-blue);
  border: 1px solid var(--xero-blue);
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 3px 0 0 3px;
  transition: all 0.2s;
}
.xero-btn:hover {
  background-color: #f0f7fc;
}
.xero-btn-arrow {
  background-color: #fff;
  color: var(--xero-blue);
  border: 1px solid var(--xero-blue);
  border-left: none; /* Combine look */
  padding: 8px 10px;
  cursor: pointer;
  border-radius: 0 3px 3px 0;
  font-size: 10px;
  display: flex;
  align-items: center;
}
.xero-btn-arrow:hover { background-color: #f0f7fc; }

/* --- FOOTER / TOTALS --- */
.footer-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 40px;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

.totals-area { text-align: right; }
.summary-row {
  display: flex;
  justify-content: flex-end;
  gap: 30px;
  padding: 8px 0;
  font-size: 14px;
}
.summary-row .label { color: #666; font-weight: 500; }
.summary-row .value { color: #222; font-weight: 600; min-width: 120px; }

.grand-total {
  font-size: 20px;
  font-weight: 700;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid #ddd;
  color: var(--text-color);
}

.btn-primary {
  background-color: #3fba13; /* Xero "Approve" green or could use Blue */
  /* Or stick to blue if prefer: var(--xero-blue) */
  color: white;
  border: none;
  padding: 12px 30px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 20px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.btn-primary:hover { filter: brightness(95%); }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }

/* --- STATUS BADGES & MODAL --- */
.status-badge {
    padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase;
    display: inline-block; width: 90%; margin: 8px auto; text-align: center;
}
.status-ok { background: var(--green-bg); color: var(--green-text); }
.status-oos { background: var(--red-bg); color: var(--red-text); }

/* Modal Styles */
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999;
}
.modal-box { background: #fff; padding: 30px; width: 420px; border-radius: 6px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
.modal-actions { margin-top: 25px; text-align: right; }
.btn-ok { background: var(--xero-blue); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
.btn-cancel { background: #eee; color: #333; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
.spinner { display:inline-block; width:12px; height:12px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; margin-left:5px; }
@keyframes spin { to {transform: rotate(360deg);} }

.toast { position: fixed; bottom: 30px; right: 30px; padding: 15px 25px; background: #333; color: white; border-radius: 5px; opacity: 0; transform: translateY(20px); transition: 0.3s; pointer-events: none; z-index: 10000; }
.toast.show { opacity: 1; transform: translateY(0); }

</style>
</head>

<body>

<div id="toast" class="toast">Notifikasi</div>

<div id="modalAddCustomer" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin-top:0">Tambah Customer Baru</h3>
    <input id="newCustomerName" type="text" placeholder="Nama Customer" style="margin-top:10px" />
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCustomerModal()">Cancel</button>
      <button class="btn-ok" onclick="submitNewCustomer()">
        Save <span id="modalSpinner" class="spinner" style="display:none"></span>
      </button>
    </div>
  </div>
</div>

<div id="modalStockWarning" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin-top:0; color:var(--red-text)">⚠️ Stok Tidak Cukup</h3>
    <p>Beberapa item melebihi stok yang tersedia.<br>Apakah customer bersedia menunggu (Pre-Order)?</p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeStockModal()">Batalkan</button>
      <button class="btn-ok" onclick="forceSubmitOrder()">Ya, Proses Pre-Order</button>
    </div>
  </div>
</div>

<div class="page-wrap">
  <div class="invoice-card">
    
    <div class="top-header">
      <div>
        <h1 class="brand-title">New Order</h1>
        <span class="brand-sub">AUXILIUM Accounting Services</span>
      </div>
      </div>

    <div class="header-grid">
      <div class="field-group">
        <span class="field-label">Customer</span>
        <select id="customerSelect"></select>
      </div>
      <div class="field-group">
        <span class="field-label">Order Type</span>
        <select id="orderType">
            <option value="General Order">General Order</option>
            <option value="Pre-Order">Pre-Order</option>
        </select>
      </div>
      <div class="field-group">
        <span class="field-label">Date</span>
        <input type="date" id="issueDate">
      </div>
      <div class="field-group">
        <span class="field-label">Order #</span>
        <input type="text" id="orderNumber" readonly>
      </div>
    </div>

    <div class="detail-grid">
        <div>
            <span class="field-label">Contact Person</span>
            <input type="text" id="detailPerson" class="detail-readonly" readonly placeholder="-">
        </div>
        <div>
            <span class="field-label">Alamat</span>
            <input type="text" id="detailAddress" class="detail-readonly" readonly placeholder="-">
        </div>
        <div>
            <span class="field-label">Kecamatan</span>
            <input type="text" id="detailKec" class="detail-readonly" readonly placeholder="-">
        </div>
        <div>
            <span class="field-label">Kota</span>
            <input type="text" id="detailCity" class="detail-readonly" readonly placeholder="-">
        </div>
    </div>

    <div class="table-container">
      <table class="xero-table">
        <thead>
          <tr>
            <th class="col-drag"></th>
            <th class="col-type">Type</th>
            <th class="col-item">Item</th>
            <th class="col-unit">Satuan</th>
            <th class="col-meter">Meter</th>
            <th class="col-qty">Qty</th>
            <th class="col-price">Unit Price</th>
            <th class="col-disc">Disc</th>
            <th style="width:100px">Net Price</th> 
            <th class="col-total">Total</th>
            <th class="col-stock">Stock</th>
            <th class="col-status">Status</th>
            <th class="col-del"></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="xero-btn-group">
        <button class="xero-btn" onclick="addRow()">Add a new line</button>
        <button class="xero-btn-arrow">▼</button>
    </div>

    <div class="footer-grid">
      <div>
        <span class="field-label">Notes</span>
        <textarea id="notes" style="height:120px; resize:vertical; margin-top:5px;"></textarea>
      </div>
      <div class="totals-area">
        <div class="summary-row">
          <span class="label">Subtotal (DPP)</span>
          <span class="value" id="dppDisplay">0.00</span>
        </div>
        <div class="summary-row">
          <span class="label">Tax (11%)</span>
          <span class="value" id="ppnDisplay">0.00</span>
        </div>
        <div class="summary-row grand-total">
          <span class="label">TOTAL</span>
          <span class="value" id="grandTotalDisplay">0.00</span>
        </div>
        
        <button class="btn-primary approve-btn" type="button">Approve Order</button>
      </div>
    </div>

  </div>
</div>

<script>
/* ================= CONFIGURATION ================= */
// GANTI URL INI DENGAN DEPLOYMENT TERBARU ANDA
const baseURL = "https://script.google.com/macros/s/AKfycbxDbH557eHfENyWVBXYoylB93SUwNQknGsZdUZLPhBsP5gzWTTVmig6mzhBsDqTHIQXdw/exec";

/* DATA STORAGE */
let customerData = []; 
let listSpandek = [], listNonSpandek = [];
let priceSpan = [], priceNon = [];
let unitSpan = [], unitNon = [];
let stockSpan = [], stockNon = [];
let choiceCustomer;

/* UTILS */
function showToast(msg, type="info") {
  const t = document.getElementById("toast"); t.textContent = msg;
  t.style.background = type==="success"?"#3fba13":type==="error"?"#d93c3c":"#333";
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2500);
}
function formatMoney(n) { return (Number(n)||0).toLocaleString("en-US", {minimumFractionDigits:2}); }
function parseMoney(s) { return parseFloat((s||"").replace(/,/g,"")) || 0; } // Adjusted for standard number format

/* INITIALIZATION */
window.onload = async function () {
  choiceCustomer = new Choices("#customerSelect", { searchEnabled: true, itemSelectText: "", shouldSort: false });
  document.getElementById("issueDate").value = new Date().toISOString().split("T")[0];
  
  await loadDropdowns();
  setOrderNumber();
  for(let i=0; i<3; i++) addRow();
  
  new Sortable(document.getElementById("itemsBody"), { handle: ".drag-handle", animation: 150 });
  
  document.getElementById('customerSelect').addEventListener('change', function(e) {
      fillCustomerDetails(e.target.value);
  });
};

/* LOGIC DETAIL CUSTOMER */
function fillCustomerDetails(selectedName) {
    const p = document.getElementById('detailPerson');
    const a = document.getElementById('detailAddress');
    const k = document.getElementById('detailKec');
    const c = document.getElementById('detailCity');
    
    if(!selectedName || selectedName === "add_new") {
        p.value="-"; a.value="-"; k.value="-"; c.value="-";
        if(selectedName === "add_new") openCustomerModal();
        return;
    }
    
    const data = customerData.find(x => x.name === selectedName);
    if(data) {
        p.value = data.person || "-";
        a.value = data.address || "-";
        k.value = data.kecamatan || "-";
        c.value = data.kota || "-";
    }
}

function setOrderNumber() {
    let last = localStorage.getItem("LAST_ORDER_NUM") || "1000000";
    let next = parseInt(last) + 1;
    localStorage.setItem("LAST_ORDER_NUM", next);
    document.getElementById("orderNumber").value = next;
}

/* FETCH DATA */
async function loadDropdowns() {
  try {
    const res = await fetch(baseURL + "?action=getdata");
    const data = await res.json();
    
    customerData = data.customers || [];
    listSpandek = data.spandek || [];
    listNonSpandek = data.nonspandek || [];
    priceSpan = data.priceSpan || [];
    priceNon = data.priceNon || [];
    unitSpan = data.unitSpan || []; 
    unitNon = data.unitNon || [];   
    stockSpan = data.stockSpan || [];
    stockNon = data.stockNon || [];

    choiceCustomer.clearChoices();
    const items = customerData.map(c => ({ value: c.name, label: c.name }));
    choiceCustomer.setChoices([{ value: "add_new", label: "+ Add New Contact" }, ...items], "value", "label", true);
    
  } catch (err) {
    console.error(err);
    showToast("Connection Error", "error");
  }
}

/* ROW OPERATIONS */
function addRow() {
  const tr = document.createElement("tr");
  // Structure adapted for Xero style inputs inside TD
  tr.innerHTML = `
    <td class="drag-handle">⋮⋮</td>
    <td><select class="type-select"><option value="">Type</option><option value="Spandek">Spandek</option><option value="Non Spandek">Non Spandek</option></select></td>
    <td><select class="item-select"></select></td>
    <td><input class="unit-input" readonly></td>
    <td><input class="meter-input" disabled></td>
    <td><input type="number" class="qty-input"></td>
    <td><input class="uprice-input" readonly></td>
    <td><input class="disc-input" value="0"></td>
    <td><input class="pqty-input" readonly></td>
    <td><input class="total-input" readonly></td>
    <td><input class="stock-display" readonly value="-"></td>
    <td style="text-align:center"><div class="status-container"></div></td>
    <td style="text-align:center"><button class="delete-btn" onclick="deleteRow(this)">×</button></td>
  `;
  document.getElementById("itemsBody").appendChild(tr);

  const typeSel = tr.querySelector(".type-select");
  const itemSel = tr.querySelector(".item-select");
  const meterInp = tr.querySelector(".meter-input");
  
  // Clean Choices for Items
  const choiceItem = new Choices(itemSel, { 
      searchEnabled: true, 
      shouldSort: false, 
      itemSelectText:"",
      placeholder: true,
      placeholderValue: "Select Item"
  });

  typeSel.addEventListener("change", () => {
    let list = [];
    if (typeSel.value === "Spandek") {
        list = listSpandek; meterInp.disabled=false; meterInp.style.background="transparent";
    } else {
        list = listNonSpandek; meterInp.disabled=true; meterInp.style.background="#eee"; meterInp.value="";
    }
    itemSel.innerHTML = "";
    choiceItem.setChoices(list.map(n => ({ value: n, label: n })), "value", "label", true);
    
    tr.querySelector(".unit-input").value = "";
    tr.querySelector(".uprice-input").value = "";
    recalcRow(tr);
  });

  itemSel.addEventListener("change", () => {
    const item = itemSel.value;
    const type = typeSel.value;
    let price = 0;
    let unit = "-";
    let index = -1;

    if (type === "Spandek") {
        index = listSpandek.indexOf(item);
        if(index >= 0) {
            price = priceSpan[index];
            unit = unitSpan[index];
        }
    } else {
        index = listNonSpandek.indexOf(item);
        if(index >= 0) {
            price = priceNon[index];
            unit = unitNon[index];
        }
    }
    
    tr.querySelector(".uprice-input").value = formatMoney(price);
    tr.querySelector(".unit-input").value = unit; 
    recalcRow(tr);
  });

  tr.querySelectorAll("input").forEach(i => i.addEventListener("input", () => { recalcRow(tr); recalcTotals(); }));
}

function deleteRow(btn) { btn.closest("tr").remove(); recalcTotals(); }

function recalcRow(row) {
  const type = row.querySelector(".type-select").value;
  const item = row.querySelector(".item-select").value;
  let meter = parseFloat(row.querySelector(".meter-input").value) || 0;
  if (type === "Non Spandek") meter = 1;

  const qty = parseFloat(row.querySelector(".qty-input").value) || 0;
  const unitPrice = parseMoney(row.querySelector(".uprice-input").value);
  const disc = parseMoney(row.querySelector(".disc-input").value);
  
  // Calculate
  const netPrice = (unitPrice - disc);
  const priceQty = netPrice * meter; // Ini harga per lembar/per meter setelah diskon
  const total = priceQty * qty;

  row.querySelector(".pqty-input").value = formatMoney(priceQty);
  row.querySelector(".total-input").value = formatMoney(total);

  // Stock check
  let stock = 0;
  let idx = -1;
  if(type==="Spandek") { idx = listSpandek.indexOf(item); if(idx>=0) stock = stockSpan[idx]||0; }
  else { idx = listNonSpandek.indexOf(item); if(idx>=0) stock = stockNon[idx]||0; }
  
  const stockDisp = row.querySelector(".stock-display");
  const statusCont = row.querySelector(".status-container");
  
  if(item) {
      stockDisp.value = stock; 
      let req = (type==="Spandek") ? (meter*qty) : qty;
      statusCont.innerHTML = "";
      if(req > 0) {
          const badge = document.createElement("span");
          badge.className = "status-badge " + (stock>=req ? "status-ok" : "status-oos");
          badge.textContent = stock>=req ? "OK" : "OOS";
          statusCont.appendChild(badge);
      }
  }
}

function recalcTotals() {
  let grand = 0;
  document.querySelectorAll(".total-input").forEach(e => grand += parseMoney(e.value));
  document.getElementById("dppDisplay").textContent = formatMoney(grand/1.11);
  document.getElementById("ppnDisplay").textContent = formatMoney(grand - (grand/1.11));
  document.getElementById("grandTotalDisplay").textContent = formatMoney(grand);
}

/* ================= ACTIONS ================= */
function openCustomerModal() { document.getElementById("modalAddCustomer").style.display="flex"; }
function closeCustomerModal() { document.getElementById("modalAddCustomer").style.display="none"; }
function openStockModal() { document.getElementById("modalStockWarning").style.display="flex"; }
function closeStockModal() { document.getElementById("modalStockWarning").style.display="none"; }

async function submitNewCustomer() {
    const name = document.getElementById("newCustomerName").value;
    if(!name) return showToast("Please enter a name", "error");
    
    document.getElementById("modalSpinner").style.display="inline-block";
    customerData.push({name:name, person:'-', address:'-', kecamatan:'-', kota:'-'});
    choiceCustomer.setChoices([{value:name, label:name}], "value", "label", false);
    choiceCustomer.setChoiceByValue(name);
    fillCustomerDetails(name);
    
    try {
        await fetch(baseURL + "?action=addcustomer&name=" + encodeURIComponent(name));
        closeCustomerModal();
        showToast("Customer Added", "success");
    } catch(e) { showToast("Error connecting", "error"); }
    document.getElementById("modalSpinner").style.display="none";
}

document.querySelector(".approve-btn").addEventListener("click", () => {
    const cust = document.getElementById("customerSelect").value;
    const type = document.getElementById("orderType").value;
    if(!cust || cust==="add_new") return showToast("Please select a customer", "error");
    
    // Skip stock check if Pre-Order
    const oos = document.querySelectorAll(".status-oos").length > 0;
    if(oos && type !== "Pre-Order") {
        openStockModal();
    } else {
        forceSubmitOrder();
    }
});

function forceSubmitOrder() {
    closeStockModal();
    const btn = document.querySelector(".approve-btn");
    btn.disabled=true; btn.textContent="Processing...";

    const payload = {
        customer: document.getElementById("customerSelect").value,
        orderType: document.getElementById("orderType").value,
        issueDate: document.getElementById("issueDate").value,
        orderNumber: document.getElementById("orderNumber").value,
        notes: document.getElementById("notes").value,
        grandTotal: document.getElementById("grandTotalDisplay").textContent,
        items: []
    };

    document.querySelectorAll("#itemsBody tr").forEach(tr => {
        const item = tr.querySelector(".item-select").value;
        if(item) {
            payload.items.push({
                type: tr.querySelector(".type-select").value,
                item: item,
                satuan: tr.querySelector(".unit-input").value,
                meter: tr.querySelector(".meter-input").value,
                qty: tr.querySelector(".qty-input").value,
                total: parseMoney(tr.querySelector(".total-input").value)
            });
        }
    });

    fetch(baseURL + "?action=submitorder&payload=" + encodeURIComponent(JSON.stringify(payload)))
    .then(res => res.text())
    .then(txt => {
        if(txt.includes("OK")) {
            showToast("Order Approved!", "success");
            setTimeout(()=>location.reload(), 1500);
        } else {
            throw new Error(txt);
        }
    })
    .catch(e => {
        showToast("Failed: " + e.message, "error");
        btn.disabled=false; btn.textContent="Approve Order";
    });
}
</script>

</body>
</html>
