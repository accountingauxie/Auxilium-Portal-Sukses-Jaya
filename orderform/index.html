<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Form Pemesanan Lengkap</title>

<link rel="stylesheet" href="https://unpkg.com/choices.js/public/assets/styles/choices.min.css">
<script src="https://unpkg.com/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
:root {
  --border: #d6dce1; --border-light: #e3e7eb; --header-bg: #f7f8fa;
  --text-muted: #697386; --blue: #0075c9; --bg: #f5f7fa;
  --green-bg: #dcfce7; --green-text: #166534; --red-bg: #fee2e2; --red-text: #991b1b;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: "Arial", sans-serif; background: var(--bg); font-size: 13px; }

/* TOP BAR & NAV */
.top-bar { padding: 10px 36px; background: #fff; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; }
.logo-section { font-weight: 600; font-size: 15px; }
.nav-menu { display: flex; gap: 8px; }
.nav-item { text-decoration: none; color: #64748b; font-size: 14px; font-weight: 500; padding: 8px 16px; border-radius: 6px; transition: 0.2s; }
.nav-item:hover, .nav-item.active { background-color: #eff6ff; color: var(--blue); }

/* LAYOUT */
.page-wrap { display: flex; justify-content: center; padding: 36px 0; }
.invoice-card { width: 1600px; background: #fff; border: 1px solid var(--border); border-radius: 10px; padding: 32px; margin: 0 auto; box-shadow: 0 2px 6px rgba(15,23,42,0.06); }
h2 { margin: 0 0 18px; font-size: 20px; font-weight: 600; }

/* INPUTS */
.field-label { display: block; margin-bottom: 4px; font-size: 12px; color: #6b7280; font-weight: 600; }
input, select, textarea { width: 100%; padding: 7px 10px; border-radius: 4px; border: 1px solid var(--border); font-size: 13px; background: white; }
input:focus, select:focus, textarea:focus { border-color: #9fb3c8; outline: none; }
input[readonly], .detail-readonly { background-color: #f8fafc; color: #475569; cursor: default; }

/* HEADER GRIDS */
.header-main { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 20px; margin-bottom: 15px; }
.header-details { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr; gap: 20px; margin-bottom: 22px; background: #f8fafc; padding: 15px; border-radius: 6px; border: 1px solid var(--border-light); }

/* TABLE STRUCTURE */
.table-wrapper { border: 1px solid var(--border); border-radius: 6px; background: #fff; margin-bottom: 16px; overflow: visible !important; }
.items-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
.items-table th { background: var(--header-bg); padding: 9px; font-size: 12px; color: var(--text-muted); text-align: left; border-bottom: 1px solid var(--border-light); }
.items-table td { padding: 8px; border-bottom: 1px solid var(--border-light); position: relative; }

/* COLUMN WIDTHS (UPDATED FOR SATUAN) */
.items-table th:nth-child(1), td:nth-child(1) { width: 30px; }  /* Drag */
.items-table th:nth-child(2), td:nth-child(2) { width: 110px; } /* Type */
.items-table th:nth-child(3), td:nth-child(3) { width: 280px; } /* Item Name (Dikecilkan dikit) */
.items-table th:nth-child(4), td:nth-child(4) { width: 70px; }  /* Satuan (NEW) */
.items-table th:nth-child(5), td:nth-child(5) { width: 70px; }  /* Meter */
.items-table th:nth-child(6), td:nth-child(6) { width: 60px; }  /* Qty */
.items-table th:nth-child(7), td:nth-child(7) { width: 120px; } /* Unit Price */
.items-table th:nth-child(8), td:nth-child(8) { width: 90px; }  /* Disc */
.items-table th:nth-child(9), td:nth-child(9) { width: 120px; } /* Price/Qty */
.items-table th:nth-child(10), td:nth-child(10) { width: 130px; } /* Total */
.items-table th:nth-child(11), td:nth-child(11) { width: 80px; } /* Stock */
.items-table th:nth-child(12), td:nth-child(12) { width: 90px; } /* Status */
.items-table th:nth-child(13), td:nth-child(13) { width: 30px; } /* Del */

.drag-handle { cursor: grab; text-align: center; color: #999; }
.delete-row { cursor: pointer; text-align: center; color: #d33; font-size: 16px; }
.add-row-btn { font-size: 13px; padding: 6px 12px; border: 1px solid var(--border); background: #fff; cursor: pointer; border-radius: 4px; margin-bottom: 10px; }

/* FOOTER & TOTALS */
.notes-and-totals { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
textarea { height: 170px; }
.totals-box { text-align: right; }
.summary-row { display: flex; justify-content: space-between; margin: 6px 0; font-size: 14px; }
.summary-row.total { font-weight: 700; font-size: 18px; margin-top: 12px; border-top: 1px solid #d4d7dc; padding-top: 12px; }
.approve-btn { margin-top: 20px; padding: 12px 42px; font-weight: 600; background: var(--blue); color: white; border: none; border-radius: 5px; cursor: pointer; }
.approve-btn:disabled { background: #94a3b8; cursor: not-allowed; }

/* BADGES & MODALS */
.status-badge { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-block; width: 100%; text-align: center; }
.status-ok { background: var(--green-bg); color: var(--green-text); }
.status-oos { background: var(--red-bg); color: var(--red-text); }
.stock-display { text-align: center; font-weight: 600; border: none; background: transparent; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 9999; }
.modal-box { background: #fff; padding: 24px; width: 400px; border-radius: 10px; box-shadow: 0 8px 26px rgba(0,0,0,0.2); }
.modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.btn-ok { background: var(--blue); color: #fff; border: none; padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: 600; }
.btn-cancel { background: #ddd; color: #333; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
.spinner { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #e5e7eb; border-top-color: #fff; animation: spin 0.7s linear infinite; display: none; }
@keyframes spin { to { transform: rotate(360deg); } }
.toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 18px; border-radius: 8px; background: #333; color: #fff; opacity: 0; transform: translateY(20px); transition: 0.25s; z-index: 99999; }
.toast.show { opacity: 1; transform: translateY(0); }
</style>
</head>

<body>

<div id="toast" class="toast"></div>

<div id="modalAddCustomer" class="modal-overlay">
  <div class="modal-box">
    <h3>Tambah Customer Baru</h3>
    <input id="newCustomerName" type="text" placeholder="Masukkan nama customer" />
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeCustomerModal()">Cancel</button>
      <button class="btn-ok" onclick="submitNewCustomer()"><span id="btnOkText">OK</span><span id="modalSpinner" class="spinner"></span></button>
    </div>
  </div>
</div>

<div id="modalStockWarning" class="modal-overlay">
  <div class="modal-box">
    <h3 style="color: var(--red-text)">‚ö†Ô∏è Stock Tidak Mencukupi</h3>
    <p>Terdapat item melebihi stok tersedia.<br>Apakah customer bersedia Pre-Order?</p>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeStockModal()">Batal</button>
      <button class="btn-ok" onclick="forceSubmitOrder()">Ya, Bersedia</button>
    </div>
  </div>
</div>

<div class="top-bar">
  <div class="logo-section">AUXILIUM <span style="font-weight:300;color:#909090">Accounting</span></div>
  <nav class="nav-menu">
    <a href="#" class="nav-item active">Home</a>
    <a href="#" class="nav-item">Receiving</a>
    <a href="#" class="nav-item">Production</a>
    <a href="#" class="nav-item">Review Invoice</a>
  </nav>
</div>

<div class="page-wrap">
  <div class="invoice-card">
    <h2>Form Pemesanan</h2>

    <div class="header-main">
      <div>
        <span class="field-label">Customer Name</span>
        <select id="customerSelect"></select>
      </div>
      <div>
        <span class="field-label">Order Type</span>
        <select id="orderType">
            <option value="General Order">General Order</option>
            <option value="Pre-Order">Pre-Order</option>
        </select>
      </div>
      <div>
        <span class="field-label">Issue date</span>
        <input type="date" id="issueDate">
      </div>
      <div>
        <span class="field-label">Order number</span>
        <input type="text" id="orderNumber" readonly>
      </div>
    </div>

    <div class="header-details">
        <div>
            <span class="field-label">Contact Person</span>
            <input type="text" id="detailPerson" class="detail-readonly" readonly placeholder="-">
        </div>
        <div>
            <span class="field-label">Alamat</span>
            <input type="text" id="detailAddress" class="detail-readonly" readonly placeholder="-">
        </div>
        <div>
            <span class="field-label">Kecamatan</span>
            <input type="text" id="detailKec" class="detail-readonly" readonly placeholder="-">
        </div>
        <div>
            <span class="field-label">Kota</span>
            <input type="text" id="detailCity" class="detail-readonly" readonly placeholder="-">
        </div>
    </div>

    <div class="table-wrapper">
      <table class="items-table">
        <thead>
          <tr>
            <th></th>
            <th>Type</th>
            <th>Item</th>
            <th>Satuan</th> <th>Meter</th>
            <th>Qty</th>
            <th>Unit Price</th>
            <th>Discount</th>
            <th>Price/Qty</th>
            <th>Total</th>
            <th>Stock</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <button class="add-row-btn" onclick="addRow()">Add row ‚ñº</button>

    <div class="notes-and-totals">
      <div>
        <span class="field-label">Catatan:</span>
        <textarea id="notes"></textarea>
      </div>
      <div class="totals-box">
        <div class="summary-row"><span class="label">DPP</span><span class="value" id="dppDisplay">0.00</span></div>
        <div class="summary-row"><span class="label">PPN 11%</span><span class="value" id="ppnDisplay">0.00</span></div>
        <div class="summary-row total"><span class="label">Grand Total</span><span class="value" id="grandTotalDisplay">0.00</span></div>
        <button class="approve-btn" type="button">Send Order</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIGURATION ================= */
// PASTE URL DEPLOYMENT GOOGLE SCRIPT ANDA DISINI
const baseURL = "https://script.google.com/macros/s/AKfycbxDbH557eHfENyWVBXYoylB93SUwNQknGsZdUZLPhBsP5gzWTTVmig6mzhBsDqTHIQXdw/exec";

/* DATA STORAGE */
let customerData = []; 
let listSpandek = [], listNonSpandek = [];
let priceSpan = [], priceNon = [];
let unitSpan = [], unitNon = []; // Array untuk Satuan
let stockSpan = [], stockNon = [];
let choiceCustomer;

/* UTILS */
function showToast(msg, type="info") {
  const t = document.getElementById("toast"); t.textContent = msg;
  t.style.background = type==="success"?"#16a34a":type==="error"?"#dc2626":"#333";
  t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2500);
}
function formatMoney(n) { return "Rp " + (Number(n)||0).toLocaleString("en-US", {minimumFractionDigits:2}); }
function parseMoney(s) { return parseFloat((s||"").replace(/Rp/gi,"").replace(/,/g,"")) || 0; }

/* INITIALIZATION */
window.onload = async function () {
  choiceCustomer = new Choices("#customerSelect", { searchEnabled: true, itemSelectText: "", shouldSort: false });
  document.getElementById("issueDate").value = new Date().toISOString().split("T")[0];
  
  await loadDropdowns();
  setOrderNumber();
  for(let i=0; i<3; i++) addRow();
  
  new Sortable(document.getElementById("itemsBody"), { handle: ".drag-handle", animation: 150 });
  
  // Listener Customer Change
  document.getElementById('customerSelect').addEventListener('change', function(e) {
      fillCustomerDetails(e.target.value);
  });
};

/* LOGIC DETAIL CUSTOMER */
function fillCustomerDetails(selectedName) {
    const p = document.getElementById('detailPerson');
    const a = document.getElementById('detailAddress');
    const k = document.getElementById('detailKec');
    const c = document.getElementById('detailCity');
    
    if(!selectedName || selectedName === "add_new") {
        p.value="-"; a.value="-"; k.value="-"; c.value="-";
        if(selectedName === "add_new") openCustomerModal();
        return;
    }
    
    const data = customerData.find(x => x.name === selectedName);
    if(data) {
        p.value = data.person || "-";
        a.value = data.address || "-";
        k.value = data.kecamatan || "-";
        c.value = data.kota || "-";
    }
}

function setOrderNumber() {
    let last = localStorage.getItem("LAST_ORDER_NUM") || "1000000";
    let next = parseInt(last) + 1;
    localStorage.setItem("LAST_ORDER_NUM", next);
    document.getElementById("orderNumber").value = next;
}

/* FETCH DATA FROM GOOGLE SCRIPT */
async function loadDropdowns() {
  try {
    const res = await fetch(baseURL + "?action=getdata");
    const data = await res.json();
    
    customerData = data.customers || [];
    listSpandek = data.spandek || [];
    listNonSpandek = data.nonspandek || [];
    priceSpan = data.priceSpan || [];
    priceNon = data.priceNon || [];
    unitSpan = data.unitSpan || []; // Load Data Satuan
    unitNon = data.unitNon || [];   // Load Data Satuan
    stockSpan = data.stockSpan || [];
    stockNon = data.stockNon || [];

    // Setup Customer Dropdown
    choiceCustomer.clearChoices();
    const items = customerData.map(c => ({ value: c.name, label: c.name }));
    choiceCustomer.setChoices([{ value: "add_new", label: "‚ûï Add New Customer" }, ...items], "value", "label", true);
    
  } catch (err) {
    console.error(err);
    showToast("Gagal memuat data", "error");
  }
}

/* ROW OPERATIONS */
function addRow() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="drag-handle">‚ãÆ‚ãÆ</td>
    <td><select class="type-select"><option value="">--</option><option value="Spandek">Spandek</option><option value="Non Spandek">Non Spandek</option></select></td>
    <td><select class="item-select"></select></td>
    <td><input class="unit-input" readonly style="background:#f8fafc;text-align:center;"></td> <td><input class="meter-input" disabled style="background:#f0f0f0"></td>
    <td><input type="number" class="qty-input"></td>
    <td><input class="uprice-input" readonly></td>
    <td><input class="disc-input" value="0"></td>
    <td><input class="pqty-input" readonly></td>
    <td><input class="total-input" readonly></td>
    <td><input class="stock-display" readonly value="-"></td>
    <td><div class="status-container"></div></td>
    <td class="delete-row" onclick="deleteRow(this)">üóë</td>
  `;
  document.getElementById("itemsBody").appendChild(tr);

  const typeSel = tr.querySelector(".type-select");
  const itemSel = tr.querySelector(".item-select");
  const meterInp = tr.querySelector(".meter-input");
  
  const choiceItem = new Choices(itemSel, { searchEnabled: true, shouldSort: false, itemSelectText:"" });

  typeSel.addEventListener("change", () => {
    let list = [];
    if (typeSel.value === "Spandek") {
        list = listSpandek; meterInp.disabled=false; meterInp.style.background="white";
    } else {
        list = listNonSpandek; meterInp.disabled=true; meterInp.style.background="#f0f0f0"; meterInp.value="";
    }
    itemSel.innerHTML = "";
    choiceItem.setChoices(list.map(n => ({ value: n, label: n })), "value", "label", true);
    
    // Reset fields
    tr.querySelector(".unit-input").value = "";
    tr.querySelector(".uprice-input").value = "";
    recalcRow(tr);
  });

  itemSel.addEventListener("change", () => {
    const item = itemSel.value;
    const type = typeSel.value;
    let price = 0;
    let unit = "-";
    let index = -1;

    if (type === "Spandek") {
        index = listSpandek.indexOf(item);
        if(index >= 0) {
            price = priceSpan[index];
            unit = unitSpan[index];
        }
    } else {
        index = listNonSpandek.indexOf(item);
        if(index >= 0) {
            price = priceNon[index];
            unit = unitNon[index];
        }
    }
    
    tr.querySelector(".uprice-input").value = formatMoney(price);
    tr.querySelector(".unit-input").value = unit; // Set Satuan
    recalcRow(tr);
  });

  tr.querySelectorAll("input").forEach(i => i.addEventListener("input", () => { recalcRow(tr); recalcTotals(); }));
}

function deleteRow(btn) { btn.closest("tr").remove(); recalcTotals(); }

function recalcRow(row) {
  const type = row.querySelector(".type-select").value;
  const item = row.querySelector(".item-select").value;
  let meter = parseFloat(row.querySelector(".meter-input").value) || 0;
  if (type === "Non Spandek") meter = 1;

  const qty = parseFloat(row.querySelector(".qty-input").value) || 0;
  const unitPrice = parseMoney(row.querySelector(".uprice-input").value);
  const disc = parseMoney(row.querySelector(".disc-input").value);
  
  const priceQty = (unitPrice - disc) * meter;
  const total = priceQty * qty;

  row.querySelector(".pqty-input").value = formatMoney(priceQty);
  row.querySelector(".total-input").value = formatMoney(total);

  // Stock check
  let stock = 0;
  let idx = -1;
  if(type==="Spandek") { idx = listSpandek.indexOf(item); if(idx>=0) stock = stockSpan[idx]||0; }
  else { idx = listNonSpandek.indexOf(item); if(idx>=0) stock = stockNon[idx]||0; }
  
  const stockDisp = row.querySelector(".stock-display");
  const statusCont = row.querySelector(".status-container");
  
  if(item) {
      stockDisp.value = stock; // Tampilkan angka stok
      let req = (type==="Spandek") ? (meter*qty) : qty;
      statusCont.innerHTML = "";
      if(req > 0) {
          const badge = document.createElement("span");
          badge.className = "status-badge " + (stock>=req ? "status-ok" : "status-oos");
          badge.textContent = stock>=req ? "Available" : "OOS";
          statusCont.appendChild(badge);
      }
  }
}

function recalcTotals() {
  let grand = 0;
  document.querySelectorAll(".total-input").forEach(e => grand += parseMoney(e.value));
  document.getElementById("dppDisplay").textContent = formatMoney(grand/1.11);
  document.getElementById("ppnDisplay").textContent = formatMoney(grand - (grand/1.11));
  document.getElementById("grandTotalDisplay").textContent = formatMoney(grand);
}

/* ================= ACTIONS ================= */
function openCustomerModal() { document.getElementById("modalAddCustomer").style.display="flex"; }
function closeCustomerModal() { document.getElementById("modalAddCustomer").style.display="none"; }
function openStockModal() { document.getElementById("modalStockWarning").style.display="flex"; }
function closeStockModal() { document.getElementById("modalStockWarning").style.display="none"; }

async function submitNewCustomer() {
    const name = document.getElementById("newCustomerName").value;
    if(!name) return showToast("Isi nama customer", "warning");
    
    document.getElementById("modalSpinner").style.display="inline-block";
    // Mock update frontend list
    customerData.push({name:name, person:'-', address:'-', kecamatan:'-', kota:'-'});
    choiceCustomer.setChoices([{value:name, label:name}], "value", "label", false);
    choiceCustomer.setChoiceByValue(name);
    fillCustomerDetails(name);
    
    // Send to backend
    try {
        await fetch(baseURL + "?action=addcustomer&name=" + encodeURIComponent(name));
        closeCustomerModal();
        showToast("Customer Added", "success");
    } catch(e) { showToast("Error connecting", "error"); }
    document.getElementById("modalSpinner").style.display="none";
}

document.querySelector(".approve-btn").addEventListener("click", () => {
    const cust = document.getElementById("customerSelect").value;
    const type = document.getElementById("orderType").value;
    if(!cust || cust==="add_new") return showToast("Pilih Customer", "warning");
    
    // Skip stock check if Pre-Order
    const oos = document.querySelectorAll(".status-oos").length > 0;
    if(oos && type !== "Pre-Order") {
        openStockModal();
    } else {
        forceSubmitOrder();
    }
});

function forceSubmitOrder() {
    closeStockModal();
    const btn = document.querySelector(".approve-btn");
    btn.disabled=true; btn.textContent="Sending...";

    const payload = {
        customer: document.getElementById("customerSelect").value,
        orderType: document.getElementById("orderType").value,
        issueDate: document.getElementById("issueDate").value,
        orderNumber: document.getElementById("orderNumber").value,
        notes: document.getElementById("notes").value,
        grandTotal: document.getElementById("grandTotalDisplay").textContent,
        items: []
    };

    document.querySelectorAll("#itemsBody tr").forEach(tr => {
        const item = tr.querySelector(".item-select").value;
        if(item) {
            payload.items.push({
                type: tr.querySelector(".type-select").value,
                item: item,
                satuan: tr.querySelector(".unit-input").value, // Kirim data satuan juga
                meter: tr.querySelector(".meter-input").value,
                qty: tr.querySelector(".qty-input").value,
                total: parseMoney(tr.querySelector(".total-input").value)
            });
        }
    });

    fetch(baseURL + "?action=submitorder&payload=" + encodeURIComponent(JSON.stringify(payload)))
    .then(res => res.text())
    .then(txt => {
        if(txt.includes("OK")) {
            showToast("Order Success!", "success");
            setTimeout(()=>location.reload(), 1500);
        } else {
            throw new Error(txt);
        }
    })
    .catch(e => {
        showToast("Failed: " + e.message, "error");
        btn.disabled=false; btn.textContent="Send Order";
    });
}
</script>

</body>
</html>
