<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Review Penjualan - Auxilium</title>
<link rel="stylesheet" href="https://unpkg.com/choices.js/public/assets/styles/choices.min.css">
<script src="https://unpkg.com/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- SYSTEM STYLE --- */
:root { 
    --primary-color: #116999; 
    --bg-color: #f4f7f6;
    --text-color: #333;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: "Arial", sans-serif; font-size: 13px; background: var(--bg-color); color: var(--text-color); }

/* Utility Alignment Classes */
.t-left { text-align: left; }
.t-center { text-align: center; }
.t-right { text-align: right; }

/* TRICK: Currency Alignment (Rp Left | Number Right) */
.currency-cell {
    display: flex;
    justify-content: space-between;
    width: 100%;
    white-space: nowrap;
}

/* Navbar */
.aux-navbar { background: #fff; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
.aux-logo img { height: 32px; }
.aux-menu a { text-decoration: none; color: #555; font-weight: 600; margin-right: 20px; font-size: 14px; }
.aux-menu a.active { color: var(--primary-color); }

/* Layout */
.page-wrap { padding: 30px 40px; max-width: 1400px; margin: 0 auto; }
.category-tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
.cat-btn { background: none; border: none; padding: 10px 20px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
.cat-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
.search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; }

/* Dashboard Table */
.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
table.xero-table { width: 100%; border-collapse: collapse; }
table.xero-table th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; color: #555; font-size: 12px; text-transform: uppercase; font-weight: bold; }
table.xero-table td { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
table.xero-table tr:hover { background: #f0f8ff; }

/* Badges */
.badge { padding: 5px 12px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; display: inline-block; letter-spacing: 0.5px; }
.badge-approve { background: #fff7e6; color: #b75900; border: 1px solid #ffe8cc; }
.badge-success { background: #ecfdf5; color: #047857; border: 1px solid #d1fae5; }
.badge-danger { background: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }

/* --- MODAL (WEB PREVIEW) --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9000; backdrop-filter: blur(2px); }
.modal-box { background: #fff; width: 1100px; max-width: 95%; height: 90vh; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #fff; }
.header-left { display: flex; align-items: center; gap: 15px; } 
.modal-body { flex: 1; overflow-y: auto; padding: 30px; background: #fff; }

.web-info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px; margin-bottom: 30px; border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; }
.web-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; display: block; margin-bottom: 5px; }
.web-value { font-size: 14px; color: #333; font-weight: bold; }

/* Web Table (Preview) */
table.web-items { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
table.web-items th { background: #f9fafb; font-size: 11px; color: #555; text-transform: uppercase; border-bottom: 1px solid #eee; font-weight: bold; padding: 10px; }
table.web-items td { padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 13px; }

/* Totals Preview */
.web-totals { display: flex; justify-content: flex-end; }
.web-total-box { width: 300px; background: #f9fafb; padding: 15px; border-radius: 8px; }
.web-total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
.web-total-row.grand { font-size: 18px; color: var(--primary-color); font-weight: bold; border-top: 1px solid #ddd; margin-top: 10px; padding-top: 10px; }

.modal-footer { padding: 15px 30px; background: #f9fafb; border-top: 1px solid #eee; text-align: right; }
.btn-action { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: bold; margin-left: 10px; transition: 0.2s; }
.btn-close { background: #fff; color: #333; border: 1px solid #ccc; }
.btn-reject { background: #dc2626; }
.btn-approve { background: #10b981; }
.btn-pdf { background: #2563eb; }

/* --- HIDDEN PDF (A5 LANDSCAPE) --- */
#pdf-hidden-container { position: absolute; left: -9999px; top: 0; }
#pdfContent { 
    background: #fff; width: 210mm; padding: 10mm 15mm; 
    font-family: "Arial", sans-serif; color: #000; 
}
.pdf-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px; }
.pdf-title { font-size: 36px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; margin-top: 5px; } 
.company-details { text-align: right; font-size: 10px; color: #333; line-height: 1.4; }
.company-logo img { height: 45px; margin-bottom: 5px; }
.company-name { font-weight: 800; font-size: 12px; color: #F59E0B; text-transform: uppercase; }

.pdf-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
.bill-to { width: 60%; }
.pdf-bill-label { font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
.pdf-cust-name { font-size: 14px; font-weight: 800; text-transform: uppercase; margin-bottom: 3px; }
.pdf-cust-addr { font-size: 10px; line-height: 1.4; color: #444; }
.meta-data { width: 35%; }
.pdf-meta-row { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 3px; width: 100%; }
.pdf-meta-key { font-weight: 700; }

/* PDF Table */
table.pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
table.pdf-table th { 
    font-size: 9px; font-weight: 800; text-transform: uppercase; 
    padding: 6px 4px; border-top: 2px solid #000; border-bottom: 2px solid #000; 
}
table.pdf-table td { padding: 6px 4px; font-size: 10px; vertical-align: top; border-bottom: 1px solid #ddd; }
table.pdf-table tr:last-child td { border-bottom: 2px solid #000; }

.pdf-totals-area { display: flex; justify-content: flex-end; }
.pdf-total-box { width: 250px; }
.pdf-total-row { display: flex; justify-content: space-between; font-size: 10px; padding: 2px 0; }
.pdf-total-row.grand { font-size: 14px; font-weight: 800; color: #116999; margin-top: 5px; border-top: 1px dotted #ccc; padding-top: 5px; }
.pdf-notes { font-size: 9px; color: #555; margin-top: 15px; border-top: 1px dotted #ccc; padding-top: 5px; }

/* Loading Animation */
.skeleton { height: 20px; background: #eee; width: 100%; border-radius: 4px; animation: pulse 1s infinite; }
@keyframes pulse { 0% {opacity: 0.6;} 50% {opacity: 1;} 100% {opacity: 0.6;} }
</style>
</head>
<body>

<div class="aux-navbar">
    <div class="aux-logo"><img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium"></div>
    <div class="aux-menu">
        <a href="#" class="active">Review Penjualan</a>
        <a href="production_dashboard.html">Production</a>
    </div>
</div>

<div class="page-wrap">
    <h2>Review Penjualan</h2>
    
    <div class="category-tabs">
        <button class="cat-btn active" onclick="setFilter('All')">All Order</button>
        <button class="cat-btn" onclick="setFilter('Awaiting Approval')">Awaiting Approval</button>
        <button class="cat-btn" onclick="setFilter('Approved Order')">Approved Order</button>
        <button class="cat-btn" onclick="setFilter('Cancel Order')">Cancelled</button>
    </div>

    <input type="text" id="searchInput" class="search-input" placeholder="Cari No Order / Customer..." onkeyup="renderTable()">

    <div class="table-card">
        <table class="xero-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Customer</th>
                    <th>Order Date</th>
                    <th>Est. Delivery</th>
                    <th>Jatuh Tempo</th>
                    <th style="text-align:right;">Total Amount</th>
                    <th style="text-align:center;">Status</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="emptyState" style="display:none; text-align:center; padding:50px; color:#999;">Tidak ada data.</div>
    </div>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <div class="header-left">
                <h3 style="margin:0; font-size: 18px; font-weight: bold;">Order #<span id="webOrderNo"></span></h3>
                <span id="webStatusBadge" class="badge"></span>
            </div>
            <button class="btn-close" onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="web-info-grid">
                <div>
                    <span class="web-label">Customer</span>
                    <div class="web-value" id="webCustomer">-</div>
                    <div style="font-size:12px; color:#666; margin-top:5px;" id="webAddress">-</div>
                </div>
                <div>
                    <span class="web-label">Order Details</span>
                    <div style="font-size:13px; margin-bottom:4px;">Date: <strong id="webDate">-</strong></div>
                    <div style="font-size:13px; margin-bottom:4px;">Est. Del: <strong id="webEst">-</strong></div>
                    <div style="font-size:13px;">Due/Term: <strong id="webDue">-</strong></div>
                </div>
                <div>
                    <span class="web-label">Additional Info</span>
                    <div style="font-size:13px; margin-bottom:4px;">CP: <span id="webCP">-</span></div>
                    <div style="font-size:13px; margin-bottom:4px;">NPWP: <span id="webNPWP">-</span></div>
                </div>
            </div>

            <table class="web-items">
                <thead>
                    <tr>
                        <th class="t-left" style="width:25%">ITEM NAME</th>
                        <th class="t-center" style="width:8%">METER</th>
                        <th class="t-center" style="width:8%">QTY</th>
                        <th class="t-center" style="width:10%">SATUAN</th>
                        <th class="t-left" style="width:15%">HARGA</th>
                        <th class="t-left" style="width:10%">DISC</th>
                        <th class="t-left" style="width:12%">NET</th>
                        <th class="t-left" style="width:12%">TOTAL</th>
                    </tr>
                </thead>
                <tbody id="webItemsBody"></tbody>
            </table>

            <div class="web-totals">
                <div class="web-total-box">
                    <div class="web-total-row"><span>Total DPP</span><span id="webDPP">0</span></div>
                    <div class="web-total-row"><span>PPN (11%)</span><span id="webPPN">0</span></div>
                    <div class="web-total-row grand"><span>Grand Total</span><span id="webTotal">0</span></div>
                </div>
            </div>
            
            <div style="margin-top:20px; padding:10px; background:#fdfdfd; border:1px dashed #ddd; border-radius:4px;">
                <strong style="font-size:11px; color:#555;">NOTES:</strong>
                <span id="webNotes" style="font-size:12px; color:#333; margin-left:5px;">-</span>
            </div>
        </div>

        <div class="modal-footer" id="modalActions"></div>
    </div>
</div>

<div id="pdf-hidden-container">
    <div id="pdfContent">
        <div class="pdf-header">
            <div class="pdf-title">INVOICE</div>
            <div class="company-details">
                <div class="company-logo">
                    <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/Screenshot_2025-12-17_161250-removebg-preview.png" alt="SJ">
                </div>
                <div class="company-name">CV. SUKSES JAYA MAKMUR LESTARI</div>
                <div>
                    JL. D.I Panjaitan, RT/RW. 008/003<br>
                    Kel. Wundudopi, Kec. Baruga, Kendari<br>
                    Sulawesi Tenggara | Telp. 0822 4708 4908
                </div>
            </div>
        </div>

        <div class="pdf-info">
            <div class="bill-to">
                <div class="pdf-bill-label">BILLED TO</div>
                <div class="pdf-cust-name" id="pdfCustName">CUSTOMER NAME</div>
                <div class="pdf-cust-addr">
                    <span id="pdfAddr">Alamat...</span><br>
                    <span id="pdfRegion">Kota, Kec</span><br>
                    Attn: <span id="pdfCP">-</span> | NPWP: <span id="pdfNPWP">-</span>
                </div>
            </div>
            <div class="meta-data">
                <div class="pdf-meta-row"><span class="pdf-meta-key">Invoice Date</span><span id="pdfDate">-</span></div>
                <div class="pdf-meta-row"><span class="pdf-meta-key">Est. Delivery</span><span id="pdfEst">-</span></div>
                <div class="pdf-meta-row"><span class="pdf-meta-key">Due Date</span><span id="pdfDue">-</span></div>
                <div class="pdf-meta-row"><span class="pdf-meta-key">Order Number</span><span id="pdfOrderNo">-</span></div>
            </div>
        </div>

        <table class="pdf-table">
            <thead>
                <tr>
                    <th class="t-left" style="width:25%;">NAMA BARANG</th>
                    <th class="t-center" style="width:8%;">METER</th>
                    <th class="t-center" style="width:8%;">QTY</th>
                    <th class="t-center" style="width:10%;">SATUAN</th>
                    <th class="t-left" style="width:13%;">HARGA SATUAN</th>
                    <th class="t-left" style="width:12%;">DISKON</th>
                    <th class="t-left" style="width:12%;">HARGA NET</th>
                    <th class="t-left" style="width:12%;">TOTAL</th>
                </tr>
            </thead>
            <tbody id="pdfItemsBody"></tbody>
        </table>

        <div class="pdf-totals-area">
            <div class="pdf-total-box">
                <div class="pdf-total-row"><span>Total DPP</span><span id="pdfDPP">0</span></div>
                <div class="pdf-total-row"><span>Total PPN (11%)</span><span id="pdfPPN">0</span></div>
                <div class="pdf-total-row grand"><span>Grand Total <span id="pdfTotal" style="margin-left:5px;">0</span></span></div>
            </div>
        </div>

        <div class="pdf-notes">
            <strong>Notes:</strong> <span id="pdfNotes">-</span>
        </div>
    </div>
</div>

<script>
const baseURL = "https://script.google.com/macros/s/AKfycbwfXZG-xWzjp2_PC68tniPhZkArpQfnZ4ipnmNU-QI1mp-cRCRbLVmDGdp2VEaNGLmG0w/exec";
let allOrders = [];
let currentFilter = 'All';

window.onload = fetchData;

async function fetchData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '<tr><td colspan="7"><div class="skeleton"></div></td></tr>';
    try {
        const res = await fetch(baseURL + "?action=getorders");
        const data = await res.json();
        if(Array.isArray(data)) { allOrders = data; renderTable(); }
    } catch(e) { console.error(e); }
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    const search = document.getElementById('searchInput').value.toLowerCase();
    tbody.innerHTML = '';
    const filtered = allOrders.filter(o => {
        if (currentFilter !== 'All') {
            if (currentFilter === 'Approved Order') {
                if (o.status === 'Awaiting Approval' || o.status === 'Cancel Order') return false;
            } else if (o.status !== currentFilter) return false;
        }
        return !search || JSON.stringify(o).toLowerCase().includes(search);
    });

    if(filtered.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';

    filtered.forEach(o => {
        let badge = 'badge-approve';
        if(o.status.includes('Cancel')) badge = 'badge-danger';
        if(o.status.includes('Completed') || o.status.includes('Production')) badge = 'badge-success';

        let tr = document.createElement('tr');
        tr.onclick = () => openModal(o.id);
        tr.innerHTML = `
            <td><strong>${o.id}</strong></td>
            <td>${o.customer}</td>
            <td>${o.date}</td>
            <td>${o.estDelivery}</td>
            <td>${o.dueDate}</td>
            <td style="text-align:right;"><strong>${fmtMoneySimple(o.grandTotal)}</strong></td>
            <td style="text-align:center;"><span class="badge ${badge}">${o.status}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

function openModal(id) {
    const o = allOrders.find(x => x.id == id);
    if(!o) return;

    // --- POPULATE HEADER ---
    document.getElementById('webOrderNo').textContent = o.id;
    document.getElementById('webStatusBadge').textContent = o.status;
    document.getElementById('webStatusBadge').className = 'badge ' + (o.status.includes('Cancel') ? 'badge-danger' : (o.status.includes('Awaiting Approval') ? 'badge-approve' : 'badge-success'));
    
    // --- POPULATE INFO ---
    ['web','pdf'].forEach(prefix => {
        document.getElementById(prefix+'Customer').textContent = o.customer;
        document.getElementById(prefix+'CustName').textContent = o.customer; // PDF Only
        document.getElementById(prefix+'Address').textContent = (o.address||"") + " " + (o.kec||"") + " " + (o.city||""); // Web
        document.getElementById(prefix+'Addr').textContent = o.address||""; // PDF
        document.getElementById(prefix+'Region').textContent = (o.kec||"") + ", " + (o.city||""); // PDF
        document.getElementById(prefix+'Date').textContent = o.date;
        document.getElementById(prefix+'Est').textContent = o.estDelivery;
        document.getElementById(prefix+'Due').textContent = o.dueDate;
        document.getElementById(prefix+'CP').textContent = o.cp || "-";
        document.getElementById(prefix+'NPWP').textContent = o.npwp || "-";
        document.getElementById(prefix+'Notes').textContent = o.notes;
        
        if(document.getElementById(prefix+'OrderNo')) document.getElementById(prefix+'OrderNo').textContent = o.id;
    });

    // --- POPULATE TABLES ---
    const webTbody = document.getElementById('webItemsBody');
    const pdfTbody = document.getElementById('pdfItemsBody');
    webTbody.innerHTML = '';
    pdfTbody.innerHTML = '';

    o.items.forEach(item => {
        let net = item.net || 0; // Ambil dari Kolom O yang sudah diambil backend
        
        // Render Web (Preview)
        webTbody.innerHTML += `
            <tr>
                <td class="t-left"><strong>${item.name}</strong><br><small style="color:#888;">${item.type}</small></td>
                <td class="t-center">${item.meter || '-'}</td>
                <td class="t-center">${item.qty}</td>
                <td class="t-center">${item.unit || '-'}</td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(item.price)}</span></div></td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(item.disc)}</span></div></td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(net)}</span></div></td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(item.total)}</span></div></td>
            </tr>`;

        // Render PDF (Hidden)
        pdfTbody.innerHTML += `
            <tr>
                <td class="t-left"><strong>${item.name}</strong><br><span style="font-size:9px; color:#666;">${item.type}</span></td>
                <td class="t-center">${item.meter || '-'}</td>
                <td class="t-center">${item.qty}</td>
                <td class="t-center">${item.unit || '-'}</td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(item.price)}</span></div></td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(item.disc)}</span></div></td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(net)}</span></div></td>
                <td><div class="currency-cell"><span>Rp</span><span>${fmtNum(item.total)}</span></div></td>
            </tr>`;
    });

    // --- TOTALS ---
    ['web','pdf'].forEach(prefix => {
        document.getElementById(prefix+'DPP').textContent = fmtMoneySimple(o.totalDPP);
        document.getElementById(prefix+'PPN').textContent = fmtMoneySimple(o.totalPPN);
        document.getElementById(prefix+'Total').textContent = fmtMoneySimple(o.grandTotal);
    });

    // --- BUTTONS ---
    let btns = `<button class="btn-action btn-close" onclick="closeModal()">Close</button>`;
    if(o.status === 'Awaiting Approval') {
        btns += `<button class="btn-action btn-reject" onclick="updateStatus('${o.id}', 'Cancel Order')">Reject</button>
                 <button class="btn-action btn-approve" onclick="updateStatus('${o.id}', 'Awaiting Production')">Approve</button>`;
    } else if (o.status !== 'Cancel Order') {
        btns += `<button class="btn-action btn-pdf" onclick="dlPDF('${o.id}')">Download PDF</button>`;
    }
    document.getElementById('modalActions').innerHTML = btns;
    document.getElementById('orderModal').style.display = 'flex';
}

function closeModal() { document.getElementById('orderModal').style.display = 'none'; }
function setFilter(f) { 
    currentFilter = f; 
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderTable(); 
}

// Helpers Formatter
function fmtNum(n) { return (Number(n)||0).toLocaleString('id-ID', {minimumFractionDigits:0}); }
function fmtMoneySimple(n) { return (Number(n)||0).toLocaleString('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}); }

async function updateStatus(id, stat) {
    if(!confirm('Update status to ' + stat + '?')) return;
    document.getElementById('modalActions').innerHTML = 'Processing...';
    await fetch(baseURL, {method:'POST', body:JSON.stringify({action:'updatestatus', id:id, status:stat})});
    fetchData(); closeModal();
}

function dlPDF(id) {
    const el = document.getElementById('pdfContent');
    const opt = {
        margin: 0,
        filename: `Invoice_${id}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3 },
        jsPDF: { unit: 'mm', format: [210, 148], orientation: 'landscape' }
    };
    const btn = document.querySelector('.btn-pdf');
    btn.textContent = "Generating...";
    html2pdf().set(opt).from(el).save().then(() => btn.textContent = "Download PDF");
}
</script>

</body>
</html>
