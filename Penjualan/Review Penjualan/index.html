<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Review Penjualan - Auxilium</title>
<link rel="stylesheet" href="https://unpkg.com/choices.js/public/assets/styles/choices.min.css">
<script src="https://unpkg.com/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- SYSTEM STYLE (UI Web) --- */
:root { 
    --primary-color: #116999; 
    --bg-color: #f4f7f6;
    --text-color: #333;
}

* { box-sizing: border-box; }
body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; font-size: 13px; background: var(--bg-color); color: var(--text-color); }

/* Navbar */
.aux-navbar { background: #fff; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
.aux-logo img { height: 32px; }
.aux-menu a { text-decoration: none; color: #555; font-weight: 600; margin-right: 20px; font-size: 14px; }
.aux-menu a.active { color: var(--primary-color); }

/* Layout */
.page-wrap { padding: 30px 40px; max-width: 1400px; margin: 0 auto; }
.category-tabs { margin-bottom: 20px; border-bottom: 2px solid #ddd; }
.cat-btn { background: none; border: none; padding: 10px 20px; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; }
.cat-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

.table-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; min-height: 400px; }
.search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; }

/* Table UI */
table.xero-table { width: 100%; border-collapse: collapse; }
table.xero-table th { text-align: left; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; color: #555; font-size: 12px; text-transform: uppercase; }
table.xero-table td { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
table.xero-table tr:hover { background: #f0f8ff; }

/* Badges */
.badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
.badge-approve { background: #fff7e6; color: #b75900; }
.badge-success { background: #ecfdf5; color: #047857; }
.badge-danger { background: #fef2f2; color: #b91c1c; }

/* --- MODAL STYLE --- */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(2px); }
.modal-box { background: #fff; width: 1100px; max-width: 95%; height: 90vh; display: flex; flex-direction: column; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.modal-body { flex: 1; overflow-y: auto; background: #888; padding: 20px; display: flex; justify-content: center; } 
/* Background Abu-abu di modal body biar kelihatan kertas PDF-nya */

.modal-footer { padding: 15px 20px; background: #fff; border-top: 1px solid #eee; text-align: right; }
.btn-action { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; color: white; font-weight: bold; margin-left: 10px; }
.btn-close { background: #fff; color: #333; border: 1px solid #ccc; }
.btn-reject { background: #dc2626; }
.btn-approve { background: #10b981; }
.btn-pdf { background: #2563eb; }

/* --- PDF DESIGN (A5 LANDSCAPE - SUKSES JAYA STYLE) --- */
#pdfContent { 
    background: #fff; 
    width: 210mm; /* Lebar A5 Landscape kurang lebih */
    min-height: 148mm; 
    padding: 10mm 15mm; 
    font-family: 'Arial', sans-serif; 
    color: #000;
    box-shadow: 0 0 15px rgba(0,0,0,0.2); 
    position: relative;
}

/* 1. Header Area */
.pdf-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px; }
.pdf-title { font-size: 36px; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; margin-top: 10px; }

.company-details { text-align: right; font-size: 10px; color: #333; line-height: 1.4; }
.company-logo img { height: 45px; margin-bottom: 5px; }
.company-name { font-weight: 800; font-size: 12px; color: #F59E0B; text-transform: uppercase; margin-bottom: 2px; } /* Warna Oranye Sukses Jaya */
.company-address { max-width: 250px; margin-left: auto; }

/* 2. Info Section */
.pdf-info { display: flex; justify-content: space-between; margin-bottom: 25px; }
.bill-to { width: 55%; }
.bill-label { font-size: 10px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; color: #000; }
.customer-name { font-size: 14px; font-weight: 800; margin-bottom: 3px; text-transform: uppercase; }
.customer-address { font-size: 10px; line-height: 1.4; color: #444; max-width: 90%; }

.meta-data { width: 35%; }
.meta-row { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px; }
.meta-key { font-weight: 700; }
.meta-val { text-align: right; }

/* 3. Table Section (Garis Tebal) */
.pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
.pdf-table th { 
    text-align: left; 
    font-size: 9px; 
    font-weight: 800; 
    text-transform: uppercase; 
    padding: 8px 5px; 
    border-top: 2px solid #000; 
    border-bottom: 2px solid #000; 
}
.pdf-table td { 
    padding: 8px 5px; 
    font-size: 10px; 
    vertical-align: top;
    border-bottom: 1px solid #ddd;
}
/* Hilangkan border bawah untuk baris terakhir item */
.pdf-table tbody tr:last-child td { border-bottom: 2px solid #000; }

.t-right { text-align: right; }
.item-sub { font-size: 9px; color: #666; margin-top: 2px; display: block; }

/* 4. Totals */
.pdf-totals { display: flex; justify-content: flex-end; margin-top: 5px; }
.total-box { width: 250px; }
.total-row { display: flex; justify-content: space-between; font-size: 10px; padding: 3px 0; }
.total-row.grand { 
    font-size: 14px; 
    font-weight: 800; 
    color: #116999; /* Biru */
    margin-top: 5px; 
    padding-top: 5px; 
}

/* 5. Notes & Footer */
.pdf-notes { font-size: 9px; color: #555; margin-top: 20px; border-top: 1px dotted #ccc; padding-top: 5px; }

/* Helper */
.skeleton { height: 20px; background: #eee; width: 100%; border-radius: 4px; animation: pulse 1s infinite; }
@keyframes pulse { 0% {opacity: 0.6;} 50% {opacity: 1;} 100% {opacity: 0.6;} }
</style>
</head>
<body>

<div class="aux-navbar">
    <div class="aux-logo"><img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium"></div>
    <div class="aux-menu">
        <a href="#" class="active">Review Penjualan</a>
        <a href="production_dashboard.html">Production</a>
    </div>
</div>

<div class="page-wrap">
    <h2>Review Penjualan</h2>
    
    <div class="category-tabs">
        <button class="cat-btn active" onclick="setFilter('All')">All Order</button>
        <button class="cat-btn" onclick="setFilter('Awaiting Approval')">Awaiting Approval</button>
        <button class="cat-btn" onclick="setFilter('Approved Order')">Approved Order</button>
        <button class="cat-btn" onclick="setFilter('Cancel Order')">Cancelled</button>
    </div>

    <input type="text" id="searchInput" class="search-input" placeholder="Cari No Order / Customer..." onkeyup="renderTable()">

    <div class="table-card">
        <table class="xero-table">
            <thead>
                <tr>
                    <th>Order #</th>
                    <th>Customer</th>
                    <th>Order Date</th>
                    <th>Est. Delivery</th>
                    <th>Jatuh Tempo</th>
                    <th style="text-align:right;">Total Amount</th>
                    <th style="text-align:center;">Status</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="emptyState" style="display:none; text-align:center; padding:50px; color:#999;">Tidak ada data.</div>
    </div>
</div>

<div id="orderModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3 style="margin:0;">Preview Order & Invoice</h3>
            <button class="btn-close" onclick="closeModal()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
        </div>
        
        <div class="modal-body">
            <div id="pdfContent">
                
                <div class="pdf-header">
                    <div class="pdf-title">INVOICE</div>
                    <div class="company-details">
                        <div class="company-logo">
                            <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/Screenshot_2025-12-17_161250-removebg-preview.png" alt="SJ Logo">
                        </div>
                        <div class="company-name">CV. SUKSES JAYA MAKMUR LESTARI</div>
                        <div class="company-address">
                            JL. D.I Panjaitan, RT/RW. 008/003<br>
                            Kel. Wundudopi, Kec. Baruga, Kendari<br>
                            Sulawesi Tenggara<br>
                            Telp. 0822 4708 4908
                        </div>
                    </div>
                </div>

                <div class="pdf-info">
                    <div class="bill-to">
                        <div class="bill-label">BILLED TO</div>
                        <div class="customer-name" id="pdfCustomer">CUSTOMER NAME</div>
                        <div class="customer-address">
                            <span id="pdfAddress">Alamat...</span><br>
                            <span id="pdfCityKec">Kota, Kecamatan</span><br>
                            Attn: <span id="pdfCP">-</span> | NPWP: <span id="pdfNPWP">-</span>
                        </div>
                    </div>
                    <div class="meta-data">
                        <div class="meta-row"><span class="meta-key">Invoice Date</span><span class="meta-val" id="pdfDate">-</span></div>
                        <div class="meta-row"><span class="meta-key">Est. Delivery</span><span class="meta-val" id="pdfEst">-</span></div>
                        <div class="meta-row"><span class="meta-key">Due Date</span><span class="meta-val" id="pdfDue">-</span></div>
                        <div class="meta-row"><span class="meta-key">Order Number</span><span class="meta-val" id="pdfOrderNo">-</span></div>
                    </div>
                </div>

                <table class="pdf-table">
                    <thead>
                        <tr>
                            <th style="width:25%;">NAMA BARANG</th>
                            <th style="width:8%;" class="t-right">SATUAN</th>
                            <th style="width:8%;" class="t-right">METER</th>
                            <th style="width:8%;" class="t-right">JML (QTY)</th>
                            <th style="width:13%;" class="t-right">HARGA SATUAN</th>
                            <th style="width:12%;" class="t-right">DISKON</th>
                            <th style="width:13%;" class="t-right">HARGA NET</th>
                            <th style="width:13%;" class="t-right">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="pdfItemsBody">
                        </tbody>
                </table>

                <div class="pdf-totals">
                    <div class="total-box">
                        <div class="total-row"><span>Total DPP</span><span id="pdfDPP">0</span></div>
                        <div class="total-row"><span>Total PPN (11%)</span><span id="pdfPPN">0</span></div>
                        <div class="total-row grand"><span>Grand Total <span id="pdfTotal" style="margin-left:5px;">0</span></span></div>
                    </div>
                </div>

                <div class="pdf-notes">
                    <strong>Notes:</strong> <span id="pdfNotes">-</span>
                </div>

            </div>
            </div>

        <div class="modal-footer" id="modalActions"></div>
    </div>
</div>

<script>
const baseURL = "https://script.google.com/macros/s/AKfycbw0T1WqJ82RL6qx3WhoI0fIKcGQzarEBKLYK0H-h4B4vBLOarbDv_zIjxNJQ8FcLh8jEQ/exec";
let allOrders = [];
let currentFilter = 'All';

window.onload = fetchData;

async function fetchData() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '<tr><td colspan="7"><div class="skeleton"></div></td></tr>';
    
    try {
        const res = await fetch(baseURL + "?action=getorders");
        const data = await res.json();
        if(Array.isArray(data)) {
            allOrders = data;
            renderTable();
        }
    } catch(e) { console.error(e); }
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    const search = document.getElementById('searchInput').value.toLowerCase();
    tbody.innerHTML = '';

    const filtered = allOrders.filter(o => {
        if (currentFilter !== 'All') {
            if (currentFilter === 'Approved Order') {
                if (o.status === 'Awaiting Approval' || o.status === 'Cancel Order') return false;
            } else if (o.status !== currentFilter) return false;
        }
        return !search || JSON.stringify(o).toLowerCase().includes(search);
    });

    if(filtered.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        return;
    }
    document.getElementById('emptyState').style.display = 'none';

    filtered.forEach(o => {
        let badge = 'badge-approve';
        if(o.status.includes('Cancel')) badge = 'badge-danger';
        if(o.status.includes('Completed') || o.status.includes('Production')) badge = 'badge-success';

        let tr = document.createElement('tr');
        tr.onclick = () => openModal(o.id);
        tr.innerHTML = `
            <td><strong>${o.id}</strong></td>
            <td>${o.customer}</td>
            <td>${o.date}</td>
            <td>${o.estDelivery}</td>
            <td>${o.dueDate}</td>
            <td style="text-align:right;"><strong>${fmtMoney(o.grandTotal)}</strong></td>
            <td style="text-align:center;"><span class="badge ${badge}">${o.status}</span></td>
        `;
        tbody.appendChild(tr);
    });
}

function openModal(id) {
    const o = allOrders.find(x => x.id == id);
    if(!o) return;

    // Fill PDF Data
    document.getElementById('pdfOrderNo').textContent = o.id;
    document.getElementById('pdfDate').textContent = o.date;
    document.getElementById('pdfEst').textContent = o.estDelivery;
    document.getElementById('pdfDue').textContent = o.dueDate;
    
    document.getElementById('pdfCustomer').textContent = o.customer;
    document.getElementById('pdfAddress').textContent = o.address || "";
    document.getElementById('pdfCityKec').textContent = (o.kec || "") + ", " + (o.city || "");
    document.getElementById('pdfCP').textContent = o.cp || "-";
    document.getElementById('pdfNPWP').textContent = o.npwp || "-";

    const tbody = document.getElementById('pdfItemsBody');
    tbody.innerHTML = '';
    o.items.forEach(item => {
        let net = (item.price || 0) - (item.disc || 0);
        tbody.innerHTML += `
            <tr>
                <td>
                    <strong>${item.name}</strong>
                    <span class="item-sub">${item.type}</span>
                </td>
                <td class="t-right">${item.unit || '-'}</td>
                <td class="t-right">${item.meter || '-'}</td>
                <td class="t-right">${item.qty}</td>
                <td class="t-right">${fmtMoney(item.price)}</td>
                <td class="t-right">${fmtMoney(item.disc)}</td>
                <td class="t-right">${fmtMoney(net)}</td>
                <td class="t-right"><strong>${fmtMoney(item.total)}</strong></td>
            </tr>
        `;
    });

    document.getElementById('pdfDPP').textContent = fmtMoney(o.totalDPP);
    document.getElementById('pdfPPN').textContent = fmtMoney(o.totalPPN);
    document.getElementById('pdfTotal').textContent = fmtMoney(o.grandTotal);
    document.getElementById('pdfNotes').textContent = o.notes || "-";

    // Action Buttons
    let btns = `<button class="btn-action btn-close" onclick="closeModal()">Close</button>`;
    if(o.status === 'Awaiting Approval') {
        btns += `<button class="btn-action btn-reject" onclick="updateStatus('${o.id}', 'Cancel Order')">Reject</button>
                 <button class="btn-action btn-approve" onclick="updateStatus('${o.id}', 'Awaiting Production')">Approve</button>`;
    } else if (o.status !== 'Cancel Order') {
        btns += `<button class="btn-action btn-pdf" onclick="dlPDF('${o.id}')">Download PDF</button>`;
    }

    document.getElementById('modalActions').innerHTML = btns;
    document.getElementById('orderModal').style.display = 'flex';
}

function closeModal() { document.getElementById('orderModal').style.display = 'none'; }
function setFilter(f) { 
    currentFilter = f; 
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    renderTable(); 
}
function fmtMoney(n) { return (Number(n)||0).toLocaleString('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}); }

async function updateStatus(id, stat) {
    if(!confirm('Update status to ' + stat + '?')) return;
    document.getElementById('modalActions').innerHTML = 'Processing...';
    await fetch(baseURL, {method:'POST', body:JSON.stringify({action:'updatestatus', id:id, status:stat})});
    fetchData(); closeModal();
}

function dlPDF(id) {
    const el = document.getElementById('pdfContent');
    const opt = {
        margin: 0.2,
        filename: `Invoice_${id}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 3 }, // Scale 3 biar tajam
        jsPDF: { unit: 'in', format: 'a5', orientation: 'landscape' }
    };
    const btn = document.querySelector('.btn-pdf');
    btn.textContent = "Generating...";
    html2pdf().set(opt).from(el).save().then(() => btn.textContent = "Download PDF");
}
</script>

</body>
</html>
